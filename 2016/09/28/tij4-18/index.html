<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="IO,file,stream,流," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="FileFile的本质是一个“文件地址标识”。内部维护着表示绝对路径的String。1private String path;
File不是单指某一个文件，而是“绝对地址”目录下的所有文件。“注意”：不迭代目录。只返回第一层的文件列表。

File对象比单纯文件名更有用。因为包含了更多有用的信息。

File#list()“绝对地址”目录下的所有文件列表可以用File#list()方法得到。
12">
<meta property="og:type" content="article">
<meta property="og:title" content="Thinking in Java 读书笔记：第十八章 - IO">
<meta property="og:url" content="www.ciaoshen.com/2016/09/28/tij4-18/index.html">
<meta property="og:site_name" content="玮 | Wei">
<meta property="og:description" content="FileFile的本质是一个“文件地址标识”。内部维护着表示绝对路径的String。1private String path;
File不是单指某一个文件，而是“绝对地址”目录下的所有文件。“注意”：不迭代目录。只返回第一层的文件列表。

File对象比单纯文件名更有用。因为包含了更多有用的信息。

File#list()“绝对地址”目录下的所有文件列表可以用File#list()方法得到。
12">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/streamZoo.jpg">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/readerWriter.gif">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/ascii.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/8859.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/utf8.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/double.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/blockingIO.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/multiIO.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/reactor.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/oldIOnewIO.jpg">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-18/buffer.jpg">
<meta property="og:updated_time" content="2016-12-17T03:50:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thinking in Java 读书笔记：第十八章 - IO">
<meta name="twitter:description" content="FileFile的本质是一个“文件地址标识”。内部维护着表示绝对路径的String。1private String path;
File不是单指某一个文件，而是“绝对地址”目录下的所有文件。“注意”：不迭代目录。只返回第一层的文件列表。

File对象比单纯文件名更有用。因为包含了更多有用的信息。

File#list()“绝对地址”目录下的所有文件列表可以用File#list()方法得到。
12">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>



  <meta name="baidu-site-verification" content="3iRy3UFlpa" />


<script>
  (function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>


  <title> Thinking in Java 读书笔记：第十八章 - IO | 玮 | Wei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-74473715-1', 'auto');
  ga('send', 'pageview');
</script>







  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">玮 | Wei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Coder & Designer</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hDG3wYskg4CYKGSXw8x7','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Thinking in Java 读书笔记：第十八章 - IO
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-28T19:55:14-04:00" content="2016-09-28">
              2016-09-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Note/" itemprop="url" rel="index">
                    <span itemprop="name">Note</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/28/tij4-18/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/28/tij4-18/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
            <span id="busuanzi_container_page_pv">&nbsp; |  &nbsp; &nbsp; Viewed <span id="busuanzi_value_page_pv"></span> times</span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="File"><a href="#File" class="headerlink" title="File"></a>File</h3><p>File的本质是一个<strong>“文件地址标识”</strong>。内部维护着表示绝对路径的String。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String path;</span><br></pre></td></tr></table></figure></p>
<p>File不是单指某一个文件，而是<strong>“绝对地址”</strong>目录下的所有文件。<strong>“注意”：不迭代目录。只返回第一层的文件列表。</strong></p>
<ul>
<li><strong>File对象比单纯文件名更有用。因为包含了更多有用的信息。</strong></li>
</ul>
<h4 id="File-list"><a href="#File-list" class="headerlink" title="File#list()"></a>File#list()</h4><p><strong>“绝对地址”</strong>目录下的所有文件列表可以用<strong>File#list()</strong>方法得到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] list() &#123;</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">        security.checkRead(path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fs.list(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法调用的<strong>fs</strong>：指的是native数据<strong>FileSystem</strong>。所以返回文件列表的动作是系统替我们完成的。不是用Java实现的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">private</span> FileSystem fs = FileSystem.getFileSystem();</span><br></pre></td></tr></table></figure></p>
<p>但我们还是可以对返回的List有所控制。通过给list()方法传入一个FilenameFilter对象做参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] list(FilenameFilter filter) &#123;</span><br><span class="line">    String names[] = list();</span><br><span class="line">    <span class="keyword">if</span> ((names == <span class="keyword">null</span>) || (filter == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> names;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; v = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; names.length ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filter.accept(<span class="keyword">this</span>, names[i])) &#123;</span><br><span class="line">            v.add(names[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v.toArray(<span class="keyword">new</span> String[v.size()]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>list()方法会回调FilenameFilter对象的accept()方法，判断某个文件是否符合过滤条件。accept()方法用个正则表达式就行了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">File path = <span class="keyword">new</span> File(<span class="string">"."</span>);</span><br><span class="line">String[] list = path.list(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">	<span class="keyword">private</span> Pattern pattern = Pattern.compile(args[<span class="number">0</span>]);</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir, String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pattern.matcher(name).matches();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这是一个标准的<strong>“策略模式”</strong>的良好实践。</p>
<h4 id="递归获取某个地址下的所有文件"><a href="#递归获取某个地址下的所有文件" class="headerlink" title="递归获取某个地址下的所有文件"></a>递归获取某个地址下的所有文件</h4><p>非常常用的功能。完全可以写进自己的类库。</p>
<p>具体实现参见本章练习4，5，6.</p>
<h3 id="“流（Stream）”家族"><a href="#“流（Stream）”家族" class="headerlink" title="“流（Stream）”家族"></a>“流（Stream）”家族</h3><p>Java IO有60个类。但只要思路清晰，它们各自的用途还是很明确的。</p>
<h4 id="两大家族：面向字节-amp-面向字符"><a href="#两大家族：面向字节-amp-面向字符" class="headerlink" title="两大家族：面向字节 &amp; 面向字符"></a>两大家族：面向字节 &amp; 面向字符</h4><p>首先要明确，IO有两大家族：</p>
<ul>
<li><strong>InputStream, OutputStream：面向字节。</strong></li>
<li><strong>Reader, Writer：面向字符。</strong></li>
</ul>
<p>上两张全家福：<br><img src="/uploads/tij4-18/streamZoo.jpg" alt="streamZoo"><br><img src="/uploads/tij4-18/readerWriter.gif" alt="readerWriter"></p>
<h5 id="字节到字符的编码"><a href="#字节到字符的编码" class="headerlink" title="字节到字符的编码"></a>字节到字符的编码</h5><p>什么是面向字节？什么是面向字符？先要从最基本的概念说起：</p>
<ul>
<li><strong>一个字节（byte）：8 bit</strong></li>
<li><strong>一个字符（char）：16 bit Unicode</strong></li>
</ul>
<p>基本单位一个<strong>”字节“</strong>占<strong>8个bit</strong>。这很简单。Java里的基本字符<strong>char</strong>基于UTF-16。和只占一个字节的ASCII码不同，常规字符占用两个字节，16 bit。</p>
<p>要搞懂各种编码之间的前世今生，推荐下面这篇比较好懂的文章：<br><a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html" target="_blank" rel="external"><strong>《字符编码笔记：ASCII，Unicode和UTF-8》</strong></a></p>
<h6 id="ASCII"><a href="#ASCII" class="headerlink" title="ASCII"></a>ASCII</h6><p>简单讲就是，一个字节8 bit，最多为256个符号编码。所以英语26个字母，再加几个常用符号，标点，256个码位足够了。这就熟悉的<strong>ASCII码</strong>。如下图，ASCII码一共收录了空格及94个“可印刷字符”。<br><img src="/uploads/tij4-18/ascii.png" alt="ascii"></p>
<h6 id="ISO-IEC-8859-1"><a href="#ISO-IEC-8859-1" class="headerlink" title="ISO/IEC 8859-1"></a>ISO/IEC 8859-1</h6><p>ASCII给英语用足够了。但其他的语言，比如拉丁语系的法语西班牙语等语言都有自己的特殊字母。所以，世界的每个不同地区又有了自己的特殊编码标准。比如<strong>ISO/IEC 8859-n</strong>系就是国际标准化组织定义的一系列8位字符集。也只占一个字节。最常用的比如<strong>ISO/IEC 8859-1</strong>就是法语，芬兰语所用的西欧字符集。<br><img src="/uploads/tij4-18/8859.png" alt="8859"></p>
<h6 id="中文编码"><a href="#中文编码" class="headerlink" title="中文编码"></a>中文编码</h6><p>汉字有好几万个。编码一个8 bit，256个码位就不够了。所以我国的汉字编码现行标准是<a href="https://zh.wikipedia.org/wiki/GB_18030" target="_blank" rel="external"><strong>《GB 18030》</strong></a>。每个字可以由1个、2个或4个字节组成，编码空间有161万个字符。另一个中国常用编码集是Big5。全世界各国都有自己的<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81" target="_blank" rel="external"><strong>《字元编码标准》</strong></a>。</p>
<h6 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h6><p>但这样编码的缺点很明显，同一个文件，到了另一个国家，用另一套编码集来解码，会产生乱码。在全球化的今天，最好全世界有一套统一的字符编码集。这就是<a href="https://zh.wikipedia.org/wiki/Unicode" target="_blank" rel="external"><strong>《Unicode》</strong></a>。Unicode的理念就是那么直接 – <strong>每种不同语言的不同字符都有一个单独编码</strong>。最初，Unicode占用2个字节，最多编码<strong>256*256=65536</strong>个字符。但很快从3.1版本开始就不够用了。所以又搞出了<strong>附加字符集</strong>。附加字符用4个字节表示。目前Unicode已对总共超过12万个字符编码。</p>
<h6 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h6><p>这里需要搞清楚一件事：<strong>Unicode只是一套符号的编码。但计算机具体怎么读取这套编码，又是另外一件事。</strong></p>
<p>我们可以老老实实地用2个字节，16位来表示一个Unicode字符。每次老老实实读取两个字节。然后在读到某个特殊标记的时候，知道是附加字符集，需要再往后读2个字节。但由于英语是使用最广泛的语言，明明一个字符就能完成，现在非要用2个字符。浪费了内存空间。不符合编码的规范：常用字符用最短的编码。所以就要想办法怎么能用一个字节表示英语，其他字符用多个字节。而且又要让电脑能够识别，自动处理。这就是UTF-8做的事。一本正经下定义的话：关键就是<strong>可变长编码</strong>。</p>
<ul>
<li><strong>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字元编码，也是一种前缀码。</strong></li>
</ul>
<p>UTF-8编码规则，如下图。可变长编码的关键就是：怎么让电脑知道每次需要读多大长度。所以必然需要某种标识。<br><img src="/uploads/tij4-18/utf8.png" alt="utf8"><br>具体的规则，很简单，只有两条：</p>
<ol>
<li>对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。</li>
<li>对于n字节的符号（n&gt;1），第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的unicode码。</li>
</ol>
<h6 id="UTF-16"><a href="#UTF-16" class="headerlink" title="UTF-16"></a>UTF-16</h6><p>UTF-16和UTF-8的不同在于，它用2个字节表示一些常用字符，4个字节表示附加字符。</p>
<p>具体编码规则，参见<a href="https://www.ibm.com/developerworks/cn/java/j-unicode/" target="_blank" rel="external"><strong>《使用 Java 语言进行 Unicode 代理编程》</strong></a>这篇文章。</p>
<h4 id="优先考虑面向字符的流"><a href="#优先考虑面向字符的流" class="headerlink" title="优先考虑面向字符的流"></a>优先考虑面向字符的流</h4><p>如果使用面向字节的流，那我们就必须自己处理上面介绍的从字节到字符的编码转换工作。比如根据UTF-16编码规则把byte[]数组解码成String字符串。虽然String类的构造器可以完成编码到字符映射的工作，一个String对象也有getBytes()方法反向编码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"我是沈玮"</span>;</span><br><span class="line"><span class="keyword">byte</span>[] b = s.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">String n = <span class="keyword">new</span> String(b,<span class="string">"UTF-8"</span>);</span><br></pre></td></tr></table></figure></p>
<p>但这样也增加了很多工作量。所以大多数情况应该优先使用面向字符的流。</p>
<p>关于Java的编码问题，也有一篇好的阅读材料：<a href="https://www.ibm.com/developerworks/cn/java/j-lo-chinesecoding/" target="_blank" rel="external"><strong>《深入分析 Java 中的中文编码问题》</strong></a>。</p>
<h4 id="数据的编码"><a href="#数据的编码" class="headerlink" title="数据的编码"></a>数据的编码</h4><p>除了byte到char需要编码和解码，其他基本型也不是直接读取就可以的。不同数据类型有不同的长度，而且内部数据编排原理也各不相同。以双精度浮点数double为例，<br><img src="/uploads/tij4-18/double.png" alt="double"><br>首先，double型的长度为64 bit。占据8个字节。最高位63位表示正负号，62-52的高11位为指数位，51-0的低52位表示尾数。</p>
<p>对double型的解码，虽然不需要一个几十万规模的字符集，但也需要一个转换。</p>
<h4 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h4><p>装饰器模式的基本思想很简单，就是利用组合和代理为类添加新功能。</p>
<p>比如一个最简单的容器模型Basic类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Basic</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String value;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String val)</span> </span>&#123; value = val; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>需要有一个所有装饰器的基类。把Basic类作为一个成员字段，以及一个以Basic类对象为参数的构造器。其实就是简单地用一个Basic对象做代理，封装所有方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">extends</span> <span class="title">Basic</span> </span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> Basic basic;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Basic basic)</span> </span>&#123; <span class="keyword">this</span>.basic = basic; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String val)</span> </span>&#123; basic.set(val); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> basic.get(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所有的装饰类继承原始装饰器基类后，可以在原有Basic基础上添加新功能。而它的构造器就是一个普通Basic类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeStamped</span> <span class="keyword">extends</span> <span class="title">Decorator</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeStamp;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TimeStamped</span><span class="params">(Basic basic)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(basic);</span><br><span class="line">		timeStamp = <span class="keyword">new</span> Date().getTime();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getStamp</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> timeStamp; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="Java-IO为什么用装饰器模式？"><a href="#Java-IO为什么用装饰器模式？" class="headerlink" title="Java IO为什么用装饰器模式？"></a>Java IO为什么用装饰器模式？</h5><p>Java用装饰器模式实现IO，<strong>主要是为了减少库中类的数量。通过拼装有限的功能组件，最终实现具有复合型功能的IO工具。</strong></p>
<p>虽然Java IO包里类一点也不少，一共有60个类。但它们能够组合出来的具有不同功能的工具数量更是惊人。这么说，Java IO虽然有点难用，但还是挺成功的。</p>
<h5 id="谁直接接触数据源？谁用来装饰？"><a href="#谁直接接触数据源？谁用来装饰？" class="headerlink" title="谁直接接触数据源？谁用来装饰？"></a>谁直接接触数据源？谁用来装饰？</h5><p>要理清IO包的脉络，一定要明确一个思路，IO包中的类分为<strong>两种不同的角色</strong>：</p>
<ul>
<li><strong>一类是直接对数据源进行读写的。</strong></li>
<li><strong>另一类是添加功能的过滤器。</strong></li>
</ul>
<p><strong>“核心IO”</strong>：负责直接读写特定类型数据源。以（InputStream，OutputStream），或者（Reader，Writer）为基类。</p>
<pre><code>* File######：
* String######:
* ByteArray######(or: CharArray######):
* Piped######:
* Zip######:
</code></pre><p><strong>“过滤器”</strong>：负责改变流的行为。以（FilterInputStream，FilterOutputStream），或者（FilterReader，FilterWriter）为基类。</p>
<pre><code>* Buffered######:
* Data######:
* Print######:
* Pushback######:
</code></pre><h5 id="组合流过滤器"><a href="#组合流过滤器" class="headerlink" title="组合流过滤器"></a>组合流过滤器</h5><p>一般使用IO包的模式就是：<strong>在核心IO类的外面套过滤器。</strong></p>
<p>考虑下面这个例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataInputStream in = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(Data.txt))));</span><br></pre></td></tr></table></figure></p>
<p>FileInputStream负责从本地文件读取字节流。然后套上一层BufferedInputStream缓冲器，避免频繁读取磁盘。最后还要套上DataInputStream装饰器，为的是方便读取不同类型的数据。</p>
<p>构造器层面，能够这样装配，因为FileInputStream有一个接受File为参数的构造器。BufferedInputStream和DataInputStream都有一个接受InputStream为参数的构造器。这就是装饰器模式的工作方式。</p>
<p>我们把DataInputStream套在最外面，最后暴露给我们的是DataInputStream类的接口，这是因为我们要用的就是DataInputStream所独有的比如readInt(), readDouble()这样方便读取数据的方法。</p>
<p>我们把BufferedInputReader夹在中间，但不用担心他的功能被覆盖掉。因为DataInputStream读取数据的方法，比如readInt()最终调用的都是read()方法（源代码如下）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">readInt</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ch1 = in.read();</span><br><span class="line">    <span class="keyword">int</span> ch2 = in.read();</span><br><span class="line">    <span class="keyword">int</span> ch3 = in.read();</span><br><span class="line">    <span class="keyword">int</span> ch4 = in.read();</span><br><span class="line">    <span class="keyword">if</span> ((ch1 | ch2 | ch3 | ch4) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">    <span class="keyword">return</span> ((ch1 &lt;&lt; <span class="number">24</span>) + (ch2 &lt;&lt; <span class="number">16</span>) + (ch3 &lt;&lt; <span class="number">8</span>) + (ch4 &lt;&lt; <span class="number">0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为int型占4个字节，所以调用4次read()方法。由于DataInputStream没有定义自己的无参数read()方法。所以根据其基类FilterInputStream类的无参数read()方法，直接调用的就是BufferedInputStream的read()方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而BufferedInputStream的read()方法是实现了缓冲功能的。所以BufferedInputStream的缓冲作用也得以发挥。同时又拥有了DataInputStream的特殊数据读取接口。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= count) &#123;</span><br><span class="line">        fill();</span><br><span class="line">        <span class="keyword">if</span> (pos &gt;= count)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getBufIfOpen()[pos++] &amp; <span class="number">0xff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以一般把DataInputStream或者PrintStream这种拥有特殊接口的类套在最外面，然后把BufferedInputStream夹在中间，最后由FileInputStream或者StringInputStream负责直接面对数据源，是套嵌多层过滤器的通用做法。</p>
<h5 id="缓冲器Buffer是怎么工作的？"><a href="#缓冲器Buffer是怎么工作的？" class="headerlink" title="缓冲器Buffer是怎么工作的？"></a>缓冲器Buffer是怎么工作的？</h5><p>作为最常用的过滤器，每个流不管是输入还是输出都会被套上一层“缓冲器”。缓冲器的原理其实很简单：一次性读取很多数据到内存，作为缓存，以后每次read就从缓存里取，而不是每次都磁盘操作读取实际文件。输出缓冲的原理也是一样，多攒一点内容才执行实际读写。下面代码是BufferedInputStream的部分源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferedInputStream</span> <span class="keyword">extends</span> <span class="title">FilterInputStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> defaultBufferSize = <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The internal buffer array where the data is stored. When necessary,</span><br><span class="line">     * it may be replaced by another array of</span><br><span class="line">     * a different size.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">byte</span> buf[];</span><br><span class="line"></span><br><span class="line">	<span class="comment">//... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，BufferedInputStream的缓冲区是一个字节数组<strong>byte buf[]</strong>。默认大小是8192字节，总共64k bit。</p>
<p>下面是它的read()方法。很简单，如果缓存读完了，就执行fill()方法重新填充。否则就直接用getBufIfOpen()方法读取缓存数组。其中pos作为数组的游标。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= count) &#123;	<span class="comment">//缓存读完</span></span><br><span class="line">        fill();</span><br><span class="line">        <span class="keyword">if</span> (pos &gt;= count)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getBufIfOpen()[pos++] &amp; <span class="number">0xff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getBufIfOpen()方法就是简单返回缓存数组。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Check to make sure that buffer has not been nulled out due to</span><br><span class="line"> * close; if not return it;</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] getBufIfOpen() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = buf;</span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Stream closed"</span>);</span><br><span class="line">    <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fill()方法稍微复杂一点，但抛开前面的各种安全检测，最后就是用getInIfOpen()方法获取它装饰的输入流。然后调用被装饰输入流的read()方法读取数据，放到缓存buffer里。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Fills the buffer with more data, taking into account</span><br><span class="line"> * shuffling and other tricks for dealing with marks.</span><br><span class="line"> * Assumes that it is being called by a synchronized method.</span><br><span class="line"> * This method also assumes that all data has already been read in,</span><br><span class="line"> * hence pos &gt; count.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = getBufIfOpen();</span><br><span class="line">    <span class="keyword">if</span> (markpos &lt; <span class="number">0</span>)</span><br><span class="line">        pos = <span class="number">0</span>;            <span class="comment">/* no mark: throw away the buffer */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pos &gt;= buffer.length)  <span class="comment">/* no room left in buffer */</span></span><br><span class="line">        <span class="keyword">if</span> (markpos &gt; <span class="number">0</span>) &#123;  <span class="comment">/* can throw away early part of the buffer */</span></span><br><span class="line">            <span class="keyword">int</span> sz = pos - markpos;</span><br><span class="line">            System.arraycopy(buffer, markpos, buffer, <span class="number">0</span>, sz);</span><br><span class="line">            pos = sz;</span><br><span class="line">            markpos = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buffer.length &gt;= marklimit) &#123;</span><br><span class="line">            markpos = -<span class="number">1</span>;   <span class="comment">/* buffer got too big, invalidate mark */</span></span><br><span class="line">            pos = <span class="number">0</span>;        <span class="comment">/* drop buffer contents */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;            <span class="comment">/* grow buffer */</span></span><br><span class="line">            <span class="keyword">int</span> nsz = pos * <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> (nsz &gt; marklimit)</span><br><span class="line">                nsz = marklimit;</span><br><span class="line">            <span class="keyword">byte</span> nbuf[] = <span class="keyword">new</span> <span class="keyword">byte</span>[nsz];</span><br><span class="line">            System.arraycopy(buffer, <span class="number">0</span>, nbuf, <span class="number">0</span>, pos);</span><br><span class="line">            <span class="keyword">if</span> (!bufUpdater.compareAndSet(<span class="keyword">this</span>, buffer, nbuf)) &#123;</span><br><span class="line">                <span class="comment">// Can't replace buf if there was an async close.</span></span><br><span class="line">                <span class="comment">// Note: This would need to be changed if fill()</span></span><br><span class="line">                <span class="comment">// is ever made accessible to multiple threads.</span></span><br><span class="line">                <span class="comment">// But for now, the only way CAS can fail is via close.</span></span><br><span class="line">                <span class="comment">// assert buf == null;</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Stream closed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            buffer = nbuf;</span><br><span class="line">        &#125;</span><br><span class="line">    count = pos;</span><br><span class="line">    <span class="keyword">int</span> n = getInIfOpen().read(buffer, pos, buffer.length - pos);</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">        count = n + pos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="一些常见使用场景"><a href="#一些常见使用场景" class="headerlink" title="一些常见使用场景"></a>一些常见使用场景</h3><p>把握住上面这个组合装饰器的原则，java IO的一些习惯用法就很好理解了。</p>
<h4 id="读取本地文本文件"><a href="#读取本地文本文件" class="headerlink" title="读取本地文本文件"></a>读取本地文本文件</h4><p>一般Unicode编码的文本文件，可以用面向字符的FileReader读取，再套一个缓冲器BufferedReader。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(Data.txt)));</span><br></pre></td></tr></table></figure></p>
<h4 id="从内存读取"><a href="#从内存读取" class="headerlink" title="从内存读取"></a>从内存读取</h4><p>一般把数据封装成String，然后用StringReader读取。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"Hello World!"</span>;</span><br><span class="line">StringReader br = <span class="keyword">new</span> StringReader(s);</span><br></pre></td></tr></table></figure></p>
<h4 id="格式化内存读取"><a href="#格式化内存读取" class="headerlink" title="格式化内存读取"></a>格式化内存读取</h4><p>格式化读取就必须用DataInputStream。因为DataInputStream是面向字节的，可以用把String打散成byte[]数组，然后用ByteArrayInputStream读取。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"Hello World!"</span>;</span><br><span class="line">DataInputStream in = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> ByteArrayInputStream(s.getBytes()));</span><br></pre></td></tr></table></figure></p>
<h4 id="基本文件输出"><a href="#基本文件输出" class="headerlink" title="基本文件输出"></a>基本文件输出</h4><p>写入本地文件，最好用PrintWriter。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PrintWriter pr = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(<span class="keyword">new</span> File(Data.txt))));</span><br></pre></td></tr></table></figure></p>
<h4 id="文件输出快捷方式"><a href="#文件输出快捷方式" class="headerlink" title="文件输出快捷方式"></a>文件输出快捷方式</h4><p>PrintWriter有一个直接接受File为参数的构造器。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PrintWriter pr = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> File(Data.txt));</span><br></pre></td></tr></table></figure></p>
<h3 id="底层“输入”“输出”是怎么实现的？"><a href="#底层“输入”“输出”是怎么实现的？" class="headerlink" title="底层“输入”“输出”是怎么实现的？"></a>底层“输入”“输出”是怎么实现的？</h3><p>到目前为止，所有的描述到了附着于具体数据读写对象的“核心IO”类就结束了。具体的读写操作被想象成一个“黑箱”过程。这里，以FileInputStream为例，解释一下，一个本地文件到底是怎么被打开，然后读取到内存的。此处主要参考了<a href="http://www.cnblogs.com/zuoxiaolong/p/jni1.html" target="_blank" rel="external"><strong> 《JNI探秘—–你不知道的FileInputStream的秘密》 </strong></a>这篇文章。感谢作者 – <strong>左潇龙</strong>。</p>
<p>先看FileInputStream源码中的一小段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileInputStream</span> <span class="keyword">extends</span> <span class="title">InputStream</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* File Descriptor - handle to the open file */</span></span><br><span class="line">    <span class="keyword">private</span> FileDescriptor fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FileChannel channel = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileInputStream</span><span class="params">(String name)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(name != <span class="keyword">null</span> ? <span class="keyword">new</span> File(name) : <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileInputStream</span><span class="params">(File file)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">    String name = (file != <span class="keyword">null</span> ? file.getPath() : <span class="keyword">null</span>);</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">        security.checkRead(name);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        &#125;</span><br><span class="line">    fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">    open(name);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这段代码有两个重点：</p>
<ol>
<li>有个FileDescriptor字段</li>
<li>构造函数最后调用了open(name)方法。</li>
</ol>
<p>FileDescriptor类里最关键的是这个叫handle的字段。就是我们打开文件的<strong>句柄（handle）</strong>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDescriptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> handle;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而open()方法是个native方法。如下所示，内部就是简单调用了另一个系统方法<strong>fileOpen()</strong>。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line"><span class="title">Java_java_io_FileInputStream_open</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path)</span> </span>&#123;</span><br><span class="line">    fileOpen(env, <span class="keyword">this</span>, path, fis_fd, O_RDONLY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而Windows系统fileOpen()方法的作用就是：<strong>获得目标文件的句柄，并赋值给handle字段。</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line">    env是一个指向JAVA本地方法环境的指针，它的作用大部分用来获取环境参数，比如当前线程。</span><br><span class="line">    this相信大家都不陌生，这就是指的当前FileInputStream的实例，只不过在C/C++环境中，它是jobject类型</span><br><span class="line">    path就是文件路径了，也是我们传进来的name参数</span><br><span class="line">    fid是FileInputStream类中fd属性的地址偏移量</span><br><span class="line">    flags是打开文件的方式，一般就是只读方式。</span><br><span class="line">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fileOpen</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>, jstring path, jfieldID fid, <span class="keyword">int</span> flags)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    jlong h = winFileHandleOpen(env, path, flags);<span class="comment">//这一句话就得到了一个文件的句柄</span></span><br><span class="line">    <span class="keyword">if</span> (h &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        SET_FD(<span class="keyword">this</span>, h, fid);<span class="comment">//这一句话就是将这个句柄赋给了FileDescriptor类的handle属性</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以打开一个文件的本质很简单，就是获得这个文件在系统中的“句柄”，然后根据这个句柄，顺藤摸瓜找到这个文件在磁盘上的物理地址。最后对磁盘进行读写。</p>
<h3 id="新I-O"><a href="#新I-O" class="headerlink" title="新I/O"></a>新I/O</h3><p>和老io包的 <strong>“面向流”</strong> 读写不同，引入java.nio包是 <strong>“面向缓冲区”</strong> 的读写。</p>
<h4 id="什么是面向缓冲区？"><a href="#什么是面向缓冲区？" class="headerlink" title="什么是面向缓冲区？"></a>什么是面向缓冲区？</h4><p>“面向流”之前已经讲了，就是老IO包所有操作的的底层都是在InputStream和OutputStream的流上进行操作。上文已经分析过，比如我们打开文件，其实就是直接获取此文件在系统上的句柄，然后通过系统调用对文件进行读写。中间没有缓冲（BufferedReader那是通过装饰器套上的）。</p>
<p>而“面向缓冲区”的结构由两个部分组成：一个是管道“FileChannel”，一个是缓冲区“ByteBuffer”。他们两个就像是 <strong>“煤矿隧道”</strong> 和 <strong>“拉煤车”</strong> 的关系。至于样的模型为什么要比传统面向流的模型要高效，背后涉及两个不同的I/O模型。</p>
<h4 id="传统阻塞式I-O"><a href="#传统阻塞式I-O" class="headerlink" title="传统阻塞式I/O"></a>传统阻塞式I/O</h4><p>旧IO包采用的是传统阻塞式IO模式。如下图所示，阻塞式IO就是用户进程在系统调用读写文件时，保持“阻塞”。大白话讲就是知道文件完整地读写完之前，用户进程一直处在等待状态。<br><img src="/uploads/tij4-18/blockingIO.png" alt="blockingIO"></p>
<h4 id="多路复用I-O"><a href="#多路复用I-O" class="headerlink" title="多路复用I/O"></a>多路复用I/O</h4><p>新IO采用的是复用I/O模型。简单讲就是第一个select步骤就是用户问系统他要的文件有没有准备好。之后的recvfrom才是真正的文件复制阶段。<br><img src="/uploads/tij4-18/multiIO.png" alt="multiIO"></p>
<p>至于这个复用I/O模型好在哪儿，关键就在于它允许内核同时管理多条“管道”。最基本的是一个叫Reactor的模式。<br><img src="/uploads/tij4-18/reactor.png" alt="reactor"></p>
<p>用户向内核注册感兴趣的事件（用register()方法），由内核维护一个负责轮询的线程，在某个同道准备好之后，通知用户。<br>nio多路复用的架构几乎就是UNIX内核的“管道-缓冲”架构的翻版。主要是为了更好地充分利用底层系统调用。实际上NIO在性能上已经几乎达到了它能达到的最佳性能。</p>
<h4 id="两者的区别"><a href="#两者的区别" class="headerlink" title="两者的区别"></a>两者的区别</h4><p>一张图，看清旧io包和nio包的区别。映证了NIO使用了Reactor模式。<br><img src="/uploads/tij4-18/oldIOnewIO.jpg" alt="oldIOnewIO"></p>
<h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4><p>注意FileChannel并没有实现SelectableChannel接口，因此不支持Selector。只有用于网络传输的ServerSocketChannel才实现了SelectableChannel接口。 下面这个清单演示了一次创建Channel，Selector，以及Channel向Selector注册感兴趣事件，获得注册钥的过程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建Selector</span></span><br><span class="line">Selector selector = Selector.open();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建Channel</span></span><br><span class="line">ServerSocketChannel ssc = ServerSocketChannel.open();</span><br><span class="line">ssc.configureBlocking( <span class="keyword">false</span> );</span><br><span class="line">ServerSocket ss = ssc.socket();</span><br><span class="line">InetSocketAddress address = <span class="keyword">new</span> InetSocketAddress( ports[i] );</span><br><span class="line">ss.bind( address );</span><br><span class="line"></span><br><span class="line"><span class="comment">//Channel向Selector注册感兴趣事件</span></span><br><span class="line">SelectionKey key = ssc.register( selector, SelectionKey.OP_ACCEPT );</span><br></pre></td></tr></table></figure></p>
<p>接下来，用Selector#selectedKey()方法监听发生的感兴趣事件，对返回的就绪的SelectionKey一一处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> num = selector.select();</span><br><span class="line"></span><br><span class="line">Set selectedKeys = selector.selectedKeys();</span><br><span class="line">Iterator it = selectedKeys.iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">     SelectionKey key = (SelectionKey)it.next();</span><br><span class="line">     <span class="comment">// ... deal with I/O event ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Buffer的细节"><a href="#Buffer的细节" class="headerlink" title="Buffer的细节"></a>Buffer的细节</h4><p>通过mark,position,limit,capacity四个标量控制缓冲区的读写。可以前进，可以后退，比传统流只能一位位往下读写更灵活。<br><img src="/uploads/tij4-18/buffer.jpg" alt="buffer"></p>
<h4 id="MappedByteBuffer"><a href="#MappedByteBuffer" class="headerlink" title="MappedByteBuffer"></a>MappedByteBuffer</h4><p>一篇好文章：<a href="http://blog.jobbole.com/104880/" target="_blank" rel="external"><strong> 《深入浅出 MappedByteBuffer》 </strong></a></p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><p>既然类和对象的本质就是数据的封装。那么无论是类还是对象，本质都是一组结构化的数据，也就是都可以序列化。</p>
<p>支持序列化的类必须实现 <strong>“Serializable”</strong> 接口。它只是一个标记性接口，没有定义任何方法。</p>
<p>一个序列化的对象可以被编码成流写入磁盘，“持久”储存。并且对象序列化<strong>保存的是对象的“全景图”和它所包含的所有引用</strong>。</p>
<p>对象序列化具体是一个很复杂的过程，尽量不要自己重复造轮子。用系统自带的 <strong>“ObjectOutputStream”</strong> 和 <strong>“ObjectInputStream”</strong> 就可以。</p>
<p>对象的“持久化”似乎为OO编程在工程上打开了一扇新的大门。尤其是网络编程，这让远距离传输对象变得非常方便。只要拥有某个类的.class文件，就能远距离复活这个类的对象。</p>
<ul>
<li><strong>!注意：</strong>序列化有个“缺陷”，就是<strong>不能序列化静态字段</strong>。需要自己添加额外方法来实现追加序列化静态字段。就像 <strong>“练习30”</strong> 中演示的那样。</li>
</ul>
<h4 id="Externalizable接口"><a href="#Externalizable接口" class="headerlink" title="Externalizable接口"></a>Externalizable接口</h4><p>Externalizable接口继承自Serializable接口。可以在序列化和反序列化过程中提供更多的控制。</p>
<p>实现Externalizable接口的类在被反序列化的时候，不是直接通过字节码来全盘复制和重建对象，而是调用默认构造器，重新构造。</p>
<p>接口通过定义 <strong>WriteExternal(ObjectOutput out)</strong> 和 <strong>ReadExternal(ObjectInput in)</strong> 两个方法。分别接受输入，输出流为参数，目的是允许追加序列化某些需要被序列化的部件。所以更灵活。</p>
<h4 id="transient关键字"><a href="#transient关键字" class="headerlink" title="transient关键字"></a>transient关键字</h4><p><strong>transient</strong> 关键字用来“定点关闭”某些不想被序列化的“敏感字段”，比如说密码。</p>
<h3 id="持久化的另一个选择-Preferences-API"><a href="#持久化的另一个选择-Preferences-API" class="headerlink" title="持久化的另一个选择 - Preferences API"></a>持久化的另一个选择 - Preferences API</h3><p>要持久化某些数据或者部件，序列化并不是唯一的选择。另一种更轻量级的实现是Preferences API。</p>
<p>关于Prefecrences API的一篇文章：<a href="http://www.ibm.com/developerworks/cn/java/j-prefapi/" target="_blank" rel="external"><strong>《用 Preferences API 存储对象》</strong></a></p>
<p>它有点类似Windows的注册表。这里对它的细节深挖。但它确实可以在系统层面持久储存某些信息。比如基本型，以及String。但它只能做这么多。</p>
<p>数据结构层面，Preferences是一系列“键-值”对的节点。一共有两棵树”用户树”和”系统树“。分别用userNodeForPackage()和systemNodeForPackage()。这两棵树功能是一样的。</p>
<p>具体这些数据被储存到哪里了？对不同的操作系统，Java使用的是不同的系统资源。对于Windows系统，就是存在了注册表里。</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h4><ul>
<li><strong>Exercise 1</strong>: (3) Modify DirList.java (or one of its variants) so that the FilenameFilter opens and reads each file (using the net.mindview.util.TextFile utility) and accepts the file based on whether any of the trailing arguments on the command line exist in that file.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line">        File path = <span class="keyword">new</span> File(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/gen/"</span>);</span><br><span class="line">        String[] list;</span><br><span class="line">        <span class="keyword">final</span> String p;</span><br><span class="line">        <span class="keyword">if</span>(args.length == <span class="number">0</span>)&#123;</span><br><span class="line">            p=<span class="string">".*gen.*"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            p=args[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        list = path.list(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">            <span class="keyword">private</span> Pattern pattern = Pattern.compile(p);</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir, String name)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">boolean</span> result=<span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    BufferedReader br=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(dir.getAbsolutePath()+<span class="string">"/"</span>+name)));</span><br><span class="line">                    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                        String line=br.readLine();</span><br><span class="line">                        <span class="keyword">if</span>(line==<span class="keyword">null</span>)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">                        <span class="keyword">if</span>(pattern.matcher(line).matches())&#123;</span><br><span class="line">                            result=<span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Can not open file:  "</span>+dir.getAbsolutePath()+name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Arrays.sort(list, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        <span class="keyword">for</span>(String dirItem : list)</span><br><span class="line">            System.out.println(dirItem+<span class="string">":   contains "</span>+p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h4><ul>
<li><strong>Exercise 2</strong>: (2) Create a class called SortedDirList with a constructor that takes a File object and builds a sorted directory list from the files at that File. Add to this class two overloaded list( ) methods: the first produces the whole list, and the second produces the subset of the list that matches its argument (which is a regular expression).</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SortedDirList</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> File path;</span><br><span class="line">        <span class="keyword">private</span> String[] list;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SortedDirList</span><span class="params">(String absPath)</span></span>&#123;</span><br><span class="line">            path=<span class="keyword">new</span> File(absPath);</span><br><span class="line">            list = path.list();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> String[] list()&#123;<span class="keyword">return</span> list;&#125;</span><br><span class="line">        <span class="keyword">public</span> String[] list(String regex)&#123;</span><br><span class="line">            list = path.list(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">                <span class="keyword">private</span> Pattern pattern = Pattern.compile(regex);</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir, String name)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> pattern.matcher(name).matches();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            Arrays.sort(list, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line">        Exercise2.SortedDirList dl=<span class="keyword">new</span> Exercise2.SortedDirList(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/gen/"</span>);</span><br><span class="line">        String[] fullList=dl.list();</span><br><span class="line">        String[] filteredList=dl.list(<span class="string">".*Ran.*"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;FULL LIST&lt;&lt;&lt;\n"</span>+Arrays.toString(fullList)+<span class="string">"\n"</span>);</span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;GEN LIST&lt;&lt;&lt;\n"</span>+Arrays.toString(filteredList));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><ul>
<li><strong>Exercise 3</strong>: (3) Modify DirList.java (or one of its variants) so that it sums up the file sizes of the selected files.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SortedDirList</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> File path;</span><br><span class="line">        <span class="keyword">private</span> String[] list;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SortedDirList</span><span class="params">(String absPath)</span></span>&#123;</span><br><span class="line">            path=<span class="keyword">new</span> File(absPath);</span><br><span class="line">            list = path.list();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> String[] list()&#123;<span class="keyword">return</span> list;&#125;</span><br><span class="line">        <span class="keyword">public</span> String[] list(String regex)&#123;</span><br><span class="line">            list = path.list(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">                <span class="keyword">private</span> Pattern pattern = Pattern.compile(regex);</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir, String name)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> pattern.matcher(name).matches();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            Arrays.sort(list, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> File <span class="title">getPath</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> path;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">countLine</span><span class="params">(File dir, String[] list)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(list.length==<span class="number">0</span>)&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        <span class="keyword">int</span> result=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(String name:list)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                BufferedReader br=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(dir+<span class="string">"/"</span>+name)));</span><br><span class="line">                <span class="keyword">while</span>(br.readLine()!=<span class="keyword">null</span>)&#123;result++;&#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Can not open the file:  "</span>+dir+<span class="string">"/"</span>+name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line">        Exercise3.SortedDirList dl=<span class="keyword">new</span> Exercise3.SortedDirList(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/gen/"</span>);</span><br><span class="line">        String[] fullList=dl.list();</span><br><span class="line">        String[] filteredList=dl.list(<span class="string">".*Ran.*"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;FULL LIST&lt;&lt;&lt;\n"</span>+Arrays.toString(fullList)+<span class="string">"\n"</span>);</span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;GEN LIST&lt;&lt;&lt;\n"</span>+Arrays.toString(filteredList)+<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Total Line: "</span>+Exercise3.countLine(dl.getPath(),filteredList));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-4-5-6"><a href="#Exercise-4-5-6" class="headerlink" title="Exercise 4,5,6"></a>Exercise 4,5,6</h4><ul>
<li><p><strong>Exercise 4</strong>: (2) Use Directory.walk( ) to sum the sizes of all files in a directory tree whose names match a particular regular expression.</p>
</li>
<li><p><strong>Exercise 5</strong>: (1) Modify ProcessFiles.java so that it matches a regular expression rather than a fixed extension.</p>
</li>
<li><p><strong>Exercise 6</strong>: (5) Use ProcessFiles to find all the Java source-code files in a particular directory subtree that have been modified after a particular date.</p>
</li>
</ul>
<h5 id="Directory-java"><a href="#Directory-java" class="headerlink" title="Directory.java"></a>Directory.java</h5><p>简化练习4中的Directory类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Directory</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; files=<span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; dirs=<span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> lines=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">()</span></span>&#123;<span class="keyword">this</span>(<span class="string">"."</span>);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(String dir)</span></span>&#123;<span class="keyword">this</span>(<span class="keyword">new</span> File(dir));&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(File dir)</span></span>&#123;<span class="keyword">this</span>(dir,<span class="string">".*"</span>);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(String dir, String regex)</span></span>&#123;<span class="keyword">this</span>(<span class="keyword">new</span> File(dir),regex);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(File dir,String regex)</span></span>&#123;</span><br><span class="line">        recurseDirs(dir,<span class="keyword">new</span> FilenameFilter()&#123;</span><br><span class="line">            <span class="keyword">private</span> Pattern p=Pattern.compile(regex);</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir,String name)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> p.matcher(name).matches();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        statistic();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(File dir,FilenameFilter filter)</span></span>&#123;</span><br><span class="line">        recurseDirs(dir,filter);</span><br><span class="line">        statistic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//递归收集文件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recurseDirs</span><span class="params">(File dir, FilenameFilter filter)</span></span>&#123;</span><br><span class="line">        File[] children=dir.listFiles();</span><br><span class="line">        <span class="keyword">if</span>(children==<span class="keyword">null</span> || children.length==<span class="number">0</span>)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="keyword">for</span>(File f:children)&#123;</span><br><span class="line">            <span class="keyword">if</span>(f.isDirectory())&#123;</span><br><span class="line">                dirs.add(f);</span><br><span class="line">                recurseDirs(f,filter);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(filter.accept(dir,f.getName()))&#123;</span><br><span class="line">                    files.add(f);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statistic</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(files!=<span class="keyword">null</span> &amp;&amp; files.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            size=files.size();</span><br><span class="line">            <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(File file:files)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    BufferedReader bf=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">                    <span class="keyword">while</span>(bf.readLine()!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                        num++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    System.out.println(file.getName()+<span class="string">" can not open!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            lines=num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">getFile</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> files;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">getDir</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> dirs;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showStatistic</span><span class="params">()</span></span>&#123;System.out.println(<span class="string">"File number:    "</span>+size+<span class="string">"\n"</span>+<span class="string">"Total Lines:   "</span>+lines+<span class="string">"\n"</span>);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise4-java"><a href="#Exercise4-java" class="headerlink" title="Exercise4.java"></a>Exercise4.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise4</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Directory d=<span class="keyword">new</span> Directory(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/"</span>,<span class="string">".*Gen.*"</span>);</span><br><span class="line">        d.showStatistic();</span><br><span class="line">        List&lt;File&gt; files=d.getFile();</span><br><span class="line">        List&lt;File&gt; dirs=d.getDir();</span><br><span class="line">        <span class="keyword">if</span>(files!=<span class="keyword">null</span>  &amp;&amp; !(files.size()==<span class="number">0</span>))&#123;</span><br><span class="line">            System.out.println(files);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(dirs!=<span class="keyword">null</span>  &amp;&amp; !(dirs.size()==<span class="number">0</span>))&#123;</span><br><span class="line">            System.out.println(dirs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ProcessFiles-java"><a href="#ProcessFiles-java" class="headerlink" title="ProcessFiles.java"></a>ProcessFiles.java</h5><p>ProcessFiles配合Directory使用。由Directory递归读取文件，然后由ProcessFiles里的Strategy模块处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessFiles</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(File file)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;</span><br><span class="line">    <span class="keyword">private</span> String ext;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProcessFiles</span><span class="params">(Strategy strategy, String ext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">        <span class="keyword">this</span>.ext = ext;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(args.length==<span class="number">0</span>)&#123;</span><br><span class="line">                processDirectoryTree(<span class="keyword">new</span> File(<span class="string">"."</span>));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">for</span>(String arg:args)&#123;</span><br><span class="line">                    processDirectoryTree(<span class="keyword">new</span> File(arg));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processDirectoryTree</span><span class="params">(File root)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(File file : <span class="keyword">new</span> Directory(root.getAbsolutePath(), <span class="string">".*\\."</span> + ext).getFile())&#123;</span><br><span class="line">            strategy.process(file.getCanonicalFile());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Demonstration of how to use it:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ProcessFiles(<span class="keyword">new</span> ProcessFiles.Strategy() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">                System.out.println(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"java"</span>).start(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise5-java"><a href="#Exercise5-java" class="headerlink" title="Exercise5.java"></a>Exercise5.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise5</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ProcessFiles(<span class="keyword">new</span> ProcessFiles.Strategy() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">                System.out.println(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"ja.*"</span>).start(args);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise6-java"><a href="#Exercise6-java" class="headerlink" title="Exercise6.java"></a>Exercise6.java</h5><p>用Directory和ProcessFile，对File做时间过滤。加了两个“时间-日期”转换方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"><span class="keyword">import</span> java.text.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise6</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">filterByModifyDate</span><span class="params">(String[] args, String date)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ProcessFiles(<span class="keyword">new</span> ProcessFiles.Strategy() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">long</span> time=getNanoTime(date);</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(file.lastModified()&gt;time)&#123;</span><br><span class="line">                    System.out.println(file+<span class="string">"   &gt;&gt;&gt;Last Modified: "</span>+getFormatDate(file.lastModified()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"java"</span>).start(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getNanoTime</span><span class="params">(String date)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            DateFormat dateFormat1 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">            Date myDate = dateFormat1.parse(date);</span><br><span class="line">            <span class="keyword">return</span> myDate.getTime();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(ParseException pe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Error when parsing Date!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0l</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFormatDate</span><span class="params">(<span class="keyword">long</span> millitime)</span></span>&#123;</span><br><span class="line">        SimpleDateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        <span class="keyword">return</span> df.format(millitime).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        filterByModifyDate(args,<span class="string">"2016-09-29"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h4><ul>
<li><strong>Exercise 7</strong>: (2) Open a text file so that you can read the file one line at a time. Read each line as a String and place that String object into a LinkedList. Print all of the lines in the LinkedList in reverse order.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise7</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        File file=<span class="keyword">new</span> File(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Directory.java"</span>);</span><br><span class="line">        LinkedList&lt;String&gt; list=<span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">        BufferedReader bf=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            bf=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                String line=bf.readLine();</span><br><span class="line">                <span class="keyword">if</span>(line==<span class="keyword">null</span>)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">                list.add(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(FileNotFoundException e)&#123;</span><br><span class="line">            System.out.println(file.getName()+<span class="string">" not found!"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"have problem when reading lines... ..."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(bf!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    bf.close();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"File can not be close!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> size=list.size();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">            System.out.println(list.get(--size));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h4><ul>
<li><strong>Exercise 8</strong>: (1) Modify Exercise 7 so that the name of the file you read is provided as a command-line argument.</li>
</ul>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class Exercise8&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> inversePrint(File file)&#123;</span><br><span class="line">        LinkedList&lt;<span class="keyword">String</span>&gt; list=<span class="keyword">new</span> LinkedList&lt;<span class="keyword">String</span>&gt;();</span><br><span class="line">        <span class="keyword">BufferedReader</span> bf=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            bf=<span class="keyword">new</span> <span class="keyword">BufferedReader</span>(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="keyword">String</span> <span class="built_in">line</span>=bf.readLine();</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">line</span>==<span class="keyword">null</span>)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">                list.<span class="built_in">add</span>(<span class="built_in">line</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(FileNotFoundException e)&#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(file.getName()+<span class="string">" not found!"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"have problem when reading lines... ..."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(bf!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    bf.close();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">                    System.out.<span class="built_in">println</span>(<span class="string">"File can not be close!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">int</span> <span class="built_in">size</span>=list.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i=<span class="number">0</span>;i&lt;list.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(list.<span class="built_in">get</span>(--<span class="built_in">size</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args)&#123;</span><br><span class="line">        <span class="keyword">if</span>(args.length==<span class="number">0</span>)&#123;</span><br><span class="line">            Exercise8.inversePrint(<span class="keyword">new</span> File(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Directory.java"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">String</span> arg:args)&#123;</span><br><span class="line">                Exercise8.inversePrint(<span class="keyword">new</span> File(arg));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h4><ul>
<li><strong>Exercise 9</strong>: (1) Modify Exercise 8 to force all the lines in the LinkedList to uppercase and send the results to System.out.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise9</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inversePrint</span><span class="params">(File file)</span></span>&#123;</span><br><span class="line">        LinkedList&lt;String&gt; list=<span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">        BufferedReader bf=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            bf=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                String line=bf.readLine();</span><br><span class="line">                <span class="keyword">if</span>(line==<span class="keyword">null</span>)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">                list.add(line.toUpperCase());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(FileNotFoundException e)&#123;</span><br><span class="line">            System.out.println(file.getName()+<span class="string">" not found!"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"have problem when reading lines... ..."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(bf!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    bf.close();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"File can not be close!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> size=list.size();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">            System.out.println(list.get(--size));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(args.length==<span class="number">0</span>)&#123;</span><br><span class="line">            Exercise9.inversePrint(<span class="keyword">new</span> File(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Directory.java"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(String arg:args)&#123;</span><br><span class="line">                Exercise9.inversePrint(<span class="keyword">new</span> File(arg));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-10"><a href="#Exercise-10" class="headerlink" title="Exercise 10"></a>Exercise 10</h4><ul>
<li><strong>Exercise 10</strong>: (2) Modify Exercise 8 to take additional command-line arguments of words to find in the file. Print all lines in which any of the words match.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise10</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">inversePrint</span><span class="params">(File file, String inWord)</span></span>&#123;</span><br><span class="line">        LinkedList&lt;String&gt; list=<span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">        BufferedReader bf=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            bf=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">            String line=<span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span>((line=bf.readLine())!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                String[] words=line.split(<span class="string">"[\\W]+"</span>);</span><br><span class="line">                <span class="keyword">if</span>(words.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(String word:words)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(word.toLowerCase().equals(inWord))&#123;</span><br><span class="line">                            list.add(line);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(FileNotFoundException e)&#123;</span><br><span class="line">            System.out.println(file.getName()+<span class="string">" not found!"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"have problem when reading lines... ..."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(bf!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    bf.close();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"File can not be close!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> size=list.size();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">            System.out.println(list.get(--size));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(args.length!=<span class="number">2</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Please check the args!"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            Exercise10.inversePrint(<span class="keyword">new</span> File(args[<span class="number">0</span>]),args[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-11"><a href="#Exercise-11" class="headerlink" title="Exercise 11"></a>Exercise 11</h4><ul>
<li><strong>Exercise 11</strong>: (2) In the innerclasses/GreenhouseController.java example, GreenhouseController contains a hard-coded set of events. Change the program so that it reads the events and their relative times from a text file, ((difficulty level 8): Use a Factory Method design pattern to build the events.</li>
</ul>
<p>使用了注册工厂模式。</p>
<h5 id="Controller-java"><a href="#Controller-java" class="headerlink" title="Controller.java"></a>Controller.java</h5><p>基层设施</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="comment">// A class from java.util to hold Event objects:</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Event&gt; eventList = <span class="keyword">new</span> ArrayList&lt;Event&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEvent</span><span class="params">(Event c)</span> </span>&#123; eventList.add(c); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(eventList.size() &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// Make a copy so you’re not modifying the list</span></span><br><span class="line">            <span class="comment">// while you’re selecting the elements in it:</span></span><br><span class="line">            <span class="keyword">for</span>(Event e : <span class="keyword">new</span> ArrayList&lt;Event&gt;(eventList))</span><br><span class="line">                <span class="keyword">if</span>(e.ready()) &#123;</span><br><span class="line">                    System.out.println(e);</span><br><span class="line">                    e.action();</span><br><span class="line">                    eventList.remove(e);</span><br><span class="line">                &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Event&gt; <span class="title">getList</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> eventList;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Event-java"><a href="#Event-java" class="headerlink" title="Event.java"></a>Event.java</h5><p>基层设施</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> eventTime;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">long</span> delayTime;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delayTime = delayTime;</span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123; <span class="comment">// Allows restarting</span></span><br><span class="line">        eventTime = System.nanoTime() + delayTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">ready</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.nanoTime() &gt;= eventTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="GreenhouseControls-java"><a href="#GreenhouseControls-java" class="headerlink" title="GreenhouseControls.java"></a>GreenhouseControls.java</h5><p>Controller和Event的综合体。 内部有一个Controller字段，每个Event都是一个内部类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreenhouseControls</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Controller con=<span class="keyword">new</span> Controller();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Controller <span class="title">getController</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> con;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> light = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LightOn</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">LightOn</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> LightOn <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> LightOn(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LightOn</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123; <span class="keyword">super</span>(delayTime); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Put hardware control code here to</span></span><br><span class="line">            <span class="comment">// physically turn on the light.</span></span><br><span class="line">            light = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Light is on"</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LightOff</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">LightOff</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> LightOff <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> LightOff(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LightOff</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123; <span class="keyword">super</span>(delayTime); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Put hardware control code here to</span></span><br><span class="line">            <span class="comment">// physically turn off the light.</span></span><br><span class="line">            light = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Light is off"</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> water = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterOn</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">WaterOn</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> WaterOn <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> WaterOn(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WaterOn</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123; <span class="keyword">super</span>(delayTime); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Put hardware control code here.</span></span><br><span class="line">            water = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Greenhouse water is on"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WaterOff</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">WaterOff</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> WaterOff <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> WaterOff(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WaterOff</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123; <span class="keyword">super</span>(delayTime); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Put hardware control code here.</span></span><br><span class="line">            water = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Greenhouse water is off"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String thermostat = <span class="string">"Day"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThermostatNight</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">ThermostatNight</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> ThermostatNight <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> ThermostatNight(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThermostatNight</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delayTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Put hardware control code here.</span></span><br><span class="line">            thermostat = <span class="string">"Night"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Thermostat on night setting"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThermostatDay</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">ThermostatDay</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> ThermostatDay <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> ThermostatDay(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThermostatDay</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delayTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Put hardware control code here.</span></span><br><span class="line">            thermostat = <span class="string">"Day"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Thermostat on day setting"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// An example of an action() that inserts a</span></span><br><span class="line">    <span class="comment">// new one of itself into the event list:</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Bell</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">Bell</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Bell <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> Bell(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Bell</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123; <span class="keyword">super</span>(delayTime); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            con.addEvent(<span class="keyword">new</span> Bell(delayTime));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Bing!"</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Restart</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">BigEventFactory</span>&lt;<span class="title">Restart</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Restart <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime, Event[] eventList)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> Restart(delayTime, eventList);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> Event[] eventList;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Restart</span><span class="params">(<span class="keyword">long</span> delayTime, Event[] eventList)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delayTime);</span><br><span class="line">            <span class="keyword">this</span>.eventList = eventList;</span><br><span class="line">            <span class="keyword">for</span>(Event e : eventList)</span><br><span class="line">                con.addEvent(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(Event e : eventList) &#123;</span><br><span class="line">                e.start(); <span class="comment">// Rerun each event</span></span><br><span class="line">                con.addEvent(e);</span><br><span class="line">            &#125;</span><br><span class="line">            start(); <span class="comment">// Rerun this Event</span></span><br><span class="line">            con.addEvent(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Restarting system"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Terminate</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">Terminate</span>&gt;</span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Terminate <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> Terminate(delayTime);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Terminate</span><span class="params">(<span class="keyword">long</span> delayTime)</span> </span>&#123; <span class="keyword">super</span>(delayTime); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123; System.exit(<span class="number">0</span>); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Terminating"</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="EventFactory-java"><a href="#EventFactory-java" class="headerlink" title="EventFactory.java"></a>EventFactory.java</h5><p>工厂接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EventFactory</span>&lt;<span class="title">T</span>&gt;</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="BigEventFactory-java"><a href="#BigEventFactory-java" class="headerlink" title="BigEventFactory.java"></a>BigEventFactory.java</h5><p>工厂接口。因为Restart类的create()方法有两个参数，所以分化出一个工厂类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BigEventFactory</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime, Event[] eventList)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="SmallEventFactory-java"><a href="#SmallEventFactory-java" class="headerlink" title="SmallEventFactory.java"></a>SmallEventFactory.java</h5><p>工厂接口。正常Event的工厂接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SmallEventFactory</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">create</span><span class="params">(<span class="keyword">long</span> delayTime)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ControllerHelper-java"><a href="#ControllerHelper-java" class="headerlink" title="ControllerHelper.java"></a>ControllerHelper.java</h5><p>主要是Event的注册工厂。还有一个从外部文件读取EventList的loadEvents()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerHelper</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,SmallEventFactory&lt;? extends Event&gt;&gt; smallEventFactories=<span class="keyword">new</span> HashMap&lt;String,SmallEventFactory&lt;? extends Event&gt;&gt;();</span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,BigEventFactory&lt;? extends Event&gt;&gt; bigEventFactories=<span class="keyword">new</span> HashMap&lt;String,BigEventFactory&lt;? extends Event&gt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        smallEventFactories.put(<span class="string">"LightOn"</span>,<span class="keyword">new</span> GreenhouseControls.LightOn.Factory());</span><br><span class="line">        smallEventFactories.put(<span class="string">"LightOff"</span>,<span class="keyword">new</span> GreenhouseControls.LightOff.Factory());</span><br><span class="line">        smallEventFactories.put(<span class="string">"WaterOn"</span>,<span class="keyword">new</span> GreenhouseControls.WaterOn.Factory());</span><br><span class="line">        smallEventFactories.put(<span class="string">"WaterOff"</span>,<span class="keyword">new</span> GreenhouseControls.WaterOff.Factory());</span><br><span class="line">        smallEventFactories.put(<span class="string">"ThermostatNight"</span>,<span class="keyword">new</span> GreenhouseControls.ThermostatNight.Factory());</span><br><span class="line">        smallEventFactories.put(<span class="string">"ThermostatDay"</span>,<span class="keyword">new</span> GreenhouseControls.ThermostatDay.Factory());</span><br><span class="line">        smallEventFactories.put(<span class="string">"Bell"</span>,<span class="keyword">new</span> GreenhouseControls.Bell.Factory());</span><br><span class="line">        bigEventFactories.put(<span class="string">"Restart"</span>,<span class="keyword">new</span> GreenhouseControls.Restart.Factory());</span><br><span class="line">        smallEventFactories.put(<span class="string">"Terminate"</span>,<span class="keyword">new</span> GreenhouseControls.Terminate.Factory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Event[] loadEvents(String path)&#123;</span><br><span class="line">        File file=<span class="keyword">new</span> File(path);</span><br><span class="line">        List&lt;Event&gt; list=<span class="keyword">new</span> ArrayList&lt;Event&gt;();</span><br><span class="line">        BufferedReader bf=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            bf=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">            String line=<span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span>((line=bf.readLine())!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                String[] param=line.split(<span class="string">"\\t"</span>);</span><br><span class="line">                <span class="keyword">if</span>(param.length!=<span class="number">2</span>)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Args Error:  "</span>+line);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    System.out.println(param[<span class="number">0</span>]+<span class="string">","</span>+param[<span class="number">1</span>]);</span><br><span class="line">                    list.add(smallEventFactories.get(param[<span class="number">0</span>]).create(Integer.parseInt(param[<span class="number">1</span>])));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(FileNotFoundException e)&#123;</span><br><span class="line">            System.out.println(file.getName()+<span class="string">" not found!"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"have problem when reading lines... ..."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(bf!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    bf.close();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"File can not be close!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(list);</span><br><span class="line">        <span class="keyword">return</span> list.toArray(<span class="keyword">new</span> Event[list.size()]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise11-java"><a href="#Exercise11-java" class="headerlink" title="Exercise11.java"></a>Exercise11.java</h5><p>最后的测试类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise11</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        GreenhouseControls c=<span class="keyword">new</span> GreenhouseControls();</span><br><span class="line">        Controller controller=c.getController();</span><br><span class="line">        controller.addEvent((Event)(ControllerHelper.smallEventFactories.get(<span class="string">"Bell"</span>).create(<span class="number">900</span>)));</span><br><span class="line">        Event[] eventList = ControllerHelper.loadEvents(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Event.txt"</span>);</span><br><span class="line">        controller.addEvent((Event)(ControllerHelper.bigEventFactories.get(<span class="string">"Restart"</span>).create(<span class="number">2000</span>,eventList)));</span><br><span class="line">        controller.addEvent((Event)(ControllerHelper.smallEventFactories.get(<span class="string">"Terminate"</span>).create(<span class="number">1000</span>)));</span><br><span class="line">        controller.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-12"><a href="#Exercise-12" class="headerlink" title="Exercise 12"></a>Exercise 12</h4><ul>
<li><strong>Exercise 12</strong>: (3) Modify Exercise 8 to also open a text file so you can write text into it. Write the lines in the LinkedList, along with line numbers (do not attempt to use the “LineNumber” classes), out to the file.</li>
</ul>
<h5 id="Exercise12-java"><a href="#Exercise12-java" class="headerlink" title="Exercise12.java"></a>Exercise12.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise12</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(File inFile, File outFile)</span></span>&#123;</span><br><span class="line">        BufferedReader in=<span class="keyword">null</span>;</span><br><span class="line">        PrintWriter out=<span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//input</span></span><br><span class="line">            in=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(inFile));</span><br><span class="line">            <span class="comment">//output</span></span><br><span class="line">            <span class="keyword">if</span>(!outFile.exists())&#123;</span><br><span class="line">                outFile.createNewFile();</span><br><span class="line">            &#125;</span><br><span class="line">            out=<span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(outFile)));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span>((line=in.readLine())!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                out.println(<span class="string">"Line "</span>+ ++count +<span class="string">":\t"</span>+line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Check your inFile and outFile!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                in.close();</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Files cannot be closed correctly!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(args.length!=<span class="number">2</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Check your arguments!"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            copyFile(<span class="keyword">new</span> File(args[<span class="number">0</span>]), <span class="keyword">new</span> File(args[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-13"><a href="#Exercise-13" class="headerlink" title="Exercise 13"></a>Exercise 13</h4><ul>
<li><strong>Exercise 13</strong>: (3) Modify BasicFileOutput.java so that it uses LineNumberReader to keep track of the line count. Note that it’s much easier to just keep track programmatically.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise13</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> String file = <span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BasicFileOutput.txt"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        LineNumberReader in = <span class="keyword">new</span> LineNumberReader(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise13.java"</span>)));</span><br><span class="line">        PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(file)));</span><br><span class="line">        <span class="keyword">int</span> lineCount = <span class="number">1</span>;</span><br><span class="line">        String s;</span><br><span class="line">        <span class="keyword">while</span>((s = in.readLine()) != <span class="keyword">null</span> )&#123;</span><br><span class="line">            out.println(in.getLineNumber() + <span class="string">": "</span> + s);</span><br><span class="line">        &#125;</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-14"><a href="#Exercise-14" class="headerlink" title="Exercise 14"></a>Exercise 14</h4><ul>
<li><strong>Exercise 14</strong>: (2) Starting with BasicFileOutput.java, write a program that compares the performance of writing to a file when using buffered and unbuffered I/O.</li>
</ul>
<p>实验结果显示加了BufferedWriter装饰器之后比原先FileWriter效率高了20-25%。</p>
<p>需要当心，不要把最初两次测试结果统计进最后结果。因为最初的两轮耗时明显地长，尤其是第一次跑，是明显的离群点。这会导致先跑的Writer吃亏。</p>
<h5 id="Exercise14-java"><a href="#Exercise14-java" class="headerlink" title="Exercise14.java"></a>Exercise14.java</h5><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line">public class <span class="type">Exercise14</span> &#123;</span><br><span class="line">    private <span class="keyword">static</span> <span class="type">String</span> inFile = <span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BufferedInputFile.java"</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> long test(<span class="type">Writer</span> <span class="keyword">out</span>) throws <span class="type">IOException</span>&#123;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="keyword">in</span> = new <span class="type">BufferedReader</span>(new <span class="type">FileReader</span>(new <span class="type">File</span>(inFile)));</span><br><span class="line">        <span class="type">int</span> lineCount = <span class="number">1</span>;</span><br><span class="line">        <span class="type">String</span> s;</span><br><span class="line">        long begin;</span><br><span class="line">        long <span class="keyword">end</span>;</span><br><span class="line">        long <span class="literal">result</span>=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((s = <span class="keyword">in</span>.readLine()) != null )&#123;</span><br><span class="line">            begin=<span class="type">System</span>.nanoTime();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10000</span>;i++)&#123;</span><br><span class="line">                <span class="keyword">out</span>.write(lineCount++ + <span class="string">": "</span> + s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">result</span>+=(<span class="type">System</span>.nanoTime()-begin);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">out</span>.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="type">void</span> main(<span class="type">String</span>[] args) throws <span class="type">IOException</span> &#123;</span><br><span class="line">        long timeBuffer=<span class="number">0</span>;</span><br><span class="line">        long timeNot=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">            <span class="type">FileWriter</span> fileOut=new <span class="type">FileWriter</span>(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BufferedInputFile.txt"</span>);</span><br><span class="line">            <span class="type">BufferedWriter</span> bufferedOut = new <span class="type">BufferedWriter</span>(new <span class="type">FileWriter</span>(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BufferedInputFile2.txt"</span>));</span><br><span class="line">            <span class="keyword">if</span>(i&gt;=<span class="number">5</span>)&#123;</span><br><span class="line">                timeBuffer+=test(bufferedOut);</span><br><span class="line">                timeNot+=test(fileOut);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">System</span>.<span class="keyword">out</span>.println(<span class="string">"Buf:    "</span>+timeBuffer/<span class="number">15</span>);</span><br><span class="line">        <span class="type">System</span>.<span class="keyword">out</span>.println(<span class="string">"Not:    "</span>+timeNot/<span class="number">15</span>);</span><br><span class="line">        <span class="type">System</span>.<span class="keyword">out</span>.println((double)timeBuffer/timeNot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Buf:    <span class="number">27568796</span></span><br><span class="line">Not:    <span class="number">37021046</span></span><br><span class="line"><span class="number">0.7446790010523365</span></span><br></pre></td></tr></table></figure>
<h4 id="Exercise-15"><a href="#Exercise-15" class="headerlink" title="Exercise 15"></a>Exercise 15</h4><ul>
<li><strong>Exercise 15</strong>: (4) Look up DataOutputStream and DataInputStream in the JDK documentation. Starting with StoringAndRecoveringData.java, create a program that stores and then retrieves all the different possible types provided by the DataOutputStream and DataInputStream classes. Verify that the values are stored and retrieved accurately.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise15</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String file)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        DataOutputStream out = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(file)));</span><br><span class="line">        out.writeBoolean(<span class="keyword">true</span>);</span><br><span class="line">        out.writeByte(<span class="number">56</span>);</span><br><span class="line">        out.writeChar(<span class="string">'a'</span>);</span><br><span class="line">        out.writeInt(<span class="number">56</span>);</span><br><span class="line">        out.writeLong(<span class="number">56l</span>);</span><br><span class="line">        out.writeShort(<span class="number">56</span>);</span><br><span class="line">        out.writeFloat(<span class="number">56f</span>);</span><br><span class="line">        out.writeDouble(<span class="number">3.14159</span>);</span><br><span class="line">        out.writeUTF(<span class="string">"That was pi"</span>);</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(String file)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        DataInputStream in = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)));</span><br><span class="line">        <span class="keyword">boolean</span> b=in.readBoolean();</span><br><span class="line">        <span class="keyword">byte</span> bt=in.readByte();</span><br><span class="line">        <span class="keyword">char</span> c=in.readChar();</span><br><span class="line">        <span class="keyword">int</span> i=in.readInt();</span><br><span class="line">        <span class="keyword">long</span> l=in.readLong();</span><br><span class="line">        <span class="keyword">short</span> s=in.readShort();</span><br><span class="line">        <span class="keyword">float</span> f=in.readFloat();</span><br><span class="line">        <span class="keyword">double</span> d=in.readDouble();</span><br><span class="line">        String str=in.readUTF();</span><br><span class="line">        in.close();</span><br><span class="line">        System.out.println(<span class="string">"["</span>+b+<span class="string">"],"</span>+<span class="string">"["</span>+bt+<span class="string">"],"</span>+<span class="string">"["</span>+c+<span class="string">"],"</span>+<span class="string">"["</span>+i+<span class="string">"],"</span>+<span class="string">"["</span>+l+<span class="string">"],"</span>+<span class="string">"["</span>+s+<span class="string">"],"</span>+<span class="string">"["</span>+f+<span class="string">"],"</span>+<span class="string">"["</span>+d+<span class="string">"],"</span>+<span class="string">"["</span>+str+<span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        String file=<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Data.txt"</span>;</span><br><span class="line">        write(file);</span><br><span class="line">        read(file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-16"><a href="#Exercise-16" class="headerlink" title="Exercise 16"></a>Exercise 16</h4><ul>
<li><strong>Exercise 16</strong>: (2) Look up RandomAccessFile in the JDK documentation. Starting with UsingRandomAccessFile.java, create a program that stores and then retrieves all the different possible types provided by the RandomAccessFile class. Verify that the values are stored and retrieved accurately.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise16</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> String file = <span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Data2.txt"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">display</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        RandomAccessFile in = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">"r"</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Value "</span> + i + <span class="string">": "</span> + in.readDouble());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(in.readUTF());</span><br><span class="line">        <span class="keyword">boolean</span> b=in.readBoolean();</span><br><span class="line">        <span class="keyword">byte</span> bt=in.readByte();</span><br><span class="line">        <span class="keyword">char</span> c=in.readChar();</span><br><span class="line">        <span class="keyword">int</span> i=in.readInt();</span><br><span class="line">        <span class="keyword">long</span> l=in.readLong();</span><br><span class="line">        <span class="keyword">short</span> s=in.readShort();</span><br><span class="line">        <span class="keyword">float</span> f=in.readFloat();</span><br><span class="line">        <span class="keyword">double</span> d=in.readDouble();</span><br><span class="line">        String str=in.readUTF();</span><br><span class="line">        in.close();</span><br><span class="line">        System.out.println(<span class="string">"["</span>+b+<span class="string">"],"</span>+<span class="string">"["</span>+bt+<span class="string">"],"</span>+<span class="string">"["</span>+c+<span class="string">"],"</span>+<span class="string">"["</span>+i+<span class="string">"],"</span>+<span class="string">"["</span>+l+<span class="string">"],"</span>+<span class="string">"["</span>+s+<span class="string">"],"</span>+<span class="string">"["</span>+f+<span class="string">"],"</span>+<span class="string">"["</span>+d+<span class="string">"],"</span>+<span class="string">"["</span>+str+<span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        RandomAccessFile out = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">"rw"</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)&#123;</span><br><span class="line">            out.writeDouble(i*<span class="number">1.414</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        out.writeUTF(<span class="string">"The end of the file"</span>);</span><br><span class="line">        out.writeBoolean(<span class="keyword">true</span>);</span><br><span class="line">        out.writeByte(<span class="number">56</span>);</span><br><span class="line">        out.writeChar(<span class="string">'a'</span>);</span><br><span class="line">        out.writeInt(<span class="number">56</span>);</span><br><span class="line">        out.writeLong(<span class="number">56l</span>);</span><br><span class="line">        out.writeShort(<span class="number">56</span>);</span><br><span class="line">        out.writeFloat(<span class="number">56f</span>);</span><br><span class="line">        out.writeDouble(<span class="number">3.14159</span>);</span><br><span class="line">        out.writeUTF(<span class="string">"That was pi"</span>);</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        write();</span><br><span class="line">        display();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-17"><a href="#Exercise-17" class="headerlink" title="Exercise 17"></a>Exercise 17</h4><ul>
<li><strong>Exercise 17</strong>: (4) Using TextFile and a Map<character,integer>, create a program that counts the occurrence of all the different characters in a file. (So if there are 12 occurrences of the letter ‘a’ in the file, the Integer associated with the Character containing ‘a’ in the Map contains ‘12’).</character,integer></li>
</ul>
<h5 id="TextFile-java"><a href="#TextFile-java" class="headerlink" title="TextFile.java"></a>TextFile.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@SuppressWarnings</span>(<span class="string">"serial"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextFile</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 读文件，返回String</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">read</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedReader in= <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(fileName).getAbsoluteFile()));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String s;</span><br><span class="line">                <span class="keyword">while</span>((s = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    sb.append(s);</span><br><span class="line">                    sb.append(<span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接写String进文件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String fileName, String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> File(fileName).getAbsoluteFile());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                out.print(text);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器。 切割成String的ArrayList。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TextFile</span><span class="params">(String fileName, String splitter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Arrays.asList(read(fileName).split(splitter)));</span><br><span class="line">        <span class="keyword">if</span>(get(<span class="number">0</span>).equals(<span class="string">""</span>))&#123;remove(<span class="number">0</span>);&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器。按行切割。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TextFile</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(fileName, <span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> File(fileName).getAbsoluteFile());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span>(String item : <span class="keyword">this</span>)&#123;</span><br><span class="line">                    out.println(item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String file = read(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span>);</span><br><span class="line">        write(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span>, file);</span><br><span class="line">        TextFile text = <span class="keyword">new</span> TextFile(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span>);</span><br><span class="line">        text.write(<span class="string">"test2.txt"</span>);</span><br><span class="line">        <span class="comment">// Break into unique sorted list of words:</span></span><br><span class="line">        TreeSet&lt;String&gt; words = <span class="keyword">new</span> TreeSet&lt;String&gt;(<span class="keyword">new</span> TextFile(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span>, <span class="string">"\\W+"</span>));</span><br><span class="line">        <span class="comment">// Display the capitalized words:</span></span><br><span class="line">        System.out.println(words.headSet(<span class="string">"a"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise17-java"><a href="#Exercise17-java" class="headerlink" title="Exercise17.java"></a>Exercise17.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise17</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        TextFile tf=<span class="keyword">new</span> TextFile(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span>,<span class="string">""</span>);</span><br><span class="line">        Map&lt;Character, Integer&gt; map=<span class="keyword">new</span> HashMap&lt;Character,Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String s:tf)&#123;</span><br><span class="line">            Character c=s.charAt(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(c))&#123;</span><br><span class="line">                map.put(c,map.get(c)+<span class="number">1</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                map.put(c,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-18"><a href="#Exercise-18" class="headerlink" title="Exercise 18"></a>Exercise 18</h4><ul>
<li><strong>Exercise 18</strong>: (1) Modify TextFile.java so that it passes IOExceptions out to the caller.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@SuppressWarnings</span>(<span class="string">"serial"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise18</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 读文件，返回String</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">read</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        BufferedReader in= <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(fileName).getAbsoluteFile()));</span><br><span class="line">        String s;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>((s = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(s);</span><br><span class="line">                sb.append(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            in.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接写String进文件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String fileName, String text)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> File(fileName).getAbsoluteFile());</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            out.print(text);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器。 切割成String的ArrayList。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise18</span><span class="params">(String fileName, String splitter)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Arrays.asList(read(fileName).split(splitter)));</span><br><span class="line">        <span class="keyword">if</span>(get(<span class="number">0</span>).equals(<span class="string">""</span>))&#123;remove(<span class="number">0</span>);&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器。按行切割。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise18</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(fileName, <span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String fileName)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> File(fileName).getAbsoluteFile());</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(String item : <span class="keyword">this</span>)&#123;</span><br><span class="line">                out.println(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        String file = read(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span>);</span><br><span class="line">        write(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span>, file);</span><br><span class="line">        Exercise18 text = <span class="keyword">new</span> Exercise18(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span>);</span><br><span class="line">        text.write(<span class="string">"test2.txt"</span>);</span><br><span class="line">        <span class="comment">// Break into unique sorted list of words:</span></span><br><span class="line">        TreeSet&lt;String&gt; words = <span class="keyword">new</span> TreeSet&lt;String&gt;(<span class="keyword">new</span> TextFile(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span>, <span class="string">"\\W+"</span>));</span><br><span class="line">        <span class="comment">// Display the capitalized words:</span></span><br><span class="line">        System.out.println(words.headSet(<span class="string">"a"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-19"><a href="#Exercise-19" class="headerlink" title="Exercise 19"></a>Exercise 19</h4><ul>
<li><strong>Exercise 19</strong>: (2) Using BinaryFile and a Map<byte,integer>, create a program that counts the occurrence of all the different bytes in a file.</byte,integer></li>
</ul>
<h5 id="BinaryFile-java"><a href="#BinaryFile-java" class="headerlink" title="BinaryFile.java"></a>BinaryFile.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryFile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] read(File bFile) <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        BufferedInputStream bf = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(bFile));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[bf.available()];</span><br><span class="line">            bf.read(data);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bf.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] read(String bFile) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> read(<span class="keyword">new</span> File(bFile).getAbsoluteFile());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise19-java"><a href="#Exercise19-java" class="headerlink" title="Exercise19.java"></a>Exercise19.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise19</span>  </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes=BinaryFile.read(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BinaryFile.java"</span>);</span><br><span class="line">        Map&lt;Byte,Integer&gt; map=<span class="keyword">new</span> HashMap&lt;Byte,Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;bytes.length;i++)&#123;</span><br><span class="line">            <span class="keyword">byte</span> b=bytes[i];</span><br><span class="line">            <span class="keyword">if</span>(map.containsKey(b))&#123;</span><br><span class="line">                map.put(b,map.get(b)+<span class="number">1</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                map.put(b,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-20"><a href="#Exercise-20" class="headerlink" title="Exercise 20"></a>Exercise 20</h4><ul>
<li><strong>Exercise 20</strong>: (4) Using Directory.walk( ) and BinaryFile, verify that all .class files in a directory tree begin with the hex characters ‘CAFEBABE’.</li>
</ul>
<h5 id="Directory-java-1"><a href="#Directory-java-1" class="headerlink" title="Directory.java"></a>Directory.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Directory</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; files=<span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;File&gt; dirs=<span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> lines=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">()</span></span>&#123;<span class="keyword">this</span>(<span class="string">"."</span>);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(String dir)</span></span>&#123;<span class="keyword">this</span>(<span class="keyword">new</span> File(dir));&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(File dir)</span></span>&#123;<span class="keyword">this</span>(dir,<span class="string">".*"</span>);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(String dir, String regex)</span></span>&#123;<span class="keyword">this</span>(<span class="keyword">new</span> File(dir),regex);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(File dir,String regex)</span></span>&#123;</span><br><span class="line">        recurseDirs(dir,<span class="keyword">new</span> FilenameFilter()&#123;</span><br><span class="line">            <span class="keyword">private</span> Pattern p=Pattern.compile(regex);</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir,String name)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> p.matcher(name).matches();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        statistic();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Directory</span><span class="params">(File dir,FilenameFilter filter)</span></span>&#123;</span><br><span class="line">        recurseDirs(dir,filter);</span><br><span class="line">        statistic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//递归收集文件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recurseDirs</span><span class="params">(File dir, FilenameFilter filter)</span></span>&#123;</span><br><span class="line">        File[] children=dir.listFiles();</span><br><span class="line">        <span class="keyword">if</span>(children==<span class="keyword">null</span> || children.length==<span class="number">0</span>)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="keyword">for</span>(File f:children)&#123;</span><br><span class="line">            <span class="keyword">if</span>(f.isDirectory())&#123;</span><br><span class="line">                dirs.add(f);</span><br><span class="line">                recurseDirs(f,filter);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(filter.accept(dir,f.getName()))&#123;</span><br><span class="line">                    files.add(f);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">statistic</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(files!=<span class="keyword">null</span> &amp;&amp; files.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            size=files.size();</span><br><span class="line">            <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(File file:files)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    BufferedReader bf=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(file));</span><br><span class="line">                    <span class="keyword">while</span>(bf.readLine()!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                        num++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    System.out.println(file.getName()+<span class="string">" can not open!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            lines=num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">getFile</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> files;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">getDir</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> dirs;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showStatistic</span><span class="params">()</span></span>&#123;System.out.println(<span class="string">"File number:    "</span>+size+<span class="string">"\n"</span>+<span class="string">"Total Lines:   "</span>+lines+<span class="string">"\n"</span>);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="BinaryFile-java-1"><a href="#BinaryFile-java-1" class="headerlink" title="BinaryFile.java"></a>BinaryFile.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryFile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] read(File bFile) <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        BufferedInputStream bf = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(bFile));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[bf.available()];</span><br><span class="line">            bf.read(data);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bf.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] read(String bFile) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> read(<span class="keyword">new</span> File(bFile).getAbsoluteFile());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise20-java"><a href="#Exercise20-java" class="headerlink" title="Exercise20.java"></a>Exercise20.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise20</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        Directory dir=<span class="keyword">new</span> Directory(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18"</span>);</span><br><span class="line">        List&lt;File&gt; files=dir.getFile();</span><br><span class="line">        <span class="keyword">if</span>(!files.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">for</span>(File file:files)&#123;</span><br><span class="line">                <span class="keyword">if</span>(file.getName().endsWith(<span class="string">".class"</span>))&#123;</span><br><span class="line">                    <span class="keyword">byte</span>[] bytes=BinaryFile.read(file);</span><br><span class="line">                    String one=Integer.toHexString(((Byte)bytes[<span class="number">0</span>]).intValue());</span><br><span class="line">                    String two=Integer.toHexString(((Byte)bytes[<span class="number">1</span>]).intValue());</span><br><span class="line">                    String three=Integer.toHexString(((Byte)bytes[<span class="number">2</span>]).intValue());</span><br><span class="line">                    String four=Integer.toHexString(((Byte)bytes[<span class="number">3</span>]).intValue());</span><br><span class="line">                    System.out.println(one+two+three+four);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-21"><a href="#Exercise-21" class="headerlink" title="Exercise 21"></a>Exercise 21</h4><ul>
<li><strong>Exercise 21</strong>: (1) Write a program that takes standard input and capitalizes all characters, then puts the results on standard output. Redirect the contents of a file into this program (the process of redirection will vary depending on your operating system).</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise21</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        PrintStream console=System.out;</span><br><span class="line">        BufferedReader br=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">        PrintStream ps=<span class="keyword">new</span> PrintStream(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise21.txt"</span>)));</span><br><span class="line">        System.setOut(ps);</span><br><span class="line">        String s;</span><br><span class="line">        <span class="keyword">while</span>((s=br.readLine())!=<span class="keyword">null</span> &amp;&amp; s.length()!=<span class="number">0</span>)&#123;</span><br><span class="line">            s=s.toUpperCase();</span><br><span class="line">            System.out.println(s.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        ps.close();</span><br><span class="line">        System.setOut(console);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-22"><a href="#Exercise-22" class="headerlink" title="Exercise 22"></a>Exercise 22</h4><ul>
<li><strong>Exercise 22</strong>: (5) Modify OSExecute.java so that, instead of printing the standard output stream, it returns the results of executing the program as a List of Strings. Demonstrate the use of this new version of the utility.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise22</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">command</span><span class="params">(String command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> err = <span class="keyword">false</span>;</span><br><span class="line">        List&lt;String&gt; list=<span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process process = <span class="keyword">new</span> ProcessBuilder(command.split(<span class="string">" "</span>)).start();</span><br><span class="line">            BufferedReader results = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">            String s;</span><br><span class="line">            <span class="keyword">while</span>((s = results.readLine())!= <span class="keyword">null</span>)&#123;</span><br><span class="line">                list.add(s);</span><br><span class="line">            &#125;</span><br><span class="line">            BufferedReader errors = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getErrorStream()));</span><br><span class="line">            <span class="comment">// Report errors and return nonzero value</span></span><br><span class="line">            <span class="comment">// to calling process if there are problems:</span></span><br><span class="line">            <span class="keyword">while</span>((s = errors.readLine())!= <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.err.println(s);</span><br><span class="line">                err = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            <span class="comment">// Compensate for Windows 2000, which throws an</span></span><br><span class="line">            <span class="comment">// exception for the default command line:</span></span><br><span class="line">            <span class="keyword">if</span>(!command.startsWith(<span class="string">"CMD /C"</span>))&#123;</span><br><span class="line">                command(<span class="string">"CMD /C "</span> + command);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OSExecuteException(<span class="string">"Errors executing "</span> + command);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        List&lt;String&gt; reverse=Exercise22.command(<span class="string">"javap com.ciaoshen.thinkinjava.chapter18.OSExecute"</span>);</span><br><span class="line">        System.out.println(reverse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-23"><a href="#Exercise-23" class="headerlink" title="Exercise 23"></a>Exercise 23</h4><ul>
<li><strong>Exercise 23</strong>: (6) Create and test a utility method to print the contents of a CharBuffer up to the point where the characters are no longer printable.</li>
</ul>
<p>这题有个坑：<br>asCharBuffer()方法，默认以UTF-16BE来解码byteBuffer里的字节。每个字符2字节。而String # getBytes()使用我系统默认编码方式：而我系统的默认编码方式是：UTF-8。英语字母一个字节。</p>
<ul>
<li>解决方法一：要么在byte解码到char的时候，找到系统默认的编码标准。</li>
<li>解决方法二：要么在getBytes编码的时候就用asCharSet默认的UTF-16BE标准：getBytes(“UTF-16BE”)。</li>
<li>解决方法三：要么在写入文件的时候直接用CharSet的视图往里写入，就会直接用UTF-16BE的编码标准。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise23</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BSIZE=<span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> File f;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise23</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> File(s));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise23</span><span class="params">(File f)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f=f;</span><br><span class="line">        <span class="keyword">if</span>(!f.exists())&#123;</span><br><span class="line">            f.createNewFile();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        FileChannel fc=<span class="keyword">new</span> FileOutputStream(f).getChannel();</span><br><span class="line">        <span class="comment">//method 1 to create and fill a ByteBuffer</span></span><br><span class="line">        ByteBuffer bf1=ByteBuffer.wrap(s.substring(<span class="number">0</span>,s.length()/<span class="number">2</span>).getBytes());</span><br><span class="line">        <span class="comment">//method 2 to create and fill a ByteBuffer</span></span><br><span class="line">        ByteBuffer bf2=ByteBuffer.allocate(BSIZE);</span><br><span class="line">        bf2.put(s.substring(s.length()/<span class="number">2</span>).getBytes());</span><br><span class="line">        bf2.flip(); <span class="comment">//Important!!</span></span><br><span class="line">        fc.write(bf1);</span><br><span class="line">        fc.write(bf2);</span><br><span class="line">        fc.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] read() <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        FileChannel fc=<span class="keyword">new</span> FileInputStream(f).getChannel();</span><br><span class="line">        ByteBuffer bf=ByteBuffer.allocate(BSIZE);</span><br><span class="line">        fc.read(bf);</span><br><span class="line">        bf.flip();</span><br><span class="line">        <span class="keyword">byte</span>[] ba=<span class="keyword">new</span> <span class="keyword">byte</span>[bf.limit()];</span><br><span class="line">        <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(bf.hasRemaining())&#123;</span><br><span class="line">            ba[index]=bf.get();</span><br><span class="line">            index++;</span><br><span class="line">        &#125;</span><br><span class="line">        fc.close();</span><br><span class="line">        <span class="keyword">return</span> ba;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//输出乱码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">char</span>[] badReadAsChars() <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        FileChannel fc=<span class="keyword">new</span> FileInputStream(f).getChannel();</span><br><span class="line">        ByteBuffer bf=ByteBuffer.allocate(BSIZE);</span><br><span class="line">        fc.read(bf);</span><br><span class="line">        bf.flip();</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         *  坑在这儿：</span><br><span class="line">         *  asCharBuffer()方法，默认以UTF-16BE来解码byteBuffer里的字节。每个字符2字节。</span><br><span class="line">         *  而String # getBytes()使用我系统默认编码方式：</span><br><span class="line">         *      而我系统的默认编码方式是：UTF-8。英语字母一个字节。</span><br><span class="line">         */</span></span><br><span class="line">        CharBuffer cf=bf.asCharBuffer();</span><br><span class="line">        <span class="keyword">char</span>[] ca=<span class="keyword">new</span> <span class="keyword">char</span>[cf.limit()];</span><br><span class="line">        <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(cf.hasRemaining())&#123;</span><br><span class="line">            ca[index]=cf.get();</span><br><span class="line">            index++;</span><br><span class="line">        &#125;</span><br><span class="line">        fc.close();</span><br><span class="line">        <span class="keyword">return</span> ca;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这种解决方案比较好。因为从头到尾使用系统默认的编码标准，系统打开本地写入的文件的时候，不会显示乱码。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">char</span>[] readAsChars() <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        FileChannel fc=<span class="keyword">new</span> FileInputStream(f).getChannel();</span><br><span class="line">        ByteBuffer bf=ByteBuffer.allocate(BSIZE);</span><br><span class="line">        fc.read(bf);</span><br><span class="line">        bf.flip();</span><br><span class="line">        <span class="comment">//解决方法一</span></span><br><span class="line">        <span class="comment">//要么在byte解码到char的时候，找到系统默认的编码标准。</span></span><br><span class="line">        CharBuffer cf=Charset.forName(System.getProperty(<span class="string">"file.encoding"</span>)).decode(bf);</span><br><span class="line">        <span class="keyword">char</span>[] ca=<span class="keyword">new</span> <span class="keyword">char</span>[cf.limit()];</span><br><span class="line">        <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(cf.hasRemaining())&#123;</span><br><span class="line">            ca[index]=cf.get();</span><br><span class="line">            index++;</span><br><span class="line">        &#125;</span><br><span class="line">        fc.close();</span><br><span class="line">        <span class="keyword">return</span> ca;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="comment">//系统默认编码是UTF-8</span></span><br><span class="line">        System.out.println(System.getProperty(<span class="string">"file.encoding"</span>));</span><br><span class="line"></span><br><span class="line">        Exercise23 gc=<span class="keyword">new</span> Exercise23(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise23.txt"</span>);</span><br><span class="line"></span><br><span class="line">        gc.write(<span class="string">"Hello World!"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] ba=gc.read();</span><br><span class="line">        System.out.println(<span class="string">"Bytes   &gt;&gt;&gt; "</span>+Arrays.toString(ba));</span><br><span class="line">        System.out.println(<span class="string">"String  &gt;&gt;&gt; "</span>+<span class="keyword">new</span> String(ba));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>[] ca=gc.readAsChars();</span><br><span class="line">        System.out.println(<span class="string">"Chars   &gt;&gt;&gt; "</span>+Arrays.toString(ca));</span><br><span class="line">        System.out.println(<span class="string">"String  &gt;&gt;&gt; "</span>+<span class="keyword">new</span> String(ca));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-24"><a href="#Exercise-24" class="headerlink" title="Exercise 24"></a>Exercise 24</h4><ul>
<li><strong>Exercise 24</strong>: (1) Modify IntBufferDemo.java to use doubles.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise24</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BSIZE = <span class="number">1024</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ByteBuffer bb = ByteBuffer.allocate(BSIZE);</span><br><span class="line">        DoubleBuffer db = bb.asDoubleBuffer();</span><br><span class="line">        db.put(<span class="keyword">new</span> <span class="keyword">double</span>[]&#123; <span class="number">11.1</span>, <span class="number">42.2</span>, <span class="number">47.3</span>, <span class="number">99.4</span>, <span class="number">143.5</span>, <span class="number">811.6</span>, <span class="number">1016.7</span> &#125;);</span><br><span class="line">        System.out.println(db.get(<span class="number">3</span>));</span><br><span class="line">        db.put(<span class="keyword">new</span> <span class="keyword">double</span>[] &#123;<span class="number">3.8</span>, <span class="number">1811.9</span>&#125;);</span><br><span class="line">        db.flip();</span><br><span class="line">        <span class="keyword">while</span>(db.hasRemaining()) &#123;</span><br><span class="line">            <span class="keyword">double</span> d = db.get();</span><br><span class="line">            System.out.println(d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-25"><a href="#Exercise-25" class="headerlink" title="Exercise 25"></a>Exercise 25</h4><ul>
<li><strong>Exercise 25</strong>: (6) Experiment with changing the ByteBuffer.allocate( ) statements in the examples in this chapter to ByteBuffer.allocateDirect( ). Demonstrate performance differences, but also notice whether the startup time of the programs noticeably changes.</li>
</ul>
<p>确实如书中所说，ByteBuffer.allocateDirect()可以提高后面的读写效率，但allocateDirect()本身启动时间比allocate()慢。</p>
<h5 id="Exercise25-java"><a href="#Exercise25-java" class="headerlink" title="Exercise25.java"></a>Exercise25.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise25</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BSIZE = <span class="number">1048576</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Tester</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Tester</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">this</span>.name = name; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.print(name + <span class="string">": "</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">                <span class="keyword">long</span> mid=test();</span><br><span class="line">                <span class="keyword">long</span> end=System.nanoTime();</span><br><span class="line">                <span class="keyword">double</span> firstHalf = mid-start;</span><br><span class="line">                <span class="keyword">double</span> secondHalf = end - mid;</span><br><span class="line">                System.out.format(<span class="string">"%.2f %.2f\n"</span>, firstHalf/<span class="number">1.0e6</span>, secondHalf/<span class="number">1.0e6</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Tester[] tests=&#123;</span><br><span class="line">        <span class="keyword">new</span> Tester(<span class="string">"Allocate"</span>) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">                ByteBuffer bb = ByteBuffer.allocate(BSIZE);</span><br><span class="line">                <span class="keyword">long</span> mid=System.nanoTime();</span><br><span class="line">                DoubleBuffer db = bb.asDoubleBuffer();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;BSIZE/<span class="number">8</span>;i++)&#123;</span><br><span class="line">                    db.put((<span class="keyword">double</span>)i);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Tester(<span class="string">"AllocateDirect"</span>) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">                ByteBuffer bb = ByteBuffer.allocateDirect(BSIZE);</span><br><span class="line">                <span class="keyword">long</span> mid=System.nanoTime();</span><br><span class="line">                DoubleBuffer db = bb.asDoubleBuffer();</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;BSIZE/<span class="number">8</span>;i++)&#123;</span><br><span class="line">                    db.put((<span class="keyword">double</span>)i);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Tester test : tests)&#123;</span><br><span class="line">            test.runTest();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Allocate: <span class="number">0</span>,<span class="number">62</span> <span class="number">10</span>,<span class="number">53</span></span><br><span class="line">AllocateDirect: <span class="number">0</span>,<span class="number">96</span> <span class="number">4</span>,<span class="number">52</span></span><br></pre></td></tr></table></figure>
<h4 id="Exercise-26"><a href="#Exercise-26" class="headerlink" title="Exercise 26"></a>Exercise 26</h4><ul>
<li><strong>Exercise 26</strong>: (3) Modify strings/JGrep.java to use Java nio memorymapped files.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise26</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">jgrep</span><span class="params">(String regex, String path)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        Pattern p = Pattern.compile(regex);</span><br><span class="line">        <span class="comment">// Iterate through the lines of the input file:</span></span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        Matcher m = p.matcher(<span class="string">""</span>);</span><br><span class="line">        FileChannel fc=<span class="keyword">new</span> RandomAccessFile(path, <span class="string">"r"</span>).getChannel();</span><br><span class="line">        CharBuffer cb=Charset.forName(System.getProperty(<span class="string">"file.encoding"</span>)).decode(fc.map(FileChannel.MapMode.READ_ONLY, <span class="number">0</span>, fc.size()));</span><br><span class="line">        StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">        Character c;</span><br><span class="line">        <span class="keyword">while</span>(cb.hasRemaining())&#123;</span><br><span class="line">            c=cb.get();</span><br><span class="line">            sb.append(c);</span><br><span class="line">            <span class="keyword">if</span>(c.equals(<span class="string">'\n'</span>))&#123;</span><br><span class="line">                m.reset(sb.toString());</span><br><span class="line">                <span class="keyword">while</span>(m.find())&#123;</span><br><span class="line">                    System.out.println(index++ + <span class="string">": "</span> + m.group() + <span class="string">": "</span> + m.start());</span><br><span class="line">                &#125;</span><br><span class="line">                sb.delete(<span class="number">0</span>,sb.length());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fc.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        jgrep(<span class="string">"if"</span>,<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise26.java"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-27"><a href="#Exercise-27" class="headerlink" title="Exercise 27"></a>Exercise 27</h4><ul>
<li><strong>Exercise 27</strong>: (1) Create a Serializable class containing a reference to an object of a second Serializable class. Create an instance of your class, serialize it to disk, then restore it and verify that the process worked correctly.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise27</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rander=<span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pregnant</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> month;</span><br><span class="line">        <span class="keyword">private</span> Baby theBaby;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Pregnant</span><span class="params">(<span class="keyword">int</span> month)</span></span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.month=month;</span><br><span class="line">            theBaby=<span class="keyword">new</span> Baby(month);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Pregnant for "</span>+month+<span class="string">" month!   Baby weights "</span>+theBaby.getWeight()+<span class="string">" KG!"</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Baby</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> weight;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> sex;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Baby</span><span class="params">(<span class="keyword">int</span> month)</span></span>&#123;</span><br><span class="line">            weight=rander.nextFloat()*rander.nextInt(<span class="number">2</span>)+(<span class="keyword">float</span>)month;</span><br><span class="line">            sex=rander.nextInt(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getWeight</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> weight;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        Exercise27.Pregnant p=<span class="keyword">new</span> Pregnant(<span class="number">5</span>);</span><br><span class="line">        File f=<span class="keyword">new</span> File(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise27.txt"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!f.exists())&#123;</span><br><span class="line">            f.createNewFile();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        ObjectOutputStream out=<span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(p);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        ObjectInputStream in=<span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(f));</span><br><span class="line">        Pregnant p2=(Pregnant)in.readObject();</span><br><span class="line">        System.out.println(p2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-28"><a href="#Exercise-28" class="headerlink" title="Exercise 28"></a>Exercise 28</h4><ul>
<li><strong>Exercise 28</strong> : (2) In Blips.java, copy the file and rename it to BlipCheck.java and rename the class Blip2 to BlipCheck (making it public and removing the public scope from the class Blips in the process). Remove the //! marks in the file and execute the program, including the offending lines. Next, comment out the default constructor for BlipCheck. Run it and explain why it works. Note that after compiling, you must execute the program with “Java Blips” because the main( ) method is still in the class Blips.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise28</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BlipCheck</span> <span class="keyword">implements</span> <span class="title">Externalizable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="comment">//这里默认构造器会被外部调用，所以必须是public的。</span></span><br><span class="line">        <span class="comment">//注释掉之后系统会自动创建一个默认构造器，默认是public的。</span></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">        BlipCheck() &#123;</span><br><span class="line">            System.out.println("Blip2 Constructor");</span><br><span class="line">        &#125;</span><br><span class="line">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Blip2.writeExternal"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Blip2.readExternal"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Constructing objects:"</span>);</span><br><span class="line">        Exercise28.BlipCheck bc = <span class="keyword">new</span> Exercise28.BlipCheck();</span><br><span class="line">        ObjectOutputStream o = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise28.txt"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Saving objects:"</span>);</span><br><span class="line">        o.writeObject(bc);</span><br><span class="line">        o.close();</span><br><span class="line">        <span class="comment">// Now get them back:</span></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise28.txt"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Recovering BlipCheck:"</span>);</span><br><span class="line">        bc = (BlipCheck)in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-29"><a href="#Exercise-29" class="headerlink" title="Exercise 29"></a>Exercise 29</h4><ul>
<li><strong>Exercise 29</strong>: (2) In Blip3.java, comment out the two lines after the phrases “You must do this:” and run the program. Explain the result and why it differs from when the two lines are in the program.</li>
</ul>
<p>运行的结果会抛出OptionalDataException。异常的原因是实现Externalizable接口的可序列化类，在序列化和反序列化的时候，都只调用默认的构造器。而这里Blip3的默认构造器没有初始化s和i的值。而在writeExternal和readExternal方法里又没有把s和i补偿序列化。反序列化的结果不完整。s和i始终没有初始化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise29</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Blip3</span> <span class="keyword">implements</span> <span class="title">Externalizable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">private</span> String s; <span class="comment">// No initialization</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Blip3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Blip3 Constructor"</span>);</span><br><span class="line">            <span class="comment">// s, i not initialized</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Blip3</span><span class="params">(String x, <span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Blip3(String x, int a)"</span>);</span><br><span class="line">            s = x;</span><br><span class="line">            i = a;</span><br><span class="line">            <span class="comment">// s &amp; i initialized only in non-default constructor.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> s + i; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Blip3.writeExternal"</span>);</span><br><span class="line">            <span class="comment">// You must do this:</span></span><br><span class="line">            <span class="comment">//out.writeObject(s);</span></span><br><span class="line">            <span class="comment">//out.writeInt(i);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Blip3.readExternal"</span>);</span><br><span class="line">            <span class="comment">// You must do this:</span></span><br><span class="line">            s = (String)in.readObject();</span><br><span class="line">            i = in.readInt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Constructing objects:"</span>);</span><br><span class="line">        Exercise29.Blip3 b3 = <span class="keyword">new</span> Exercise29.Blip3(<span class="string">"A String "</span>, <span class="number">47</span>);</span><br><span class="line">        System.out.println(b3);</span><br><span class="line">        ObjectOutputStream o = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise29.txt"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Saving object:"</span>);</span><br><span class="line">        o.writeObject(b3);</span><br><span class="line">        o.close();</span><br><span class="line">        <span class="comment">// Now get it back:</span></span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise29.txt"</span>));</span><br><span class="line">        System.out.println(<span class="string">"Recovering b3:"</span>);</span><br><span class="line">        b3 = (Blip3)in.readObject();</span><br><span class="line">        <span class="comment">// System.out.println(b3);  //!!OptionalDataException</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-30"><a href="#Exercise-30" class="headerlink" title="Exercise 30"></a>Exercise 30</h4><ul>
<li><strong>Exercise 30</strong>: (1) Repair the program CADState.java as described in the text.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise30</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Shape</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RED = <span class="number">1</span>, BLUE = <span class="number">2</span>, GREEN = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> color=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> xPos, yPos, dimension;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setColor</span><span class="params">(<span class="keyword">int</span> newColor)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getColor</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Shape</span><span class="params">(<span class="keyword">int</span> xVal, <span class="keyword">int</span> yVal, <span class="keyword">int</span> dim)</span> </span>&#123;</span><br><span class="line">            xPos = xVal;</span><br><span class="line">            yPos = yVal;</span><br><span class="line">            dimension = dim;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getClass() +</span><br><span class="line">            <span class="string">"color["</span> + getColor() + <span class="string">"] xPos["</span> + xPos +</span><br><span class="line">            <span class="string">"] yPos["</span> + yPos + <span class="string">"] dim["</span> + dimension + <span class="string">"]\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Shape <span class="title">randomFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> xVal = rand.nextInt(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">int</span> yVal = rand.nextInt(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">int</span> dim = rand.nextInt(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">switch</span>(counter++ % <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> <span class="keyword">new</span> Circle(xVal, yVal, dim);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> <span class="keyword">new</span> Square(xVal, yVal, dim);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">return</span> <span class="keyword">new</span> Line(xVal, yVal, dim);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serializeStaticState</span><span class="params">(ObjectOutputStream os)</span> <span class="keyword">throws</span> IOException </span>&#123; os.writeInt(color); &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserializeStaticState</span><span class="params">(ObjectInputStream os)</span> <span class="keyword">throws</span> IOException </span>&#123; color = os.readInt(); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Circle</span><span class="params">(<span class="keyword">int</span> xVal, <span class="keyword">int</span> yVal, <span class="keyword">int</span> dim)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(xVal, yVal, dim);</span><br><span class="line">            color=RED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColor</span><span class="params">(<span class="keyword">int</span> newColor)</span> </span>&#123; color = newColor; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> color; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Square</span><span class="params">(<span class="keyword">int</span> xVal, <span class="keyword">int</span> yVal, <span class="keyword">int</span> dim)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(xVal, yVal, dim);</span><br><span class="line">            color = RED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColor</span><span class="params">(<span class="keyword">int</span> newColor)</span> </span>&#123; color = newColor; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> color; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Line</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Line</span><span class="params">(<span class="keyword">int</span> xVal, <span class="keyword">int</span> yVal, <span class="keyword">int</span> dim)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(xVal, yVal, dim);</span><br><span class="line">            color=RED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColor</span><span class="params">(<span class="keyword">int</span> newColor)</span> </span>&#123; color = newColor; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> color; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/CADState.txt"</span>));</span><br><span class="line">        <span class="comment">// Read in the same order they were written:</span></span><br><span class="line">        List&lt;Class&lt;? extends Exercise30.Shape&gt;&gt; shapeTypes = (List&lt;Class&lt;? extends Exercise30.Shape&gt;&gt;)in.readObject();</span><br><span class="line">        Exercise30.Line.deserializeStaticState(in);</span><br><span class="line">        List&lt;Exercise30.Shape&gt; shapes = (List&lt;Exercise30.Shape&gt;)in.readObject();</span><br><span class="line">        System.out.println(shapes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-31，32"><a href="#Exercise-31，32" class="headerlink" title="Exercise 31，32"></a>Exercise 31，32</h4><ul>
<li><strong>Exercise 31</strong>: (2) Add appropriate address information to Person.java and People.java.</li>
<li><strong>Exercise 32</strong>: (4) Using a Map<string,integer> and the net.mindview.util.TextFile utility, write a program that counts the occurrence of words in a file (use “\W+” as the second argument to the TextFile constructor). Store the results as an XML file.</string,integer></li>
</ul>
<p>涉及外部库Elliote Rusty Harold的XOM。跳过。</p>
<h4 id="Exercise-33"><a href="#Exercise-33" class="headerlink" title="Exercise 33"></a>Exercise 33</h4><ul>
<li><strong>Exercise 33</strong>: (2) Write a program that displays the current value of a directory called “base directory” and prompts you for a new value. Use the Preferences API to store the value.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter18;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.prefs.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise33</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> BackingStoreException</span>&#123;</span><br><span class="line">        Preferences root=Preferences.userRoot();</span><br><span class="line">        root.clear();   <span class="comment">//remove the previous enregistrer</span></span><br><span class="line">        <span class="keyword">byte</span>[] info=root.getByteArray(<span class="string">"base directory"</span>,<span class="string">"/Users"</span>.getBytes());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(info));</span><br><span class="line">        info=<span class="string">"/Users/Wei"</span>.getBytes();</span><br><span class="line">        root.putByteArray(<span class="string">"base directory"</span>,info);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(root.getByteArray(<span class="string">"base directory"</span>,<span class="string">"/Users"</span>.getBytes())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/IO/" rel="tag">#IO</a>
          
            <a href="/tags/file/" rel="tag">#file</a>
          
            <a href="/tags/stream/" rel="tag">#stream</a>
          
            <a href="/tags/流/" rel="tag">#流</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/28/doubleCapacity/" rel="next" title="HashMap的doubleCapacity()方法这样写妙在哪？">
                <i class="fa fa-chevron-left"></i> HashMap的doubleCapacity()方法这样写妙在哪？
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/10/19/copyView/" rel="prev" title="视图还是副本？">
                视图还是副本？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/09/28/tij4-18/"
           data-title="Thinking in Java 读书笔记：第十八章 - IO" data-url="www.ciaoshen.com/2016/09/28/tij4-18/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/shenAvatar.jpg"
               alt="沈玮 | Wei SHEN" />
          <p class="site-author-name" itemprop="name">沈玮 | Wei SHEN</p>
          <p class="site-description motion-element" itemprop="description">Coder & Designer</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">65</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">208</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/helloShen" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.douban.com/people/72441576/" target="_blank">
                  
                    <i class="fa fa-globe"></i> DouBan
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/pang-pang-37-37" target="_blank">
                  
                    <i class="fa fa-globe"></i> ZhiHu
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#File"><span class="nav-number">1.</span> <span class="nav-text">File</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#File-list"><span class="nav-number">1.1.</span> <span class="nav-text">File#list()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#递归获取某个地址下的所有文件"><span class="nav-number">1.2.</span> <span class="nav-text">递归获取某个地址下的所有文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“流（Stream）”家族"><span class="nav-number">2.</span> <span class="nav-text">“流（Stream）”家族</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#两大家族：面向字节-amp-面向字符"><span class="nav-number">2.1.</span> <span class="nav-text">两大家族：面向字节 & 面向字符</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#字节到字符的编码"><span class="nav-number">2.1.1.</span> <span class="nav-text">字节到字符的编码</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ASCII"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">ASCII</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ISO-IEC-8859-1"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">ISO/IEC 8859-1</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#中文编码"><span class="nav-number">2.1.1.3.</span> <span class="nav-text">中文编码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Unicode"><span class="nav-number">2.1.1.4.</span> <span class="nav-text">Unicode</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#UTF-8"><span class="nav-number">2.1.1.5.</span> <span class="nav-text">UTF-8</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#UTF-16"><span class="nav-number">2.1.1.6.</span> <span class="nav-text">UTF-16</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优先考虑面向字符的流"><span class="nav-number">2.2.</span> <span class="nav-text">优先考虑面向字符的流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据的编码"><span class="nav-number">2.3.</span> <span class="nav-text">数据的编码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#装饰器模式"><span class="nav-number">2.4.</span> <span class="nav-text">装饰器模式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Java-IO为什么用装饰器模式？"><span class="nav-number">2.4.1.</span> <span class="nav-text">Java IO为什么用装饰器模式？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#谁直接接触数据源？谁用来装饰？"><span class="nav-number">2.4.2.</span> <span class="nav-text">谁直接接触数据源？谁用来装饰？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#组合流过滤器"><span class="nav-number">2.4.3.</span> <span class="nav-text">组合流过滤器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#缓冲器Buffer是怎么工作的？"><span class="nav-number">2.4.4.</span> <span class="nav-text">缓冲器Buffer是怎么工作的？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些常见使用场景"><span class="nav-number">3.</span> <span class="nav-text">一些常见使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#读取本地文本文件"><span class="nav-number">3.1.</span> <span class="nav-text">读取本地文本文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从内存读取"><span class="nav-number">3.2.</span> <span class="nav-text">从内存读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#格式化内存读取"><span class="nav-number">3.3.</span> <span class="nav-text">格式化内存读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本文件输出"><span class="nav-number">3.4.</span> <span class="nav-text">基本文件输出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#文件输出快捷方式"><span class="nav-number">3.5.</span> <span class="nav-text">文件输出快捷方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#底层“输入”“输出”是怎么实现的？"><span class="nav-number">4.</span> <span class="nav-text">底层“输入”“输出”是怎么实现的？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新I-O"><span class="nav-number">5.</span> <span class="nav-text">新I/O</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是面向缓冲区？"><span class="nav-number">5.1.</span> <span class="nav-text">什么是面向缓冲区？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#传统阻塞式I-O"><span class="nav-number">5.2.</span> <span class="nav-text">传统阻塞式I/O</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多路复用I-O"><span class="nav-number">5.3.</span> <span class="nav-text">多路复用I/O</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#两者的区别"><span class="nav-number">5.4.</span> <span class="nav-text">两者的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#演示"><span class="nav-number">5.5.</span> <span class="nav-text">演示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Buffer的细节"><span class="nav-number">5.6.</span> <span class="nav-text">Buffer的细节</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MappedByteBuffer"><span class="nav-number">5.7.</span> <span class="nav-text">MappedByteBuffer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化"><span class="nav-number">6.</span> <span class="nav-text">序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Externalizable接口"><span class="nav-number">6.1.</span> <span class="nav-text">Externalizable接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#transient关键字"><span class="nav-number">6.2.</span> <span class="nav-text">transient关键字</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久化的另一个选择-Preferences-API"><span class="nav-number">7.</span> <span class="nav-text">持久化的另一个选择 - Preferences API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习"><span class="nav-number">8.</span> <span class="nav-text">练习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-1"><span class="nav-number">8.1.</span> <span class="nav-text">Exercise 1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-2"><span class="nav-number">8.2.</span> <span class="nav-text">Exercise 2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3"><span class="nav-number">8.3.</span> <span class="nav-text">Exercise 3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-4-5-6"><span class="nav-number">8.4.</span> <span class="nav-text">Exercise 4,5,6</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Directory-java"><span class="nav-number">8.4.1.</span> <span class="nav-text">Directory.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise4-java"><span class="nav-number">8.4.2.</span> <span class="nav-text">Exercise4.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ProcessFiles-java"><span class="nav-number">8.4.3.</span> <span class="nav-text">ProcessFiles.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise5-java"><span class="nav-number">8.4.4.</span> <span class="nav-text">Exercise5.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise6-java"><span class="nav-number">8.4.5.</span> <span class="nav-text">Exercise6.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-7"><span class="nav-number">8.5.</span> <span class="nav-text">Exercise 7</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-8"><span class="nav-number">8.6.</span> <span class="nav-text">Exercise 8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-9"><span class="nav-number">8.7.</span> <span class="nav-text">Exercise 9</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-10"><span class="nav-number">8.8.</span> <span class="nav-text">Exercise 10</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-11"><span class="nav-number">8.9.</span> <span class="nav-text">Exercise 11</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Controller-java"><span class="nav-number">8.9.1.</span> <span class="nav-text">Controller.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Event-java"><span class="nav-number">8.9.2.</span> <span class="nav-text">Event.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GreenhouseControls-java"><span class="nav-number">8.9.3.</span> <span class="nav-text">GreenhouseControls.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#EventFactory-java"><span class="nav-number">8.9.4.</span> <span class="nav-text">EventFactory.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BigEventFactory-java"><span class="nav-number">8.9.5.</span> <span class="nav-text">BigEventFactory.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SmallEventFactory-java"><span class="nav-number">8.9.6.</span> <span class="nav-text">SmallEventFactory.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ControllerHelper-java"><span class="nav-number">8.9.7.</span> <span class="nav-text">ControllerHelper.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise11-java"><span class="nav-number">8.9.8.</span> <span class="nav-text">Exercise11.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-12"><span class="nav-number">8.10.</span> <span class="nav-text">Exercise 12</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise12-java"><span class="nav-number">8.10.1.</span> <span class="nav-text">Exercise12.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-13"><span class="nav-number">8.11.</span> <span class="nav-text">Exercise 13</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-14"><span class="nav-number">8.12.</span> <span class="nav-text">Exercise 14</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise14-java"><span class="nav-number">8.12.1.</span> <span class="nav-text">Exercise14.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#测试结果"><span class="nav-number">8.12.2.</span> <span class="nav-text">测试结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-15"><span class="nav-number">8.13.</span> <span class="nav-text">Exercise 15</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-16"><span class="nav-number">8.14.</span> <span class="nav-text">Exercise 16</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-17"><span class="nav-number">8.15.</span> <span class="nav-text">Exercise 17</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#TextFile-java"><span class="nav-number">8.15.1.</span> <span class="nav-text">TextFile.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise17-java"><span class="nav-number">8.15.2.</span> <span class="nav-text">Exercise17.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-18"><span class="nav-number">8.16.</span> <span class="nav-text">Exercise 18</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-19"><span class="nav-number">8.17.</span> <span class="nav-text">Exercise 19</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#BinaryFile-java"><span class="nav-number">8.17.1.</span> <span class="nav-text">BinaryFile.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise19-java"><span class="nav-number">8.17.2.</span> <span class="nav-text">Exercise19.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-20"><span class="nav-number">8.18.</span> <span class="nav-text">Exercise 20</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Directory-java-1"><span class="nav-number">8.18.1.</span> <span class="nav-text">Directory.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BinaryFile-java-1"><span class="nav-number">8.18.2.</span> <span class="nav-text">BinaryFile.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise20-java"><span class="nav-number">8.18.3.</span> <span class="nav-text">Exercise20.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-21"><span class="nav-number">8.19.</span> <span class="nav-text">Exercise 21</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-22"><span class="nav-number">8.20.</span> <span class="nav-text">Exercise 22</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-23"><span class="nav-number">8.21.</span> <span class="nav-text">Exercise 23</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-24"><span class="nav-number">8.22.</span> <span class="nav-text">Exercise 24</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-25"><span class="nav-number">8.23.</span> <span class="nav-text">Exercise 25</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise25-java"><span class="nav-number">8.23.1.</span> <span class="nav-text">Exercise25.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#结果"><span class="nav-number">8.23.2.</span> <span class="nav-text">结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-26"><span class="nav-number">8.24.</span> <span class="nav-text">Exercise 26</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-27"><span class="nav-number">8.25.</span> <span class="nav-text">Exercise 27</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-28"><span class="nav-number">8.26.</span> <span class="nav-text">Exercise 28</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-29"><span class="nav-number">8.27.</span> <span class="nav-text">Exercise 29</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-30"><span class="nav-number">8.28.</span> <span class="nav-text">Exercise 30</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-31，32"><span class="nav-number">8.29.</span> <span class="nav-text">Exercise 31，32</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-33"><span class="nav-number">8.30.</span> <span class="nav-text">Exercise 33</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">沈玮 | Wei SHEN</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io" rel="external nofollow">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>

</br>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div>
  <span id="busuanzi_container_site_pv">
  Visited  <span id="busuanzi_value_site_pv"></span>  times
  </span>

<span id="busuanzi_container_site_pv">&nbsp; &nbsp; | &nbsp; &nbsp;</span>

  <span id="busuanzi_container_site_uv">
  <span id="busuanzi_value_site_uv"></span>  Visitors
  </span>
<div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ciaoshen"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  





  
  

  
  


</body>
</html>
