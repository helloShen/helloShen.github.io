<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="concurrent,process,thread," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="单处理器情况下，为什么并发？对“进程”而言，单纯的是想要实现多任务。对“线程”而言，主要是为性能考虑。
因为有“阻塞”，转而处理另一个任务，所以效率更高。
朴素的Thread首先，Java中关于线程Thread最基本的事实是：

除非通过Native方法将本地线程加入JVM，创建线程唯一的方法就是“创建一个Thread类的实例对象，然后调用它的start()方法。”

其次，关于Thread对象实">
<meta property="og:type" content="article">
<meta property="og:title" content="Thinking in Java 读书笔记：第二十一章 - 并发（草稿）">
<meta property="og:url" content="www.ciaoshen.com/2016/10/28/tij4-21/index.html">
<meta property="og:site_name" content="玮 | Wei">
<meta property="og:description" content="单处理器情况下，为什么并发？对“进程”而言，单纯的是想要实现多任务。对“线程”而言，主要是为性能考虑。
因为有“阻塞”，转而处理另一个任务，所以效率更高。
朴素的Thread首先，Java中关于线程Thread最基本的事实是：

除非通过Native方法将本地线程加入JVM，创建线程唯一的方法就是“创建一个Thread类的实例对象，然后调用它的start()方法。”

其次，关于Thread对象实">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-21/aqs.png">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-21/aqs2.jpg">
<meta property="og:image" content="www.ciaoshen.com/uploads/tij4-21/javaVolatile.png">
<meta property="og:updated_time" content="2016-12-12T23:57:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thinking in Java 读书笔记：第二十一章 - 并发（草稿）">
<meta name="twitter:description" content="单处理器情况下，为什么并发？对“进程”而言，单纯的是想要实现多任务。对“线程”而言，主要是为性能考虑。
因为有“阻塞”，转而处理另一个任务，所以效率更高。
朴素的Thread首先，Java中关于线程Thread最基本的事实是：

除非通过Native方法将本地线程加入JVM，创建线程唯一的方法就是“创建一个Thread类的实例对象，然后调用它的start()方法。”

其次，关于Thread对象实">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>



  <meta name="baidu-site-verification" content="3iRy3UFlpa" />


<script>
  (function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>


  <title> Thinking in Java 读书笔记：第二十一章 - 并发（草稿） | 玮 | Wei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-74473715-1', 'auto');
  ga('send', 'pageview');
</script>







  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">玮 | Wei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Coder & Designer</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hDG3wYskg4CYKGSXw8x7','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Thinking in Java 读书笔记：第二十一章 - 并发（草稿）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-10-28T20:08:31-04:00" content="2016-10-28">
              2016-10-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Note/" itemprop="url" rel="index">
                    <span itemprop="name">Note</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/28/tij4-21/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/28/tij4-21/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
            <span id="busuanzi_container_page_pv">&nbsp; |  &nbsp; &nbsp; Viewed <span id="busuanzi_value_page_pv"></span> times</span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="单处理器情况下，为什么并发？"><a href="#单处理器情况下，为什么并发？" class="headerlink" title="单处理器情况下，为什么并发？"></a>单处理器情况下，为什么并发？</h3><p>对“进程”而言，单纯的是想要实现多任务。<br>对“线程”而言，主要是为性能考虑。</p>
<p>因为有“阻塞”，转而处理另一个任务，所以效率更高。</p>
<h3 id="朴素的Thread"><a href="#朴素的Thread" class="headerlink" title="朴素的Thread"></a>朴素的Thread</h3><p>首先，Java中关于线程Thread最基本的事实是：</p>
<ul>
<li><strong>除非通过Native方法将本地线程加入JVM，创建线程唯一的方法就是“创建一个Thread类的实例对象，然后调用它的start()方法。”</strong></li>
</ul>
<p>其次，关于Thread对象实例的构造，需要注意，start()方法依赖于run()方法：</p>
<ul>
<li><strong>要么传递一个Runnable对象给构造器做参数。</strong></li>
<li><strong>要么重写Thread自己的run()方法。</strong></li>
</ul>
<h3 id="Executor和线程池"><a href="#Executor和线程池" class="headerlink" title="Executor和线程池"></a>Executor和线程池</h3><p>朴素的Thread对象，对映单个线程。多个Thread对象，多个线程是可以共存的。但会互相竞争资源。<strong>Executor</strong>创建一个“线程池”的概念，对线程统一管理。</p>
<ul>
<li>newCachedThreadPool：创建一个可缓存线程池，如果线程池长度超过处理需要，可灵活回收空闲线程，若无可回收，则新建线程。</li>
<li>newFixedThreadPool：创建一个定长线程池，可控制线程最大并发数，超出的线程会在队列中等待。</li>
<li>newScheduledThreadPool：创建一个定长线程池，支持定时及周期性任务执行。</li>
<li>newSingleThreadExecutor：创建一个单线程化的线程池，它只会用唯一的工作线程来执行任务，保证所有任务按照指定顺序(FIFO, LIFO, 优先级)执行。</li>
</ul>
<p>以上四个线程池工厂方法返回值面向统一的接口：ExecutorService。<br><strong>一般情况下，不要使用单独线程。总是首先考虑线程池！</strong></p>
<h4 id="execute-方法"><a href="#execute-方法" class="headerlink" title="execute( )方法"></a>execute( )方法</h4><p>无返回值的启动新线程靠调用execute()方法。多个线程完成任务的时间轴完全是随机的。</p>
<h4 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h4><p>有返回值的启动新线程靠调用submit()方法。多个线程间的相对执行顺序也是乱序。返回值类型为Future。</p>
<p><strong>！注意：</strong> 因为JVM不保证Future获得返回值的时间。所以，用get()方法获取返回值时，如果返回值还没有计算完成，get()方法是阻塞当前线程的。所以下面4个方法，第一个看上去完全是顺序执行的，后面三个都是乱序。就是因为get()方法等待计算结果完成后才打印结果。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">newCalledToFuture</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ExecutorService ex=Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        List&lt;Future&lt;Integer&gt;&gt; list=<span class="keyword">new</span> ArrayList&lt;Future&lt;Integer&gt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            TestCall called=<span class="keyword">new</span> TestCall(i+<span class="number">1</span>);</span><br><span class="line">            Future&lt;Integer&gt; result=ex.submit(called);</span><br><span class="line">            list.add(result);</span><br><span class="line">            System.out.println(<span class="string">"SUM &gt;&gt;&gt; #"</span>+called.getId()+<span class="string">"("</span>+result.get()+<span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">        System.out.println(ie);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(ExecutionException ee)&#123;</span><br><span class="line">        System.out.println(ee);</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        ex.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">newCalled</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ExecutorService ex=Executors.newCachedThreadPool();</span><br><span class="line">    List&lt;Future&lt;Integer&gt;&gt; list=<span class="keyword">new</span> ArrayList&lt;Future&lt;Integer&gt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        TestCall called=<span class="keyword">new</span> TestCall(i+<span class="number">1</span>);</span><br><span class="line">        list.add(ex.submit(called));</span><br><span class="line">        System.out.println(<span class="string">"SUM &gt;&gt;&gt; #"</span>+called.getId()+<span class="string">" finished!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ex.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">toFuture</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ExecutorService ex=Executors.newCachedThreadPool();</span><br><span class="line">    List&lt;Future&lt;Integer&gt;&gt; list=<span class="keyword">new</span> ArrayList&lt;Future&lt;Integer&gt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        Future&lt;Integer&gt; result=ex.submit(<span class="keyword">new</span> TestCall(i+<span class="number">1</span>));</span><br><span class="line">        list.add(result);</span><br><span class="line">    &#125;</span><br><span class="line">    ex.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">direct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ExecutorService ex=Executors.newCachedThreadPool();</span><br><span class="line">    List&lt;Future&lt;Integer&gt;&gt; list=<span class="keyword">new</span> ArrayList&lt;Future&lt;Integer&gt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        list.add(ex.submit(<span class="keyword">new</span> TestCall(i+<span class="number">1</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    ex.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>线程的优先级<strong>不是“死锁”</strong>。并不保证高优先级的线程一定在低优先级线程之前执行，而低优先级的线程迟迟得不到执行。</p>
<p>事实是：高优先级的线程只是执行的频率较高而已。</p>
<h3 id="yield-让步"><a href="#yield-让步" class="headerlink" title="yield( )让步"></a>yield( )让步</h3><p>和System.gc()方法类似，yield()方法仅仅是<strong>“建议”</strong>当前线程可以让给其他线程了。<strong>但完全不保证会让位。</strong></p>
<h3 id="Daemon后台线程"><a href="#Daemon后台线程" class="headerlink" title="Daemon后台线程"></a>Daemon后台线程</h3><p>关于Daemon Thread后台线程的几个重要事实有：</p>
<ul>
<li>所有非后台线程结束后，所有后台线程自动结束。（后台线程结束时，甚至不会执行finally中的任务。）</li>
<li>可以用setDaemon()方法设置成后台线程。也可以用ThreadFactory进行构造，其中有关于后台的参数。</li>
<li>后台线程创建的所有线程，自动设为后台线程。</li>
</ul>
<h3 id="ThreadFactory"><a href="#ThreadFactory" class="headerlink" title="ThreadFactory"></a>ThreadFactory</h3><p>刚才说过的Executor的四个线程池工厂方法接受ThreadFactory类型作为参数，用来封装Thread的实例化过程。ThreadFactory接口只定义了Thread newThread(Runnable r)一个方法。</p>
<p><strong>！注意：</strong>用ThreadFactory构造出来的Executor，在执行executor(Runnable r)方法时，传入的Runnable对象参数不会直接被传递给ThreadFactory的newThread(Runnable r)方法，而是会先包装成一个Worker。所以想通过Runnable往newThread(Runnable r)方法传递数据是危险的。</p>
<h3 id="未捕获异常"><a href="#未捕获异常" class="headerlink" title="未捕获异常"></a>未捕获异常</h3><p>书里未捕获异常一部分讲的不是很清楚。 这里稍微解释一下。</p>
<p>如果在Runnable对象的run()方法中抛出异常的话，在run()方法中捕获异常还来得及。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UncaughtException</span></span>&#123;</span><br><span class="line">    <span class="comment">//Runnable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperException</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Bingo! Exception caught!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Executor</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">letsGo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        es.execute(<span class="keyword">new</span> SuperException());</span><br><span class="line">        es.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        letsGo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果在Executor里捕获已经捕获不到了。这就是所谓的<strong>“异常逃逸”</strong>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UncaughtException</span></span>&#123;</span><br><span class="line">    <span class="comment">//Runnable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperException</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Executor</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">letsGo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            es.execute(<span class="keyword">new</span> SuperException());</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Bingo! Exception caught!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            es.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        letsGo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>“异常逃逸”不是说异常就不见了，消失了。其实它还是会冒泡到控制台的。而且自作主张显示在异常报告的第一行。这里的”逃逸”是指异常逃脱了我们try{}catch{}语句对异常的处理。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"pool-1-thread-1"</span> java.lang.RuntimeException</span><br><span class="line">	at com.ciaoshen.thinkinjava.chapter21.UncaughtException<span class="variable">$SuperException</span>.run(UncaughtException.java:<span class="number">11</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br></pre></td></tr></table></figure></p>
<p>逃逸的原因很容易猜，因为执行execute()方法的是主线程的Excecutor。而抛出异常的线程池中被分配来执行run()的某线程。JVM的异常处理是各线程只管自己的事。所以同理，就算我们把异常处理套到main()方法的主体中也无法捕获异常。因为始终是在主线程里做动作，这是无法处理其他线程里的异常的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UncaughtException</span></span>&#123;</span><br><span class="line">    <span class="comment">//Runnable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SuperException</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Executor</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">letsGo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        es.execute(<span class="keyword">new</span> SuperException());</span><br><span class="line">        es.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            letsGo();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Bingo! Exception caught!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>想要捕获的话，就要到执行run()方法的线程里想办法。Java的解决办法是，先创建一个UncaughtExceptionHandler，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUncaughtExceptionHandler</span> <span class="keyword">implements</span> <span class="title">Thread</span>.<span class="title">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"caught "</span> + e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在ThreadFactory里，用setUncaughtExceptionHandler()方法，把这个handler附着在某个Thread上。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HandlerThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="keyword">this</span> + <span class="string">" creating new Thread"</span>);</span><br><span class="line">		Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">		System.out.println(<span class="string">"created "</span> + t);</span><br><span class="line">		t.setUncaughtExceptionHandler(<span class="keyword">new</span> MyUncaughtExceptionHandler());</span><br><span class="line">		System.out.println(<span class="string">"eh = "</span> + t.getUncaughtExceptionHandler());</span><br><span class="line">		<span class="keyword">return</span> t;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="synchronized关键字和Lock"><a href="#synchronized关键字和Lock" class="headerlink" title="synchronized关键字和Lock"></a>synchronized关键字和Lock</h3><h4 id="竞态条件"><a href="#竞态条件" class="headerlink" title="竞态条件"></a>竞态条件</h4><p>并发最常见也最典型的问题来了：<strong>竞争公共资源</strong>。道理很简单，<strong>厕所只有一个，大家都要上怎么办？</strong>。这里大家争夺的“资源”，术语叫<strong>“状态”</strong>。其实可以理解为一个“变量”。当有多个线程可以调用某些方法，改变同一变量的状态，就构成了“竟态条件”，可能引起冲突。下面代码就是构成一个最简单的“竞态条件”：我们有一个数字变量。increment()方法每次对这个数加2，正常情况下，输出的数字一直是偶数。但当我们并发多个线程同时执行，线程很可能在执行了一次自增操作后就线程就被挂起。另一个线程接管，因此输出有可能变成奇数。这就是竞态条件下的冲突。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mutex</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">        num++; </span><br><span class="line">		Thread.yield(); </span><br><span class="line">		num++;</span><br><span class="line">		System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="独占锁，synchronized关键字"><a href="#独占锁，synchronized关键字" class="headerlink" title="独占锁，synchronized关键字"></a>独占锁，synchronized关键字</h4><p>最常用的解决方法就是加“独占锁”。用<strong>synchronized</strong>关键字。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mutex</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> num=<span class="number">0</span>;	<span class="comment">//“private”禁止外部方法调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">        num++; </span><br><span class="line">		Thread.yield(); </span><br><span class="line">		num++;</span><br><span class="line">		System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里synchronized所做的事情是：<strong>声明任何线程如果想要调用increment()方法，必须先获得当前Mutex类实例对象的唯一“独占令牌”，直到increment()方法执行完成，才释放令牌。在此期间，其他所有希望对同一个Mutex对象执行increment()操作的线程，都必须阻塞等候。</strong></p>
<p><strong>！注意：所以</strong>synchronized是一个“悲观锁”，或者叫“阻塞锁”。对象的独占令牌被占用后，其他尝试调用互斥令牌的线程会被阻塞等候。而且它是“不公平的”，因为它不保证先到的线程先执行。</p>
<p>所以synchronized<strong>“效率较低。”</strong>。因为阻塞，挂起，切换上下文，恢复线程，都需要转入内核态完成，开销很大。</p>
<h4 id="synchronized-临界区"><a href="#synchronized-临界区" class="headerlink" title="synchronized(){}临界区"></a>synchronized(){}临界区</h4><p>独占锁还可以通过下面synchronized(){}区块的形式，划定独占锁的执行范围。小括号里用来指定独占锁针对的对象。花括号划定需要用锁的范围。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mutex</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> num=<span class="number">0</span>;	<span class="comment">//“private”禁止外部方法调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span>（<span class="keyword">this</span>）&#123;</span><br><span class="line">        	num++; </span><br><span class="line">			Thread.yield(); </span><br><span class="line">			num++;</span><br><span class="line">			System.out.println(num);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于独占锁，或者独占区块，需要记住：<strong>独占锁定义的是：“过程”在访问“变量”的时候，需要取得变量的“独占令牌”。</strong> 打个不恰当的比方：“飞机上大家要使用公共厕所”。这时候：</p>
<ol>
<li>线程：相当于上厕所的人。</li>
<li>过程：相当于在马桶上拉屎这件事。</li>
<li>对象：比如说就是厕所。</li>
</ol>
<p>下面是一个测试的例子：我有一个输出结果永远为偶数的自增操作单元。可以每次自增2，以及检查输出是不是偶数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLock</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//synchronized(this)&#123;   //可以锁这里</span></span><br><span class="line">            num++; Thread.yield(); num++;</span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNum</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//synchronized(this)&#123;   //可以锁这里</span></span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后，写两个Runnable类允许多线程同时调用自增操作单元。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Checker2</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> TestLock tl;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Checker2</span><span class="params">(TestLock tl)</span></span>&#123;<span class="keyword">this</span>.tl=tl;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Run</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="comment">//synchronized(Checker2.this)&#123;  //这里不行</span></span><br><span class="line">                <span class="keyword">long</span> stop=System.currentTimeMillis()+<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">while</span>(System.currentTimeMillis()&lt;stop)&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(tl)&#123;	<span class="comment">////这里可以</span></span><br><span class="line">                        tl.increment();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Check</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="comment">//synchronized(Checker2.this)&#123;  //这里不行</span></span><br><span class="line">                <span class="keyword">long</span> stop=System.currentTimeMillis()+<span class="number">10</span>;</span><br><span class="line">                <span class="keyword">int</span> num;</span><br><span class="line">                <span class="keyword">while</span>(System.currentTimeMillis()&lt;stop)&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(tl)&#123;	<span class="comment">//这里可以</span></span><br><span class="line">                        num=tl.getNum();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(num%<span class="number">2</span>!=<span class="number">0</span>)&#123;</span><br><span class="line">                        System.out.println(num);</span><br><span class="line">                        Thread.yield();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//main execute the runnable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Checker2 ck=<span class="keyword">new</span> Checker2(<span class="keyword">new</span> TestLock());</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        es.execute(ck.new Run());</span><br><span class="line">        es.execute(ck.new Check());</span><br><span class="line">        es.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意，我们要求取得独占令牌的对象可以是当前类型的一个成员字段“TestLock tl”。锁可以加在TestLock类的被调用的原始操作上。也可以加在Checker2涉及“TestLock tl”的过程上。</p>
<p>但注意临界区尽量精准，千万不要直接套在整个while()的外面。这样“TestLock tl”的锁会被一直占用，导致其他线程完全无法获得令牌。</p>
<h4 id="ReentrantLock可重入锁"><a href="#ReentrantLock可重入锁" class="headerlink" title="ReentrantLock可重入锁"></a>ReentrantLock可重入锁</h4><p>除了synchronized之外，另一个选择是使用ReentrantLock，又叫“乐观锁”，或者“可重入锁”。用法和效果和synchronized都差不多。差别是它必须显式地创建锁，锁住和解锁。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mutex</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> num=<span class="number">0</span>;	<span class="comment">//“private”禁止外部方法调用</span></span><br><span class="line">	<span class="keyword">private</span> Lock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">		lock.lock();</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">        	num++; </span><br><span class="line">			Thread.yield(); </span><br><span class="line">			num++;</span><br><span class="line">			System.out.println(num);</span><br><span class="line">		&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但ReentrantLock解决资源冲突的机制，使用了和synchronized不同的<strong>非阻塞算法（non-blocking algorithms）</strong>。简单说就是：乐观地假设操作不会频繁地引起冲突。不管三七二十一先进行操作，如果没有其他线程争用共享数据，那操作就成功了。如果共享数据被争用，产生了冲突，那就再进行其他的补偿措施（最常见的补偿措施就是不断地重试，直到试成功为止）。所以采取这种策略的锁都可以叫<strong>“乐观锁”</strong>。</p>
<p>乐观锁的核心思想是基于<strong>volatile int state</strong>这样的一个属性，同时配合Unsafe工具用原子性的操作来实现对当前锁的状态进行修改。当state的值为0的时候，标识改Lock不被任何线程所占有。</p>
<h5 id="CSA-Compare-and-Swap"><a href="#CSA-Compare-and-Swap" class="headerlink" title="CSA (Compare and Swap)"></a>CSA (Compare and Swap)</h5><p>乐观锁的关键点就在于：需要<strong>冲突检测</strong>和<strong>修改状态</strong>这两个步骤具备<strong>原子性</strong>，这样就能保证不可能同时有两个线程同时修改了状态，同时抢到了锁。这是靠一个叫<strong>CAS（Compare and Swap）</strong>的硬件指令来保证的。看一下 ReentrantLock 的源码，核心的获取锁的方法是：<strong>compareAndSetState()</strong>，它调用Java本地方法compareAndSwapInt，而compareAndSwapInt方法内部又是借助C语言来调用底层intel处理器的CAS指令<strong>《cmpxchg》</strong>指令来完成的。先确认一遍State现在是不是0，如果是，那代表目前Lock是可用的，然后马上改变State的状态，获取锁。这一系列动作全包含在一个cmpxchg指令中，执行一个机器码的过程是不可能中间停下来，切换上下文到另一个线程的。这正是可重入锁线程安全的理论保障。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">               setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">               acquire(<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">	... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="AQS-AbstractQueuedSynchronizer"><a href="#AQS-AbstractQueuedSynchronizer" class="headerlink" title="AQS (AbstractQueuedSynchronizer)"></a>AQS (AbstractQueuedSynchronizer)</h5><p>抢占锁失败之后的重入策略，和Synchronized独占锁就不同了，不会马上阻塞挂起等待唤醒。而是进入一个等待队列，以期重新获取锁。所以关键就在这个队列上，它叫<strong>AbstractQueuedSynchronizer（简称AQS)</strong>。</p>
<p>这个AQS就很重要了，它是JDK1.5提供的一个<strong>基于FIFO等待队列实现的一个用于实现同步器的基础框架</strong>。AQS有多重要呢，可以说java.util.concurrent包里面几乎所有的有关锁、多线程并发以及线程同步器等重要组件的实现都是基于AQS这个框架。下图展示了ReentrantLock和这个框架的关系。<br><img src="/uploads/tij4-21/aqs.png" alt="aqs"></p>
<p>AbstractQueuedSynchronizer模板类中定义的主要方法比如tyrAcuire()尝试获取锁，tryRelease()尝试释放锁。而AbstractQueuedSynchronizer本身基于一个FIFO队列。它的核心思想是：避免所有等待获取锁的线程都不停地进行尝试，这样会引发“羊群效应”大量消耗资源，变得低效。改为只让排在队列头部的线程尝试获取锁。这就是ReentrantLock相对高效的原因。具体关于AbstractQueuedSynchronizer的细节，可以参看<a href="https://my.oschina.net/andylucc/blog/651982" target="_blank" rel="external"><strong>《扒一扒ReentrantLock以及AQS实现原理》</strong></a>这篇文章。<br><img src="/uploads/tij4-21/aqs2.jpg" alt="aqs"></p>
<h5 id="ReentrantLock的惯用法"><a href="#ReentrantLock的惯用法" class="headerlink" title="ReentrantLock的惯用法"></a>ReentrantLock的惯用法</h5><p>用ReentrantLock时的一个惯用法是：“上锁/try/finally/解锁”。不管操作是否成功，最后都要解锁。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line">	lock.lock();</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		++counter;</span><br><span class="line">	&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">		lock.unlock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="关于volatile"><a href="#关于volatile" class="headerlink" title="关于volatile"></a>关于volatile</h3><p>光有锁并不能保证“线程安全”。还必须给竟态资源加上volatile关键字。volatile是指：保持变量的<strong>“可见性”</strong>。什么是可见性？SUN官方定义是这样的：</p>
<ul>
<li><strong>Any write to a volatile variable establishes a happens-before relationship with subsequent reads of that same variable.</strong></li>
</ul>
<p>什么意思？看下图：<br><img src="/uploads/tij4-21/javaVolatile.png" alt="javaVolatile"><br>Java的内存模型是这样：每个Thread都有一小块“缓存区”，不是之内存，是CPU里的缓存区。如果一个变量的值被改变，可能只是先缓存在这个缓存区，内存上变量的值没有被改写。这就导致对变量操作“可见性”的问题。比如我先改变一个变量值，然后从内存中读取它，可能读取出来的还是原始值。相当于值的改变对我们不可见。</p>
<p>这里的“happens-before relationship（偏序关系）”指的就是，必须保证如果值的改变发生在读取之前，那么这个改变要确确实实写进内存，让读取操作“可见”。</p>
<p>所以“可见性”粗略说就是：每次值的写入都直接写进内存，而不使用CPU缓存的优化。</p>
<p>所以，<strong>所有用volatile关键字修饰的变量，他们的“读”，“写”操作都保证是原子性的。</strong> 这一定要记住！</p>
<p>所以，线程安全的三个关键词：<strong>“互斥性”</strong>，<strong>“可见性”</strong>，<strong>“原子性”</strong>。</p>
<h3 id="结束线程"><a href="#结束线程" class="headerlink" title="结束线程"></a>结束线程</h3><p>ExecutorService#shutdown()：不再接受新任务。</p>
<p>ExecutorService#shutdownNow()：立刻终止所有任务。</p>
<p>ExecutorService#awaitTermination()：阻塞直到所有现有任务完成，然后结束所有线程，关闭线程池。</p>
<h3 id="线程（任务）的中断（interrupt）"><a href="#线程（任务）的中断（interrupt）" class="headerlink" title="线程（任务）的中断（interrupt）"></a>线程（任务）的中断（interrupt）</h3><p>Thread#interrupt()方法可以“试图”中断<strong>“阻塞中”</strong>的线程。注意只能中断处于”阻塞状态“的线程。但：</p>
<ul>
<li>sleep阻塞是可以被中断的</li>
<li>IO阻塞是不可以被中断的</li>
<li>synchronized阻塞是不可以被中断的</li>
</ul>
<p><strong>！注意：</strong>这里的线程不是指线程池ExecutorService，而是只单个线程执行的Runnable任务。</p>
<p>如果任务不是由execute()执行，而是submit()执行，那在返回的Future上调用cancel()，可以有针对性地关闭线程池中的特定任务。</p>
<p>但要强制中断IO阻塞，可以直接关闭底层IO。另外和普通IO不同，nio是可以响应Future的cancel()中断的。</p>
<p>Synchronized的独占锁不可中断，但ReentrantLock的乐观锁是可以中断的。用Reentrant#lockInterruptibly()。因为上面分析过了，乐观锁本质上并没有阻塞冲突线程，它们只是在不断地重试而已。</p>
<h4 id="中断任务的一个惯用法（良好实践）"><a href="#中断任务的一个惯用法（良好实践）" class="headerlink" title="中断任务的一个惯用法（良好实践）"></a>中断任务的一个惯用法（良好实践）</h4><p>由于Java的interrupt只能中断“处于阻塞状态中”的任务（虽然对于IO和synchronized锁造成的阻塞也无力中断），所以当线程处于“非阻塞状态”下愉快运行的时候，除非暴力结束线程，看起来我们没有办法中断某个任务。</p>
<p>一个可行的方法是用静态方法Thread.interrupted()判断当前线程是否收到interrupt命令。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(!interrupted())&#123;</span><br><span class="line">		<span class="comment">//工作代码，一旦收到中断指令，就跳出</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">	<span class="comment">//除非是在sleep()状态下被中断，否则不会捕获InterruptedException</span></span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">	<span class="comment">//非阻塞状态下被中断后的处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体实例，参见练习18.</p>
<h3 id="wait-notify-notifyAll"><a href="#wait-notify-notifyAll" class="headerlink" title="wait( ), notify( ), notifyAll( )"></a>wait( ), notify( ), notifyAll( )</h3><p>wait()阻塞挂起当前线程的同时，<strong>释放互斥锁</strong>。这点和sleep()不同，sleep()不释放互斥锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">someObject.notifyAll();</span><br><span class="line">someObject.wait();</span><br></pre></td></tr></table></figure>
<p>先唤醒正在等待某个对象互斥锁的所有线程，然后再阻塞挂起当前线程，释放互斥锁，这样做是安全的。</p>
<p>另外wait()的一个惯用法是：尽量把wait()放在一个while(!condition){wait();}里面。防止醒来后却发现不满足条件的情况。</p>
<p>最后，对某个对象调用wait()和notify(),notifyAll()之前先获得这个对象上的互斥锁。</p>
<h4 id="notify-和notifyAll"><a href="#notify-和notifyAll" class="headerlink" title="notify( )和notifyAll( )"></a>notify( )和notifyAll( )</h4><p>notify()和notifyAll()的区别在于，notifyAll()唤醒所有排队线程，而notify()只唤醒其中一个线程，但却无法控制唤醒的是哪一个。</p>
<p>notifyAll()的策略就是，在这个锁上等的线程都叫醒。由线程自己判断这次的事务是否和自己有关。</p>
<p>notify()只叫醒一个线程，线程也需要自己判断这次的事务是否和自己有关。但notify()和notifyAll()的区别在于，如果任务和被唤醒的线程无关，继续睡之前，此线程还需要把接力棒传下去唤醒另一个线程，虽然它也不清楚唤醒的是哪个线程。</p>
<p>所以一般来说notifyAll()更合理一些。特殊情况用notify()要小心。</p>
<h4 id="wait-能被interrupt信号中断"><a href="#wait-能被interrupt信号中断" class="headerlink" title="wait( )能被interrupt信号中断"></a>wait( )能被interrupt信号中断</h4><p>这里有必要再次强调interrupt的有效范围：</p>
<ul>
<li>能中断sleep()阻塞</li>
<li>能中断wait()阻塞</li>
<li>无法中断synchronized互斥锁阻塞</li>
<li>无法中断IO阻塞</li>
</ul>
<p>尤其注意，当使用while(!Thread.interrupted())判断时，不要过早拦截InterruptedException导致无法跳出循环。</p>
<h3 id="“生产者-消费者”模型"><a href="#“生产者-消费者”模型" class="headerlink" title="“生产者-消费者”模型"></a>“生产者-消费者”模型</h3><p>这是一个交叉模型，无论是生产者还是消费者，都秉持同一个逻辑：</p>
<ul>
<li>占在自己的锁上，条件不满足时一直等待。</li>
<li>一旦条件满足，开始工作。必要时可以获取公共资源的锁。</li>
<li>执行完任务，跑到对方的锁上唤醒对方的线程。</li>
</ul>
<h3 id="condition-await-condition-signalAll"><a href="#condition-await-condition-signalAll" class="headerlink" title="condition#await( ), condition#signalAll( )"></a>condition#await( ), condition#signalAll( )</h3><p>除了wait()和notifyAll()来完成线程间的协作。conditon#await()和conditon#signalAll()也能实现同样的功能。</p>
<p>和wait()以及notifyAll()是附着于Object不同。conditon#await()和conditon#signalAll()是附着于Lock。</p>
<p>这里贴一个Oracle官方的例子：例子里通过两个条件来控制不同线程。</p>
<ul>
<li>Condition notFull：”防满溢标签“。当数组存满100个元素时，防满溢标签放出await()方法“阻塞，挂起，释放锁”。只有同一个标签放出signalAll()才能终止await()让线程继续。</li>
<li>Condition notEmpty：”防空标签“。当数组中没有元素时，防空标签放出await()方法“阻塞，挂起，释放锁”。只有同一个标签放出signalAll()才能终止await()让线程继续。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">final</span> Condition notFull  = lock.newCondition(); </span><br><span class="line">  <span class="keyword">final</span> Condition notEmpty = lock.newCondition(); </span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Object[] items = <span class="keyword">new</span> Object[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> putptr, takeptr, count;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (count == items.length)</span><br><span class="line">        notFull.await();</span><br><span class="line">      items[putptr] = x;</span><br><span class="line">      <span class="keyword">if</span> (++putptr == items.length) putptr = <span class="number">0</span>;</span><br><span class="line">      ++count;</span><br><span class="line">      notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (count == <span class="number">0</span>)</span><br><span class="line">        notEmpty.await();</span><br><span class="line">      Object x = items[takeptr];</span><br><span class="line">      <span class="keyword">if</span> (++takeptr == items.length) takeptr = <span class="number">0</span>;</span><br><span class="line">      --count;</span><br><span class="line">      notFull.signal();</span><br><span class="line">      <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面的练习28也是一个使用condition很好的例子。</p>
<h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3><p>无论通过Object#wait(),notify()组合还是condition#await(),signal()组合，这种通过互斥锁握手来实现同步的策略还是有点复杂。</p>
<p>一个更简单的解决方案是BlockingQueue。它的特性主要有两点：</p>
<ol>
<li>对它的操作是“线程安全”的。所以它内部肯定是维护着一个互斥锁的。操作和操作之间具有原子性。可以放心地用。</li>
<li>队列满了，插入操作会被阻塞挂起。空了，读取操作会被阻塞挂起。</li>
</ol>
<p>BlockingQueue的阻塞能被中断。</p>
<h3 id="类库中的其他构件"><a href="#类库中的其他构件" class="headerlink" title="类库中的其他构件"></a>类库中的其他构件</h3><h4 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h4><p>适用于某个任务必须等好几个前置任务完成之后才能执行，那用CountDownLatch把这个任务锁住。每完成一个任务latch就countDown()一下。当latch为零时，这个被锁住的任务就会自动运行。</p>
<h4 id="DelayQueue和PriorityBlockingQueue"><a href="#DelayQueue和PriorityBlockingQueue" class="headerlink" title="DelayQueue和PriorityBlockingQueue"></a>DelayQueue和PriorityBlockingQueue</h4><p>两个特性：BlockingQueue，Priority。其中DelayQueue的优先级是以delay的长短实现，时间上排在前面的优先级更高。</p>
<h4 id="ScheduledThreadPoolExecutor"><a href="#ScheduledThreadPoolExecutor" class="headerlink" title="ScheduledThreadPoolExecutor"></a>ScheduledThreadPoolExecutor</h4><p>schedule()延迟执行一次任务<br>scheduleAtFixedRate()周期性执行任务</p>
<h4 id="Semaphore计数信号量"><a href="#Semaphore计数信号量" class="headerlink" title="Semaphore计数信号量"></a>Semaphore计数信号量</h4><p>计数信号量顾名思义就像一个“计数器”。用来管理有限个数的对象。acquire()申请对象。release()释放对象。当计数器满，也就是对象全部被拿走之后，申请线程会被阻塞。Semaphore本身并不持有对象，它只是个计数器，一个线程安全的计数器。</p>
<ul>
<li>acquire()申请对象</li>
<li>release()释放对象</li>
</ul>
<p>size代表对象的数量。fair代表是不是一个公平锁，也就是被阻塞的申请线程是不是FIFO排队等对象被释放。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Semaphore(<span class="keyword">int</span> size, <span class="keyword">boolean</span> fair)</span><br></pre></td></tr></table></figure></p>
<p>需要注意，Semaphore是没有对每个对象加synchronized独占锁，因为否则acquire()锁住某个对象后，release()就被阻塞住，无法释放。但Semaphore是线程安全的。因为acquire()和release()两个方法都是原子性的。底层都基于原子性的CAS (compare and swap)机器码。</p>
<p>书里列举了利用Semaphore实现一个“对象池”模型。参见练习33.</p>
<h4 id="Exchanger"><a href="#Exchanger" class="headerlink" title="Exchanger"></a>Exchanger</h4><p>Exchanger也是模拟一个“生产者-消费者”的场景。想象这样一个场景：<strong>妈妈煎饼，我吃饼。</strong> </p>
<p>朴素的“生产者-消费者”模型是：只有一个盘子，只能放5张饼。妈妈煎5张饼，装满盘子叫我。我吃完5张饼叫妈妈。妈妈继续煎饼。</p>
<p>Exchanger的“生产者-消费者”模型的不同在于：有两个盘子，容量可以不一样，比如一号盘能装5张，二号盘装3张。初始我和妈妈分别持有其中一个。妈妈剪完5张饼往一号盘里放，叫我。同时我正在吃二号盘里的三张饼。吃完了了叫妈妈。此时我和妈妈握手，交换盘子。我拿到装满5张饼的一号盘继续吃。妈妈拿到空的二号盘，继续煎饼。具体的煎饼模型，参见练习34.</p>
<p>Exchanger有一个需要注意的地方：当一个线程提出交换的时候，如果它的patener线程已经提出了交换，那当前线程可以直接获得patener线程提供的对象，继续运行。这就是为什么练习34里，两个线程各持有10个盘子，但运行的结果是生产者先生产20个煎饼，然后消费者再吃20个煎饼。</p>
<h3 id="并发组件综合使用的一些经验"><a href="#并发组件综合使用的一些经验" class="headerlink" title="并发组件综合使用的一些经验"></a>并发组件综合使用的一些经验</h3><h3 id="Synchronized-Lock-Atomic的性能比较"><a href="#Synchronized-Lock-Atomic的性能比较" class="headerlink" title="Synchronized, Lock, Atomic的性能比较"></a>Synchronized, Lock, Atomic的性能比较</h3><p>记住下面这些基本结论：</p>
<ul>
<li>大规模测试中synchronized比Lock和Atomic明显低效</li>
<li>单独使用Atomic只能保证库中定义的非常简单的操作是原子性的</li>
<li>理论上Lock是更好的那个，但它使用起来语法不如synchronized简洁</li>
</ul>
<p>所以关于锁的选择的一个基调应该是：<strong>对性能不太敏感的时候，尽量使用synchronized以保持代码的可读性。只有当性能需要严格调优时才考虑替换成Lock。</strong></p>
<h3 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h3><p>同步的原理是在写入的时候会先创造一个副本，先在副本上修改，最后通过一个原子性的动作把副本和原本同步。</p>
<h3 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h3><p>常规的ReentrantLock的任意读写操作都是互斥的。很好地保护了线程安全。但如果要进一步提高效率的话，读操作其实是不用独占锁的。所以就有了ReentrantReadWriteLock。它的readLock是“共享锁”，writeLock是“独占锁”。所以它允许多个线程同时进行读操作。但每个时刻都只能有一个线程进行写操作。并且读操作和写操作也不能同时进行。</p>
<p>关于ReentrantReadWriteLock的具体操作，参见练习40.</p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h4><ul>
<li><strong>Exercise 1</strong>: (2) Implement a Runnable. Inside run( ), print a message, and then call yield( ). Repeat this three times, and then return from run( ). Put a startup message in the constructor and a shutdown message when the task terminates. Create a number of these tasks and drive them using threads.</li>
</ul>
<p>Thread间的切换完全看JVM心情。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise1</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> max=<span class="number">10</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise1</span><span class="params">()</span></span>&#123;System.out.println(<span class="string">"Operation NO."</span>+id+<span class="string">" initialized ... "</span>);&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">"#"</span>+id+<span class="string">"("</span>+(max--)+<span class="string">")"</span>);</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Operation NO."</span>+id+<span class="string">" is finished!"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Exercise1()).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h4><ul>
<li><strong>Exercise 2</strong>: (2) Following the form of generics/Fibonacci.java, create a task that produces a sequence of n Fibonacci numbers, where n is provided to the constructor of the task. Create a number of these tasks and drive them using threads.</li>
</ul>
<p>运行结果还是看JVM心情。</p>
<h5 id="Generator-java"><a href="#Generator-java" class="headerlink" title="Generator.java"></a>Generator.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Generator</span>&lt;<span class="title">T</span>&gt;</span>&#123;<span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span></span>;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Fibonacci-java"><a href="#Fibonacci-java" class="headerlink" title="Fibonacci.java"></a>Fibonacci.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fibonacci</span> <span class="keyword">implements</span> <span class="title">Generator</span>&lt;<span class="title">Integer</span>&gt;,<span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Fibonacci</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;count=num;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> count&gt;<span class="number">0</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">next</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> count--&gt;<span class="number">0</span>? fibo(++index):-<span class="number">1</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">fibo</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(num==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(num==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fibo(num-<span class="number">1</span>)+fibo(num-<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(hasNext())&#123;</span><br><span class="line">            System.out.print(next()+<span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Fibonacci f=<span class="keyword">new</span> Fibonacci(<span class="number">8</span>);</span><br><span class="line">        f.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise2-java"><a href="#Exercise2-java" class="headerlink" title="Exercise2.java"></a>Exercise2.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Fibonacci(i+<span class="number">1</span>)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><ul>
<li><strong>Exercise 3</strong>: (1) Repeat Exercise 1 using the different types of executors shown in this section.</li>
</ul>
<p>结果除了最后一个SingleThreadExecutor输出结果是顺序的，其他三个都是乱序。不代表他们都没有能力，只是还没有用其中的控制函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise3</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Generator</span>&lt;<span class="title">String</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> num;    <span class="comment">//remains how many</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise3</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;<span class="keyword">this</span>.num=num;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> num&gt;<span class="number">0</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">next</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> num&gt;<span class="number">0</span>? <span class="string">"#"</span>+id+<span class="string">"["</span>+(num--)+<span class="string">"] "</span>:<span class="string">"NULL"</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(hasNext())&#123;</span><br><span class="line">            System.out.print(next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testDifferentThreadPool</span><span class="params">(ExecutorService ex)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            ex.execute(<span class="keyword">new</span> Exercise3(i+<span class="number">5</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ex.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise3.testDifferentThreadPool(Executors.newCachedThreadPool());</span><br><span class="line">        Exercise3.testDifferentThreadPool(Executors.newFixedThreadPool(<span class="number">5</span>));</span><br><span class="line">        Exercise3.testDifferentThreadPool(Executors.newScheduledThreadPool(<span class="number">5</span>));</span><br><span class="line">        Exercise3.testDifferentThreadPool(Executors.newSingleThreadExecutor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><ul>
<li><strong>Exercise 4</strong>: (1) Repeat Exercise 2 using the different types of executors shown in this section.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise4</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testDifferentThreadPool</span><span class="params">(ExecutorService ex)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            ex.execute(<span class="keyword">new</span> Fibonacci(i+<span class="number">5</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ex.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise4.testDifferentThreadPool(Executors.newCachedThreadPool());</span><br><span class="line">        Exercise4.testDifferentThreadPool(Executors.newFixedThreadPool(<span class="number">5</span>));</span><br><span class="line">        Exercise4.testDifferentThreadPool(Executors.newScheduledThreadPool(<span class="number">5</span>));</span><br><span class="line">        Exercise4.testDifferentThreadPool(Executors.newSingleThreadExecutor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-5"><a href="#Exercise-5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><ul>
<li><strong>Exercise 5</strong>: (2) Modify Exercise 2 so that the task is a Callable that sums the values of all the Fibonacci numbers. Create several tasks and display the results.</li>
</ul>
<h5 id="Fibonacci-java-1"><a href="#Fibonacci-java-1" class="headerlink" title="Fibonacci.java"></a>Fibonacci.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fibonacci</span> <span class="keyword">implements</span> <span class="title">Generator</span>&lt;<span class="title">Integer</span>&gt;,<span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Fibonacci</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;count=num;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> count&gt;<span class="number">0</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">next</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> count--&gt;<span class="number">0</span>? fibo(++index):-<span class="number">1</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">fibo</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(num==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(num==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fibo(num-<span class="number">1</span>)+fibo(num-<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(hasNext())&#123;</span><br><span class="line">            System.out.print(next()+<span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Fibonacci f=<span class="keyword">new</span> Fibonacci(<span class="number">8</span>);</span><br><span class="line">        f.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise5-java"><a href="#Exercise5-java" class="headerlink" title="Exercise5.java"></a>Exercise5.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise5</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Integer</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Fibonacci f;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise5</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        f=<span class="keyword">new</span> Fibonacci(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(f.hasNext())&#123;</span><br><span class="line">            sum+=f.next();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService ex=Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            List&lt;Future&lt;Integer&gt;&gt; list=<span class="keyword">new</span> ArrayList&lt;Future&lt;Integer&gt;&gt;();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                list.add(ex.submit(<span class="keyword">new</span> Exercise5(i+<span class="number">1</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(Future&lt;Integer&gt; f:list)&#123;</span><br><span class="line">                System.out.println(f.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(ie);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(ExecutionException ee)&#123;</span><br><span class="line">            System.out.println(ee);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            ex.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h4><ul>
<li><strong>Exercise 7</strong>: (2) Experiment with different sleep times in Daemons.java to see what happens.</li>
</ul>
<p>主线程休眠时间不够的话，守护线程没有时间运行。 但守护进程运行的时间非常不稳定。经常是尽管主线程有足够的休眠时间，也得不到执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Daemon</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Thread[] t = <span class="keyword">new</span> Thread[<span class="number">100</span>];</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; t.length; i++) &#123;</span><br><span class="line">            t[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> DaemonSpawn());</span><br><span class="line">            t[i].start();</span><br><span class="line">            System.out.print(<span class="string">"DaemonSpawn "</span> + i + <span class="string">" started, "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; t.length; i++)</span><br><span class="line">            System.out.print(<span class="string">"t["</span> + i + <span class="string">"].isDaemon() = "</span> +</span><br><span class="line">                    t[i].isDaemon() + <span class="string">", "</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            Thread.yield();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DaemonSpawn</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise7</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread d = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Daemon());</span><br><span class="line">        d.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        d.start();</span><br><span class="line">        <span class="comment">//System.out.print("d.isDaemon() = " + d.isDaemon() + ", ");</span></span><br><span class="line">        <span class="comment">//TimeUnit.NANOSECONDS.sleep(1);</span></span><br><span class="line">        <span class="comment">//TimeUnit.MILLISECONDS.sleep(1);</span></span><br><span class="line">        <span class="comment">//TimeUnit.MICROSECONDS.sleep(1);</span></span><br><span class="line">        <span class="comment">//TimeUnit.SECONDS.sleep(1);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h4><ul>
<li><strong>Exercise 8</strong>: (1) Modify MoreBasicThreads.java so that all the threads are daemon threads, and verify that the program ends as soon as main( ) is able to exit.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise8</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> countDown = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> threadCount = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise8</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Store the thread name:</span></span><br><span class="line">        <span class="keyword">super</span>(Integer.toString(++threadCount));</span><br><span class="line">        setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"#"</span> + getName() + <span class="string">"("</span> + countDown + <span class="string">"), "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.print(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span>(--countDown == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">            Thread th=<span class="keyword">new</span> Exercise8();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         *  Additional time</span><br><span class="line">         *</span><br><span class="line">        try&#123;</span><br><span class="line">            TimeUnit.NANOSECONDS.sleep(1);</span><br><span class="line">        &#125;catch(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(ie);</span><br><span class="line">        &#125;</span><br><span class="line">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h4><ul>
<li><strong>Exercise 9</strong>: (3) Modify SimplePriorities.java so that a custom ThreadFactory sets the priorities of the threads.</li>
</ul>
<p>这题有两个坑：</p>
<ol>
<li>我第一次尝试把priority字段封装在Runnable对象里，然后想在ThreadFactory的newThread()方法里提取出Runnable对象的priority字段。但这样是不可行的。因为ThreadFactory对象获得的Runnable对象不是ExecutorService的execute()方法参数传递进去的那个Runnable对象。ThreadFactory获得的是ThreadPoolExecutor类包装成Worker类的一个Runnable对象。它的priority字段并不是这么直接能得到。</li>
<li>无论计算量有多大，以及优先级差距有多大，线程的运行还是没有规律可循。尤其在我的电脑上，优先级1级和10级的线程还是混在一起执行。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise9</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise9ThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> priority;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Exercise9ThreadFactory</span><span class="params">(<span class="keyword">int</span> lev)</span></span>&#123;priority=lev;&#125;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span></span>&#123;</span><br><span class="line">            Thread th=<span class="keyword">new</span> Thread(r);</span><br><span class="line">            th.setPriority(priority);</span><br><span class="line">            <span class="keyword">return</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> countDown = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">double</span> d; <span class="comment">// No optimization</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread() + <span class="string">": "</span> + countDown;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// An expensive, interruptable operation:</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">100000000</span>; i++) &#123;</span><br><span class="line">                d += (Math.PI + Math.E) / (<span class="keyword">double</span>)i;</span><br><span class="line">                <span class="keyword">if</span>(i % <span class="number">1000</span> == <span class="number">0</span>)</span><br><span class="line">                    Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span>(--countDown == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService exLow = Executors.newCachedThreadPool(<span class="keyword">new</span> Exercise9.Exercise9ThreadFactory(Thread.MIN_PRIORITY));</span><br><span class="line">        ExecutorService exHigh = Executors.newCachedThreadPool(<span class="keyword">new</span> Exercise9.Exercise9ThreadFactory(Thread.MAX_PRIORITY));</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">            exLow.execute(<span class="keyword">new</span> Exercise9());</span><br><span class="line">        &#125;</span><br><span class="line">        exHigh.execute(<span class="keyword">new</span> Exercise9());</span><br><span class="line">        exLow.shutdown();</span><br><span class="line">        exHigh.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-10"><a href="#Exercise-10" class="headerlink" title="Exercise 10"></a>Exercise 10</h4><ul>
<li><strong>Exercise 10</strong>: (4) Modify Exercise 5 following the example of the ThreadMethod class, so that runTask( ) takes an argument of the number of Fibonacci numbers to sum, and each time you call runTask( ) it returns the Future produced by the call to submit( ).</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise10</span></span>&#123;</span><br><span class="line">    <span class="comment">//Executor</span></span><br><span class="line">    <span class="keyword">private</span> ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">private</span> Fibonacci f=<span class="keyword">new</span> Fibonacci();</span><br><span class="line">    <span class="comment">//inner Callable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future <span class="title">runTask</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> es.submit(<span class="keyword">new</span> Callable&lt;Integer&gt;()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">                Integer result=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(++index&lt;=num)&#123;</span><br><span class="line">                    result+=f.fibo(index);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>&#123;es.shutdown();&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise10 ex=<span class="keyword">new</span> Exercise10();</span><br><span class="line">        Future f=ex.runTask(<span class="number">10</span>);</span><br><span class="line">        ex.close();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(f.get());</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(ie);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(ExecutionException ee)&#123;</span><br><span class="line">            System.out.println(ee);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-11"><a href="#Exercise-11" class="headerlink" title="Exercise 11"></a>Exercise 11</h4><ul>
<li><strong>Exercise 11</strong>: (3) Create a class containing two data fields, and a method that manipulates those fields in a multistep process so that, during the execution of that method, those fields are in an “improper state” (according to some definition that you establish). Add methods to read the fields, and create multiple threads to call the various methods and show that the data is visible in its “improper state.” Fix the problem using the synchronized keyword.</li>
</ul>
<p>例子的两个字段存放Fibonacci数列的前两个数字。fiboNext()方法动态将Fibonacci数列往前推进。show()方法显示当前两个基本数字之和。可以在有synchronized锁，或者无synchronized锁之间自由切换。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise11</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadFactory11</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Thread(r,String.valueOf(++count));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> base1=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> base2=<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//public void fiboNext()&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">fiboNext</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum=base1+base2;</span><br><span class="line">        base1=base2;</span><br><span class="line">        Thread.yield();</span><br><span class="line">        base2=sum;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//public void show()&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Thread #"</span>+Thread.currentThread().getName()+<span class="string">" &gt;&gt;&gt; "</span>+String.valueOf(base1)+<span class="string">"+"</span>+String.valueOf(base2)+<span class="string">"="</span>+String.valueOf(base1+base2));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//public void run()&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">            fiboNext();</span><br><span class="line">            show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Runnable r=<span class="keyword">new</span> Exercise11();</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool(<span class="keyword">new</span> ThreadFactory11());</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">            es.execute(r);</span><br><span class="line">        &#125;</span><br><span class="line">        es.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>无synchronized锁情况下的输出：不但Fibonacci数列的结果不对，而且还有重复计算的情况，而且显示的顺序也乱序。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Thread <span class="comment">#4 &gt;&gt;&gt; 5+8=13</span></span><br><span class="line">Thread <span class="comment">#2 &gt;&gt;&gt; 3+5=8</span></span><br><span class="line">Thread <span class="comment">#1 &gt;&gt;&gt; 3+5=8</span></span><br><span class="line">Thread <span class="comment">#5 &gt;&gt;&gt; 5+10=15</span></span><br><span class="line">Thread <span class="comment">#1 &gt;&gt;&gt; 25+40=80</span></span><br><span class="line">Thread <span class="comment">#5 &gt;&gt;&gt; 40+65=105</span></span><br><span class="line">Thread <span class="comment">#3 &gt;&gt;&gt; 3+5=8</span></span><br><span class="line">Thread <span class="comment">#1 &gt;&gt;&gt; 65+105=170</span></span><br><span class="line">Thread <span class="comment">#3 &gt;&gt;&gt; 105+210=315</span></span><br><span class="line">Thread <span class="comment">#2 &gt;&gt;&gt; 15+25=40</span></span><br><span class="line">Thread <span class="comment">#4 &gt;&gt;&gt; 10+15=25</span></span><br><span class="line">Thread <span class="comment">#2 &gt;&gt;&gt; 525+840=1365</span></span><br><span class="line">Thread <span class="comment">#3 &gt;&gt;&gt; 315+525=840</span></span><br><span class="line">Thread <span class="comment">#1 &gt;&gt;&gt; 210+315=525</span></span><br><span class="line">Thread <span class="comment">#3 &gt;&gt;&gt; 2205+3570=5775</span></span><br><span class="line">Thread <span class="comment">#5 &gt;&gt;&gt; 105+170=275</span></span><br><span class="line">Thread <span class="comment">#3 &gt;&gt;&gt; 5775+9345=15120</span></span><br><span class="line">Thread <span class="comment">#1 &gt;&gt;&gt; 3570+5775=9345</span></span><br><span class="line">Thread <span class="comment">#2 &gt;&gt;&gt; 1365+2205=4410</span></span><br><span class="line">Thread <span class="comment">#2 &gt;&gt;&gt; 15120+24465=39585</span></span><br><span class="line">Thread <span class="comment">#4 &gt;&gt;&gt; 840+1365=2205</span></span><br><span class="line">Thread <span class="comment">#5 &gt;&gt;&gt; 9345+15120=24465</span></span><br><span class="line">Thread <span class="comment">#4 &gt;&gt;&gt; 24465+39585=64050</span></span><br><span class="line">Thread <span class="comment">#5 &gt;&gt;&gt; 39585+64050=103635</span></span><br><span class="line">Thread <span class="comment">#4 &gt;&gt;&gt; 64050+103635=167685</span></span><br></pre></td></tr></table></figure></p>
<p>有了synchronized锁之后，一切正常。不管有多少个线程一起工作，Fibonacci数列都正确计算，按顺序输出：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Thread #1 &gt;&gt;&gt; 1+2=3</span><br><span class="line">Thread #1 &gt;&gt;&gt; 2+3=5</span><br><span class="line">Thread #1 &gt;&gt;&gt; 3+5=8</span><br><span class="line">Thread #1 &gt;&gt;&gt; 5+8=13</span><br><span class="line">Thread #1 &gt;&gt;&gt; 8+13=21</span><br><span class="line">Thread #5 &gt;&gt;&gt; 13+21=34</span><br><span class="line">Thread #5 &gt;&gt;&gt; 21+34=55</span><br><span class="line">Thread #5 &gt;&gt;&gt; 34+55=89</span><br><span class="line">Thread #5 &gt;&gt;&gt; 55+89=144</span><br><span class="line">Thread #5 &gt;&gt;&gt; 89+144=233</span><br><span class="line">Thread #4 &gt;&gt;&gt; 144+233=377</span><br><span class="line">Thread #4 &gt;&gt;&gt; 233+377=610</span><br><span class="line">Thread #4 &gt;&gt;&gt; 377+610=987</span><br><span class="line">Thread #4 &gt;&gt;&gt; 610+987=1597</span><br><span class="line">Thread #4 &gt;&gt;&gt; 987+1597=2584</span><br><span class="line">Thread #3 &gt;&gt;&gt; 1597+2584=4181</span><br><span class="line">Thread #3 &gt;&gt;&gt; 2584+4181=6765</span><br><span class="line">Thread #3 &gt;&gt;&gt; 4181+6765=10946</span><br><span class="line">Thread #3 &gt;&gt;&gt; 6765+10946=17711</span><br><span class="line">Thread #3 &gt;&gt;&gt; 10946+17711=28657</span><br><span class="line">Thread #2 &gt;&gt;&gt; 17711+28657=46368</span><br><span class="line">Thread #2 &gt;&gt;&gt; 28657+46368=75025</span><br><span class="line">Thread #2 &gt;&gt;&gt; 46368+75025=121393</span><br><span class="line">Thread #2 &gt;&gt;&gt; 75025+121393=196418</span><br><span class="line">Thread #2 &gt;&gt;&gt; 121393+196418=317811</span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-12-13"><a href="#Exercise-12-13" class="headerlink" title="Exercise 12,13"></a>Exercise 12,13</h4><ul>
<li><strong>Exercise 12</strong>: (3) Repair AtomicityTest.java using the synchronized keyword. Can you demonstrate that it is now correct?</li>
<li><strong>Exercise 13</strong>: (1) Repair SerialNumberChecker.java using the synchronized keyword. Can you demonstrate that it is now correct?</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise12</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> duration;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise12</span><span class="params">(<span class="keyword">int</span> duration)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.duration=duration;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">f3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        i++;i++;i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stop=System.currentTimeMillis()+duration;</span><br><span class="line">        <span class="keyword">while</span>(System.currentTimeMillis() &lt; stop)&#123;</span><br><span class="line">            f3();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.yield();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> i;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Checker</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">int</span> value;</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise12.<span class="keyword">this</span>)&#123;</span><br><span class="line">                value=getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(value%<span class="number">3</span>!=<span class="number">0</span>)&#123;</span><br><span class="line">                System.out.println(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                check();</span><br><span class="line">                Thread.yield();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ExecutorService mainService=Executors.newCachedThreadPool();</span><br><span class="line">        ExecutorService daemonService=Executors.newCachedThreadPool(<span class="keyword">new</span> ThreadFactory()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span></span>&#123;</span><br><span class="line">                Thread th=<span class="keyword">new</span> Thread(r);</span><br><span class="line">                th.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> th;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Exercise12 task=<span class="keyword">new</span> Exercise12(<span class="number">1000</span>);</span><br><span class="line">        Checker checker=task.new Checker();</span><br><span class="line">        </span><br><span class="line">        mainService.execute(task);</span><br><span class="line">        daemonService.execute(checker);</span><br><span class="line">        </span><br><span class="line">        mainService.shutdown();</span><br><span class="line">        daemonService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-14"><a href="#Exercise-14" class="headerlink" title="Exercise 14"></a>Exercise 14</h4><ul>
<li><strong>Exercise 14</strong>: (4) Demonstrate that java.util.Timer scales to large numbers by creating a program that generates many Timer objects that perform some simple task when the timeout completes.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise14</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> Timer().schedule(<span class="keyword">new</span> TimerTask()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">5</span>;j&gt;<span class="number">0</span>;j--)&#123;</span><br><span class="line">                        System.out.println(<span class="string">"#"</span>+Thread.currentThread().getName()+ <span class="string">" &gt;&gt;&gt; "</span> +j);</span><br><span class="line">                        <span class="keyword">try</span>&#123;</span><br><span class="line">                            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                            System.out.println(<span class="string">"Sleep Interrupted!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">6000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise14.action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-15"><a href="#Exercise-15" class="headerlink" title="Exercise 15"></a>Exercise 15</h4><ul>
<li><strong>Exercise 15</strong>: (1) Create a class with three methods containing critical sections that all synchronize on the same object. Create multiple tasks to demonstrate that only one of these methods can run at a time. Now modify the methods so that each one synchronizes on a different object and show that all three methods can be running at once.</li>
</ul>
<p>取消注释，换成synchronized(this)，就变成对三个不同的对象加同步锁。同步就被破坏。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise15</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String str;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise15</span><span class="params">(String name)</span></span>&#123;str=name;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aaa</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="comment">//synchronized (this)&#123;</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Exercise15.<span class="keyword">this</span>)&#123;</span><br><span class="line">                str=str.substring(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">                str+=<span class="string">"AAA"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bbb</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="comment">//synchronized (this)&#123;</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Exercise15.<span class="keyword">this</span>)&#123;</span><br><span class="line">                str=str.substring(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">                str+=<span class="string">"BBB"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ccc</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="comment">//synchronized (this)&#123;</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Exercise15.<span class="keyword">this</span>)&#123;</span><br><span class="line">                str=str.substring(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">                str+=<span class="string">"CCC"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">            System.out.println(str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ExecutorService executor=Executors.newCachedThreadPool();</span><br><span class="line">        Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> x=<span class="number">0</span>;</span><br><span class="line">        Exercise15 theMain=<span class="keyword">new</span> Exercise15(<span class="string">"STR-"</span>);</span><br><span class="line">        Runnable aaa=theMain.new Aaa(), bbb=theMain.new Bbb(), ccc=theMain.new Ccc();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            x=rand.nextInt(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">switch</span>(x)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    executor.execute(aaa); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    executor.execute(bbb); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    executor.execute(ccc); <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            executor.execute(theMain);</span><br><span class="line">        &#125;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-16"><a href="#Exercise-16" class="headerlink" title="Exercise 16"></a>Exercise 16</h4><ul>
<li><strong>Exercise 16</strong>: (1) Modify Exercise 15 to use explicit Lock objects.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise16</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String str;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise16</span><span class="params">(String name)</span></span>&#123;str=name;&#125;</span><br><span class="line">    <span class="keyword">private</span> Lock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Aaa</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                str=str.substring(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">                str+=<span class="string">"AAA"</span>;</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bbb</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                str=str.substring(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">                str+=<span class="string">"BBB"</span>;</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ccc</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                str=str.substring(<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">                str+=<span class="string">"CCC"</span>;</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(str);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ExecutorService executor=Executors.newCachedThreadPool();</span><br><span class="line">        Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">int</span> x=<span class="number">0</span>;</span><br><span class="line">        Exercise16 theMain=<span class="keyword">new</span> Exercise16(<span class="string">"STR-"</span>);</span><br><span class="line">        Runnable aaa=theMain.new Aaa(), bbb=theMain.new Bbb(), ccc=theMain.new Ccc();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            x=rand.nextInt(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">switch</span>(x)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    executor.execute(aaa); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    executor.execute(bbb); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    executor.execute(ccc); <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            executor.execute(theMain);</span><br><span class="line">        &#125;</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise17"><a href="#Exercise17" class="headerlink" title="Exercise17"></a>Exercise17</h4><ul>
<li><strong>Exercise 17</strong>: (2) Create a radiation counter that can have any number of remote sensors.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise17</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> macro=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//count</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> canceled=<span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> List&lt;Detector&gt; list=<span class="keyword">new</span> ArrayList&lt;Detector&gt;();</span><br><span class="line">    <span class="comment">//increment</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;count++;&#125;</span><br><span class="line">    <span class="comment">//show count</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> count;&#125;</span><br><span class="line">    <span class="comment">//cancel</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span></span>&#123;canceled=<span class="keyword">true</span>;&#125;</span><br><span class="line">    <span class="comment">//Runnable inner class: each sub counter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Detector</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> id=++macro;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> number=<span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Detector</span><span class="params">()</span></span>&#123;list.add(<span class="keyword">this</span>);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">int</span> seed;</span><br><span class="line">            <span class="keyword">while</span>(!canceled)&#123;</span><br><span class="line">                seed=rand.nextInt(<span class="number">10</span>);</span><br><span class="line">                <span class="keyword">switch</span>(seed)&#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                        increment(); number++; <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> number;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> id;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Listener</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!canceled)&#123;</span><br><span class="line">                <span class="keyword">for</span>(Detector d:list)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Detector #"</span>+d.getId()+<span class="string">": "</span>+d.getNumber()+<span class="string">"      Total: "</span>+getCount());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//main</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        Exercise17 rc=<span class="keyword">new</span> Exercise17();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            es.execute(rc.new Detector());</span><br><span class="line">        &#125;</span><br><span class="line">        es.execute(rc.new Listener());</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">3000</span>);</span><br><span class="line">            rc.cancel();</span><br><span class="line">            es.shutdown();</span><br><span class="line">            <span class="keyword">if</span>(!es.awaitTermination(<span class="number">250</span>,TimeUnit.MILLISECONDS))&#123;</span><br><span class="line">                System.out.println(<span class="string">"Some thread not terminated!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Termination Interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            rc.cancel();</span><br><span class="line">            es.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-18"><a href="#Exercise-18" class="headerlink" title="Exercise 18"></a>Exercise 18</h4><ul>
<li><strong>Exercise 18</strong>: (2) Create a non-task class with a method that calls sleep( ) for a long interval. Create a task that calls the method in the non-task class. In main( ), start the task, then call interrupt( ) to terminate it. Make sure that the task shuts down safely.</li>
</ul>
<p>这题很好地演示了面对interrupt()只能在sleep()的情况下中断线程的情况下，怎么利用interrupted()判断来迫使程序在非阻塞状态下也能正常中断。这是很好的一种惯用法（良好实践）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise18</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise18</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"I am awake!"</span>);</span><br><span class="line">            <span class="keyword">long</span> begin=System.currentTimeMillis()+<span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                <span class="keyword">if</span>(System.currentTimeMillis()&gt;=begin)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Sleeping..."</span>);</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">                    System.out.println(<span class="string">"I am awake!"</span>);</span><br><span class="line">                    begin=System.currentTimeMillis()+<span class="number">1000</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Interrupted in daytime!"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Interrupted while sleeping!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GotoSleep</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">new</span> Sleep();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        Future&lt;?&gt; f=es.submit(<span class="keyword">new</span> Exercise18.GotoSleep());</span><br><span class="line">        es.shutdown();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="keyword">long</span>)(<span class="keyword">new</span> Random().nextInt(<span class="number">10000</span>)));</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test Interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            f.cancel(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-19"><a href="#Exercise-19" class="headerlink" title="Exercise 19"></a>Exercise 19</h4><ul>
<li><strong>Exercise 19</strong>: (4) Modify OrnamentalGarden.java so that it uses interrupt( ).</li>
</ul>
<h5 id="Count-java"><a href="#Count-java" class="headerlink" title="Count.java"></a>Count.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Count</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">    <span class="comment">// Remove the synchronized keyword to see counting fail:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> temp = count;</span><br><span class="line">        <span class="keyword">if</span>(rand.nextBoolean()) <span class="comment">// Yield half the time</span></span><br><span class="line">            Thread.yield();</span><br><span class="line">        <span class="keyword">return</span> (count = ++temp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> count; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Entrance-java"><a href="#Entrance-java" class="headerlink" title="Entrance.java"></a>Entrance.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Entrance</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Count count = <span class="keyword">new</span> Count();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Entrance&gt; entrances =</span><br><span class="line">    <span class="keyword">new</span> ArrayList&lt;Entrance&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Doesn’t need synchronization to read:</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Entrance</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="comment">// Keep this task in a list. Also prevents</span></span><br><span class="line">        <span class="comment">// garbage collection of dead tasks:</span></span><br><span class="line">        entrances.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                    ++number;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="keyword">this</span> + <span class="string">" Total: "</span> + count.increment());</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> number; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Entrance "</span> + id + <span class="string">": "</span> + getValue();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTotalCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count.value();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sumEntrances</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(Entrance entrance : entrances)</span><br><span class="line">            sum += entrance.getValue();</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise19-java"><a href="#Exercise19-java" class="headerlink" title="Exercise19.java"></a>Exercise19.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise19</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">            exec.execute(<span class="keyword">new</span> Entrance(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Run for a while, then stop and collect the data:</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">        <span class="keyword">if</span>(!exec.awaitTermination(<span class="number">250</span>, TimeUnit.MILLISECONDS))&#123;</span><br><span class="line">            System.out.println(<span class="string">"Some tasks were not terminated!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Total: "</span> + Entrance.getTotalCount());</span><br><span class="line">        System.out.println(<span class="string">"Sum of Entrances: "</span> + Entrance.sumEntrances());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-20"><a href="#Exercise-20" class="headerlink" title="Exercise 20"></a>Exercise 20</h4><ul>
<li><strong>Exercise 20</strong>: (1) Modify CachedThreadPool.java so that all tasks receive an interrupt( ) before they are completed.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiftOff</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> countDown = <span class="number">10</span>; <span class="comment">// Default</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> taskCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id = taskCount++;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> begin,end;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LiftOff</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LiftOff</span><span class="params">(<span class="keyword">int</span> countDown)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.countDown = countDown;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">status</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"#"</span> + id + <span class="string">"("</span> + (countDown &gt; <span class="number">0</span> ? countDown : <span class="string">"Liftoff!"</span>) + <span class="string">"), "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        begin=System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted() &amp;&amp; countDown-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(status());</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Thread#"</span>+Thread.currentThread().getName()+<span class="string">" --&gt; Task#["</span>+id+<span class="string">"] recieve the Interruption signal after "</span>+((System.currentTimeMillis()-begin)/(<span class="keyword">float</span>)<span class="number">1000</span>)+<span class="string">" seconds!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-21"><a href="#Exercise-21" class="headerlink" title="Exercise 21"></a>Exercise 21</h4><ul>
<li><strong>Exercise 21</strong>: (2) Create two Runnables, one with a run( ) that starts and calls wait( ). The second class should capture the reference of the first Runnable object. Its run( ) should call notifyAll( ) for the first task after some number of seconds have passed so that the first task can display a message. Test your classes using an Executor.</li>
</ul>
<p>这题的坑在于对InterruptedException信号的处理。不要在实际业务逻辑函数randomWord()和format()里过早拦截和处理InterruptedException，否则就永远跳不出Runnable模块里的while(!Thread.interrupted())的循环。</p>
<p>这里有必要再次强调interrupt的有效范围：</p>
<ul>
<li>能中断sleep()阻塞</li>
<li>能中断wait()阻塞</li>
<li>无法中断synchronized互斥锁阻塞</li>
<li>无法中断IO阻塞</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise21</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span>[] word=<span class="keyword">new</span> <span class="keyword">char</span>[rand.nextInt(<span class="number">15</span>)+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> prepared=<span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> formatted=<span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span></span>&#123;</span><br><span class="line">        word=<span class="keyword">new</span> <span class="keyword">char</span>[rand.nextInt(<span class="number">15</span>)+<span class="number">1</span>];</span><br><span class="line">        prepared=<span class="keyword">false</span>;</span><br><span class="line">        formatted=<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">new</span> PrepareWord().randomWord();</span><br><span class="line">            <span class="keyword">new</span> FormatWord().format();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Task interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        es.execute(<span class="keyword">new</span> PrepareWord());</span><br><span class="line">        es.execute(<span class="keyword">new</span> FormatWord());</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test interrupted incorrectly!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            es.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrepareWord</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">randomWord</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;    <span class="comment">//这里不处理interrupt信号很重要，抛出去让Runnable处理</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;word.length;i++)&#123;</span><br><span class="line">                <span class="keyword">char</span> c=(<span class="keyword">char</span>)(((<span class="keyword">int</span>)<span class="string">'a'</span>)+rand.nextInt(<span class="number">26</span>));</span><br><span class="line">                word[i]=c;</span><br><span class="line">                System.out.print(c);</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">200</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">""</span>);</span><br><span class="line">            prepared=<span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise21.<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                        randomWord();</span><br><span class="line">                        Exercise21.<span class="keyword">this</span>.notifyAll();</span><br><span class="line">                        <span class="keyword">while</span>(!formatted)&#123;</span><br><span class="line">                            Exercise21.<span class="keyword">this</span>.wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(<span class="string">"&gt;&gt;&gt; String 《"</span>+<span class="keyword">new</span> String(word)+<span class="string">"》constructed!"</span>);</span><br><span class="line">                        reset();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Word generation interrupted!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"Word Generator exit correctly!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormatWord</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">format</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;	<span class="comment">//这里不处理interrupt信号很重要，抛出去让Runnable处理</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;word.length;i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i%<span class="number">2</span>==<span class="number">0</span>)&#123;</span><br><span class="line">                    word[i]=Character.toUpperCase(word[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.print(word[i]);</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">200</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">""</span>);</span><br><span class="line">            formatted=<span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise21.<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                        <span class="keyword">while</span>(!prepared || formatted)&#123;</span><br><span class="line">                            Exercise21.<span class="keyword">this</span>.wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                        format();</span><br><span class="line">                        Exercise21.<span class="keyword">this</span>.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Word format interrupted!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"Word Decorator exit correctly!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise21 ex=<span class="keyword">new</span> Exercise21();</span><br><span class="line">        <span class="comment">//ex.preTest();</span></span><br><span class="line">        ex.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-22"><a href="#Exercise-22" class="headerlink" title="Exercise 22"></a>Exercise 22</h4><ul>
<li><strong>Exercise 22</strong>: (4) Create an example of a busy wait. One task sleeps for a while and then sets a flag to true. The second task watches that flag inside a while loop (this is the busy wait) and when the flag becomes true, sets it back to false and reports the change to the console. Note how much wasted time the program spends inside the busy wait, and create a second version of the program that uses wait( ) instead of the busy wait.</li>
</ul>
<p>光做true or false太无聊，稍微改动为地球人和外星人的大战。标志改成int，表示地球陷落程度。故事模型是这样：</p>
<ul>
<li>外星人在陷落程度100之前攻击力10，满100以后攻击力3。</li>
<li>原始人在陷落程度80之前攻击力3，80-100时攻击力8，满100之后，攻击力10。</li>
<li>现代人在陷落程度100之前一直休眠，满100后一波大反攻。然后接着休眠。</li>
<li>外星人和原始人对战时，不用wait()和notifyAll()。和现代人对战时会使用wait()和notifyAll()。</li>
<li>实时显示地球状态。</li>
</ul>
<p>外星人远古人的战争，就是处于忙等状态，两个线程由JVM控制交替运行。while(!Thread.interrupted())一直在循环。<br>外星人和现代人的战争，虽然外星人的每次进攻都会调用notifyAll()给人类警醒，但人类的设定是不到家园彻底沦陷，不会反击。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise22</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> earthFallen=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);earthFallen--;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">fallen</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);earthFallen++;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> result=Math.min(earthFallen,<span class="number">100</span>)/<span class="number">5</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>;y&lt;<span class="number">20</span>-result;y++)&#123;</span><br><span class="line">            System.out.print(<span class="string">"+"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>;x&lt;result;x++)&#123;</span><br><span class="line">            System.out.print(<span class="string">"-"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimitiveAlien</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attack</span><span class="params">(<span class="keyword">int</span> times)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise22.<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i &lt; times;i++)&#123;</span><br><span class="line">                    fallen();</span><br><span class="line">                &#125;</span><br><span class="line">                show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="keyword">if</span>(earthFallen&lt;<span class="number">100</span>)&#123;</span><br><span class="line">                        attack(rand.nextInt(<span class="number">10</span>));</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        attack(rand.nextInt(<span class="number">3</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Alien interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"TimeOver! We Alien "</span>+ (earthFallen&gt;=<span class="number">100</span>? <span class="string">"WIN!"</span>:<span class="string">"LOSE!"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Alien</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attack</span><span class="params">(<span class="keyword">int</span> times)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise22.<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;times;i++)&#123;</span><br><span class="line">                    fallen();</span><br><span class="line">                &#125;</span><br><span class="line">                show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(Exercise22.<span class="keyword">this</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(earthFallen&lt;<span class="number">100</span>)&#123;</span><br><span class="line">                            attack(rand.nextInt(<span class="number">10</span>));</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            attack(rand.nextInt(<span class="number">3</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                        Exercise22.<span class="keyword">this</span>.notifyAll();</span><br><span class="line">                        Exercise22.<span class="keyword">this</span>.wait();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Alien interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"TimeOver! We Alien "</span>+ (earthFallen&gt;=<span class="number">100</span>? <span class="string">"WIN!"</span>:<span class="string">"LOSE!"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Primitive</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defense</span><span class="params">(<span class="keyword">int</span> times)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise22.<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;times;i++)&#123;</span><br><span class="line">                    save();</span><br><span class="line">                &#125;</span><br><span class="line">                show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="keyword">if</span>(earthFallen&lt;<span class="number">80</span>)&#123;</span><br><span class="line">                        defense(rand.nextInt(<span class="number">3</span>));</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(earthFallen&lt;<span class="number">100</span>)&#123;</span><br><span class="line">                        defense(rand.nextInt(<span class="number">8</span>));</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        defense(rand.nextInt(<span class="number">10</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Primitive Interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"TimeOver! We Primitive "</span>+ (earthFallen&gt;=<span class="number">100</span>? <span class="string">"LOSE!"</span>:<span class="string">"WIN!"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">defense</span><span class="params">(<span class="keyword">int</span> times)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise22.<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;times;i++)&#123;</span><br><span class="line">                    save();</span><br><span class="line">                &#125;</span><br><span class="line">                show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(Exercise22.<span class="keyword">this</span>)&#123;</span><br><span class="line">                        <span class="keyword">while</span>(earthFallen&lt;<span class="number">100</span>)&#123;</span><br><span class="line">                            Exercise22.<span class="keyword">this</span>.notifyAll();</span><br><span class="line">                            Exercise22.<span class="keyword">this</span>.wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                        defense(rand.nextInt(<span class="number">100</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Human Interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"TimeOver! We Human "</span>+(earthFallen&gt;<span class="number">100</span>? <span class="string">"LOSE!"</span>:<span class="string">"WIN!"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise22 ex=<span class="keyword">new</span> Exercise22();</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//es.execute(ex.new PrimitiveAlien());</span></span><br><span class="line">        <span class="comment">//es.execute(ex.new Primitive());</span></span><br><span class="line">        es.execute(ex.new Alien());</span><br><span class="line">        es.execute(ex.new Human());</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">15</span>)+<span class="number">1</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test Interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            es.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-23"><a href="#Exercise-23" class="headerlink" title="Exercise 23"></a>Exercise 23</h4><ul>
<li><strong>Exercise 23</strong>: (7) Demonstrate that WaxOMatic.java works successfully when you use notify( ) instead of notifyAll( ).</li>
</ul>
<p>下面的程序，就算是好几个WaxOn任务和WaxOff任务一起跑，也会正常上蜡，除蜡循环操作。</p>
<p>使用notify()替代notifyAll()的关键在于既然不能控制被唤醒的是不是恰当的任务，一个任务收到唤醒信号后，需要判断是不是符合醒来的条件，否则继续等待。而且，继续睡或者完成任务之前，还需要把接力棒传下去唤醒另一个任务，虽然它也不清楚唤醒的是哪个任务。</p>
<h5 id="Car-java"><a href="#Car-java" class="headerlink" title="Car.java"></a>Car.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> waxOn = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">wax</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        waitForBuffing();</span><br><span class="line">        System.out.print(<span class="string">"Wax On! "</span>);</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">200</span>);</span><br><span class="line">        waxOn = <span class="keyword">true</span>; <span class="comment">// Ready to buff</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">buff</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        waitForWaxing();</span><br><span class="line">        System.out.print(<span class="string">"Wax Off! "</span>);</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">200</span>);</span><br><span class="line">        waxOn = <span class="keyword">false</span>; <span class="comment">// Ready to wax</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">waitForWaxing</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(waxOn == <span class="keyword">false</span>)&#123;</span><br><span class="line">            notify();</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">waitForBuffing</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(waxOn == <span class="keyword">true</span>)&#123;</span><br><span class="line">            notify();</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="WaxOn-java"><a href="#WaxOn-java" class="headerlink" title="WaxOn.java"></a>WaxOn.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaxOn</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaxOn</span><span class="params">(Car c)</span> </span>&#123; car = c; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                car.wax();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Exiting via interrupt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Ending Wax On task"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="WaxOff-java"><a href="#WaxOff-java" class="headerlink" title="WaxOff.java"></a>WaxOff.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaxOff</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaxOff</span><span class="params">(Car c)</span> </span>&#123; car = c; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                car.buff();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Exiting via interrupt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Ending Wax Off task"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise23-java"><a href="#Exercise23-java" class="headerlink" title="Exercise23.java"></a>Exercise23.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise23</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Car car = <span class="keyword">new</span> Car();</span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOff(car));</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOn(car));</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOff(car));</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOn(car));</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOff(car));</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOn(car));</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOff(car));</span><br><span class="line">        exec.execute(<span class="keyword">new</span> WaxOn(car));</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">5</span>); <span class="comment">// Run for a while...</span></span><br><span class="line">        exec.shutdownNow(); <span class="comment">// Interrupt all tasks</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-24"><a href="#Exercise-24" class="headerlink" title="Exercise 24"></a>Exercise 24</h4><ul>
<li><strong>Exercise 24</strong>: (1) Solve a single-producer, single-consumer problem using wait( ) and notifyAll( ). The producer must not overflow the receiver’s buffer, which can happen if the producer is faster than the consumer. If the consumer is faster than the producer, then it must not read the same data more than once. Do not assume anything about the relative speeds of the producer or consumer.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise24</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Queue&lt;String&gt; table=<span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Fourniseur fourniseur=<span class="keyword">new</span> Fourniseur();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Consumer consumer=<span class="keyword">new</span> Consumer();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">randomFood</span><span class="params">()</span></span>&#123;</span><br><span class="line">        StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;rand.nextInt(<span class="number">15</span>)+<span class="number">1</span>;i++)&#123;</span><br><span class="line">            sb.append((<span class="keyword">char</span>)(((<span class="keyword">int</span>)<span class="string">'a'</span>)+rand.nextInt(<span class="number">26</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(table)&#123;</span><br><span class="line">            Iterator ite=table.iterator();</span><br><span class="line">            <span class="keyword">while</span>(ite.hasNext())&#123;</span><br><span class="line">                System.out.print(((String)ite.next()).substring(<span class="number">0</span>,<span class="number">1</span>));</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">10</span>-table.size();j++)&#123;</span><br><span class="line">                System.out.print(<span class="string">"-"</span>);</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fourniseur</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="comment">//让出生产锁，有7道菜就不上新菜</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                        <span class="keyword">while</span>(table.size()&gt;<span class="number">7</span>)&#123;</span><br><span class="line">                            wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//占住消费锁，上一轮菜</span></span><br><span class="line">                    System.out.println(<span class="string">"Here come the new plate!"</span>);</span><br><span class="line">                    <span class="keyword">synchronized</span>(Exercise24.<span class="keyword">this</span>.consumer)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;rand.nextInt(<span class="number">3</span>)+<span class="number">1</span>;i++)&#123;</span><br><span class="line">                            <span class="keyword">synchronized</span>(Exercise24.<span class="keyword">this</span>.table)&#123;</span><br><span class="line">                                table.add(randomFood());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        show();</span><br><span class="line">                        Exercise24.<span class="keyword">this</span>.consumer.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Fourniseur interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Fourniseur exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="comment">//让出消费锁，少于2道菜就等上菜</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                        <span class="keyword">while</span>(table.size()&lt;<span class="number">2</span>)&#123;</span><br><span class="line">                            wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//占住生产锁，吃一轮</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(Exercise24.<span class="keyword">this</span>.fourniseur)&#123;</span><br><span class="line">                        System.out.println(<span class="string">"I can eat now!"</span>);</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;rand.nextInt(<span class="number">2</span>)+<span class="number">1</span>;i++)&#123;</span><br><span class="line">                            <span class="keyword">synchronized</span>(Exercise24.<span class="keyword">this</span>.table)&#123;</span><br><span class="line">                                table.poll();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        show();</span><br><span class="line">                        Exercise24.<span class="keyword">this</span>.fourniseur.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Fourniseur interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Fourniseur exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise24 ex=<span class="keyword">new</span> Exercise24();</span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        es.execute(ex.fourniseur);</span><br><span class="line">        es.execute(ex.consumer);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test Interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            es.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-25"><a href="#Exercise-25" class="headerlink" title="Exercise 25"></a>Exercise 25</h4><ul>
<li><strong>Exercise 25</strong>: (1) In the Chef class in Restaurant.java, return from run( ) after calling shutdownNow( ) and observe the difference in behavior.</li>
</ul>
<p>我相当于只是去掉了chef循环中的sleep()。这样就不会每次都从try{}catch(){}里退出。</p>
<h5 id="Meal-java"><a href="#Meal-java" class="headerlink" title="Meal.java"></a>Meal.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Meal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> orderNum;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Meal</span><span class="params">(<span class="keyword">int</span> orderNum)</span> </span>&#123; <span class="keyword">this</span>.orderNum = orderNum; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Meal "</span> + orderNum; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="WaitPerson-java"><a href="#WaitPerson-java" class="headerlink" title="WaitPerson.java"></a>WaitPerson.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitPerson</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Exercise25 restaurant;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaitPerson</span><span class="params">(Exercise25 r)</span> </span>&#123; restaurant = r; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span>(restaurant.meal == <span class="keyword">null</span>)</span><br><span class="line">                        wait(); <span class="comment">// ... for the chef to produce a meal</span></span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"Waitperson got "</span> + restaurant.meal);</span><br><span class="line">                <span class="keyword">synchronized</span>(restaurant.chef) &#123;</span><br><span class="line">                    restaurant.meal = <span class="keyword">null</span>;</span><br><span class="line">                    restaurant.chef.notifyAll(); <span class="comment">// Ready for another</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"WaitPerson interrupted"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Chef-java"><a href="#Chef-java" class="headerlink" title="Chef.java"></a>Chef.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chef</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Exercise25 restaurant;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Chef</span><span class="params">(Exercise25 r)</span> </span>&#123; restaurant = r; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span>(restaurant.meal != <span class="keyword">null</span>)</span><br><span class="line">                        wait(); <span class="comment">// ... for the meal to be taken</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(++count == <span class="number">10</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Out of food, closing"</span>);</span><br><span class="line">                    restaurant.exec.shutdownNow();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.print(<span class="string">"Order up! "</span>);</span><br><span class="line">                <span class="keyword">synchronized</span>(restaurant.waitPerson) &#123;</span><br><span class="line">                    restaurant.meal = <span class="keyword">new</span> Meal(count);</span><br><span class="line">                    restaurant.waitPerson.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//TimeUnit.MILLISECONDS.sleep(100);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Chef interrupted"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise25-java"><a href="#Exercise25-java" class="headerlink" title="Exercise25.java"></a>Exercise25.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise25</span> </span>&#123;</span><br><span class="line">    Meal meal;</span><br><span class="line">    ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">    WaitPerson waitPerson = <span class="keyword">new</span> WaitPerson(<span class="keyword">this</span>);</span><br><span class="line">    Chef chef = <span class="keyword">new</span> Chef(<span class="keyword">this</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise25</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        exec.execute(chef);</span><br><span class="line">        exec.execute(waitPerson);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Exercise25();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-26"><a href="#Exercise-26" class="headerlink" title="Exercise 26"></a>Exercise 26</h4><ul>
<li><strong>Exercise 26</strong>: (8) Add a BusBoy class to Restaurant.java. After the meal is delivered, the WaitPerson should notify the BusBoy to clean up.</li>
</ul>
<p>思路就是：</p>
<ul>
<li>每500微妙来一个客人。</li>
<li>服务生：如果菜没好，就在自己的锁上等着。菜好了就跑到厨师锁上，准备上菜。上菜前再跑到跑堂的锁上，让跑堂的擦桌子。桌子干净后上菜，上完菜通知厨师再准备。</li>
<li>厨师：如果菜没卖掉，就在自己的锁上等着。菜卖掉之后，马上跑到服务生锁上，准备下一道，完了之后通知服务生。</li>
<li>跑堂：在自己锁上等着。一叫就醒。跑去擦桌子。擦完继续等服务生叫他。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise26</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count=<span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> tableClean=<span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> Meal meal=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> WaitPerson waitPerson;</span><br><span class="line">    <span class="keyword">private</span> Chef chef;</span><br><span class="line">    <span class="keyword">private</span> BusBoy busBoy;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService es;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise26</span><span class="params">(<span class="keyword">int</span> count)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count=count;</span><br><span class="line">        es=Executors.newCachedThreadPool();</span><br><span class="line">        waitPerson=<span class="keyword">new</span> WaitPerson();</span><br><span class="line">        chef=<span class="keyword">new</span> Chef();</span><br><span class="line">        busBoy=<span class="keyword">new</span> BusBoy();</span><br><span class="line">        es.execute(waitPerson);</span><br><span class="line">        es.execute(chef);</span><br><span class="line">        es.execute(busBoy);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Meal</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Meal</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Meal</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;id=num;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Meal "</span>+id;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//WaitPerson</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitPerson</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">                    <span class="comment">//wait on self lock</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                        <span class="keyword">while</span>(meal==<span class="keyword">null</span>)&#123;</span><br><span class="line">                            wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//deliver the food on Chef lock</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(Exercise26.<span class="keyword">this</span>.chef)&#123;</span><br><span class="line">                        System.out.println(<span class="string">"Here is the food!"</span>);</span><br><span class="line">                        <span class="comment">//call busboy</span></span><br><span class="line">                        <span class="keyword">synchronized</span>(Exercise26.<span class="keyword">this</span>.busBoy)&#123;</span><br><span class="line">                            System.out.println(<span class="string">"BusBoy, clean the table! "</span>);</span><br><span class="line">                            busBoy.notifyAll();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                            <span class="keyword">while</span>(!tableClean)&#123;</span><br><span class="line">                                wait();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(<span class="string">"Food served! "</span>);</span><br><span class="line">                        meal=<span class="keyword">null</span>;</span><br><span class="line">                        tableClean=<span class="keyword">false</span>;</span><br><span class="line">                        chef.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"WaitPerson interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Chef</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chef</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="comment">//wait on self lock</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                        <span class="keyword">while</span>(meal!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                            wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"Order come!"</span>);</span><br><span class="line">                    <span class="keyword">if</span>(++count&gt;Exercise26.<span class="keyword">this</span>.count)&#123;</span><br><span class="line">                        System.out.println(<span class="string">"Out of meal!"</span>);</span><br><span class="line">                        Exercise26.<span class="keyword">this</span>.es.shutdownNow();</span><br><span class="line">                        TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//prepare food on WaitPerson lock</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(Exercise26.<span class="keyword">this</span>.waitPerson)&#123;</span><br><span class="line">                        meal=<span class="keyword">new</span> Meal(count);</span><br><span class="line">                        System.out.println(meal+<span class="string">" prepared!"</span>);</span><br><span class="line">                        waitPerson.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Chef interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//BusBoy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusBoy</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    <span class="comment">//wait on self lock</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                        wait();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//clean the table on the WaitPerson lock</span></span><br><span class="line">                    <span class="keyword">synchronized</span>(Exercise26.<span class="keyword">this</span>.waitPerson)&#123;</span><br><span class="line">                        tableClean=<span class="keyword">true</span>;</span><br><span class="line">                        System.out.println(<span class="string">"Table cleaned!"</span>);</span><br><span class="line">                        waitPerson.notifyAll();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"BusBoy interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Exercise26(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-28"><a href="#Exercise-28" class="headerlink" title="Exercise 28"></a>Exercise 28</h4><ul>
<li><strong>Exercise 28</strong>: (3) Modify TestBlockingQueues.java by adding a new task that places LiftOff on the BlockingQueue, instead of doing it in main( ).</li>
</ul>
<p>这题里BlockingQueue有个很大的坑：就是BlockingQueue的put()或者take()如果取不到元素是阻塞的。一定要做好中断情况下，退出循环，结束线程的准备。下面程序中要是没有那个break，当某一次BlockingQueue的put()被终止后，马上会尝试下一次，然后继续阻塞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise28</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;LiftOff28&gt; rockets;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LiftOffRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LiftOffRunner</span><span class="params">(BlockingQueue&lt;LiftOff28&gt; queue)</span> </span>&#123;</span><br><span class="line">            rockets = queue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                    LiftOff28 rocket = rockets.take();</span><br><span class="line">                    rocket.run(); <span class="comment">// Use this thread</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Waking from take()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread()+<span class="string">"Exiting LiftOffRunner"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LiftOffFiller</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> times=<span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LiftOffFiller</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;times=num;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(LiftOff28 lo)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rockets.put(lo);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Interrupted during put()"</span>);</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;times;i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(Thread.interrupted())&#123;</span><br><span class="line">                    <span class="keyword">break</span>;  <span class="comment">//保证当interrupt时，跳出循环。否则下一次BlockingQueue的put()会继续阻塞，线程无法退出。</span></span><br><span class="line">                &#125;</span><br><span class="line">                add(<span class="keyword">new</span> LiftOff28(<span class="number">5</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread()+<span class="string">"Exiting LiftOffFiller!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getkey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in)).readLine();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(java.io.IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getkey</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(message);</span><br><span class="line">        getkey();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(String msg, BlockingQueue&lt;LiftOff28&gt; queue)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        System.out.println(msg);</span><br><span class="line">        LiftOffRunner runner = <span class="keyword">new</span> LiftOffRunner(queue);</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(runner);</span><br><span class="line">        t.start();</span><br><span class="line">        Thread f=<span class="keyword">new</span> Thread(<span class="keyword">new</span> LiftOffFiller(<span class="number">5</span>));</span><br><span class="line">        f.start();</span><br><span class="line">        getkey(<span class="string">"Press ‘Enter’ ("</span> + msg + <span class="string">")"</span>);</span><br><span class="line">        t.interrupt();</span><br><span class="line">        f.interrupt();</span><br><span class="line">        System.out.println(<span class="string">"Finished "</span> + msg + <span class="string">" test"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        test(<span class="string">"LinkedBlockingQueue"</span>, <span class="keyword">new</span> LinkedBlockingQueue&lt;LiftOff28&gt;());</span><br><span class="line">        test(<span class="string">"ArrayBlockingQueue"</span>, <span class="keyword">new</span> ArrayBlockingQueue&lt;LiftOff28&gt;(<span class="number">3</span>));</span><br><span class="line">        test(<span class="string">"SynchronousQueue"</span>, <span class="keyword">new</span> SynchronousQueue&lt;LiftOff28&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-29"><a href="#Exercise-29" class="headerlink" title="Exercise 29"></a>Exercise 29</h4><ul>
<li><strong>Exercise 29</strong>: (8) Modify ToastOMatic.java to create peanut butter and jelly on toast sandwiches using two separate assembly lines (one for peanut butter, the second for jelly, then merging the two lines).</li>
</ul>
<p>总体思路很简单：</p>
<ol>
<li>涂黄油的流水线就涂黄油。涂果酱的线就涂果酱。</li>
<li>关键步骤在于：黄油流水线下来再送到果酱流水线。果酱流水线下来再送到黄油流水线。</li>
<li>最后一道管卡把FINISH状态下的都过滤出来。</li>
</ol>
<h5 id="Toast29-java"><a href="#Toast29-java" class="headerlink" title="Toast29.java"></a>Toast29.java</h5><p>吐司有四种状态，什么都没涂，只涂了黄油，只涂了果酱，黄油果酱都涂过了。注意黄油果酱的顺序不重要，只要都涂过就可以吃。另外涂过的不可以重复涂。所以peanutButter()和jamme()两个方法都用switch根据不同状态处理。相当于有限状态机。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Toast29</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> Status29&#123;DRY, PBD, JMD, FINISH&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Status29 status=Status29.DRY;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Toast29</span><span class="params">()</span></span>&#123;id=++count;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">peanutButter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(status)&#123;</span><br><span class="line">            <span class="keyword">case</span> DRY:</span><br><span class="line">                status=Status29.PBD; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PBD:</span><br><span class="line">                System.out.println(<span class="string">"ERROR: "</span>+<span class="keyword">this</span>+<span class="string">" alread PeanutButtered!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> JMD:</span><br><span class="line">                status=Status29.FINISH;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FINISH:</span><br><span class="line">                System.out.println(<span class="string">"ERROR: "</span>+<span class="keyword">this</span>+<span class="string">" alread finished!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">jamme</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(status)&#123;</span><br><span class="line">            <span class="keyword">case</span> DRY:</span><br><span class="line">                status=Status29.JMD; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> JMD:</span><br><span class="line">                System.out.println(<span class="string">"ERROR: "</span>+<span class="keyword">this</span>+<span class="string">" alread Jammed!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PBD:</span><br><span class="line">                status=Status29.FINISH;<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FINISH:</span><br><span class="line">                System.out.println(<span class="string">"ERROR: "</span>+<span class="keyword">this</span>+<span class="string">" alread finished!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Status29 <span class="title">getStatus</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> status;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatus</span><span class="params">(Status29 s)</span></span>&#123;status=s;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Toast#"</span>+id+<span class="string">": "</span>+status;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="ToastQueue29-java"><a href="#ToastQueue29-java" class="headerlink" title="ToastQueue29.java"></a>ToastQueue29.java</h5><p>BlockingQueue换个名字。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastQueue29</span> <span class="keyword">extends</span> <span class="title">LinkedBlockingQueue</span>&lt;<span class="title">Toast29</span>&gt;</span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="Toaster29-java"><a href="#Toaster29-java" class="headerlink" title="Toaster29.java"></a>Toaster29.java</h5><p>有两个这样专门生产原味吐司的线程，分别插进涂黄油队列和涂果酱队列。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Toaster29</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 toastQueue;</span><br><span class="line">    <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Toaster29</span><span class="params">(ToastQueue29 tq)</span></span>&#123;toastQueue=tq;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>+rand.nextInt(<span class="number">100</span>));</span><br><span class="line">                Toast29 t=<span class="keyword">new</span> Toast29();</span><br><span class="line">                System.out.println(t);</span><br><span class="line">                toastQueue.put(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="PeanutButterer19-java"><a href="#PeanutButterer19-java" class="headerlink" title="PeanutButterer19.java"></a>PeanutButterer19.java</h5><p>负责涂黄油的线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeanutButterer29</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 toastQueue;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 peanutButterQueue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PeanutButterer29</span><span class="params">(ToastQueue29 tq, ToastQueue29 pbq)</span></span>&#123;</span><br><span class="line">        toastQueue=tq;</span><br><span class="line">        peanutButterQueue=pbq;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                Toast29 t=toastQueue.take();</span><br><span class="line">                t.peanutButter();</span><br><span class="line">                System.out.println(t);</span><br><span class="line">                peanutButterQueue.put(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="Jammer29-java"><a href="#Jammer29-java" class="headerlink" title="Jammer29.java"></a>Jammer29.java</h5><p>负责涂果酱的线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Jammer29</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 toastQueue;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 jammeQueue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Jammer29</span><span class="params">(ToastQueue29 tq, ToastQueue29 jmq)</span></span>&#123;</span><br><span class="line">        toastQueue=tq;</span><br><span class="line">        jammeQueue=jmq;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                Toast29 t=toastQueue.take();</span><br><span class="line">                t.jamme();</span><br><span class="line">                System.out.println(t);</span><br><span class="line">                jammeQueue.put(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="PBChecker29-java"><a href="#PBChecker29-java" class="headerlink" title="PBChecker29.java"></a>PBChecker29.java</h5><p>从涂完黄油的队列里挑拣已经FINISH的和只涂了黄油的。只涂了黄油的再插入涂果酱流水线。FINISH的就等待被吃。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PBChecker29</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 peanutButteredQueue;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 jammeQueue;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 finishQueue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PBChecker29</span><span class="params">(ToastQueue29 pbdq, ToastQueue29 jmq, ToastQueue29 fq)</span></span>&#123;</span><br><span class="line">        peanutButteredQueue=pbdq;</span><br><span class="line">        jammeQueue=jmq;</span><br><span class="line">        finishQueue=fq;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                Toast29 t=peanutButteredQueue.take();</span><br><span class="line">                <span class="keyword">switch</span>(t.getStatus())&#123;</span><br><span class="line">                    <span class="keyword">case</span> DRY:</span><br><span class="line">                        System.out.println(<span class="string">"ERROR: "</span>+t+<span class="string">" still DRY, cannot PeanutButter!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PBD:</span><br><span class="line">                        jammeQueue.put(t);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> JMD:</span><br><span class="line">                        System.out.println(<span class="string">"ERROR: "</span>+t+<span class="string">" need to be PeanutButtered!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> FINISH:</span><br><span class="line">                        finishQueue.put(t);<span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="JMChecker29-java"><a href="#JMChecker29-java" class="headerlink" title="JMChecker29.java"></a>JMChecker29.java</h5><p>同理，从涂完果酱的队列里挑拣已经FINISH的和只涂了果酱的。只涂了果酱的再插入涂黄油流水线。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMChecker29</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 jammedQueue;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 peanutButterQueue;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 finishQueue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JMChecker29</span><span class="params">(ToastQueue29 jmdq, ToastQueue29 pbq, ToastQueue29 fq)</span></span>&#123;</span><br><span class="line">        jammedQueue=jmdq;</span><br><span class="line">        peanutButterQueue=pbq;</span><br><span class="line">        finishQueue=fq;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                Toast29 t=jammedQueue.take();</span><br><span class="line">                <span class="keyword">switch</span>(t.getStatus())&#123;</span><br><span class="line">                    <span class="keyword">case</span> DRY:</span><br><span class="line">                        System.out.println(<span class="string">"ERROR: "</span>+t+<span class="string">" still DRY, cannot Jamme!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> PBD:</span><br><span class="line">                        System.out.println(<span class="string">"ERROR: "</span>+t+<span class="string">" need to be Jammed!!!"</span>);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> JMD:</span><br><span class="line">                        peanutButterQueue.put(t);<span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> FINISH:</span><br><span class="line">                        finishQueue.put(t);<span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="Eater29-java"><a href="#Eater29-java" class="headerlink" title="Eater29.java"></a>Eater29.java</h5><p>专门负责从成品吐司队列里拿来吃的线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Eater29</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ToastQueue29 finishQueue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Eater29</span><span class="params">(ToastQueue29 fq)</span></span>&#123;</span><br><span class="line">        finishQueue=fq;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                Toast29 t=finishQueue.take();</span><br><span class="line">                <span class="keyword">if</span>(t.getStatus()!=Toast29.Status29.FINISH)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"ERROR: "</span>+t+<span class="string">" not Finished!"</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    System.out.println(t+<span class="string">"  YAMMY! YAMMY!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Toaster29 exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="Exercise29-java"><a href="#Exercise29-java" class="headerlink" title="Exercise29.java"></a>Exercise29.java</h5><p>创建这5个队列，7个线程。一起运行。他们之间就靠BlockingQueue的协调一起工作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise29</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ToastQueue29 queuePB=<span class="keyword">new</span> ToastQueue29();</span><br><span class="line">        ToastQueue29 queueJM=<span class="keyword">new</span> ToastQueue29();</span><br><span class="line">        ToastQueue29 queuePBD=<span class="keyword">new</span> ToastQueue29();</span><br><span class="line">        ToastQueue29 queueJMD=<span class="keyword">new</span> ToastQueue29();</span><br><span class="line">        ToastQueue29 queueFINISH=<span class="keyword">new</span> ToastQueue29();</span><br><span class="line">        </span><br><span class="line">        ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">        es.execute(<span class="keyword">new</span> Toaster29(queuePB));</span><br><span class="line">        es.execute(<span class="keyword">new</span> Toaster29(queueJM));</span><br><span class="line">        es.execute(<span class="keyword">new</span> PeanutButterer29(queuePB,queuePBD));</span><br><span class="line">        es.execute(<span class="keyword">new</span> Jammer29(queueJM,queueJMD));</span><br><span class="line">        es.execute(<span class="keyword">new</span> PBChecker29(queuePBD,queueJM,queueFINISH));</span><br><span class="line">        es.execute(<span class="keyword">new</span> JMChecker29(queueJMD,queuePB,queueFINISH));</span><br><span class="line">        es.execute(<span class="keyword">new</span> Eater29(queueFINISH));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test Interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            es.shutdownNow();</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-30"><a href="#Exercise-30" class="headerlink" title="Exercise 30"></a>Exercise 30</h4><ul>
<li><strong>Exercise 30</strong>: (1) Modify PipedIO.java to use a BlockingQueue instead of a pipe.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise30</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;Character&gt; bq=<span class="keyword">new</span> LinkedBlockingQueue&lt;Character&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">char</span> c = <span class="string">'A'</span>; c &lt;= <span class="string">'z'</span>; c++) &#123;</span><br><span class="line">                        bq.put(c);</span><br><span class="line">                        TimeUnit.MILLISECONDS.sleep(rand.nextInt(<span class="number">500</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(e + <span class="string">" Sender sleep interrupted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                    System.out.print(<span class="string">"Read: "</span> + (<span class="keyword">char</span>)bq.take() + <span class="string">", "</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(e + <span class="string">" Sender sleep interrupted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">        exec.execute(<span class="keyword">new</span> Sender());</span><br><span class="line">        exec.execute(<span class="keyword">new</span> Receiver());</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">4</span>);</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-31"><a href="#Exercise-31" class="headerlink" title="Exercise 31"></a>Exercise 31</h4><ul>
<li><strong>Exercise 31</strong>: (8) Change DeadlockingDiningPhilosophers.java so that when a philosopher is done with its chopsticks, it drops them into a bin. When a philosopher wants to eat, it takes the next two available chopsticks from the bin. Does this eliminate the possibility of deadlock? Can you reintroduce deadlock by simply reducing the number of available chopsticks?</li>
</ul>
<p>经典的哲学家就餐问题。理论上用一个筷子筒还是有可能死锁的。因为拿筷子的动作分解为两步：拿第一根筷子，拿第二根筷子。最坏的情况每个哲学家的线程都在拿了第一根筷子的时候被挂起，结果还是每人拿了一根筷子。所以，我在拿筷子和还筷子两个动作上都加了互斥锁。这样拿两根筷子的动作有了原子性，就不可能存在所有人都拿着一根等另一根的情况。最糟糕的情况是，拿着一根筷子的哥们儿，永远吃不到。</p>
<p>后面一个问题，通过减少筷子，是不是可能死锁？只能说，当只有一根筷子的时候，谁都吃不成。这算不算也是死锁呢？</p>
<h5 id="ChopstickBuck-java"><a href="#ChopstickBuck-java" class="headerlink" title="ChopstickBuck.java"></a>ChopstickBuck.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChopstickBuck</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> num;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> availableNum;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChopstickBuck</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.num=num;</span><br><span class="line">        availableNum=num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//只要拿两根筷子的动作是原子性的，就不会死锁</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">while</span>(availableNum==<span class="number">0</span>)&#123;</span><br><span class="line">                wait();</span><br><span class="line">            &#125;</span><br><span class="line">            availableNum--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//同理</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">drop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        availableNum++;availableNum++;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Philosopher-java"><a href="#Philosopher-java" class="headerlink" title="Philosopher.java"></a>Philosopher.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> ponderFactor;</span><br><span class="line">    <span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> ChopstickBuck buck;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ponderFactor == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(rand.nextInt(ponderFactor * <span class="number">250</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(ChopstickBuck buck, <span class="keyword">int</span> ident, <span class="keyword">int</span> ponder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.buck=buck;</span><br><span class="line">        id = ident;</span><br><span class="line">        ponderFactor = ponder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span> + <span class="string">" "</span> + <span class="string">"thinking"</span>);</span><br><span class="line">                pause();</span><br><span class="line">                <span class="comment">// Philosopher becomes hungry</span></span><br><span class="line">                System.out.println(<span class="keyword">this</span> + <span class="string">" "</span> + <span class="string">"want to eat"</span>);</span><br><span class="line">                buck.take();</span><br><span class="line">                System.out.println(<span class="keyword">this</span> + <span class="string">" "</span> + <span class="string">"eating"</span>);</span><br><span class="line">                pause();</span><br><span class="line">                buck.drop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span> + <span class="string">" "</span> + <span class="string">"exiting via interrupt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Philosopher "</span> + id; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise31-java"><a href="#Exercise31-java" class="headerlink" title="Exercise31.java"></a>Exercise31.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise31</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ponder = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            ponder = Integer.parseInt(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">if</span>(args.length &gt; <span class="number">1</span>)&#123;</span><br><span class="line">            size = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">        Chopstick[] sticks = <span class="keyword">new</span> Chopstick[size];</span><br><span class="line">        ChopstickBuck buck=<span class="keyword">new</span> ChopstickBuck(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)&#123;</span><br><span class="line">            exec.execute(<span class="keyword">new</span> Philosopher(buck , i, ponder));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(args.length == <span class="number">3</span> &amp;&amp; args[<span class="number">2</span>].equals(<span class="string">"timeout"</span>))&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Press ‘Enter’ to quit"</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-32"><a href="#Exercise-32" class="headerlink" title="Exercise 32"></a>Exercise 32</h4><ul>
<li><strong>Exercise 32</strong>: (7) Use a CountDownLatch to solve the problem of correlating the results from the Entrances in OrnamentalGarden.java. Remove the unnecessary code from the new version of the example.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  主测试线程会创建所有旋转门线程和一个总的控制线程。</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise32</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  静态成员</span><br><span class="line">     */</span></span><br><span class="line">    <span class="comment">//探测器容器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Entrance&gt; entrances = <span class="keyword">new</span> ArrayList&lt;Entrance&gt;();</span><br><span class="line">    <span class="comment">//静态计算总次数系统，因为和非静态成员CountDownLatch无关</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">sumEntrances</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Entrance entrance : entrances)&#123;</span><br><span class="line">            count += entrance.getValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTotalCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  非静态成员。关键就是初始化本次实验的探测器的总数。</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch latch;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> entranceNum;</span><br><span class="line">    <span class="keyword">private</span> Runnable sumCounter;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exercise32</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        latch=<span class="keyword">new</span> CountDownLatch(num);</span><br><span class="line">        entranceNum=num;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">this</span>).start();   <span class="comment">//构造器运行实验</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Press Entry key to stop!"</span>);</span><br><span class="line">        ExecutorService execSum=Executors.newCachedThreadPool();</span><br><span class="line">        ExecutorService execEntrance = Executors.newCachedThreadPool();</span><br><span class="line">        execSum.execute(<span class="keyword">new</span> SumCounter()); <span class="comment">//总数统计线程</span></span><br><span class="line">        execSum.shutdown();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entranceNum; i++)&#123;   <span class="comment">//每个旋转门的计数线程</span></span><br><span class="line">            execEntrance.execute(<span class="keyword">new</span> Entrance(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(ioe);</span><br><span class="line">        &#125;</span><br><span class="line">        execEntrance.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  不能是静态套嵌类，因为还是依赖于外部总控制器实例的latch。</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Entrance</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> number = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Entrance</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">            entrances.add(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                        ++number;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="keyword">this</span>);</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>+<span class="string">"Sleep interrupted"</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"Stopping "</span> + <span class="keyword">this</span>);</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> number; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Entrance "</span> + id + <span class="string">": "</span> + getValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SumCounter</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                latch.await();</span><br><span class="line">                sumEntrances();</span><br><span class="line">                System.out.println(<span class="string">"------------------------"</span>);</span><br><span class="line">                System.out.println(<span class="string">"TOTAL:  "</span>+count);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Summer interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Exercise32 ex=<span class="keyword">new</span> Exercise32(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-33"><a href="#Exercise-33" class="headerlink" title="Exercise 33"></a>Exercise 33</h4><ul>
<li><strong>Exercise 33</strong>: (7) Modify GreenhouseScheduler.java so that it uses a DelayQueue instead of a ScheduledExecutor.</li>
</ul>
<p>所有任务都继承Delayed接口，插入DelayQueue。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise33</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  传统任务</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> light = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> water = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> String thermostat = <span class="string">"Day"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">getThermostat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> thermostat;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setThermostat</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        thermostat = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//delayed task</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Delayed</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> trigger;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DelayedTask</span><span class="params">(<span class="keyword">long</span> time)</span></span>&#123;trigger=time;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> unit.convert(trigger-System.nanoTime(),unit);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed arg)</span></span>&#123;</span><br><span class="line">            DelayedTask dt=(DelayedTask)arg;</span><br><span class="line">            <span class="keyword">if</span>(trigger&lt;dt.trigger)&#123;<span class="keyword">return</span> -<span class="number">1</span>;&#125;</span><br><span class="line">            <span class="keyword">if</span>(trigger&gt;dt.trigger)&#123;<span class="keyword">return</span> <span class="number">1</span>;&#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">(<span class="keyword">long</span> nanoTime)</span></span>&#123;</span><br><span class="line">            trigger=System.nanoTime()+nanoTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//delayed events</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LightOn</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LightOn</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Turning on lights"</span>);</span><br><span class="line">            light = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LightOff</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LightOff</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Turning off lights"</span>);</span><br><span class="line">            light = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WaterOn</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WaterOn</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Turning greenhouse water on"</span>);</span><br><span class="line">            water = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WaterOff</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WaterOff</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Turning greenhouse water off"</span>);</span><br><span class="line">            water = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ThermostatNight</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThermostatNight</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Thermostat to night setting"</span>);</span><br><span class="line">            setThermostat(<span class="string">"Night"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ThermostatDay</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ThermostatDay</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Thermostat to day setting"</span>);</span><br><span class="line">            setThermostat(<span class="string">"Day"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Bell</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Bell</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">"Bing!"</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Terminate</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Terminate</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Terminating"</span>);</span><br><span class="line">            es.shutdownNow();</span><br><span class="line">            System.out.println(<span class="string">"Executor shutdown!"</span>);</span><br><span class="line">            <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span>(DataPoint d : data)</span><br><span class="line">                        System.out.println(d);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//delay Queue</span></span><br><span class="line">    <span class="keyword">private</span> DelayQueue&lt;DelayedTask&gt; dq=<span class="keyword">new</span> DelayQueue&lt;DelayedTask&gt;();</span><br><span class="line">    <span class="keyword">private</span> ExecutorService es=Executors.newCachedThreadPool();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">getExecutor</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> es;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTask</span><span class="params">(DelayedTask dt)</span></span>&#123;</span><br><span class="line">        dq.put(dt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduled</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> num=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(dq.size()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                    es.execute((Runnable)dq.take());</span><br><span class="line">                    System.out.println(<span class="string">"Thread#"</span>+num);</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    num++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            es.shutdownNow();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Executor interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Executor exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">repeat</span><span class="params">(<span class="keyword">int</span> times)</span></span>&#123;</span><br><span class="line">        Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=times;i++)&#123;</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">                    DelayedTask task=dq.take();</span><br><span class="line">                    es.execute((Runnable)task);</span><br><span class="line">                    System.out.println(<span class="string">"Thread#"</span>+i);</span><br><span class="line">                    task.reset((<span class="keyword">long</span>)(rand.nextInt(<span class="number">5000</span>)));</span><br><span class="line">                    dq.put(task);</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            es.shutdownNow();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Executor interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Executor exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  新功能：数据收集</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DataPoint</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Calendar time;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> temperature;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> humidity;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataPoint</span><span class="params">(Calendar d, <span class="keyword">float</span> temp, <span class="keyword">float</span> hum)</span> </span>&#123;</span><br><span class="line">            time = d;</span><br><span class="line">            temperature = temp;</span><br><span class="line">            humidity = hum;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> time.getTime() +</span><br><span class="line">            String.format(<span class="string">" temperature: %1$.1f humidity: %2$.2f"</span>,temperature, humidity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Calendar lastTime = Calendar.getInstance();</span><br><span class="line">    &#123; <span class="comment">// Adjust date to the half hour</span></span><br><span class="line">        lastTime.set(Calendar.MINUTE, <span class="number">30</span>);</span><br><span class="line">        lastTime.set(Calendar.SECOND, <span class="number">00</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> lastTemp = <span class="number">65.0f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tempDirection = +<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> lastHumidity = <span class="number">50.0f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> humidityDirection = +<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line">    List&lt;DataPoint&gt; data = Collections.synchronizedList(<span class="keyword">new</span> ArrayList&lt;DataPoint&gt;());</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CollectData</span> <span class="keyword">extends</span> <span class="title">DelayedTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CollectData</span><span class="params">(<span class="keyword">long</span> delay)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"Collecting data"</span>);</span><br><span class="line">            <span class="keyword">synchronized</span>(Exercise33.<span class="keyword">this</span>) &#123;</span><br><span class="line">                lastTime.set(Calendar.MINUTE,lastTime.get(Calendar.MINUTE) + <span class="number">30</span>);</span><br><span class="line">                <span class="keyword">if</span>(rand.nextInt(<span class="number">5</span>) == <span class="number">4</span>)&#123;</span><br><span class="line">                    tempDirection = -tempDirection;</span><br><span class="line">                &#125;</span><br><span class="line">                lastTemp = lastTemp + tempDirection * (<span class="number">1.0f</span> + rand.nextFloat());</span><br><span class="line">                <span class="keyword">if</span>(rand.nextInt(<span class="number">5</span>) == <span class="number">4</span>)&#123;</span><br><span class="line">                    humidityDirection = -humidityDirection;</span><br><span class="line">                &#125;</span><br><span class="line">                lastHumidity = lastHumidity + humidityDirection * rand.nextFloat();</span><br><span class="line">                data.add(<span class="keyword">new</span> DataPoint((Calendar)lastTime.clone(),lastTemp, lastHumidity));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Exercise33 ex=<span class="keyword">new</span> Exercise33();</span><br><span class="line">        <span class="comment">//ex.setTask(ex.new Terminate(5000));</span></span><br><span class="line">        ex.setTask(ex.new Bell(<span class="number">1000</span>));</span><br><span class="line">        ex.setTask(ex.new ThermostatNight(<span class="number">2000</span>));</span><br><span class="line">        ex.setTask(ex.new LightOn(<span class="number">200</span>));</span><br><span class="line">        ex.setTask(ex.new LightOff(<span class="number">400</span>));</span><br><span class="line">        ex.setTask(ex.new WaterOn(<span class="number">600</span>));</span><br><span class="line">        ex.setTask(ex.new WaterOff(<span class="number">800</span>));</span><br><span class="line">        ex.setTask(ex.new ThermostatDay(<span class="number">1400</span>));</span><br><span class="line">        ex.setTask(ex.new CollectData(<span class="number">500</span>));</span><br><span class="line">        ex.scheduled();</span><br><span class="line">        <span class="comment">//ex.repeat(20);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise34"><a href="#Exercise34" class="headerlink" title="Exercise34"></a>Exercise34</h4><ul>
<li><strong>Exercise 34</strong>: (1) Modify ExchangerDemo.java to use your own class instead of Fat.</li>
</ul>
<p>Exchanger有一个需要注意的地方：当一个线程提出交换的时候，如果它的patener线程已经提出了交换，那当前线程可以直接获得patener线程提供的对象，继续运行。这就是为什么练习34里，两个线程各持有10个盘子，但运行的结果是生产者先生产20个煎饼，然后消费者再吃20个煎饼。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise34</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ExchangerProducer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Generator&lt;T&gt; generator;</span><br><span class="line">        <span class="keyword">private</span> Exchanger&lt;List&lt;T&gt;&gt; exchanger;</span><br><span class="line">        <span class="keyword">private</span> List&lt;T&gt; holder;</span><br><span class="line">        ExchangerProducer(Exchanger&lt;List&lt;T&gt;&gt; exchg,Generator&lt;T&gt; gen, List&lt;T&gt; holder) &#123;</span><br><span class="line">            exchanger = exchg;</span><br><span class="line">            generator = gen;</span><br><span class="line">            <span class="keyword">this</span>.holder = holder;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Exercise34.size; i++)</span><br><span class="line">                        holder.add(generator.next());</span><br><span class="line">                    <span class="comment">// Exchange full for empty:</span></span><br><span class="line">                    holder = exchanger.exchange(holder);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Producer Thread interrupted!"</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"Producer Thread exit!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ExchangerConsumer</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Exchanger&lt;List&lt;T&gt;&gt; exchanger;</span><br><span class="line">        <span class="keyword">private</span> List&lt;T&gt; holder;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> T value;</span><br><span class="line">        ExchangerConsumer(Exchanger&lt;List&lt;T&gt;&gt; ex, List&lt;T&gt; holder)&#123;</span><br><span class="line">            exchanger = ex;</span><br><span class="line">            <span class="keyword">this</span>.holder = holder;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                    holder = exchanger.exchange(holder);</span><br><span class="line">                    <span class="keyword">for</span>(T x : holder) &#123;</span><br><span class="line">                        value = x; <span class="comment">// Fetch out value</span></span><br><span class="line">                        holder.remove(x); <span class="comment">// OK for CopyOnWriteArrayList</span></span><br><span class="line">                        System.out.println(x+<span class="string">" eaten!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Consumer Thread interrupted!"</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"Consumer Thread exit!"</span>);</span><br><span class="line">                System.out.println(<span class="string">"Final value: "</span> + value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pancake</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Pancake</span><span class="params">()</span></span>&#123;</span><br><span class="line">            id=++count;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" cooked!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Pancake#"</span>+id;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Generator</span>&lt;<span class="title">T</span>&gt;</span>&#123;<span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span></span>;&#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Oven</span> <span class="keyword">implements</span> <span class="title">Generator</span>&lt;<span class="title">Pancake</span>&gt;</span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Pancake <span class="title">next</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Pancake();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> size = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> delay = <span class="number">5</span>; <span class="comment">// Seconds</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            size = <span class="keyword">new</span> Integer(args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(args.length &gt; <span class="number">1</span>)&#123;</span><br><span class="line">            delay = <span class="keyword">new</span> Integer(args[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        Exercise34 ex=<span class="keyword">new</span> Exercise34();</span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">        Exchanger&lt;List&lt;Pancake&gt;&gt; xc = <span class="keyword">new</span> Exchanger&lt;List&lt;Pancake&gt;&gt;();</span><br><span class="line">        List&lt;Pancake&gt;</span><br><span class="line">        producerPlate = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Pancake&gt;(),</span><br><span class="line">        consumerPlate = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Pancake&gt;();</span><br><span class="line">        exec.execute(ex.new ExchangerProducer&lt;Pancake&gt;(xc,ex.new Oven(), producerPlate));</span><br><span class="line">        exec.execute(ex.new ExchangerConsumer&lt;Pancake&gt;(xc,consumerPlate));</span><br><span class="line">        TimeUnit.SECONDS.sleep(delay);</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-35"><a href="#Exercise-35" class="headerlink" title="Exercise 35"></a>Exercise 35</h4><ul>
<li><strong>Exercise 35</strong>: (8) Modify BankTellerSimulation.java so that it represents Web clients making requests of a fixed number of servers. The goal is to determine the load that the group of servers can handle.</li>
</ul>
<p>WebClient只要连接申请队列没有满，就一直加快创建新申请的频率。最后稳定下来的频率就是对方WebServer的最大连接申请吞吐量。</p>
<h5 id="WebClient-java"><a href="#WebClient-java" class="headerlink" title="WebClient.java"></a>WebClient.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebClient</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="comment">//web请求</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> serviceTime;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(<span class="keyword">int</span> tm)</span> </span>&#123; serviceTime = tm; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getServiceTime</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> serviceTime; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"["</span> + serviceTime + <span class="string">"]"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//web请求队列</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestLine</span> <span class="keyword">extends</span> <span class="title">ArrayBlockingQueue</span>&lt;<span class="title">Request</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxSize;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RequestLine</span><span class="params">(<span class="keyword">int</span> maxLineSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(maxLineSize);</span><br><span class="line">            maxSize=maxLineSize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMax</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> maxSize;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"[Empty]"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span>(Request r : <span class="keyword">this</span>)&#123;</span><br><span class="line">                result.append(r);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//web请求生成器，自动根据服务器吞吐量调节生成频率。</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestGenerator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> period=<span class="number">100</span>;    <span class="comment">//初始频率，每秒一个请求</span></span><br><span class="line">        <span class="keyword">private</span> RequestLine requests;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RequestGenerator</span><span class="params">(RequestLine rq)</span> </span>&#123;</span><br><span class="line">            requests = rq;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(rand.nextInt(period));</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        requests.add(<span class="keyword">new</span> Request(rand.nextInt(<span class="number">1000</span>)));</span><br><span class="line">                        <span class="keyword">if</span>(period&gt;<span class="number">1</span>)&#123;</span><br><span class="line">                            period-=<span class="number">1</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(IllegalStateException  ise)&#123;    <span class="comment">//队列满了</span></span><br><span class="line">                        period+=<span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"CustomerGenerator interrupted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"CustomerGenerator terminating"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">showBalance</span><span class="params">()</span></span>&#123;</span><br><span class="line">            StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">float</span> freq=<span class="number">1000</span>/(<span class="keyword">float</span>)period;</span><br><span class="line">            String str=String.format(<span class="string">"%.2f"</span>,freq);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;(<span class="keyword">int</span>)(freq);i++)&#123;</span><br><span class="line">                sb=sb.append(<span class="string">"+"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.append(<span class="string">" "</span>+str).toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="WebServer-java"><a href="#WebServer-java" class="headerlink" title="WebServer.java"></a>WebServer.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebServer</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> handlerCounter = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//银行出纳，web请求处理器</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Comparable</span>&lt;<span class="title">RequestHandler</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id = handlerCounter++;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> requestServed = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> WebClient.RequestLine requests;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> servingRequestLine = <span class="keyword">true</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RequestHandler</span><span class="params">(WebClient.RequestLine rq)</span> </span>&#123; requests = rq; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                    WebClient.Request r = requests.take();</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(r.getServiceTime());</span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                        requestServed++;</span><br><span class="line">                        <span class="keyword">while</span>(!servingRequestLine)&#123;</span><br><span class="line">                            wait();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span> + <span class="string">"interrupted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="keyword">this</span> + <span class="string">"terminating"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">hangs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            requestServed = <span class="number">0</span>;</span><br><span class="line">            servingRequestLine = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">serveRequestLine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">assert</span> !servingRequestLine:<span class="string">"already serving: "</span> + <span class="keyword">this</span>;</span><br><span class="line">            servingRequestLine = <span class="keyword">true</span>;</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Request Handler  "</span> + id + <span class="string">" "</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">shortString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"H"</span> + id; &#125;</span><br><span class="line">        <span class="comment">// Used by priority queue:</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(RequestHandler other)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> requestServed &lt; other.requestServed ? -<span class="number">1</span> : (requestServed == other.requestServed ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//银行经理控制出纳数量，服务器大脑负载调节器</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> ExecutorService exec;</span><br><span class="line">        <span class="keyword">private</span> WebClient.RequestLine requests;</span><br><span class="line">        <span class="keyword">private</span> PriorityQueue&lt;RequestHandler&gt; workingHandlers = <span class="keyword">new</span> PriorityQueue&lt;RequestHandler&gt;();</span><br><span class="line">        <span class="keyword">private</span> Queue&lt;RequestHandler&gt; handlersDoingOtherThings = <span class="keyword">new</span> LinkedList&lt;RequestHandler&gt;();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> adjustmentPeriod;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxHandler;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Server</span><span class="params">(ExecutorService e, WebClient.RequestLine requests, <span class="keyword">int</span> adjustmentPeriod, <span class="keyword">int</span> maxHandler)</span> </span>&#123;</span><br><span class="line">            exec = e;</span><br><span class="line">            <span class="keyword">this</span>.requests = requests;</span><br><span class="line">            <span class="keyword">this</span>.adjustmentPeriod = adjustmentPeriod;</span><br><span class="line">            <span class="keyword">this</span>.maxHandler=maxHandler;</span><br><span class="line">            <span class="comment">// Start with a single handler:</span></span><br><span class="line">            RequestHandler handler= <span class="keyword">new</span> RequestHandler(requests);</span><br><span class="line">            exec.execute(handler);</span><br><span class="line">            workingHandlers.add(handler);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHandlerNumber</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> workingHandlers.size()+handlersDoingOtherThings.size();&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adjustHandlerNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// This is actually a control system. By adjusting</span></span><br><span class="line">            <span class="comment">// the numbers, you can reveal stability issues in</span></span><br><span class="line">            <span class="comment">// the control mechanism.</span></span><br><span class="line">            <span class="comment">// If line is too long, add another handler:</span></span><br><span class="line">            <span class="keyword">if</span>(requests.size() / (<span class="keyword">float</span>)requests.getMax() &gt; <span class="number">0.5f</span>) &#123;</span><br><span class="line">                <span class="comment">// If handlers are on break or doing</span></span><br><span class="line">                <span class="comment">// another job, bring one back:</span></span><br><span class="line">                <span class="keyword">if</span>(handlersDoingOtherThings.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    RequestHandler handler = handlersDoingOtherThings.remove();</span><br><span class="line">                    handler.serveRequestLine();</span><br><span class="line">                    workingHandlers.offer(handler);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Else start a new request handler</span></span><br><span class="line">                <span class="keyword">if</span>(workingHandlers.size()&lt;maxHandler)&#123;</span><br><span class="line">                    RequestHandler handler = <span class="keyword">new</span> RequestHandler(requests);</span><br><span class="line">                    exec.execute(handler);</span><br><span class="line">                    workingHandlers.add(handler);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If line is short enough, remove a handler:</span></span><br><span class="line">            <span class="keyword">if</span>(workingHandlers.size() &gt; <span class="number">1</span> &amp;&amp; requests.size() / (<span class="keyword">float</span>)requests.getMax() &lt; <span class="number">0.5f</span>)&#123;</span><br><span class="line">                reassignOneHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If there is no line, we only need one handler:</span></span><br><span class="line">            <span class="keyword">if</span>(requests.size() == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">while</span>(workingHandlers.size() &gt; <span class="number">1</span>)&#123;</span><br><span class="line">                    reassignOneHandler();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Give a request handler a different job or a break:</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reassignOneHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            RequestHandler handler = workingHandlers.poll();</span><br><span class="line">            handler.hangs();</span><br><span class="line">            handlersDoingOtherThings.offer(handler);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted()) &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(adjustmentPeriod);</span><br><span class="line">                    adjustHandlerNumber();</span><br><span class="line">                    <span class="comment">/**</span><br><span class="line">                    System.out.print(requests + " &#123; ");</span><br><span class="line">                    for(RequestHandler handler : workingHandlers)</span><br><span class="line">                        System.out.print(handler.shortString() + " ");</span><br><span class="line">                    System.out.println("&#125;");</span><br><span class="line">                     */</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span> + <span class="string">"interrupted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="keyword">this</span> + <span class="string">"terminating"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"["</span>+workingHandlers.size()+<span class="string">"/"</span>+handlersDoingOtherThings.size()+<span class="string">"/"</span>+maxHandler+<span class="string">"]"</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise35-java"><a href="#Exercise35-java" class="headerlink" title="Exercise35.java"></a>Exercise35.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise35</span> </span>&#123;</span><br><span class="line">    <span class="comment">//准备运行测试</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_LINE_SIZE = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ADJUSTMENT_PERIOD = <span class="number">100</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">// If line is too long, customers will leave:</span></span><br><span class="line">        WebClient.RequestLine requests = <span class="keyword">new</span> WebClient.RequestLine(MAX_LINE_SIZE);</span><br><span class="line">        WebClient.RequestGenerator gen=<span class="keyword">new</span> WebClient.RequestGenerator(requests);</span><br><span class="line">        exec.execute(gen);</span><br><span class="line">        <span class="comment">// Manager will add and remove tellers as necessary:</span></span><br><span class="line">        WebServer.Server server=<span class="keyword">new</span> WebServer.Server(exec, requests, ADJUSTMENT_PERIOD, <span class="number">30</span>);</span><br><span class="line">        exec.execute(server);</span><br><span class="line">        <span class="comment">// print the result</span></span><br><span class="line">        exec.execute(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                        TimeUnit.MILLISECONDS.sleep(<span class="number">20</span>);</span><br><span class="line">                        System.out.println(gen.showBalance()+<span class="string">" ["</span>+requests.size()+<span class="string">"/"</span>+MAX_LINE_SIZE+<span class="string">"]"</span>+server);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Print interrupted!"</span>);</span><br><span class="line">                &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                    System.out.println(<span class="string">"Printer exit!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span>(args.length &gt; <span class="number">0</span>)&#123; <span class="comment">// Optional argument</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="keyword">new</span> Integer(args[<span class="number">0</span>]));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"Press ‘Enter’ to quit"</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-36"><a href="#Exercise-36" class="headerlink" title="Exercise 36"></a>Exercise 36</h4><ul>
<li><strong>Exercise 36</strong>: (10) Modify RestaurantWithQueues.java so there’s one OrderTicket object per table. Change order to orderTicket, and add a Table class, with multiple Customers per table.</li>
</ul>
<p>十分题。做的时候，场景又更加被复杂化了一点。变成一道15分题。</p>
<h5 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h5><p>先说一下做这道题时体会到的几条设计原则：</p>
<ul>
<li>设计首先要搞清楚要做什么。明确整件事的整体流程，脉络。</li>
<li>整体非常复杂的情况下，可以先分开设计各个局部的细节。</li>
<li>局部细节可以从各个不同的角度。一点点勾画出整体。</li>
<li>最后把各个细化了的局部拼接起来成为一个整体。（比如这题的关键，就是几个局部间起串联作用的BlockingQueue。）</li>
<li>除了从整体到局部，再到整体的三步走，也可以先从最简单的功能开始，一点点扩展功能。</li>
<li>扩展功能的设计方法的关键，在于每一步都要实际运行测试。保证一步一个脚印，系统健壮。（比如这题分成：等座系统+点菜系统+做菜系统+上菜系统+价格系统。一层层往上拼装。）</li>
</ul>
<h5 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h5><p>餐馆的整体大致流程如下：</p>
<ol>
<li>每1微秒来个客人。</li>
<li>客人先在TableQueue排队找座位。每个桌子的位置有限。</li>
<li>客人找到座位后，方可进入ServiceQueue。等服务员过来点菜。</li>
<li>ServiceQueue另一头，是服务员。按照FIFO顺序接待点餐。</li>
<li>每个客人依次点：前菜，正餐，甜点，咖啡，四份食物（枚举型预先定义好），每份都是一个Order。4个Order写在一个OrderTicket里。客人点完菜，就等着吃。</li>
<li>服务员把点餐小票OrderTicket加到OrderQueue里排队。</li>
<li>OrderQueue另一头，厨师按FIFO从OrderQueue拿点餐小票做菜。厨师每做一个菜，花1微秒。直到4个菜都做完，拿下个小票。</li>
<li>每个做完的菜叫一个Plate。进入PlateQueue。</li>
<li>服务员会同时监听PlateQueue。准备为客人上菜。</li>
<li>每个客人都只有一个餐位。同时只能吃一道菜。菜要一道一道吃。</li>
<li>上菜拿到手，客人要和小票核对菜有没有上错。</li>
<li>吃完所有4道菜，客人付钱。</li>
<li>客人离开。</li>
</ol>
<h5 id="局部细描"><a href="#局部细描" class="headerlink" title="局部细描"></a>局部细描</h5><ul>
<li>客人：Client类。等座，等点餐，等上菜，吃菜，付账，离开。反向依赖注入：客人包含Restaurant类，OrderTicket类。同时也组合，餐位SpaceQueue。</li>
<li>服务员：WaitPerson类。监听客人点餐。监听上菜。反向依赖注入：服务员包含Restaurant类，OrderTicket类。和TableQueue,ServiceQueue,OrderQueue,PlateQueue,SpaceQueue打交道。</li>
<li>厨师：Chef类。等点餐小票OrderTicket，做菜。反向依赖注入：Restaurant类。和OrderQueue，PlateQueue交互。</li>
<li>小票：OrderTicket类。组合一个Order的列表。还要包括服务员，客人，餐桌的信息。</li>
<li>每个点餐：Order类。每个点餐就包括Food信息。</li>
<li>餐桌： Table类。简单的能坐几个人。</li>
<li>食物：Food类和Course类。枚举出食物。</li>
<li>餐馆：Restaurant类。最宏观的类。包含一切：桌子，厨师，服务员。还有TableQueue,ServiceQueue,OrderQueue,PlateQueue,SpaceQueue这些队列。</li>
</ul>
<p>线程：</p>
<ul>
<li>每个客人是一个单独的线程。</li>
<li>每个服务员是一个单独线程。</li>
<li>每个厨师是一个单独线程。</li>
<li>餐馆是一个主线程，启动以上所有的客人，服务员和厨师的线程。</li>
</ul>
<p>模块拆分（这次运用了层层增加功能的扩展法）：</p>
<ul>
<li>第一步定义枚举型菜品：Food类和Course类。然后写一个随机菜品生成器。</li>
<li>最简单的客人等座系统。客人排队TableQueue，找到一个座位后报告他找到座位了。</li>
<li>在等座系统基础上，加上点菜系统。找到座位后客人在ServiceQueue等着。服务员监听ServiceQueue来帮客人点菜。点完菜报告点的什么菜。</li>
<li>在前两步基础上再加入厨师做菜系统。服务员的点单小票加入OrderQueue。厨师按顺序拿小票做菜。做完报告什么菜好了。</li>
<li>再加上服务员上菜系统：厨师做好的菜加入PlateQueue。服务员监听PlateQueue，拿到做好的Plate然后上菜，加入SpaceQueue，客人一个一个菜吃过来，检查上菜有没有错，对的话报告吃了什么菜。</li>
<li>最后加入价格系统。每个菜有个价格。每张小票要计算总价格。客人吃完所有菜，付钱，走人。</li>
</ul>
<h5 id="整体整合"><a href="#整体整合" class="headerlink" title="整体整合"></a>整体整合</h5><p>所有的客人，服务员，厨师线程，通过TableQueue,ServiceQueue,OrderQueue,PlateQueue,SpaceQueue几个同步带锁队列同步互动。不需要再加独占锁。</p>
<p>检查会不会有死锁的情况。比如服务员在监听客人排队点餐，和监听上菜队列时，如果阻塞，有可能导致死锁。因为如果点菜时阻塞：当没新客人的时候服务员死等，会死锁，永远不上菜。如果监听上菜时死锁：新客人都在排队，厨师就没菜做，服务员等厨师就是死锁。</p>
<p>所以最后，服务员在ServiceQueue和PlateQueue两个队列上只是轮询忙等，不阻塞。</p>
<h5 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h5><h6 id="Food36-java"><a href="#Food36-java" class="headerlink" title="Food36.java"></a>Food36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Food36</span> </span>&#123;   <span class="comment">//两层枚举的第一层</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">enum</span> Appetizer implements Food36 &#123;</span><br><span class="line">        SALAD(<span class="number">15.5f</span>), SOUP(<span class="number">10.8f</span>), SPRING_ROLLS(<span class="number">8.8f</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> price=<span class="number">0.0f</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Appetizer</span><span class="params">(<span class="keyword">float</span> p)</span></span>&#123;price=p;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> EnumPrinter.getText(<span class="keyword">this</span>)+<span class="string">"("</span>+price+<span class="string">")"</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> price;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> MainCourse implements Food36 &#123;</span><br><span class="line">        LASAGNE(<span class="number">28.5f</span>), BURRITO(<span class="number">35.9f</span>), PAD_THAI(<span class="number">16.9f</span>),</span><br><span class="line">        LENTILS(<span class="number">21.0f</span>), HUMMOUS(<span class="number">12.5f</span>), VINDALOO(<span class="number">39.9f</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> price=<span class="number">0.0f</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">MainCourse</span><span class="params">(<span class="keyword">float</span> p)</span></span>&#123;price=p;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> EnumPrinter.getText(<span class="keyword">this</span>)+<span class="string">"("</span>+price+<span class="string">")"</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> price;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> Dessert implements Food36 &#123;</span><br><span class="line">        TIRAMISU(<span class="number">9.9f</span>), GELATO(<span class="number">5.6f</span>), BLACK_FOREST_CAKE(<span class="number">8.7f</span>),</span><br><span class="line">        FRUIT(<span class="number">15.5f</span>), CREME_CARAMEL(<span class="number">5.5f</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> price=<span class="number">0.0f</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Dessert</span><span class="params">(<span class="keyword">float</span> p)</span></span>&#123;price=p;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> EnumPrinter.getText(<span class="keyword">this</span>)+<span class="string">"("</span>+price+<span class="string">")"</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> price;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> Coffee implements Food36 &#123;</span><br><span class="line">        BLACK_COFFEE(<span class="number">6.5f</span>), DECAF_COFFEE(<span class="number">4.3f</span>), ESPRESSO(<span class="number">5.0f</span>),</span><br><span class="line">        LATTE(<span class="number">3.1f</span>), CAPPUCCINO(<span class="number">4.3f</span>), TEA(<span class="number">2.8f</span>), HERB_TEA(<span class="number">3.0f</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">float</span> price=<span class="number">0.0f</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Coffee</span><span class="params">(<span class="keyword">float</span> p)</span></span>&#123;price=p;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> EnumPrinter.getText(<span class="keyword">this</span>)+<span class="string">"("</span>+price+<span class="string">")"</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> price;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumPrinter</span></span>&#123;   <span class="comment">//依赖注入</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getText</span><span class="params">(Enum e)</span></span>&#123;<span class="keyword">return</span> <span class="string">"["</span>+e.getClass().getSimpleName()+<span class="string">"-"</span>+e.name()+<span class="string">"]"</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(Appetizer.SALAD);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Course36-java"><a href="#Course36-java" class="headerlink" title="Course36.java"></a>Course36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Course36 &#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  枚举工厂：两层枚举的第二层</span><br><span class="line">     */</span></span><br><span class="line">    APPETIZER(Food36.Appetizer.class),</span><br><span class="line">    MAINCOURSE(Food36.MainCourse.class),</span><br><span class="line">    DESSERT(Food36.Dessert.class),</span><br><span class="line">    COFFEE(Food36.Coffee.class);</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  抽象构造</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> Food36[] values;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Course36</span><span class="params">(Class&lt;? extends Food36&gt; kind)</span> </span>&#123;</span><br><span class="line">        values = kind.getEnumConstants();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food36 <span class="title">randomFood</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> values[rand.nextInt(values.length)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  对象管理</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Course36 <span class="title">randomType</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> values()[rand.nextInt(values().length)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food36 <span class="title">random</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> randomType().randomFood();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food36 <span class="title">randomAppet</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> APPETIZER.randomFood();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food36 <span class="title">randomMain</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MAINCOURSE.randomFood();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food36 <span class="title">randomDessert</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DESSERT.randomFood();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Food36 <span class="title">randomCoffee</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> COFFEE.randomFood();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Food36 food=Course36.random();</span><br><span class="line">        System.out.println(food);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Order36-java"><a href="#Order36-java" class="headerlink" title="Order36.java"></a>Order36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order36</span> <span class="keyword">extends</span> <span class="title">Thing36</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Order"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id+<span class="string">" "</span>+food;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Food36 food;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderTicket36 ticket;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order36</span><span class="params">(Food36 f, OrderTicket36 t)</span></span>&#123;</span><br><span class="line">        food=f;</span><br><span class="line">        ticket=t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food36 <span class="title">getFood</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> food;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderTicket36 <span class="title">getTicket</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> ticket;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getPrice</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> food.getPrice();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="OrderTicket36-java"><a href="#OrderTicket36-java" class="headerlink" title="OrderTicket36.java"></a>OrderTicket36.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderTicket36</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Order ticket"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Order36&gt; orders=<span class="keyword">new</span> ArrayList&lt;Order36&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Table36 table;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Client36 client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WaitPerson36 waiter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> totalPrice=<span class="number">0.0f</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderTicket36</span><span class="params">(Table36 t, Client36 c, WaitPerson36 w)</span></span>&#123;</span><br><span class="line">        table=t;</span><br><span class="line">        client=c;</span><br><span class="line">        waiter=w;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderTicket36</span><span class="params">(Client36 c, WaitPerson36 w)</span></span>&#123;</span><br><span class="line">        table=c.getTable();</span><br><span class="line">        client=c;</span><br><span class="line">        waiter=w;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Table36 <span class="title">getTable</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> table;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Client36 <span class="title">getClient</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> client;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getTotalPrice</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> totalPrice;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> WaitPerson36 <span class="title">getWaiter</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> waiter;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOrder</span><span class="params">(Order36 order)</span></span>&#123;</span><br><span class="line">        orders.add(order);</span><br><span class="line">        totalPrice+=order.getPrice();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order36&gt; <span class="title">getOrders</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> orders;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readTicket</span><span class="params">()</span></span>&#123;</span><br><span class="line">        StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(client+<span class="string">" wants to eat: "</span>);</span><br><span class="line">        <span class="keyword">for</span>(Order36 order:orders)&#123;</span><br><span class="line">            sb.append(order.toString()+<span class="string">"; "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Table36-java"><a href="#Table36-java" class="headerlink" title="Table36.java"></a>Table36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Table36</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Table"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_CLIENT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> available;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Order36&gt; orderTicket;</span><br><span class="line">    <span class="keyword">private</span> Restaurant36 restaurant;    <span class="comment">//反向依赖注入</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Table36</span><span class="params">(<span class="keyword">int</span> size,Restaurant36 restaurant)</span></span>&#123;</span><br><span class="line">        MAX_CLIENT=size;</span><br><span class="line">        available=size;</span><br><span class="line">        orderTicket=<span class="keyword">new</span> LinkedBlockingQueue&lt;Order36&gt;();</span><br><span class="line">        <span class="keyword">this</span>.restaurant=restaurant;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>+<span class="string">" created! "</span>+left()+<span class="string">" seats in total!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">available</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> available&gt;<span class="number">0</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">left</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> available;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">oneSit</span><span class="params">(Client36 client)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!available())&#123;System.out.println(<span class="string">"Error, "</span>+<span class="keyword">this</span>+<span class="string">" not available for "</span>+client);<span class="keyword">return</span>;&#125;</span><br><span class="line">        --available;</span><br><span class="line">        <span class="keyword">if</span>(available())&#123;</span><br><span class="line">            restaurant.moreTable(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">oneLeave</span><span class="params">(Client36 client)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(available&gt;=MAX_CLIENT)&#123;System.out.println(<span class="string">"Error, no client on "</span>+<span class="keyword">this</span>+<span class="string">"!"</span>);<span class="keyword">return</span>;&#125;</span><br><span class="line">        ++available;</span><br><span class="line">        <span class="keyword">if</span>(available==<span class="number">1</span>)&#123;</span><br><span class="line">            restaurant.moreTable(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Table36 table=<span class="keyword">new</span> Table36(<span class="number">3</span>,<span class="keyword">new</span> Restaurant36(<span class="number">5</span>,<span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Plate36-java"><a href="#Plate36-java" class="headerlink" title="Plate36.java"></a>Plate36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Plate36</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Plate"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id+<span class="string">": "</span>+chef+<span class="string">"-&gt;"</span>+order;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Order36 order;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Chef36 chef;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Table36 table;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Plate36</span><span class="params">(Order36 o, Chef36 c, Table36 t)</span></span>&#123;</span><br><span class="line">        order=o;</span><br><span class="line">        chef=c;</span><br><span class="line">        table=t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order36 <span class="title">getOrder</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> order;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Chef36 <span class="title">getChef</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> chef;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Table36 <span class="title">getTable</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> table;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Client36-java"><a href="#Client36-java" class="headerlink" title="Client36.java"></a>Client36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client36</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Client"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Restaurant36 restaurant;    <span class="comment">//反向依赖注入</span></span><br><span class="line">    <span class="keyword">private</span> Table36 table=<span class="keyword">null</span>;  <span class="comment">//反向依赖注入</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> foundTable=<span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Client36&gt; serviceQueue;</span><br><span class="line">    <span class="keyword">private</span> SynchronousQueue&lt;Plate36&gt; hisSpace; <span class="comment">//普通组合。每个客人只有一个餐位，菜要一道一道吃。</span></span><br><span class="line">    <span class="keyword">private</span> OrderTicket36 ticket;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> finished;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Client36</span><span class="params">(Restaurant36 r)</span></span>&#123;</span><br><span class="line">        restaurant=r;</span><br><span class="line">        serviceQueue=r.getServiceQueue();</span><br><span class="line">        hisSpace=<span class="keyword">new</span> SynchronousQueue&lt;Plate36&gt;();</span><br><span class="line">        finished=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">lookForTable</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            table=restaurant.getTables().take();   <span class="comment">//访问同步阻塞队列</span></span><br><span class="line">            sit(table);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is interrupted in the queue of table!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">foundTable</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> table!=<span class="keyword">null</span>;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Table36 <span class="title">getTable</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> table;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlockingQueue&lt;Plate36&gt; <span class="title">getSpace</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> hisSpace;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">keepTicket</span><span class="params">(OrderTicket36 t)</span></span>&#123;ticket=t;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderTicket36 <span class="title">getTicket</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> ticket;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkOrder</span><span class="params">(Order36 o)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ticket==<span class="keyword">null</span>)&#123;<span class="keyword">return</span> <span class="keyword">false</span>;&#125;</span><br><span class="line">        <span class="keyword">return</span> ticket.getOrders().contains(o);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">sit</span><span class="params">(Table36 table)</span></span>&#123;</span><br><span class="line">        table.oneSit(<span class="keyword">this</span>);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>+<span class="string">" sit on "</span>+table+<span class="string">". "</span>+<span class="string">"["</span>+table.left()+<span class="string">" left]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">leave</span><span class="params">(Table36 table)</span></span>&#123;</span><br><span class="line">        table.oneLeave(<span class="keyword">this</span>);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>+<span class="string">" leave "</span>+table+<span class="string">". ["</span>+table.left()+<span class="string">" left]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">finishEat</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> finished==ticket.getOrders().size();&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ticket==<span class="keyword">null</span>)&#123;System.out.println(<span class="string">"Sorry, I didn't eat anything!"</span>);<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="keyword">if</span>(!finishEat())&#123;System.out.println(<span class="string">"Sorry, I didn't finish the dinner!"</span>);<span class="keyword">return</span>;&#125;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>+<span class="string">" Pay "</span>+ticket.getTotalPrice()+<span class="string">". Bye-Bye!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//look for table</span></span><br><span class="line">            lookForTable();</span><br><span class="line">            <span class="comment">//wait in serviceQueue</span></span><br><span class="line">            serviceQueue.put(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">//等点餐小票</span></span><br><span class="line">            <span class="keyword">while</span>(ticket==<span class="keyword">null</span>)&#123;</span><br><span class="line">                Thread.yield();</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//等着上菜</span></span><br><span class="line">            <span class="keyword">while</span>(!finishEat())&#123;</span><br><span class="line">                Plate36 plate=hisSpace.take();  <span class="comment">//阻塞</span></span><br><span class="line">                <span class="keyword">if</span>(checkOrder(plate.getOrder()))&#123;</span><br><span class="line">                    System.out.println(<span class="keyword">this</span>+<span class="string">" is eating "</span>+plate+<span class="string">"..."</span>);</span><br><span class="line">                    finished++;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//吃完再付账</span></span><br><span class="line">            pay();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" Eat interrupted!"</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="comment">//leave table。不管吃没吃完都要走。</span></span><br><span class="line">            <span class="keyword">if</span>(foundTable())&#123;</span><br><span class="line">                leave(table);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(Course36.random());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="WaitPerson36-java"><a href="#WaitPerson36-java" class="headerlink" title="WaitPerson36.java"></a>WaitPerson36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitPerson36</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Wait Person"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Restaurant36 restaurant;    <span class="comment">//反向依赖注入</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Client36&gt; serviceQueue;    <span class="comment">//反向依赖注入</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;OrderTicket36&gt; orderQueue;    <span class="comment">//反向依赖注入</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Plate36&gt; plateQueue;  <span class="comment">//反向依赖注入</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WaitPerson36</span><span class="params">(Restaurant36 r)</span></span>&#123;</span><br><span class="line">        restaurant=r;</span><br><span class="line">        serviceQueue=restaurant.getServiceQueue();</span><br><span class="line">        orderQueue=restaurant.getOrderQueue();</span><br><span class="line">        plateQueue=restaurant.getPlateQueue();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                <span class="comment">//点菜</span></span><br><span class="line">                Client36 client=serviceQueue.poll(<span class="number">1</span>,TimeUnit.MILLISECONDS);    <span class="comment">//不阻塞，等1微秒(否则没新客人的时候服务员死等，会死锁，永远不上菜。)</span></span><br><span class="line">                <span class="keyword">if</span>(client!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    OrderTicket36 ticket=<span class="keyword">new</span> OrderTicket36(client,<span class="keyword">this</span>);</span><br><span class="line">                    ticket.addOrder(<span class="keyword">new</span> Order36(Course36.randomAppet(),ticket));</span><br><span class="line">                    ticket.addOrder(<span class="keyword">new</span> Order36(Course36.randomMain(),ticket));</span><br><span class="line">                    ticket.addOrder(<span class="keyword">new</span> Order36(Course36.randomDessert(),ticket));</span><br><span class="line">                    ticket.addOrder(<span class="keyword">new</span> Order36(Course36.randomCoffee(),ticket));</span><br><span class="line">                    System.out.println(ticket.readTicket());</span><br><span class="line">                    orderQueue.put(ticket); <span class="comment">//无界队列，不阻塞</span></span><br><span class="line">                    client.keepTicket(ticket);</span><br><span class="line">                &#125;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//上菜</span></span><br><span class="line">                Plate36 plate=plateQueue.poll(<span class="number">1</span>,TimeUnit.MILLISECONDS); <span class="comment">//不阻塞，等1微秒（否则，新客人都在排队，厨师就没菜做，服务员等厨师就是死锁。）</span></span><br><span class="line">                <span class="keyword">if</span>(plate!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    Client36 client2=plate.getOrder().getTicket().getClient();</span><br><span class="line">                    client2.getSpace().put(plate);    <span class="comment">//阻塞。不会死锁。</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" Service Interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Chef36-java"><a href="#Chef36-java" class="headerlink" title="Chef36.java"></a>Chef36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chef36</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Chef"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Restaurant36 restaurant;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;OrderTicket36&gt; orders;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Plate36&gt; plates;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Chef36</span><span class="params">(Restaurant36 r)</span></span>&#123;</span><br><span class="line">        restaurant=r;</span><br><span class="line">        orders=restaurant.getOrderQueue();</span><br><span class="line">        plates=restaurant.getPlateQueue();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                OrderTicket36 ticket=orders.take(); <span class="comment">//阻塞</span></span><br><span class="line">                List&lt;Order36&gt; list=ticket.getOrders();</span><br><span class="line">                <span class="keyword">for</span>(Order36 order:list)&#123;</span><br><span class="line">                    Plate36 plate=<span class="keyword">new</span> Plate36(order,<span class="keyword">this</span>,ticket.getTable());</span><br><span class="line">                    plates.put(plate);   <span class="comment">//无界队列，不阻塞</span></span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    System.out.println(plate+<span class="string">" for "</span>+ticket.getClient()+<span class="string">"at "</span>+ticket.getTable()+<span class="string">" prepared!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Restaurant36-java"><a href="#Restaurant36-java" class="headerlink" title="Restaurant36.java"></a>Restaurant36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Restaurant36</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++count;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name=<span class="string">"Restaurant"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name+<span class="string">" #"</span>+id;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tableNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tableSize;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Table36&gt; tables;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Client36&gt; serviceQueue;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;OrderTicket36&gt; orderQueue;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Plate36&gt; plateQueue;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Restaurant36</span><span class="params">(<span class="keyword">int</span> tableNum, <span class="keyword">int</span> tableSize)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tableNum=tableNum;</span><br><span class="line">        <span class="keyword">this</span>.tableSize=tableSize;</span><br><span class="line">        tables=<span class="keyword">new</span> ArrayBlockingQueue&lt;Table36&gt;(tableNum);</span><br><span class="line">        serviceQueue=<span class="keyword">new</span> LinkedBlockingQueue&lt;Client36&gt;();</span><br><span class="line">        orderQueue=<span class="keyword">new</span> LinkedBlockingQueue&lt;OrderTicket36&gt;();</span><br><span class="line">        plateQueue=<span class="keyword">new</span> LinkedBlockingQueue&lt;Plate36&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlockingQueue&lt;Table36&gt; <span class="title">getTables</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> tables;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlockingQueue&lt;Client36&gt; <span class="title">getServiceQueue</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> serviceQueue;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlockingQueue&lt;OrderTicket36&gt; <span class="title">getOrderQueue</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> orderQueue;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlockingQueue&lt;Plate36&gt; <span class="title">getPlateQueue</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> plateQueue;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">moreTable</span><span class="params">(Table36 table)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            tables.put(table);   <span class="comment">//访问同步阻塞队列</span></span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Table Insertion interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;tableNum;i++)&#123;</span><br><span class="line">            moreTable(<span class="keyword">new</span> Table36(rand.nextInt(tableSize)+<span class="number">1</span>,<span class="keyword">this</span>));</span><br><span class="line">            <span class="keyword">if</span>(Thread.currentThread().interrupted())&#123;</span><br><span class="line">                System.out.println(<span class="string">"Restaurant initialization interrupted!"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="Exercise36-java"><a href="#Exercise36-java" class="headerlink" title="Exercise36.java"></a>Exercise36.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise36</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Press enter to stop!"</span>);</span><br><span class="line">        <span class="comment">//executor</span></span><br><span class="line">        ExecutorService exec=Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//restaurant</span></span><br><span class="line">        Restaurant36 restaurant=<span class="keyword">new</span> Restaurant36(<span class="number">5</span>,<span class="number">10</span>);</span><br><span class="line">        exec.execute(restaurant);</span><br><span class="line">        <span class="comment">//client</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//Wait Person</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                exec.execute(<span class="keyword">new</span> WaitPerson36(restaurant));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">                exec.execute(<span class="keyword">new</span> Chef36(restaurant));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">                exec.execute(<span class="keyword">new</span> Client36(restaurant));</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Error in Standard input!"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Client creation interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h6><p>测试了一个餐馆，10个服务员，5个厨师，100个客人，5张桌子，每张桌子1-10个位置。输出的结果就像下面这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Press enter to stop!</span><br><span class="line">Table <span class="comment">#1 created! 8 seats in total!</span></span><br><span class="line">Table <span class="comment">#2 created! 2 seats in total!</span></span><br><span class="line">Table <span class="comment">#3 created! 1 seats in total!</span></span><br><span class="line">Table <span class="comment">#4 created! 2 seats in total!</span></span><br><span class="line">Table <span class="comment">#5 created! 10 seats in total!</span></span><br><span class="line">Client <span class="comment">#1 sit on Table #1. [7 left]</span></span><br><span class="line">Client <span class="comment">#2 sit on Table #2. [1 left]</span></span><br><span class="line">Client <span class="comment">#3 sit on Table #3. [0 left]</span></span><br><span class="line">Client <span class="comment">#4 sit on Table #4. [1 left]</span></span><br><span class="line">Client <span class="comment">#5 sit on Table #5. [9 left]</span></span><br><span class="line">Client <span class="comment">#6 sit on Table #1. [6 left]</span></span><br><span class="line">Client <span class="comment">#7 sit on Table #2. [0 left]</span></span><br><span class="line">Client <span class="comment">#1 wants to eat: Order #1 [Appetizer-SPRING_ROLLS](8.8); Order #4 [MainCourse-HUMMOUS](12.5); Order #8 [Dessert-GELATO](5.6); Order #12 [Coffee-HERB_TEA](3.0); </span></span><br><span class="line">Client <span class="comment">#5 wants to eat: Order #2 [Appetizer-SALAD](15.5); Order #5 [MainCourse-LENTILS](21.0); Order #10 [Dessert-TIRAMISU](9.9); Order #13 [Coffee-BLACK_COFFEE](6.5); </span></span><br><span class="line">Client <span class="comment">#6 wants to eat: Order #21 [Appetizer-SOUP](10.8); Order #22 [MainCourse-HUMMOUS](12.5); Order #23 [Dessert-GELATO](5.6); Order #24 [Coffee-LATTE](3.1); </span></span><br><span class="line">Client <span class="comment">#7 wants to eat: Order #25 [Appetizer-SPRING_ROLLS](8.8); Order #26 [MainCourse-PAD_THAI](16.9); Order #27 [Dessert-BLACK_FOREST_CAKE](8.7); Order #28 [Coffee-LATTE](3.1); </span></span><br><span class="line">Client <span class="comment">#3 wants to eat: Order #17 [Appetizer-SOUP](10.8); Order #18 [MainCourse-VINDALOO](39.9); Order #19 [Dessert-TIRAMISU](9.9); Order #20 [Coffee-DECAF_COFFEE](4.3); </span></span><br><span class="line">Client <span class="comment">#4 wants to eat: Order #3 [Appetizer-SALAD](15.5); Order #6 [MainCourse-PAD_THAI](16.9); Order #9 [Dessert-FRUIT](15.5); Order #14 [Coffee-BLACK_COFFEE](6.5); </span></span><br><span class="line">Client <span class="comment">#2 wants to eat: Order #7 [Appetizer-SOUP](10.8); Order #11 [MainCourse-PAD_THAI](16.9); Order #15 [Dessert-FRUIT](15.5); Order #16 [Coffee-TEA](2.8); </span></span><br><span class="line">Client <span class="comment">#8 sit on Table #4. [0 left]</span></span><br><span class="line">Client <span class="comment">#1 is eating Plate #1: Chef #1-&gt;Order #1 [Appetizer-SPRING_ROLLS](8.8)...</span></span><br><span class="line">Client <span class="comment">#8 wants to eat: Order #29 [Appetizer-SALAD](15.5); Order #30 [MainCourse-LENTILS](21.0); Order #31 [Dessert-BLACK_FOREST_CAKE](8.7); Order #32 [Coffee-BLACK_COFFEE](6.5); </span></span><br><span class="line">Client <span class="comment">#5 is eating Plate #2: Chef #2-&gt;Order #2 [Appetizer-SALAD](15.5)...</span></span><br><span class="line">Client <span class="comment">#6 is eating Plate #3: Chef #3-&gt;Order #21 [Appetizer-SOUP](10.8)...</span></span><br><span class="line">Client <span class="comment">#7 is eating Plate #4: Chef #4-&gt;Order #25 [Appetizer-SPRING_ROLLS](8.8)...</span></span><br><span class="line">Client <span class="comment">#3 is eating Plate #5: Chef #5-&gt;Order #17 [Appetizer-SOUP](10.8)...</span></span><br><span class="line">Plate <span class="comment">#1: Chef #1-&gt;Order #1 [Appetizer-SPRING_ROLLS](8.8) for Client #1at Table #1 prepared!</span></span><br><span class="line">Client <span class="comment">#9 sit on Table #5. [8 left]</span></span><br><span class="line">... ...</span><br><span class="line">... ...</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-37"><a href="#Exercise-37" class="headerlink" title="Exercise 37"></a>Exercise 37</h4><ul>
<li><strong>Exercise 37</strong>: (2) Modify CarBuilder.java to add another stage to the car-building process, whereby you add the exhaust system, body, and fenders. As with the second stage, assume these processes can be performed simultaneously by robots.</li>
</ul>
<p>这里需要注意CyclicBarrier栅栏是必须的。不然会出现两种问题：第一，hire()只是把某个Robot绑定某个Assembler，并激活这个robot。但robot实际操作完成还需要一段时间。如果有robot没有完成工作，但Assembler已经开始装载下一辆汽车，那这个robot装配的部件会装到下一辆车上，因为robot是绑定Assembler的。第二，只要Assembler完成激活所有robot，就算部分robot的工作还没完成，半成品汽车也会被送入finishQueue。最后Reporter打印的就是未完成品。</p>
<p>所以这个汽车装配的场景必须保证所有机器人都成功装上他负责的部件，才能把成品送入成品仓库。然后组装器才能再加载新的毛坯车。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise37</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  Car</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> carId=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> engine=<span class="keyword">false</span>, drivenTrain=<span class="keyword">false</span>, wheels=<span class="keyword">false</span>, exhaust=<span class="keyword">false</span>, body=<span class="keyword">false</span>, fender=<span class="keyword">false</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;id=num;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Car</span><span class="params">()</span></span>&#123;id=++carId;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> id;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEngine</span><span class="params">()</span></span>&#123;engine=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDriveTrain</span><span class="params">()</span></span>&#123;drivenTrain=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWheels</span><span class="params">()</span></span>&#123;wheels=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addExhaust</span><span class="params">()</span></span>&#123;exhaust=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBody</span><span class="params">()</span></span>&#123;body=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFender</span><span class="params">()</span></span>&#123;fender=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"[Car #"</span>+id+(engine? <span class="string">" Engine"</span>:<span class="string">""</span>)+(drivenTrain? <span class="string">" DrivenTrain"</span>:<span class="string">""</span>)+(wheels? <span class="string">" Wheels"</span>:<span class="string">""</span>)+(exhaust? <span class="string">" Exhaust"</span>:<span class="string">""</span>)+(body? <span class="string">" Body"</span>:<span class="string">""</span>)+(fender? <span class="string">" Fender"</span>:<span class="string">""</span>)+<span class="string">"]"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * ChassisBuilder</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChassisBuilder</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="comment">//carqueue</span></span><br><span class="line">        <span class="keyword">private</span> CarQueue carQueue;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ChassisBuilder</span><span class="params">(CarQueue queue)</span></span>&#123;</span><br><span class="line">            carQueue=queue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Thread</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    Car car=<span class="keyword">new</span> Car();</span><br><span class="line">                    System.out.println(car+<span class="string">" created!"</span>);</span><br><span class="line">                    carQueue.put(car);    <span class="comment">//blocked</span></span><br><span class="line">                    System.out.println(car+<span class="string">" into the car queue."</span>);</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"CharssisBuilder exit correctly!"</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"CharssisBuilder is interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * CarQueue</span><br><span class="line">     */</span></span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CarQueue</span> <span class="keyword">extends</span> <span class="title">LinkedBlockingQueue</span>&lt;<span class="title">Car</span>&gt;</span>&#123;</span><br><span class="line">         <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">0l</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Robot</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> robotId=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Robot</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">int</span> id=++robotId;</span><br><span class="line">        <span class="keyword">private</span> RobotPool pool;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Robot</span><span class="params">(RobotPool p)</span></span>&#123;pool=p;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Robot #"</span>+id+<span class="string">": "</span>+getClass().getSimpleName();&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">powerDown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;   <span class="comment">//ready to work</span></span><br><span class="line">            engage=<span class="keyword">false</span>;</span><br><span class="line">            assembler=<span class="keyword">null</span>;</span><br><span class="line">            pool.release(<span class="keyword">this</span>);</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is ready to work!"</span>);</span><br><span class="line">            <span class="keyword">while</span>(engage==<span class="keyword">false</span>)&#123;</span><br><span class="line">                wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">protected</span> Assembler assembler;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Robot <span class="title">assignAssembler</span><span class="params">(Assembler a)</span></span>&#123;</span><br><span class="line">            assembler=a;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" binding with "</span>+a);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">boolean</span> engage=<span class="keyword">false</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">engage</span><span class="params">()</span></span>&#123;engage=<span class="keyword">true</span>;notifyAll();&#125; <span class="comment">//finish powerdown</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">performService</span><span class="params">()</span></span>;  <span class="comment">//work</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    powerDown();</span><br><span class="line">                    performService();</span><br><span class="line">                    assembler.getBarrier().await();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>+<span class="string">" interrupted!"</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(BrokenBarrierException bbe)&#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>+<span class="string">" barrier broken!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EngineRobot</span> <span class="keyword">extends</span> <span class="title">Robot</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EngineRobot</span><span class="params">(RobotPool r)</span></span>&#123;<span class="keyword">super</span>(r);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performService</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is installing engine for "</span>+assembler.getCar());</span><br><span class="line">            assembler.getCar().addEngine();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DriveTrainRobot</span> <span class="keyword">extends</span> <span class="title">Robot</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DriveTrainRobot</span><span class="params">(RobotPool r)</span></span>&#123;<span class="keyword">super</span>(r);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performService</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is installing Drive Train for "</span>+assembler.getCar());</span><br><span class="line">            assembler.getCar().addDriveTrain();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WheelRobot</span> <span class="keyword">extends</span> <span class="title">Robot</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WheelRobot</span><span class="params">(RobotPool r)</span></span>&#123;<span class="keyword">super</span>(r);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performService</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is installing wheel for "</span>+assembler.getCar());</span><br><span class="line">            assembler.getCar().addWheels();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExhaustRobot</span> <span class="keyword">extends</span> <span class="title">Robot</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ExhaustRobot</span><span class="params">(RobotPool r)</span></span>&#123;<span class="keyword">super</span>(r);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performService</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is installing exhaust system for "</span>+assembler.getCar());</span><br><span class="line">            assembler.getCar().addExhaust();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BodyRobot</span> <span class="keyword">extends</span> <span class="title">Robot</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BodyRobot</span><span class="params">(RobotPool r)</span></span>&#123;<span class="keyword">super</span>(r);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performService</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is installing body of car for "</span>+assembler.getCar());</span><br><span class="line">            assembler.getCar().addBody();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FenderRobot</span> <span class="keyword">extends</span> <span class="title">Robot</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FenderRobot</span><span class="params">(RobotPool r)</span></span>&#123;<span class="keyword">super</span>(r);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performService</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" is installing fenders for "</span>+assembler.getCar());</span><br><span class="line">            assembler.getCar().addFender();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  Assembler</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> assemblerId=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Assembler</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> id=++assemblerId;</span><br><span class="line">        <span class="keyword">private</span> Car car;</span><br><span class="line">        <span class="keyword">private</span> CyclicBarrier barrier=<span class="keyword">new</span> CyclicBarrier(<span class="number">7</span>);</span><br><span class="line">        <span class="function"><span class="keyword">public</span> CyclicBarrier <span class="title">getBarrier</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> barrier;&#125;</span><br><span class="line">        <span class="keyword">private</span> RobotPool pool;</span><br><span class="line">        <span class="keyword">private</span> CarQueue carQueue, finishQueue;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Assembler</span><span class="params">(RobotPool p, CarQueue c, CarQueue f)</span></span>&#123;</span><br><span class="line">            pool=p;</span><br><span class="line">            carQueue=c;</span><br><span class="line">            finishQueue=f;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Assembler #"</span>+id;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Car <span class="title">getCar</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> car;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    car=carQueue.take();    <span class="comment">//block</span></span><br><span class="line">                    pool.hire(ExhaustRobot.class, <span class="keyword">this</span>);    <span class="comment">//block</span></span><br><span class="line">                    pool.hire(BodyRobot.class,<span class="keyword">this</span>);    <span class="comment">//block</span></span><br><span class="line">                    pool.hire(FenderRobot.class,<span class="keyword">this</span>);  <span class="comment">//block</span></span><br><span class="line">                    pool.hire(EngineRobot.class,<span class="keyword">this</span>);  <span class="comment">//block</span></span><br><span class="line">                    pool.hire(DriveTrainRobot.class,<span class="keyword">this</span>);  <span class="comment">//block</span></span><br><span class="line">                    pool.hire(WheelRobot.class,<span class="keyword">this</span>);   <span class="comment">//block</span></span><br><span class="line">                    barrier.await();</span><br><span class="line">                    finishQueue.put(car);   <span class="comment">//block</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>+<span class="string">" interrupted!"</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(BrokenBarrierException bbe)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Barrier brocken!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="keyword">this</span>+<span class="string">" exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  RobotPool</span><br><span class="line">     */</span></span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RobotPool</span></span>&#123;</span><br><span class="line">         <span class="keyword">private</span> Set&lt;Robot&gt; pool=<span class="keyword">new</span> HashSet&lt;Robot&gt;();</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">hire</span><span class="params">(Class&lt;? extends Robot&gt; robotType,Assembler a )</span> <span class="keyword">throws</span> InterruptedException </span>&#123;  <span class="comment">//allow to interrupt the assembler</span></span><br><span class="line">            <span class="keyword">for</span>(Robot r:pool)&#123;</span><br><span class="line">                <span class="keyword">if</span>(r.getClass().equals(robotType))&#123;</span><br><span class="line">                        pool.remove(r);</span><br><span class="line">                        r.assignAssembler(a);</span><br><span class="line">                        r.engage();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            wait();</span><br><span class="line">            hire(robotType,a);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(Robot r)</span></span>&#123;pool.add(r);&#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Finally</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reporter</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> CarQueue cars;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Reporter</span><span class="params">(CarQueue queue)</span></span>&#123;cars=queue;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    Car car=cars.take();</span><br><span class="line">                    System.out.println(car+<span class="string">" finished!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Reporter interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Reporter exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  MAIN</span><br><span class="line">     * <span class="doctag">@param</span> args</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Type Entry to stop!"</span>);</span><br><span class="line">        Exercise37 ex=<span class="keyword">new</span> Exercise37();</span><br><span class="line">        ExecutorService exec=Executors.newCachedThreadPool();</span><br><span class="line">        RobotPool pool=ex.new RobotPool();</span><br><span class="line">        CarQueue carQueue=ex.new CarQueue();</span><br><span class="line">        CarQueue finishQueue=ex.new CarQueue();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">            exec.execute(ex.new Assembler(pool,carQueue,finishQueue));</span><br><span class="line">        &#125;</span><br><span class="line">        exec.execute(ex.new EngineRobot(pool));</span><br><span class="line">        exec.execute(ex.new DriveTrainRobot(pool));</span><br><span class="line">        exec.execute(ex.new WheelRobot(pool));</span><br><span class="line">        exec.execute(ex.new ExhaustRobot(pool));</span><br><span class="line">        exec.execute(ex.new BodyRobot(pool));</span><br><span class="line">        exec.execute(ex.new FenderRobot(pool));</span><br><span class="line">        exec.execute(ex.new ChassisBuilder(carQueue));</span><br><span class="line">        exec.execute(ex.new Reporter(finishQueue));</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-38"><a href="#Exercise-38" class="headerlink" title="Exercise 38"></a>Exercise 38</h4><ul>
<li><strong>Exercise 38</strong>: (3) Using the approach in CarBuilder.java, model the house-building story that was given in this chapter.</li>
</ul>
<p>和第37题生产汽车不一样的一点是，生产汽车先装车窗还是先装轮子，顺序不重要。但造房子必须先打地基，再架钢结构，再布管线，再浇灌混凝土，最后装饰，一切按步骤进行。所以这题在hire()函数中绑定包工队后，项目经理会到包工队的锁上等待完工。包工队完工后会notifyAll()和经理握手，然后经理再找下一环节的包工队。所以经理和每个包工队两次握手，第一次握手 – 经理把专项子工程交给包工队，第二次握手 – 包工队完工交付任务。</p>
<p>这题另一个收获是自发体会到了“生产者-消费者”模型要互相跑到对方的锁上叫醒对方，确实是比较合理的一种构型，可以当做一种惯用法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> *  Exercise 38 house building with concurrent</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise38</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  House</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">House</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String owner;</span><br><span class="line">        <span class="keyword">private</span> Draw draw;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> designed=<span class="keyword">false</span>, base=<span class="keyword">false</span>, structure=<span class="keyword">false</span>, pipeline=<span class="keyword">false</span>, wall=<span class="keyword">false</span>, decoration=<span class="keyword">false</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">House</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">            owner=name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">            StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">            sb.append(<span class="string">"["</span>+owner);</span><br><span class="line">            <span class="keyword">if</span>(designed)&#123;sb.append(<span class="string">" Designed!"</span>);&#125;</span><br><span class="line">            <span class="keyword">if</span>(base)&#123;sb.append(<span class="string">" Based!"</span>);&#125;</span><br><span class="line">            <span class="keyword">if</span>(structure)&#123;sb.append(<span class="string">" Structured!"</span>);&#125;</span><br><span class="line">            <span class="keyword">if</span>(pipeline)&#123;sb.append(<span class="string">" Pipelined!"</span>);&#125;</span><br><span class="line">            <span class="keyword">if</span>(wall)&#123;sb.append(<span class="string">" Walled!"</span>);&#125;</span><br><span class="line">            <span class="keyword">if</span>(decoration)&#123;sb.append(<span class="string">" Decorated!"</span>);&#125;</span><br><span class="line">            <span class="keyword">return</span> sb.append(<span class="string">"]"</span>).toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//all atomic</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">bindingDraw</span><span class="params">(Draw d)</span></span>&#123;</span><br><span class="line">            draw=d;</span><br><span class="line">            designed=<span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addBase</span><span class="params">()</span></span>&#123;base=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addStructure</span><span class="params">()</span></span>&#123;structure=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addPipeline</span><span class="params">()</span></span>&#123;pipeline=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addWall</span><span class="params">()</span></span>&#123;wall=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addDecoration</span><span class="params">()</span></span>&#123;decoration=<span class="keyword">true</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">getBase</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> base;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">getStructure</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> structure;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">getPipeline</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> pipeline;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">getWall</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> wall;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">getDecoration</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> decoration;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Market</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> HouseQueue orders;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Market</span><span class="params">(HouseQueue q)</span></span>&#123;orders=q;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">               <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                    House house=<span class="keyword">new</span> House(getName(<span class="number">10</span>));</span><br><span class="line">                    System.out.println(<span class="string">"New house Order: "</span>+house);</span><br><span class="line">                    orders.put(house);</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Test interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Test exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  Two main queues</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HouseQueue</span> <span class="keyword">extends</span> <span class="title">LinkedBlockingQueue</span>&lt;<span class="title">House</span>&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  Designer</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Draw</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> House house;</span><br><span class="line">        <span class="keyword">private</span> Designer designer;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Draw</span><span class="params">(House h,Designer d)</span></span>&#123;house=h;designer=d;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> house+<span class="string">" designed by "</span>+designer;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Designer <span class="title">getDesigner</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> designer;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> House <span class="title">getHouse</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> house;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Designer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> HouseQueue orders;</span><br><span class="line">        <span class="keyword">private</span> HouseQueue creations;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Designer</span><span class="params">(String n,HouseQueue o,HouseQueue c)</span></span>&#123;name=n;orders=o;creations=c;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Designer "</span>+name;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(House h)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">            h.bindingDraw(<span class="keyword">new</span> Draw(h,<span class="keyword">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    House h=orders.take();  <span class="comment">//block</span></span><br><span class="line">                    System.out.println(<span class="keyword">this</span>+<span class="string">" get new order: "</span>+h);</span><br><span class="line">                    draw(h);</span><br><span class="line">                    System.out.println(h+<span class="string">" designed by "</span>+<span class="keyword">this</span>);</span><br><span class="line">                    creations.put(h);   <span class="comment">//block</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Designer interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Designer exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  Manager</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Manager</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> HouseQueue creations;</span><br><span class="line">        <span class="keyword">private</span> HouseQueue finished;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Class&lt;? extends Contractor&gt;&gt; plan;</span><br><span class="line">        <span class="keyword">private</span> House project;</span><br><span class="line">        <span class="keyword">private</span> ContractorPool humanResource;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Manager</span><span class="params">(String n,HouseQueue c,HouseQueue f,List&lt;Class&lt;? extends Contractor&gt;&gt; p,ContractorPool h)</span></span>&#123;</span><br><span class="line">            name=n;</span><br><span class="line">            creations=c;</span><br><span class="line">            finished=f;</span><br><span class="line">            plan=p;</span><br><span class="line">            humanResource=h;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Manager "</span>+name;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> House <span class="title">getProject</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> project;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">bindingProject</span><span class="params">(House house)</span></span>&#123;project=house;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">finishProject</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">            finished.put(project);  <span class="comment">//never block</span></span><br><span class="line">            project=<span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">vacation</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;  <span class="comment">//thread</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    House house=creations.take();   <span class="comment">//block</span></span><br><span class="line">                    System.out.println(<span class="keyword">this</span>+<span class="string">" take the project of "</span>+house);</span><br><span class="line">                    bindingProject(house);</span><br><span class="line">                    <span class="keyword">for</span>(Class&lt;? extends Contractor&gt; task:plan)&#123;</span><br><span class="line">                        humanResource.hire(task,<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    finishProject();</span><br><span class="line">                    vacation();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Manager interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Manager exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  Contractor</span><br><span class="line">     */</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Contractor</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">         <span class="keyword">private</span> String name;</span><br><span class="line">         <span class="keyword">private</span> Manager manager;</span><br><span class="line">         <span class="keyword">private</span> <span class="keyword">boolean</span> ready=<span class="keyword">false</span>;</span><br><span class="line">         <span class="keyword">protected</span> ContractorPool pool;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="title">Contractor</span><span class="params">(String n, ContractorPool p)</span></span>&#123;name=n;pool=p;&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">bindingManager</span><span class="params">(Manager m)</span></span>&#123;</span><br><span class="line">             pool.remove(<span class="keyword">this</span>);</span><br><span class="line">             manager=m;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">decouplingManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">             pool.add(<span class="keyword">this</span>);</span><br><span class="line">             manager=<span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Manager <span class="title">getManager</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> manager;&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name;&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> ready;&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">ready</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">             decouplingManager();</span><br><span class="line">             ready=<span class="keyword">true</span>;</span><br><span class="line">             <span class="keyword">synchronized</span>(pool)&#123;</span><br><span class="line">                 notifyAll();</span><br><span class="line">             &#125;</span><br><span class="line">             System.out.println(<span class="keyword">this</span>+<span class="string">" is ready!"</span>);</span><br><span class="line">             wait();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">             <span class="keyword">try</span>&#123;</span><br><span class="line">                 <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                     ready();   <span class="comment">//block</span></span><br><span class="line">                     work();</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                 System.out.println(<span class="keyword">this</span>+<span class="string">" Interrupted!"</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             System.out.println(<span class="keyword">this</span>+<span class="string">" exit!"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseContractor</span> <span class="keyword">extends</span> <span class="title">Contractor</span></span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="title">BaseContractor</span><span class="params">(String n,ContractorPool p)</span></span>&#123;<span class="keyword">super</span>(n,p);&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Base contractor "</span>+getName();&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">             Manager manager=getManager();</span><br><span class="line">             manager.getProject().addBase();</span><br><span class="line">             System.out.println(manager.getProject()+<span class="string">" Base well constructed by "</span>+<span class="keyword">this</span>);</span><br><span class="line">             notifyAll();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StructureContractor</span> <span class="keyword">extends</span> <span class="title">Contractor</span></span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="title">StructureContractor</span><span class="params">(String n,ContractorPool p)</span></span>&#123;<span class="keyword">super</span>(n,p);&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Structure contractor "</span>+getName();&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">             Manager manager=getManager();</span><br><span class="line">             manager.getProject().addStructure();</span><br><span class="line">             System.out.println(manager.getProject()+<span class="string">" Structure well constructed by "</span>+<span class="keyword">this</span>);</span><br><span class="line">             notifyAll();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PipelineContractor</span> <span class="keyword">extends</span> <span class="title">Contractor</span></span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="title">PipelineContractor</span><span class="params">(String n,ContractorPool p)</span></span>&#123;<span class="keyword">super</span>(n,p);&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Pipeline contractor "</span>+getName();&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">             Manager manager=getManager();</span><br><span class="line">             manager.getProject().addPipeline();</span><br><span class="line">             System.out.println(manager.getProject()+<span class="string">" Pipeline well constructed by "</span>+<span class="keyword">this</span>);</span><br><span class="line">             notifyAll();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WallContractor</span> <span class="keyword">extends</span> <span class="title">Contractor</span></span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="title">WallContractor</span><span class="params">(String n,ContractorPool p)</span></span>&#123;<span class="keyword">super</span>(n,p);&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Wall contractor "</span>+getName();&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">             Manager manager=getManager();</span><br><span class="line">             manager.getProject().addWall();</span><br><span class="line">             System.out.println(manager.getProject()+<span class="string">" Wall well constructed by "</span>+<span class="keyword">this</span>);</span><br><span class="line">             notifyAll();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorationContractor</span> <span class="keyword">extends</span> <span class="title">Contractor</span></span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="title">DecorationContractor</span><span class="params">(String n,ContractorPool p)</span></span>&#123;<span class="keyword">super</span>(n,p);&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Decoration contractor "</span>+getName();&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">             Manager manager=getManager();</span><br><span class="line">             manager.getProject().addDecoration();</span><br><span class="line">             System.out.println(manager.getProject()+<span class="string">" Decoration well constructed by "</span>+<span class="keyword">this</span>);</span><br><span class="line">             notifyAll();   <span class="comment">//tell manager this work is done</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContractorPool</span></span>&#123;</span><br><span class="line">         <span class="keyword">private</span> List&lt;Contractor&gt; pool=<span class="keyword">new</span> ArrayList&lt;Contractor&gt;();</span><br><span class="line">         <span class="function"><span class="keyword">public</span> List&lt;Contractor&gt; <span class="title">getContractors</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> pool;&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Contractor c)</span></span>&#123;pool.add(c);notifyAll();&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Contractor c)</span></span>&#123;pool.remove(c);&#125;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hire</span><span class="params">(Class&lt;? extends Contractor&gt; task, Manager manager)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">             <span class="keyword">for</span>(Contractor contractor:pool)&#123;</span><br><span class="line">                 <span class="keyword">if</span>(contractor.getClass().equals(task))&#123;</span><br><span class="line">                     <span class="keyword">synchronized</span>(contractor)&#123;</span><br><span class="line">                         contractor.bindingManager(manager);</span><br><span class="line">                         System.out.println(manager+<span class="string">" hire "</span>+contractor);</span><br><span class="line">                         contractor.notifyAll();    <span class="comment">//call contractor to work</span></span><br><span class="line">                         contractor.wait(); <span class="comment">//block, wait contractor to finish the work</span></span><br><span class="line">                         System.out.println(<span class="string">"Bye bye "</span>+contractor);</span><br><span class="line">                         <span class="keyword">return</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 wait();</span><br><span class="line">                 hire(task,manager);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  Acceptance</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptance</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> HouseQueue finished;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Acceptance</span><span class="params">(String n,HouseQueue h)</span></span>&#123;name=n;finished=h;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Acceptance "</span>+name;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> name;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                 <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                    House house=finished.take();    <span class="comment">//block</span></span><br><span class="line">                    System.out.println(house+<span class="string">" finished!"</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                 System.out.println(<span class="keyword">this</span>+<span class="string">" Interrupted!"</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             System.out.println(<span class="keyword">this</span>+<span class="string">" exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">(<span class="keyword">int</span> length)</span></span>&#123;</span><br><span class="line">        Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">        StringBuilder str=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;length;i++)&#123;</span><br><span class="line">            str.append((<span class="keyword">char</span>)(((<span class="keyword">int</span>)<span class="string">'a'</span>)+rand.nextInt(<span class="number">26</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Press Entry to exit!"</span>);</span><br><span class="line">        Exercise38 ex=<span class="keyword">new</span> Exercise38();</span><br><span class="line">        ExecutorService exec=Executors.newCachedThreadPool();</span><br><span class="line">        HouseQueue orders=ex.new HouseQueue();</span><br><span class="line">        HouseQueue creations=ex.new HouseQueue();</span><br><span class="line">        HouseQueue finished=ex.new HouseQueue();</span><br><span class="line">        List&lt;Class&lt;? extends Contractor&gt;&gt; plan=<span class="keyword">new</span> ArrayList&lt;Class&lt;? extends Contractor&gt;&gt;();</span><br><span class="line">        plan.add(BaseContractor.class);</span><br><span class="line">        plan.add(StructureContractor.class);</span><br><span class="line">        plan.add(PipelineContractor.class);</span><br><span class="line">        plan.add(WallContractor.class);</span><br><span class="line">        plan.add(DecorationContractor.class);</span><br><span class="line">        ContractorPool humanResource=ex.new ContractorPool();</span><br><span class="line">        exec.execute(ex.new BaseContractor(ex.getName(<span class="number">1</span>),humanResource));</span><br><span class="line">        exec.execute(ex.new StructureContractor(ex.getName(<span class="number">1</span>),humanResource));</span><br><span class="line">        exec.execute(ex.new PipelineContractor(ex.getName(<span class="number">1</span>),humanResource));</span><br><span class="line">        exec.execute(ex.new WallContractor(ex.getName(<span class="number">1</span>),humanResource));</span><br><span class="line">        exec.execute(ex.new DecorationContractor(ex.getName(<span class="number">1</span>),humanResource));</span><br><span class="line"></span><br><span class="line">        exec.execute(ex.new Market(orders));    <span class="comment">//market thread</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;  <span class="comment">//designer thread</span></span><br><span class="line">            Designer d=ex.new Designer(ex.getName(<span class="number">7</span>),orders,creations);</span><br><span class="line">            exec.execute(d);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;   <span class="comment">//manager thread</span></span><br><span class="line">            Manager manager=ex.new Manager(ex.getName(<span class="number">5</span>),creations,finished,plan,humanResource);</span><br><span class="line">            exec.execute(manager);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.execute(ex.new Acceptance(ex.getName(<span class="number">5</span>),finished));</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">           System.in.read();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ioe)&#123;</span><br><span class="line">           System.out.println(<span class="string">"Test interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Test exit!"</span>);</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-39"><a href="#Exercise-39" class="headerlink" title="Exercise 39"></a>Exercise 39</h4><ul>
<li><strong>Exercise 39</strong>: (6) Does FastSimulation.java make reasonable assumptions? Try changing the array to ordinary ints instead of AtomicInteger and using Lock mutexes. Compare the performance between the two versions of the program.</li>
</ul>
<p>首先Lock和Atomic肯定是不一样的。Atomic的效果其实非常有限，书上的FastSimulation.java的互斥临界区非常小，只能保证在获取了oldValue后，然后计算出newValue之前，如果其他线程改变了oldValue的值，Atomic才会发现他的原子性遭到了破坏。但这样并不能保证整个操作是线程安全的。因为newValue是previous和next和current三者的平均值，这里如果是next或者previous中途被修改，Atomic是无法察觉的。但实际上几个Evoler的操作已经被互相影响了。所以compareAndSet()仅仅确保oldValue没有被篡改并不是线程安全的。</p>
<p>但ReentrantLock完全不同，被lock()锁上的代码都能保证不可能同时有两个线程操作这段代码，所以是线程安全的。previous, oldValue, next都不会被中途篡改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise39</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> N_ELEMENTS=<span class="number">100000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> N_GENES=<span class="number">30</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> N_EVOLVERS=<span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[][] GRID=<span class="keyword">new</span> <span class="keyword">int</span>[N_ELEMENTS][N_GENES];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Evoler</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(!Thread.interrupted())&#123;</span><br><span class="line">                <span class="keyword">int</span> element=rand.nextInt(N_ELEMENTS);</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;N_GENES;i++)&#123;</span><br><span class="line">                    <span class="keyword">int</span> previous=i-<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span>(previous&lt;<span class="number">0</span>)&#123;previous=N_GENES-<span class="number">1</span>;&#125;</span><br><span class="line">                    <span class="keyword">int</span> next=i+<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span>(next==N_GENES)&#123;next=<span class="number">0</span>;&#125;</span><br><span class="line">                    Lock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">                    lock.lock();</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        <span class="keyword">int</span> oldValue=GRID[element][i];</span><br><span class="line">                        <span class="keyword">int</span> newValue=(oldValue+GRID[element][previous]+GRID[element][next])/<span class="number">3</span>;</span><br><span class="line">                        GRID[element][i]=newValue;</span><br><span class="line">                        System.out.println(oldValue+<span class="string">" replaced by "</span>+newValue);</span><br><span class="line">                    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                        lock.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Press Entry to Exit!"</span>);</span><br><span class="line">        ExecutorService exec=Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;N_ELEMENTS;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;N_GENES;j++)&#123;</span><br><span class="line">                GRID[i][j]=rand.nextInt(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;N_EVOLVERS;i++)&#123;</span><br><span class="line">            exec.execute(<span class="keyword">new</span> Evoler());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IOException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">        System.out.println(<span class="string">"Test exit."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-40"><a href="#Exercise-40" class="headerlink" title="Exercise 40"></a>Exercise 40</h4><ul>
<li><strong>Exercise 40</strong>: (6) Following the example of ReaderWriterList.java, create a ReaderWriterMap using a HashMap. Investigate its performance by modifying MapComparisons.java. How does it compare to a synchronized HashMap and a ConcurrentHashMap?</li>
</ul>
<p>这题，虽然能正常运行，但遗留了一个小问题：运行结果getReadLockCount()显示一直为0。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise40</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//ReadWriteMap</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Map&lt;K,V&gt; lockedMap=<span class="keyword">new</span> HashMap&lt;K,V&gt;();</span><br><span class="line">        <span class="keyword">private</span> ReentrantReadWriteLock lock=<span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReadWriteMap</span><span class="params">(Collection&lt;K&gt; c1, Collection&lt;V&gt; c2)</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(c1.size()!=c2.size())&#123;System.out.println(<span class="string">"Check your collections!"</span>);<span class="keyword">return</span>;&#125;</span><br><span class="line">            Iterator&lt;K&gt; iteKey=c1.iterator();</span><br><span class="line">            Iterator&lt;V&gt; iteValue=c2.iterator();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;c1.size();i++)&#123;</span><br><span class="line">                lockedMap.put(iteKey.next(),iteValue.next());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">            StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span>(Map.Entry&lt;K,V&gt; entry:lockedMap.entrySet())&#123;</span><br><span class="line">                sb.append(<span class="string">"["</span>+entry.getKey()+<span class="string">","</span>+entry.getValue()+<span class="string">"] "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> V <span class="title">read</span><span class="params">(K key)</span></span>&#123;</span><br><span class="line">            Lock readLock=lock.readLock();</span><br><span class="line">            readLock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> lockedMap.get(key);</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                readLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(K key, V value)</span></span>&#123;</span><br><span class="line">            Lock writeLock=lock.writeLock();</span><br><span class="line">            writeLock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                lockedMap.put(key,value);</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">                writeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet()&#123;<span class="keyword">return</span> lockedMap.entrySet();&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ReentrantReadWriteLock <span class="title">getLock</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> lock;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Reader</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reader</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">for</span>(Map.Entry&lt;Integer,String&gt; entry:map.entrySet())&#123;</span><br><span class="line">                    String value=map.read(entry.getKey());</span><br><span class="line">                    System.out.println(value+<span class="string">" is readed!   &gt;&gt;&gt;"</span>+map.getLock().getReadLockCount()+<span class="string">" threads is on Read Lock!"</span>);</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Reader interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Reader exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Writer</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Writer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">for</span>(Map.Entry&lt;Integer,String&gt; entry:map.entrySet())&#123;</span><br><span class="line">                    <span class="keyword">char</span> rc=(<span class="keyword">char</span>)(((<span class="keyword">int</span>)<span class="string">'a'</span>)+rand.nextInt(<span class="number">26</span>));</span><br><span class="line">                    String str=Character.toString(rc);</span><br><span class="line">                    map.write(entry.getKey(),str);</span><br><span class="line">                    System.out.println(entry.getValue()+<span class="string">" is changed to "</span>+str+<span class="string">"   &gt;&gt;&gt;"</span>+map.getLock().getWriteHoldCount()+<span class="string">" threads is on Write Lock!"</span>);</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="string">"Writer interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"Writer exit!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fields</span></span><br><span class="line">    <span class="keyword">private</span> ExecutorService exec=Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> ReadWriteMap&lt;Integer,String&gt; map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> readTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> writeTime;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Exercise40</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> rt, <span class="keyword">int</span> wt)</span></span>&#123;</span><br><span class="line">        SIZE=size;</span><br><span class="line">        List&lt;Integer&gt; keys=<span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">        List&lt;String&gt; values=<span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;SIZE;i++)&#123;</span><br><span class="line">            keys.add(rand.nextInt(<span class="number">1000</span>));</span><br><span class="line">            <span class="keyword">char</span> rc=(<span class="keyword">char</span>)(((<span class="keyword">int</span>)<span class="string">'a'</span>)+rand.nextInt(<span class="number">26</span>));</span><br><span class="line">            values.add(Character.toString(rc));</span><br><span class="line">        &#125;</span><br><span class="line">        map=<span class="keyword">new</span> ReadWriteMap&lt;Integer,String&gt;(keys,values);</span><br><span class="line">        readTime=rt;</span><br><span class="line">        writeTime=wt;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;readTime;i++)&#123;</span><br><span class="line">            exec.execute(<span class="keyword">new</span> Reader());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;writeTime;i++)&#123;</span><br><span class="line">            exec.execute(<span class="keyword">new</span> Writer());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">        System.out.println(<span class="string">"Test exit!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise40 test=<span class="keyword">new</span> Exercise40(<span class="number">50</span>,<span class="number">20</span>,<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-41"><a href="#Exercise-41" class="headerlink" title="Exercise 41"></a>Exercise 41</h4><ul>
<li><strong>Exercise 41</strong>: (6) Add a message handler to ActiveObjectDemo.java that has no return value, and call this within main( ).</li>
</ul>
<p>两个存放Future结果的列表作为成员字段存放着，showResults()方法负责从结果列表中获取结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise41</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService exec = Executors.newSingleThreadExecutor();</span><br><span class="line">    <span class="keyword">private</span> List&lt;Future&lt;String&gt;&gt; intResults=<span class="keyword">new</span> CopyOnWriteArrayList&lt;Future&lt;String&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;Future&lt;String&gt;&gt; floatResults=<span class="keyword">new</span> CopyOnWriteArrayList&lt;Future&lt;String&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//calculateInt</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">calculateInt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> a, <span class="keyword">final</span> <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">        intResults.add(exec.submit(<span class="keyword">new</span> Callable&lt;String&gt;()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">                sleep(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"    "</span>+a+<span class="string">" + "</span>+b+<span class="string">" = "</span>+(a+b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//calculateFloat</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">calculateFloat</span><span class="params">(<span class="keyword">final</span> <span class="keyword">float</span> a, <span class="keyword">final</span> <span class="keyword">float</span> b)</span></span>&#123;</span><br><span class="line">        floatResults.add(exec.submit(<span class="keyword">new</span> Callable&lt;String&gt;()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">                sleep(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"    "</span>+a+<span class="string">" + "</span>+b+<span class="string">" = "</span>+(a+b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//tools</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> time)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(time);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Calculator is interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>&#123;exec.shutdownNow();&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//message handler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showResults</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> endAt=System.currentTimeMillis()+<span class="number">5000</span>;   <span class="comment">//5 secs</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(Future&lt;String&gt; r:intResults)&#123;</span><br><span class="line">                <span class="keyword">if</span>(r.isDone())&#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        System.out.println(r.get());</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">                    &#125;</span><br><span class="line">                    intResults.remove(r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(Future&lt;String&gt; r:floatResults)&#123;</span><br><span class="line">                <span class="keyword">if</span>(r.isDone())&#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        System.out.println(r.get());</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException();</span><br><span class="line">                    &#125;</span><br><span class="line">                    floatResults.remove(r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(System.currentTimeMillis()&gt;=endAt)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise41 test=<span class="keyword">new</span> Exercise41();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">            test.calculateInt(test.rand.nextInt(<span class="number">100</span>),test.rand.nextInt(<span class="number">100</span>));</span><br><span class="line">            test.calculateFloat((test.rand.nextFloat()*test.rand.nextInt(<span class="number">100</span>)),(test.rand.nextFloat()*test.rand.nextInt(<span class="number">100</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        test.showResults();</span><br><span class="line">        test.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-42"><a href="#Exercise-42" class="headerlink" title="Exercise 42"></a>Exercise 42</h4><ul>
<li><strong>Exercise 42</strong>: (7) Modify WaxOMatic.java so that it implements active objects.</li>
</ul>
<p>这里每个机器人ActiveCarRobot就是一个活动对象，每个机器人负责一辆车，它有自己的单线程Executor，有自己的任务队列和结果队列，交替执行10次上蜡和抛光之后，显示结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter21;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise42</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> carCount=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> robotCount=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;ActiveCarRobot&gt; robots=<span class="keyword">new</span> ArrayList&lt;ActiveCarRobot&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++carCount;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> waxOn=<span class="keyword">false</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waxOn</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(waxOn)&#123;System.out.println(<span class="string">"Error, the wax already on!"</span>);<span class="keyword">return</span>;&#125;</span><br><span class="line">            waxOn=<span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waxOff</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!waxOn)&#123;System.out.println(<span class="string">"Error, should waxOn before waxOff!"</span>);<span class="keyword">return</span>;&#125;</span><br><span class="line">            waxOn=<span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Car#"</span>+id;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveCarRobot</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id=++robotCount;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService exec=Executors.newSingleThreadExecutor();</span><br><span class="line">        <span class="keyword">private</span> List&lt;Future&lt;String&gt;&gt; results=<span class="keyword">new</span> CopyOnWriteArrayList&lt;Future&lt;String&gt;&gt;();</span><br><span class="line">        <span class="keyword">private</span> Car car;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ActiveCarRobot</span><span class="params">(Car c)</span></span>&#123;car=c;robots.add(<span class="keyword">this</span>);&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="string">"Robot#"</span>+id;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">                results.add(waxOn());</span><br><span class="line">                sleep(<span class="number">10</span>);</span><br><span class="line">                results.add(waxOff());</span><br><span class="line">            &#125;</span><br><span class="line">            showResults();</span><br><span class="line">            shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">waxOn</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> exec.submit(<span class="keyword">new</span> Callable&lt;String&gt;()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">                    sleep(<span class="number">10</span>);</span><br><span class="line">                    car.waxOn();</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"    "</span>+car+<span class="string">" wax on by "</span>+ActiveCarRobot.<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">waxOff</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> exec.submit(<span class="keyword">new</span> Callable&lt;String&gt;()&#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">                    sleep(<span class="number">10</span>);</span><br><span class="line">                    car.waxOff();</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"    "</span>+car+<span class="string">" wax off by "</span>+ActiveCarRobot.<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> time)</span></span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(time);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>+<span class="string">" interrupted!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>&#123;exec.shutdownNow();&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showResults</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">long</span> endAt=System.currentTimeMillis()+<span class="number">5000</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(Future&lt;String&gt; f:results)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(f.isDone())&#123;</span><br><span class="line">                        <span class="keyword">try</span>&#123;</span><br><span class="line">                            System.out.println(f.get());</span><br><span class="line">                        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                            System.out.println(<span class="string">"Error when reading the results!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    results.remove(f);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(System.currentTimeMillis()&gt;=endAt)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Exercise42 test=<span class="keyword">new</span> Exercise42();</span><br><span class="line">        ExecutorService exec=Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            exec.execute(test.new ActiveCarRobot(test.new Car()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(InterruptedException ie)&#123;</span><br><span class="line">            System.out.println(<span class="string">"Test interrupted!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/concurrent/" rel="tag">#concurrent</a>
          
            <a href="/tags/process/" rel="tag">#process</a>
          
            <a href="/tags/thread/" rel="tag">#thread</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/28/aop2/" rel="next" title="【转】面向切面编程(AOP) - 续">
                <i class="fa fa-chevron-left"></i> 【转】面向切面编程(AOP) - 续
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/12/activeObject/" rel="prev" title="并发 - 活动对象">
                并发 - 活动对象 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/10/28/tij4-21/"
           data-title="Thinking in Java 读书笔记：第二十一章 - 并发（草稿）" data-url="www.ciaoshen.com/2016/10/28/tij4-21/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/shenAvatar.jpg"
               alt="沈玮 | Wei SHEN" />
          <p class="site-author-name" itemprop="name">沈玮 | Wei SHEN</p>
          <p class="site-description motion-element" itemprop="description">Coder & Designer</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">65</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">208</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/helloShen" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.douban.com/people/72441576/" target="_blank">
                  
                    <i class="fa fa-globe"></i> DouBan
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/pang-pang-37-37" target="_blank">
                  
                    <i class="fa fa-globe"></i> ZhiHu
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#单处理器情况下，为什么并发？"><span class="nav-number">1.</span> <span class="nav-text">单处理器情况下，为什么并发？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#朴素的Thread"><span class="nav-number">2.</span> <span class="nav-text">朴素的Thread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Executor和线程池"><span class="nav-number">3.</span> <span class="nav-text">Executor和线程池</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#execute-方法"><span class="nav-number">3.1.</span> <span class="nav-text">execute( )方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Future"><span class="nav-number">3.2.</span> <span class="nav-text">Future</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优先级"><span class="nav-number">4.</span> <span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yield-让步"><span class="nav-number">5.</span> <span class="nav-text">yield( )让步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Daemon后台线程"><span class="nav-number">6.</span> <span class="nav-text">Daemon后台线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ThreadFactory"><span class="nav-number">7.</span> <span class="nav-text">ThreadFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#未捕获异常"><span class="nav-number">8.</span> <span class="nav-text">未捕获异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronized关键字和Lock"><span class="nav-number">9.</span> <span class="nav-text">synchronized关键字和Lock</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#竞态条件"><span class="nav-number">9.1.</span> <span class="nav-text">竞态条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#独占锁，synchronized关键字"><span class="nav-number">9.2.</span> <span class="nav-text">独占锁，synchronized关键字</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#synchronized-临界区"><span class="nav-number">9.3.</span> <span class="nav-text">synchronized(){}临界区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ReentrantLock可重入锁"><span class="nav-number">9.4.</span> <span class="nav-text">ReentrantLock可重入锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CSA-Compare-and-Swap"><span class="nav-number">9.4.1.</span> <span class="nav-text">CSA (Compare and Swap)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AQS-AbstractQueuedSynchronizer"><span class="nav-number">9.4.2.</span> <span class="nav-text">AQS (AbstractQueuedSynchronizer)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ReentrantLock的惯用法"><span class="nav-number">9.4.3.</span> <span class="nav-text">ReentrantLock的惯用法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于volatile"><span class="nav-number">10.</span> <span class="nav-text">关于volatile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结束线程"><span class="nav-number">11.</span> <span class="nav-text">结束线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程（任务）的中断（interrupt）"><span class="nav-number">12.</span> <span class="nav-text">线程（任务）的中断（interrupt）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#中断任务的一个惯用法（良好实践）"><span class="nav-number">12.1.</span> <span class="nav-text">中断任务的一个惯用法（良好实践）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wait-notify-notifyAll"><span class="nav-number">13.</span> <span class="nav-text">wait( ), notify( ), notifyAll( )</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#notify-和notifyAll"><span class="nav-number">13.1.</span> <span class="nav-text">notify( )和notifyAll( )</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wait-能被interrupt信号中断"><span class="nav-number">13.2.</span> <span class="nav-text">wait( )能被interrupt信号中断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“生产者-消费者”模型"><span class="nav-number">14.</span> <span class="nav-text">“生产者-消费者”模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#condition-await-condition-signalAll"><span class="nav-number">15.</span> <span class="nav-text">condition#await( ), condition#signalAll( )</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BlockingQueue"><span class="nav-number">16.</span> <span class="nav-text">BlockingQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类库中的其他构件"><span class="nav-number">17.</span> <span class="nav-text">类库中的其他构件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CountDownLatch"><span class="nav-number">17.1.</span> <span class="nav-text">CountDownLatch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DelayQueue和PriorityBlockingQueue"><span class="nav-number">17.2.</span> <span class="nav-text">DelayQueue和PriorityBlockingQueue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ScheduledThreadPoolExecutor"><span class="nav-number">17.3.</span> <span class="nav-text">ScheduledThreadPoolExecutor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Semaphore计数信号量"><span class="nav-number">17.4.</span> <span class="nav-text">Semaphore计数信号量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exchanger"><span class="nav-number">17.5.</span> <span class="nav-text">Exchanger</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并发组件综合使用的一些经验"><span class="nav-number">18.</span> <span class="nav-text">并发组件综合使用的一些经验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Synchronized-Lock-Atomic的性能比较"><span class="nav-number">19.</span> <span class="nav-text">Synchronized, Lock, Atomic的性能比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CopyOnWriteArrayList"><span class="nav-number">20.</span> <span class="nav-text">CopyOnWriteArrayList</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReentrantReadWriteLock"><span class="nav-number">21.</span> <span class="nav-text">ReentrantReadWriteLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习"><span class="nav-number">22.</span> <span class="nav-text">练习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-1"><span class="nav-number">22.1.</span> <span class="nav-text">Exercise 1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-2"><span class="nav-number">22.2.</span> <span class="nav-text">Exercise 2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Generator-java"><span class="nav-number">22.2.1.</span> <span class="nav-text">Generator.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Fibonacci-java"><span class="nav-number">22.2.2.</span> <span class="nav-text">Fibonacci.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise2-java"><span class="nav-number">22.2.3.</span> <span class="nav-text">Exercise2.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3"><span class="nav-number">22.3.</span> <span class="nav-text">Exercise 3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-4"><span class="nav-number">22.4.</span> <span class="nav-text">Exercise 4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-5"><span class="nav-number">22.5.</span> <span class="nav-text">Exercise 5</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Fibonacci-java-1"><span class="nav-number">22.5.1.</span> <span class="nav-text">Fibonacci.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise5-java"><span class="nav-number">22.5.2.</span> <span class="nav-text">Exercise5.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-7"><span class="nav-number">22.6.</span> <span class="nav-text">Exercise 7</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-8"><span class="nav-number">22.7.</span> <span class="nav-text">Exercise 8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-9"><span class="nav-number">22.8.</span> <span class="nav-text">Exercise 9</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-10"><span class="nav-number">22.9.</span> <span class="nav-text">Exercise 10</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-11"><span class="nav-number">22.10.</span> <span class="nav-text">Exercise 11</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-12-13"><span class="nav-number">22.11.</span> <span class="nav-text">Exercise 12,13</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-14"><span class="nav-number">22.12.</span> <span class="nav-text">Exercise 14</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-15"><span class="nav-number">22.13.</span> <span class="nav-text">Exercise 15</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-16"><span class="nav-number">22.14.</span> <span class="nav-text">Exercise 16</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise17"><span class="nav-number">22.15.</span> <span class="nav-text">Exercise17</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-18"><span class="nav-number">22.16.</span> <span class="nav-text">Exercise 18</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-19"><span class="nav-number">22.17.</span> <span class="nav-text">Exercise 19</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Count-java"><span class="nav-number">22.17.1.</span> <span class="nav-text">Count.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Entrance-java"><span class="nav-number">22.17.2.</span> <span class="nav-text">Entrance.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise19-java"><span class="nav-number">22.17.3.</span> <span class="nav-text">Exercise19.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-20"><span class="nav-number">22.18.</span> <span class="nav-text">Exercise 20</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-21"><span class="nav-number">22.19.</span> <span class="nav-text">Exercise 21</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-22"><span class="nav-number">22.20.</span> <span class="nav-text">Exercise 22</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-23"><span class="nav-number">22.21.</span> <span class="nav-text">Exercise 23</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Car-java"><span class="nav-number">22.21.1.</span> <span class="nav-text">Car.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WaxOn-java"><span class="nav-number">22.21.2.</span> <span class="nav-text">WaxOn.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WaxOff-java"><span class="nav-number">22.21.3.</span> <span class="nav-text">WaxOff.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise23-java"><span class="nav-number">22.21.4.</span> <span class="nav-text">Exercise23.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-24"><span class="nav-number">22.22.</span> <span class="nav-text">Exercise 24</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-25"><span class="nav-number">22.23.</span> <span class="nav-text">Exercise 25</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Meal-java"><span class="nav-number">22.23.1.</span> <span class="nav-text">Meal.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WaitPerson-java"><span class="nav-number">22.23.2.</span> <span class="nav-text">WaitPerson.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Chef-java"><span class="nav-number">22.23.3.</span> <span class="nav-text">Chef.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise25-java"><span class="nav-number">22.23.4.</span> <span class="nav-text">Exercise25.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-26"><span class="nav-number">22.24.</span> <span class="nav-text">Exercise 26</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-28"><span class="nav-number">22.25.</span> <span class="nav-text">Exercise 28</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-29"><span class="nav-number">22.26.</span> <span class="nav-text">Exercise 29</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Toast29-java"><span class="nav-number">22.26.1.</span> <span class="nav-text">Toast29.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ToastQueue29-java"><span class="nav-number">22.26.2.</span> <span class="nav-text">ToastQueue29.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Toaster29-java"><span class="nav-number">22.26.3.</span> <span class="nav-text">Toaster29.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PeanutButterer19-java"><span class="nav-number">22.26.4.</span> <span class="nav-text">PeanutButterer19.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Jammer29-java"><span class="nav-number">22.26.5.</span> <span class="nav-text">Jammer29.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PBChecker29-java"><span class="nav-number">22.26.6.</span> <span class="nav-text">PBChecker29.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JMChecker29-java"><span class="nav-number">22.26.7.</span> <span class="nav-text">JMChecker29.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Eater29-java"><span class="nav-number">22.26.8.</span> <span class="nav-text">Eater29.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise29-java"><span class="nav-number">22.26.9.</span> <span class="nav-text">Exercise29.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-30"><span class="nav-number">22.27.</span> <span class="nav-text">Exercise 30</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-31"><span class="nav-number">22.28.</span> <span class="nav-text">Exercise 31</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ChopstickBuck-java"><span class="nav-number">22.28.1.</span> <span class="nav-text">ChopstickBuck.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Philosopher-java"><span class="nav-number">22.28.2.</span> <span class="nav-text">Philosopher.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise31-java"><span class="nav-number">22.28.3.</span> <span class="nav-text">Exercise31.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-32"><span class="nav-number">22.29.</span> <span class="nav-text">Exercise 32</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-33"><span class="nav-number">22.30.</span> <span class="nav-text">Exercise 33</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise34"><span class="nav-number">22.31.</span> <span class="nav-text">Exercise34</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-35"><span class="nav-number">22.32.</span> <span class="nav-text">Exercise 35</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#WebClient-java"><span class="nav-number">22.32.1.</span> <span class="nav-text">WebClient.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WebServer-java"><span class="nav-number">22.32.2.</span> <span class="nav-text">WebServer.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise35-java"><span class="nav-number">22.32.3.</span> <span class="nav-text">Exercise35.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-36"><span class="nav-number">22.33.</span> <span class="nav-text">Exercise 36</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#设计原则"><span class="nav-number">22.33.1.</span> <span class="nav-text">设计原则</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#整体流程"><span class="nav-number">22.33.2.</span> <span class="nav-text">整体流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#局部细描"><span class="nav-number">22.33.3.</span> <span class="nav-text">局部细描</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#整体整合"><span class="nav-number">22.33.4.</span> <span class="nav-text">整体整合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#代码"><span class="nav-number">22.33.5.</span> <span class="nav-text">代码</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Food36-java"><span class="nav-number">22.33.5.1.</span> <span class="nav-text">Food36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Course36-java"><span class="nav-number">22.33.5.2.</span> <span class="nav-text">Course36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Order36-java"><span class="nav-number">22.33.5.3.</span> <span class="nav-text">Order36.java</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OrderTicket36-java"><span class="nav-number">22.33.6.</span> <span class="nav-text">OrderTicket36.java</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Table36-java"><span class="nav-number">22.33.6.1.</span> <span class="nav-text">Table36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Plate36-java"><span class="nav-number">22.33.6.2.</span> <span class="nav-text">Plate36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Client36-java"><span class="nav-number">22.33.6.3.</span> <span class="nav-text">Client36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#WaitPerson36-java"><span class="nav-number">22.33.6.4.</span> <span class="nav-text">WaitPerson36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Chef36-java"><span class="nav-number">22.33.6.5.</span> <span class="nav-text">Chef36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Restaurant36-java"><span class="nav-number">22.33.6.6.</span> <span class="nav-text">Restaurant36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Exercise36-java"><span class="nav-number">22.33.6.7.</span> <span class="nav-text">Exercise36.java</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#输出"><span class="nav-number">22.33.6.8.</span> <span class="nav-text">输出</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-37"><span class="nav-number">22.34.</span> <span class="nav-text">Exercise 37</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-38"><span class="nav-number">22.35.</span> <span class="nav-text">Exercise 38</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-39"><span class="nav-number">22.36.</span> <span class="nav-text">Exercise 39</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-40"><span class="nav-number">22.37.</span> <span class="nav-text">Exercise 40</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-41"><span class="nav-number">22.38.</span> <span class="nav-text">Exercise 41</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-42"><span class="nav-number">22.39.</span> <span class="nav-text">Exercise 42</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">沈玮 | Wei SHEN</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io" rel="external nofollow">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>

</br>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div>
  <span id="busuanzi_container_site_pv">
  Visited  <span id="busuanzi_value_site_pv"></span>  times
  </span>

<span id="busuanzi_container_site_pv">&nbsp; &nbsp; | &nbsp; &nbsp;</span>

  <span id="busuanzi_container_site_uv">
  <span id="busuanzi_value_site_uv"></span>  Visitors
  </span>
<div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ciaoshen"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  





  
  

  
  


</body>
</html>
