<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="枚举,状态机,职责链,表驱动," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="Enum的一些基本性质枚举型都是java.lang.Enum的派生类Oracle官方手册上对Enum类的定义：1Class Enum&amp;lt;E extends Enum&amp;lt;E&amp;gt;&amp;gt;
先不管这个自限定结构的意义到底是什么，很明确的一点是：所有我们定义的枚举型都是Enum类的派生类。 下面的语句，声明并定义了一个叫Signal的枚举型。1public enum Signal &amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="Thinking in Java 读书笔记：第十九章 - 枚举">
<meta property="og:url" content="www.ciaoshen.com/2016/10/20/tij4-19/index.html">
<meta property="og:site_name" content="玮 | Wei">
<meta property="og:description" content="Enum的一些基本性质枚举型都是java.lang.Enum的派生类Oracle官方手册上对Enum类的定义：1Class Enum&amp;lt;E extends Enum&amp;lt;E&amp;gt;&amp;gt;
先不管这个自限定结构的意义到底是什么，很明确的一点是：所有我们定义的枚举型都是Enum类的派生类。 下面的语句，声明并定义了一个叫Signal的枚举型。1public enum Signal &amp;#123;">
<meta property="og:updated_time" content="2016-10-26T01:51:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thinking in Java 读书笔记：第十九章 - 枚举">
<meta name="twitter:description" content="Enum的一些基本性质枚举型都是java.lang.Enum的派生类Oracle官方手册上对Enum类的定义：1Class Enum&amp;lt;E extends Enum&amp;lt;E&amp;gt;&amp;gt;
先不管这个自限定结构的意义到底是什么，很明确的一点是：所有我们定义的枚举型都是Enum类的派生类。 下面的语句，声明并定义了一个叫Signal的枚举型。1public enum Signal &amp;#123;">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: 'Author'
    }
  };
</script>



  <meta name="baidu-site-verification" content="3iRy3UFlpa" />


<script>
  (function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>


  <title> Thinking in Java 读书笔记：第十九章 - 枚举 | 玮 | Wei </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-74473715-1', 'auto');
  ga('send', 'pageview');
</script>







  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">玮 | Wei</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Coder & Designer</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
      
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'hDG3wYskg4CYKGSXw8x7','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Thinking in Java 读书笔记：第十九章 - 枚举
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-10-20T12:04:51-04:00" content="2016-10-20">
              2016-10-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Note/" itemprop="url" rel="index">
                    <span itemprop="name">Note</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/20/tij4-19/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/20/tij4-19/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
            <span id="busuanzi_container_page_pv">&nbsp; |  &nbsp; &nbsp; Viewed <span id="busuanzi_value_page_pv"></span> times</span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Enum的一些基本性质"><a href="#Enum的一些基本性质" class="headerlink" title="Enum的一些基本性质"></a>Enum的一些基本性质</h3><h4 id="枚举型都是java-lang-Enum的派生类"><a href="#枚举型都是java-lang-Enum的派生类" class="headerlink" title="枚举型都是java.lang.Enum的派生类"></a>枚举型都是java.lang.Enum的派生类</h4><p>Oracle官方手册上对Enum类的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class Enum&lt;E extends Enum&lt;E&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>先不管这个自限定结构的意义到底是什么，很明确的一点是：<strong>所有我们定义的枚举型都是Enum类的派生类。</strong> 下面的语句，声明并定义了一个叫Signal的枚举型。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Signal &#123; GREEN, YELLOW, RED,&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于上面的Signal枚举型，记住两个事实：</p>
<ul>
<li><strong>Signal是一个实实在在的类。</strong></li>
<li><strong>GREEN,YELLOW,RED是Signal类仅有的三个实例。</strong></li>
</ul>
<h4 id="枚举型可以有自己的成员"><a href="#枚举型可以有自己的成员" class="headerlink" title="枚举型可以有自己的成员"></a>枚举型可以有自己的成员</h4><p>为什么说枚举型是一个是实实在在的类？看看，<strong>枚举型和普通类一样，可以有自己的字段和方法，甚至是自己的构造方法。</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Signal &#123;</span><br><span class="line">	GREEN, YELLOW, RED;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">Signal</span><span class="params">(String des)</span></span>&#123;description=des;&#125;</span><br><span class="line">	<span class="keyword">private</span> String description;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> description;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>.name()+<span class="string">":	"</span>+description;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有两个地方需要注意：</p>
<ol>
<li>最后一个枚举实例后面要用<strong>“分号”</strong>和下面的字段，方法隔开。</li>
<li>构造函数<strong>不能是public或protected</strong>的。而且只能在枚举型内部被调用。（实际相当于只能是private的）</li>
</ol>
<h4 id="枚举型的实质是“单例模式”的变种"><a href="#枚举型的实质是“单例模式”的变种" class="headerlink" title="枚举型的实质是“单例模式”的变种"></a>枚举型的实质是“单例模式”的变种</h4><p>Signal的例子中，GREEN,YELLOW,RED的真实身份<strong>是Signal类型的“静态实例”</strong>。</p>
<p>关于Java的Enum型，必须记住Joshua Bloch的一句话：</p>
<ul>
<li>The basic idea behind Java’s enum types is simple: <strong>they are classes that export one instance for each enumeration constant via a public static final field.</strong>    – Joshua Bloch</li>
</ul>
<p>简单讲就是：<strong>枚举型中的每个枚举都是它的一个静态成员字段。而且无法改变（常量）。</strong></p>
<p>所以枚举型和单例模式本质上非常相似。他们都严格限制自己的对象实例的数量。不太严格地说，单例器其实是枚举型的一个特例：只有单个枚举实例。记住Joshua Bloch的另一句话：</p>
<ul>
<li><strong>In other words, enum types are instance-controlled. They are a generalization of singletons which are essentially single-element enums.</strong></li>
</ul>
<p>以下代码为枚举型Signal的javap反编译结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">ciaoshen</span>.<span class="title">thinkinjava</span>.<span class="title">chapter19</span>.<span class="title">Signal</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Enum</span>&lt;<span class="title">com</span>.<span class="title">ciaoshen</span>.<span class="title">thinkinjava</span>.<span class="title">chapter19</span>.<span class="title">Signal</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.ciaoshen.thinkinjava.chapter19.Signal GREEN;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.ciaoshen.thinkinjava.chapter19.Signal YELLOW;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.ciaoshen.thinkinjava.chapter19.Signal RED;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.Signal[] values();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.<span class="function">Signal <span class="title">valueOf</span><span class="params">(java.lang.String)</span></span>;</span><br><span class="line">  <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>已经确定了GREEN,YELLOW,RED三个枚举都是静态常量成员字段。考虑到枚举型的构造函数无法在枚举型外部被使用，所以保证每个枚举是“effective final”。</p>
<p>另外看到编译器擅自生成了另外两个静态方法：values()和valueOf()。这两个是非常常用的用来获取枚举实例的手段：</p>
<ul>
<li><strong>values():</strong> 返回含有全部内部枚举实例的数组。</li>
<li><strong>valueOf(String name):</strong> 通过某个枚举实例的String字面量来获取与之对应的枚举实例。</li>
</ul>
<p>注意！因为是编译器自动合成的，所以这两个方法在Enum里是找不到的。</p>
<p>而且代码中明确了enum Signal继承自Enum<signal>。注意泛型就是Signal自身。所以这也符合最开始Enum的自限定定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class Enum&lt;E extends Enum&lt;E&gt;&gt;</span><br></pre></td></tr></table></figure></signal></p>
<p>而且Signal枚举型本身也是被final关键字修饰的，所以它无法被继承。而且由于它继承自Enum<signal>它也不能再继承其他类。</signal></p>
<h4 id="枚举类内部还可以定义抽象方法"><a href="#枚举类内部还可以定义抽象方法" class="headerlink" title="枚举类内部还可以定义抽象方法"></a>枚举类内部还可以定义抽象方法</h4><p>枚举型内部允许定义抽象方法。如果这样做，这个抽象方法必须在每个枚举中被实现。我们对之前的Signal类做如下改造：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Light &#123;</span><br><span class="line">    GREEN&#123;<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;System.out.println(<span class="string">"Green"</span>);&#125;&#125;,</span><br><span class="line">    YELLOW&#123;<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;System.out.println(<span class="string">"Yellow"</span>);&#125;&#125;,</span><br><span class="line">    RED&#123;<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;System.out.println(<span class="string">"Red"</span>);&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再用javap进行反编译，结果如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">ciaoshen</span>.<span class="title">thinkinjava</span>.<span class="title">chapter19</span>.<span class="title">Signal</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Enum</span>&lt;<span class="title">com</span>.<span class="title">ciaoshen</span>.<span class="title">thinkinjava</span>.<span class="title">chapter19</span>.<span class="title">Signal</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.ciaoshen.thinkinjava.chapter19.Signal GREEN;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.ciaoshen.thinkinjava.chapter19.Signal YELLOW;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> com.ciaoshen.thinkinjava.chapter19.Signal RED;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.Signal[] values();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.<span class="function">Signal <span class="title">valueOf</span><span class="params">(java.lang.String)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;</span><br><span class="line">  com.ciaoshen.thinkinjava.chapter19.Signal(java.lang.String, <span class="keyword">int</span>, com.ciaoshen.thinkinjava.chapter19.Signal$<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>class Signal前多了一个abstract修饰词。注意Signal$1其实代表了一个匿名内部类。</p>
<h4 id="扒光枚举类的全部语法糖"><a href="#扒光枚举类的全部语法糖" class="headerlink" title="扒光枚举类的全部语法糖"></a>扒光枚举类的全部语法糖</h4><p>怎么看都觉得枚举型还是有问题。到底内部是怎么实现的呢？让我们把所有语法糖都扒掉看一下（用dj反编译）。</p>
<p>下面两个反编译的例子来自<a href="http://rejoy.iteye.com/blog/1781964" target="_blank" rel="external"><strong>《Java语法糖–枚举》</strong></a>。感谢作者：Rajoy。</p>
<p>第一个例子是最朴素的枚举型：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Sex &#123;  </span><br><span class="line">         MALE,  </span><br><span class="line">         FEMALE  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面是简单javap反编译的结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sex</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Enum</span></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex MALE;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex FEMALE;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Sex[] values();  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sex <span class="title">valueOf</span><span class="params">(java.lang.String)</span>  </span><br><span class="line">    <span class="keyword">static</span> </span>&#123;&#125;;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面是用dj深度反编译的结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sex</span> <span class="keyword">extends</span> <span class="title">Enum</span>  </span><br><span class="line"></span>&#123;  </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Sex[] values()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> (Sex[])$VALUES.clone();  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sex <span class="title">valueOf</span><span class="params">(String s)</span>  </span><br><span class="line">    </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> (Sex)Enum.valueOf(Sex, s);  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Sex</span><span class="params">(String s, <span class="keyword">int</span> i)</span>  </span><br><span class="line">    </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>(s, i);  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex MALE;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex FEMALE;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex $VALUES[];  </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">static</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        MALE = <span class="keyword">new</span> Sex(<span class="string">"MALE"</span>, <span class="number">0</span>);  </span><br><span class="line">        FEMALE = <span class="keyword">new</span> Sex(<span class="string">"FEMALE"</span>, <span class="number">1</span>);  </span><br><span class="line">        $VALUES = (<span class="keyword">new</span> Sex[] &#123;  </span><br><span class="line">            MALE, FEMALE  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看清楚编译器背着我们做了什么了吗？</p>
<p>MALE,FEMALE枚举确实是静态常量。在最后的静态块里初始化。构造函数默认两个参数：第一个是String字面量，和变量名保持一致。第二个是声明时候的顺序id。Enum自带的ordinal()和compareTo()函数就以这个字段为依据。$VALUES字段还是字面量的数组。</p>
<p>再来一个复杂一点的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Sex &#123;  </span><br><span class="line">         MALE &#123;  </span><br><span class="line">                   <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">                            <span class="keyword">return</span> <span class="string">"我是男人"</span>;  </span><br><span class="line">                   &#125;  </span><br><span class="line">         &#125;,  </span><br><span class="line">         FEMALE &#123;  </span><br><span class="line">                   <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">                            <span class="keyword">return</span> <span class="string">"我是女人"</span>;  </span><br><span class="line">                   &#125;  </span><br><span class="line">         &#125;;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面直接是dj反编译的结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sex</span> <span class="keyword">extends</span> <span class="title">Enum</span>  </span><br><span class="line"></span>&#123;  </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Sex[] values()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> (Sex[])$VALUES.clone();  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sex <span class="title">valueOf</span><span class="params">(String s)</span>  </span><br><span class="line">    </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> (Sex)Enum.valueOf(Sex, s);  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Sex</span><span class="params">(String s, <span class="keyword">int</span> i)</span>  </span><br><span class="line">    </span>&#123;  </span><br><span class="line">        <span class="keyword">super</span>(s, i);  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span>  </span><br><span class="line">    </span>&#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex MALE;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex FEMALE;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex $VALUES[];  </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">static</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        MALE = <span class="keyword">new</span> Sex(<span class="string">"MALE"</span>, <span class="number">0</span>) &#123;  </span><br><span class="line">   </span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span>  </span><br><span class="line">            </span>&#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="string">"\u6211\u662F\u7537\u4EBA"</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">   </span><br><span class="line">        &#125;  </span><br><span class="line">;  </span><br><span class="line">        FEMALE = <span class="keyword">new</span> Sex(<span class="string">"FEMALE"</span>, <span class="number">1</span>) &#123;  </span><br><span class="line">   </span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span>  </span><br><span class="line">            </span>&#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="string">"\u6211\u662F\u5973\u4EBA"</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">   </span><br><span class="line">        &#125;  </span><br><span class="line">;  </span><br><span class="line">        $VALUES = (<span class="keyword">new</span> Sex[] &#123;  </span><br><span class="line">            MALE, FEMALE  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这回重写了toString()方法。可以看到在Sex类内部是以匿名内部类的方式重新定义了Sex类的两个新派生类。</p>
<p>同样的，如果我们像之前那样先定义一个抽象方法，然后在枚举实例中实现它们的话，Sex类就会被定义成抽象类，并以匿名内部类的形式继承抽象类并实现抽象方法。</p>
<p>至此，java枚举型的语法糖浮云总算拨云见日。底层的逻辑总算自洽了。之前提到各种枚举型的特性也都都能得到很好的解释。</p>
<h3 id="利用反射获取enum实例"><a href="#利用反射获取enum实例" class="headerlink" title="利用反射获取enum实例"></a>利用反射获取enum实例</h3><p>下面是一个给定一个enum型，随机返回它enum实例的工具：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Enums</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Enum&lt;T&gt;&gt; <span class="function">T <span class="title">random</span><span class="params">(Class&lt;T&gt; c )</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c.getEnumConstants()[rand.nextInt(c.getEnumConstants().length)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的关键就在于，利用了反射Class#getEnumConstants()方法获取enum实例。这里<code>&lt;T extends Enum&lt;T&gt;&gt;</code>代表对enum型泛型。</p>
<h3 id="枚举型作为成员字段是“静态的”"><a href="#枚举型作为成员字段是“静态的”" class="headerlink" title="枚举型作为成员字段是“静态的”"></a>枚举型作为成员字段是“静态的”</h3><p>看下面这个简单场景，枚举型Light是A类中的一个成员字段。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">enum</span> Light &#123;GREEN, YELLOW, RED&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但要访问Light枚举时，必须这么调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(A.Light);</span><br></pre></td></tr></table></figure></p>
<p>因为，<strong>在一个类内部的枚举型“隐式”地是静态的</strong>。用static修饰过。所以枚举型永远是静态成员变量。这样的“语法糖”我非常不喜欢。我宁愿光明正大地声明成static。</p>
<h3 id="EnumSet"><a href="#EnumSet" class="headerlink" title="EnumSet"></a>EnumSet</h3><p>EnumSet的实现很值得一说。作者是Joshua Bloch。首先，EnumSet是抽象类。和大多数类库自带Set一样，它继承自AbstractSet，获得了AbstractSet和AbstractMap的部分功能。</p>
<p>实现它的两个具体类型：一个RegularEnumSet，一个JumboEnumSet。但之所以我们在代码中很少见到直接调用这两个类的构造函数，是因为主要由EnumSet的构造函数负责调用它们。通过noneOf()函数中的如下部分代码，基本可以判断：RegularEnumSet用在枚举规模小于64的情况下。而JamboEnumSet用在大于64的情况下。要做这样的拆分，估计还是出于效率的考虑。毕竟可扩展大小的开销不小。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">noneOf</span><span class="params">(Class&lt;E&gt; elementType)</span> </span>&#123;</span><br><span class="line">    Enum[] universe = getUniverse(elementType);</span><br><span class="line">    <span class="keyword">if</span> (universe == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException(elementType + <span class="string">" not an enum"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (universe.length &lt;= <span class="number">64</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RegularEnumSet&lt;&gt;(elementType, universe);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JumboEnumSet&lt;&gt;(elementType, universe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>和容器内部大多维护的是数组不同，在RegularEnumSet中维护的主力数据结构确实如书中所说是一个<strong>long型</strong>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> elements = <span class="number">0L</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后看它的add()函数：明显是把long型64 bit中，某个枚举实例的次序属性（ordinal）所对应的位置设为1。用1 bit表示这个枚举实例的存在。所以也确实像书里说的，long型中的每一位，映射到一个具体的枚举实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    typeCheck(e);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> oldElements = elements;</span><br><span class="line">    elements |= (<span class="number">1L</span> &lt;&lt; ((Enum)e).ordinal());</span><br><span class="line">    <span class="keyword">return</span> elements != oldElements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至于JumboEnumSet，其中维护的主力容器是一个long型数组。看看它的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JumboEnumSet</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">E</span>&gt;&gt; <span class="keyword">extends</span> <span class="title">EnumSet</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">334349849919042784L</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> elements[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    JumboEnumSet(Class&lt;E&gt;elementType, Enum[] universe) &#123;</span><br><span class="line">        <span class="keyword">super</span>(elementType, universe);</span><br><span class="line">        elements = <span class="keyword">new</span> <span class="keyword">long</span>[(universe.length + <span class="number">63</span>) &gt;&gt;&gt; <span class="number">6</span>];</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//... ...</span></span><br></pre></td></tr></table></figure></p>
<p>相当于枚举规模对64取模获得的数组长度。</p>
<p>EnumSet的“效率”是值得信赖的。</p>
<h3 id="EnumMap"><a href="#EnumMap" class="headerlink" title="EnumMap"></a>EnumMap</h3><p>EnumMap和EnumSet类似。但除了Enum型作为Key值，它还可以有一个Value值。因此使用更灵活。这里要推荐一个很实用的<strong>“命令模式”</strong>。</p>
<p>所谓“命令模式”很简单，顾名思义，就是把“命令”当做Key值，然后相应的“行动”当做Value值，存储到EnumMap中。</p>
<p>由于前面说过每个枚举实例都可以重载一遍枚举类中的成员方法。甚至初始的成员方法可以是个抽象方法。前面也展示过，Enum语法糖剥去以后，每个枚举实例都是静态常量。重写成员方法，实际以匿名内部类的方法实现。这里命令模式中代表Value值的“行动”代码也可以用匿名内部类来实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123; <span class="function"><span class="keyword">void</span> <span class="title">action</span><span class="params">()</span></span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> AlarmPoints &#123;BATHROOM,KITCHEN&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumMaps</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		EnumMap&lt;AlarmPoints,Command&gt; em = <span class="keyword">new</span> EnumMap&lt;AlarmPoints,Command&gt;(AlarmPoints.class);</span><br><span class="line">		</span><br><span class="line">		em.put(KITCHEN, <span class="keyword">new</span> Command() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123; print(<span class="string">"Kitchen fire!"</span>); &#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		em.put(BATHROOM, <span class="keyword">new</span> Command() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123; print(<span class="string">"Bathroom alert!"</span>); &#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用书上的一个例子。首先定义一个简单Command接口，只有action()一个方法。 我们的枚举类是AlarmPoints。有两个枚举实例：BATHROOM和KITCHEN。他们作为EnumMap的两个键值，对应了两个不同的action()方法。其中action()方法是以匿名内部类的形式被定义的。</p>
<p>每个枚举实例有自己特有的行为方法，是实际开发中非常常见的一种抽象。这种场景下，用EnumMap能使代码很清晰，简洁。</p>
<h3 id="职责链（Chain-of-Responsibility）和状态机"><a href="#职责链（Chain-of-Responsibility）和状态机" class="headerlink" title="职责链（Chain of Responsibility）和状态机"></a>职责链（Chain of Responsibility）和状态机</h3><p>职责链（Chain of Responsibility）是很常用的一种抽象。它的本质是把一系列的“操作”抽象成解决问题的一系列方法。在遇到问题之后，进行一一尝试，直到问题被解决为止，或者最终被标记为不可解决。</p>
<p>很明显，枚举很适合用来罗列一系列有限的解决方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Problem</span></span>&#123;</span><br><span class="line">	<span class="comment">//some code here</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Solution&#123;</span><br><span class="line">	METHOD_A&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Problem p)</span></span>&#123;</span><br><span class="line">			<span class="comment">//do something</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	METHOD_B&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Problem p)</span></span>&#123;</span><br><span class="line">			<span class="comment">//do something</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	METHOD_C&#123;</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Problem p)</span></span>&#123;</span><br><span class="line">			<span class="comment">//do something</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>状态机模拟的场景更复杂一些。但基本思想是不变的，所谓有限状态机，枚举型可以被用来罗列有限的状态。然后同样的，以匿名内部类的形式定义各个状态下的具体操作。而还可以根据一系列枚举的条件，来决定执行什么操作。练习10和练习11中的<strong>“售货机”</strong>模型就是有限状态机最好的例子。</p>
<h3 id="多路分发"><a href="#多路分发" class="headerlink" title="多路分发"></a>多路分发</h3><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p><strong>“多路分发（Multiple Dispatching）”</strong>模式源自于多对象交互的场景。比如下面这个算数的例子。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Number</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Number <span class="title">plus</span><span class="params">(Number n)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Number <span class="title">multiple</span><span class="params">(Number n)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Integer</span> <span class="keyword">extends</span> <span class="title">Number</span></span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Real</span> <span class="keyword">extends</span> <span class="title">Number</span></span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rational</span> <span class="keyword">extends</span> <span class="title">Number</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>Number接口面向其他Number定义了加法和乘法。而Number底下有自然数，实数，有理数这样的派生类。所以当我们用两个数做加法或乘法的时候会像下面这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Number a=<span class="keyword">new</span> Integer();</span><br><span class="line">Number b=<span class="keyword">new</span> Real();</span><br><span class="line">a.plus(b);</span><br></pre></td></tr></table></figure></p>
<p>但这里的问题是Java只支持单路分发，编译器只能对一个对象实施动态绑定。所以a.plus(b);是无法编译的。</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>解决的方法就是<strong>“两路分发”</strong>。书中举了一个“石头剪刀布”游戏的例子。像下面这样的朴素方式是不行的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function">Outcome <span class="title">eval</span><span class="params">(Paper p)</span></span>;</span><br><span class="line">	<span class="function">Outcome <span class="title">eval</span><span class="params">(Scissors s)</span></span>;</span><br><span class="line">	<span class="function">Outcome <span class="title">eval</span><span class="params">(Rock r)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Paper</span> <span class="keyword">implements</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Paper p)</span> </span>&#123; <span class="keyword">return</span> DRAW; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Scissors s)</span> </span>&#123; <span class="keyword">return</span> WIN; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Rock r)</span> </span>&#123; <span class="keyword">return</span> LOSE; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scissors</span> <span class="keyword">implements</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Paper p)</span> </span>&#123; <span class="keyword">return</span> LOSE; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Scissors s)</span> </span>&#123; <span class="keyword">return</span> DRAW; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Rock r)</span> </span>&#123; <span class="keyword">return</span> WIN; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rock</span> <span class="keyword">implements</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Paper p)</span> </span>&#123; <span class="keyword">return</span> WIN; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Scissors s)</span> </span>&#123; <span class="keyword">return</span> LOSE; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Rock r)</span> </span>&#123; <span class="keyword">return</span> DRAW; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为我们最终势必会产生<strong>Item.eval(Item it)</strong>这样的代码。这是无法编译的。解决的办法就是创建一个额外的面向Item（以Item型为参数）的方法。当系统动态绑定it对象的运行时类型后，再通过it对象回调this对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function">Outcome <span class="title">compete</span><span class="params">(Item it)</span></span>;</span><br><span class="line">	<span class="function">Outcome <span class="title">eval</span><span class="params">(Paper p)</span></span>;</span><br><span class="line">	<span class="function">Outcome <span class="title">eval</span><span class="params">(Scissors s)</span></span>;</span><br><span class="line">	<span class="function">Outcome <span class="title">eval</span><span class="params">(Rock r)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Paper</span> <span class="keyword">implements</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">compete</span><span class="params">(Item it)</span> </span>&#123; <span class="keyword">return</span> it.eval(<span class="keyword">this</span>); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Paper p)</span> </span>&#123; <span class="keyword">return</span> DRAW; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Scissors s)</span> </span>&#123; <span class="keyword">return</span> WIN; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Rock r)</span> </span>&#123; <span class="keyword">return</span> LOSE; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scissors</span> <span class="keyword">implements</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">compete</span><span class="params">(Item it)</span> </span>&#123; <span class="keyword">return</span> it.eval(<span class="keyword">this</span>); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Paper p)</span> </span>&#123; <span class="keyword">return</span> LOSE; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Scissors s)</span> </span>&#123; <span class="keyword">return</span> DRAW; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Rock r)</span> </span>&#123; <span class="keyword">return</span> WIN; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rock</span> <span class="keyword">implements</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">compete</span><span class="params">(Item it)</span> </span>&#123; <span class="keyword">return</span> it.eval(<span class="keyword">this</span>); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Paper p)</span> </span>&#123; <span class="keyword">return</span> WIN; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Scissors s)</span> </span>&#123; <span class="keyword">return</span> LOSE; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">eval</span><span class="params">(Rock r)</span> </span>&#123; <span class="keyword">return</span> DRAW; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="用枚举型多路分发"><a href="#用枚举型多路分发" class="headerlink" title="用枚举型多路分发"></a>用枚举型多路分发</h4><p>用枚举实现多路分发，完全是另外一个思路：<strong>“写死”</strong>。下面是书里给的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> RoShamBo2 implements Competitor&lt;RoShamBo2&gt; &#123;</span><br><span class="line">	PAPER(DRAW, LOSE, WIN),</span><br><span class="line">	SCISSORS(WIN, DRAW, LOSE),</span><br><span class="line">	ROCK(LOSE, WIN, DRAW);</span><br><span class="line">	<span class="keyword">private</span> Outcome vPAPER, vSCISSORS, vROCK;</span><br><span class="line">	RoShamBo2(Outcome paper,Outcome scissors,Outcome rock) &#123;</span><br><span class="line">		<span class="keyword">this</span>.vPAPER = paper;</span><br><span class="line">		<span class="keyword">this</span>.vSCISSORS = scissors;</span><br><span class="line">		<span class="keyword">this</span>.vROCK = rock;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">compete</span><span class="params">(RoShamBo2 it)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">switch</span>(it) &#123;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">case</span> PAPER: <span class="keyword">return</span> vPAPER;</span><br><span class="line">			<span class="keyword">case</span> SCISSORS: <span class="keyword">return</span> vSCISSORS;</span><br><span class="line">			<span class="keyword">case</span> ROCK: <span class="keyword">return</span> vROCK;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>“原理”也很简单，用枚举把石头，剪刀，布之间的胜负关系全部写死。实际玩游戏的时候，对参数进行switch。</p>
<h3 id="表驱动编码"><a href="#表驱动编码" class="headerlink" title="表驱动编码"></a>表驱动编码</h3><p>上面提到的这种“写死”的方法，看上去和呆萌，但在实际工程中很常用。《代码大全》中也有专门的一节描述这个模式，叫做“表驱动（table-driven code）”。</p>
<p>书上也有一个专门的例子。还是石头剪刀布的例子，彻底用一个二维数组把对决结果全都写死：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> RoShamBo6 implements Competitor&lt;RoShamBo6&gt; &#123;</span><br><span class="line">	PAPER, SCISSORS, ROCK;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Outcome[][] table = &#123;</span><br><span class="line">		&#123; DRAW, LOSE, WIN &#125;, <span class="comment">// PAPER</span></span><br><span class="line">		&#123; WIN, DRAW, LOSE &#125;, <span class="comment">// SCISSORS</span></span><br><span class="line">		&#123; LOSE, WIN, DRAW &#125;, <span class="comment">// ROCK</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Outcome <span class="title">compete</span><span class="params">(RoShamBo6 other)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> table[<span class="keyword">this</span>.ordinal()][other.ordinal()];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="本章练习常用工具包"><a href="#本章练习常用工具包" class="headerlink" title="本章练习常用工具包"></a>本章练习常用工具包</h4><h5 id="枚举随机器"><a href="#枚举随机器" class="headerlink" title="枚举随机器"></a>枚举随机器</h5><p>Enums.Random()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Enums</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Enum&lt;T&gt;&gt; <span class="function">T <span class="title">random</span><span class="params">(Class&lt;T&gt; c )</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> random(c.getEnumConstants());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">random</span><span class="params">(T[] values)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> values[rand.nextInt(values.length)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//System.out.println(random(CartoonCharacter2.class));</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h4><ul>
<li><strong>Exercise 1</strong>: (2) Use a static import to modify TrafficLight.java so you don’t have to qualify the enum instances.</li>
</ul>
<p>除了完成题目，还练习了最基本的Enum型的创建，构造。</p>
<h5 id="Signal-java"><a href="#Signal-java" class="headerlink" title="Signal.java"></a>Signal.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Signal &#123;</span><br><span class="line">    GREEN(<span class="string">"You can pass!"</span>),</span><br><span class="line">    YELLOW(<span class="string">"Red light coming soon!"</span>),</span><br><span class="line">    RED(<span class="string">"You must stop!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Signal</span><span class="params">(String s)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.description=s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> description;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String id=name();</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="TrafficLight-java"><a href="#TrafficLight-java" class="headerlink" title="TrafficLight.java"></a>TrafficLight.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.Signal.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrafficLight</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Signal color=RED;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(color)&#123;</span><br><span class="line">            <span class="keyword">case</span> RED:</span><br><span class="line">                color=GREEN;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YELLOW:</span><br><span class="line">                color=RED;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> GREEN:</span><br><span class="line">                color=YELLOW;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">look</span><span class="params">()</span></span>&#123;System.out.println(color);&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Signal s:values())&#123;</span><br><span class="line">            System.out.println(s+<span class="string">": "</span>+s.getDescription());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            change();</span><br><span class="line">            look();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise1-java"><a href="#Exercise1-java" class="headerlink" title="Exercise1.java"></a>Exercise1.java</h5><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.Signal.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.TrafficLight.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Signal s:values())&#123;</span><br><span class="line">            System.out.println(s+<span class="string">": "</span>+s.getDescription());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            change();</span><br><span class="line">            look();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h4><ul>
<li><strong>Exercise 2</strong>: (2) Instead of implementing an interface, make next( ) a static method. What are the benefits and drawbacks of this approach?</li>
</ul>
<p>用next()不用创建实例，用起来更方便了。缺点是面向Generator接口的方法要受到影响。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> CartoonCharacter&#123;</span><br><span class="line">    SLAPPY, SPANKY, PUNCHY, SILLY, BOUNCY, NUTTY, BOB;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random rand=<span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CartoonCharacter <span class="title">next</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> values()[rand.nextInt(values().length)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise2</span></span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">            System.out.println(CartoonCharacter.next());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><ul>
<li><strong>Exercise 3</strong>: (1) Add a new Course to Course.java and demonstrate that it works in Meal.java.</li>
</ul>
<h5 id="Food-java"><a href="#Food-java" class="headerlink" title="Food.java"></a>Food.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Food</span> </span>&#123;</span><br><span class="line">    <span class="keyword">enum</span> Appetizer implements Food &#123;</span><br><span class="line">        SALAD, SOUP, SPRING_ROLLS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> MainCourse implements Food &#123;</span><br><span class="line">        LASAGNE, BURRITO, PAD_THAI,</span><br><span class="line">        LENTILS, HUMMOUS, VINDALOO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> Dessert implements Food &#123;</span><br><span class="line">        TIRAMISU, GELATO, BLACK_FOREST_CAKE,</span><br><span class="line">        FRUIT, CREME_CARAMEL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> Coffee implements Food &#123;</span><br><span class="line">        BLACK_COFFEE, DECAF_COFFEE, ESPRESSO,</span><br><span class="line">        LATTE, CAPPUCCINO, TEA, HERB_TEA;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">enum</span> Drink implements Food &#123;</span><br><span class="line">        COKECOLA, APPLE_JUICE, ORINGE_JUICE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Course-java"><a href="#Course-java" class="headerlink" title="Course.java"></a>Course.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Course &#123;</span><br><span class="line">    APPETIZER(Food.Appetizer.class),</span><br><span class="line">    MAINCOURSE(Food.MainCourse.class),</span><br><span class="line">    DESSERT(Food.Dessert.class),</span><br><span class="line">    COFFEE(Food.Coffee.class),</span><br><span class="line">    DRINK(Food.Drink.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Food[] values;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Course</span><span class="params">(Class&lt;? extends Food&gt; kind)</span> </span>&#123;</span><br><span class="line">        values = kind.getEnumConstants();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">randomSelection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Enums.random(values);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise3-java"><a href="#Exercise3-java" class="headerlink" title="Exercise3.java"></a>Exercise3.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Course course : Course.values()) &#123;</span><br><span class="line">                Food food = course.randomSelection();</span><br><span class="line">                System.out.println(food);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"---"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><ul>
<li><strong>Exercise 4</strong>: (1) Repeat the above exercise for Meal2.java.</li>
</ul>
<h5 id="Meal2-java"><a href="#Meal2-java" class="headerlink" title="Meal2.java"></a>Meal2.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Meal2 &#123;</span><br><span class="line">    APPETIZER(Food.Appetizer.class),</span><br><span class="line">    MAINCOURSE(Food.MainCourse.class),</span><br><span class="line">    DESSERT(Food.Dessert.class),</span><br><span class="line">    COFFEE(Food.Coffee.class),</span><br><span class="line">    DRINK(Food.Drink.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Food[] values;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Meal2</span><span class="params">(Class&lt;? extends Food&gt; kind)</span> </span>&#123;</span><br><span class="line">        values = kind.getEnumConstants();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Food</span> </span>&#123;</span><br><span class="line">        <span class="keyword">enum</span> Appetizer implements Food &#123;</span><br><span class="line">            SALAD, SOUP, SPRING_ROLLS;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">enum</span> MainCourse implements Food &#123;</span><br><span class="line">            LASAGNE, BURRITO, PAD_THAI,</span><br><span class="line">            LENTILS, HUMMOUS, VINDALOO;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">enum</span> Dessert implements Food &#123;</span><br><span class="line">            TIRAMISU, GELATO, BLACK_FOREST_CAKE,</span><br><span class="line">            FRUIT, CREME_CARAMEL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">enum</span> Coffee implements Food &#123;</span><br><span class="line">            BLACK_COFFEE, DECAF_COFFEE, ESPRESSO,</span><br><span class="line">            LATTE, CAPPUCCINO, TEA, HERB_TEA;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">enum</span> Drink implements Food &#123;</span><br><span class="line">            COKECOLA, APPLE_JUICE, ORINGE_JUICE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Food <span class="title">randomSelection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Enums.random(values);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise4-java"><a href="#Exercise4-java" class="headerlink" title="Exercise4.java"></a>Exercise4.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Meal2 meal : Meal2.values()) &#123;</span><br><span class="line">                Meal2.Food food = meal.randomSelection();</span><br><span class="line">                System.out.println(food);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"---"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-5"><a href="#Exercise-5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><ul>
<li><strong>Exercise 5</strong>: (4) Modify control/VowelsAndConsonants.java so that it uses three enum types: VOWEL, SOMETIMES_A_VOWEL, and CONSONANT. The enum constructor should take the various letters that describe that particular category. Hint: Use varargs, and remember that varargs automatically creates an array for you.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Exercise5 &#123;</span><br><span class="line"></span><br><span class="line">    VOWEL(<span class="string">"aeiou"</span>.split(<span class="string">""</span>)),</span><br><span class="line">    SOMETIMES_A_VOWEL(<span class="string">"y"</span>,<span class="string">"w"</span>),</span><br><span class="line">    CONSONANT(<span class="string">"bcdfghjklmnpqrstvxz"</span>.split(<span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] members;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Exercise5</span><span class="params">(String... letters)</span></span>&#123;</span><br><span class="line">        members=letters;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String[] getMembers()&#123;<span class="keyword">return</span> members;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">        List&lt;String&gt; vo=Arrays.asList(VOWEL.getMembers());</span><br><span class="line">        List&lt;String&gt; some=Arrays.asList(SOMETIMES_A_VOWEL.getMembers());</span><br><span class="line">        List&lt;String&gt; con=Arrays.asList(CONSONANT.getMembers());</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> ic=rand.nextInt(<span class="number">26</span>) + <span class="string">'a'</span>;</span><br><span class="line">            String sc = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;(<span class="keyword">char</span>)ic&#125;);</span><br><span class="line">            System.out.println(sc + <span class="string">", "</span> + ic + <span class="string">": "</span>+(vo.contains(sc)? <span class="string">"Vowel"</span>:<span class="string">""</span>)+(some.contains(sc)? <span class="string">"Sometime a Vowel"</span>:<span class="string">""</span>)+(con.contains(sc)? <span class="string">"Consonants"</span>:<span class="string">""</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-6"><a href="#Exercise-6" class="headerlink" title="Exercise 6"></a>Exercise 6</h4><ul>
<li><strong>Exercise 6</strong>: (3) Is there any special benefit in nesting Appetizer, MainCourse, Dessert, and Coffee inside Food rather than making them standalone enums that just happen to implement Food?<br>我的理解是只要枚举实现了某个接口，都能实现面向这个接口的编程，以及利用反射构造一个模拟套嵌结构（由于枚举无法构造套嵌类的结构）。但如果把枚举放在接口内部，可以有更少的java源文件，封装好一些。如果把接口也放在某个枚举类内部，这样模拟两层套嵌枚举（书里说的“枚举的枚举”）的时候代码更清晰，容易阅读。 下面是根据练习5的字母的枚举的枚举的实现：</li>
</ul>
<h5 id="Letters-java"><a href="#Letters-java" class="headerlink" title="Letters.java"></a>Letters.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Letters &#123;</span><br><span class="line"></span><br><span class="line">    VOWEL(Letter.Vowel.class),</span><br><span class="line">    SOMETIMES_A_VOWEL(Letter.SometimesAVowel.class),</span><br><span class="line">    CONSONANT(Letter.Consonant.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Letter[] values;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Letters</span><span class="params">(Class&lt;? extends Letter&gt; c)</span></span>&#123;</span><br><span class="line">        values=c.getEnumConstants();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Letter[] getValues()&#123;</span><br><span class="line">        <span class="keyword">return</span> values;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Letter</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> Vowel implements Letter&#123;</span><br><span class="line">            A(<span class="string">'a'</span>),E(<span class="string">'e'</span>),I(<span class="string">'i'</span>),O(<span class="string">'o'</span>),U(<span class="string">'u'</span>);</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">char</span> name;</span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="title">Vowel</span><span class="params">(<span class="keyword">char</span> n)</span></span>&#123;name=n;&#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;name&#125;);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> SometimesAVowel implements Letter&#123;</span><br><span class="line">            Y(<span class="string">'y'</span>),W(<span class="string">'w'</span>);</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">char</span> name;</span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="title">SometimesAVowel</span><span class="params">(<span class="keyword">char</span> n)</span></span>&#123;name=n;&#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;name&#125;);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> Consonant implements Letter&#123;</span><br><span class="line">            B(<span class="string">'b'</span>),C(<span class="string">'c'</span>),D(<span class="string">'d'</span>),F(<span class="string">'f'</span>),G(<span class="string">'g'</span>),H(<span class="string">'h'</span>),J(<span class="string">'j'</span>),K(<span class="string">'k'</span>),L(<span class="string">'l'</span>),M(<span class="string">'m'</span>),N(<span class="string">'n'</span>),P(<span class="string">'p'</span>),Q(<span class="string">'q'</span>),R(<span class="string">'r'</span>),S(<span class="string">'s'</span>),T(<span class="string">'t'</span>),V(<span class="string">'v'</span>),X(<span class="string">'x'</span>),Z(<span class="string">'z'</span>);</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">char</span> name;</span><br><span class="line">            <span class="function"><span class="keyword">private</span> <span class="title">Consonant</span><span class="params">(<span class="keyword">char</span> n)</span></span>&#123;name=n;&#125;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;name&#125;);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise6-java"><a href="#Exercise6-java" class="headerlink" title="Exercise6.java"></a>Exercise6.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise6</span> <span class="keyword">implements</span> <span class="title">Letters</span>.<span class="title">Letter</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">10</span>;j++)&#123;</span><br><span class="line">            StringBuilder sb=<span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">                Letters ls=Enums.random(Letters.class);</span><br><span class="line">                Letter l=Enums.random(ls.getValues());</span><br><span class="line">                sb.append(l.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(sb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h4><ul>
<li><strong>Exercise 7</strong>: (3) Find the source code for EnumSet and explain how it works.</li>
</ul>
<p>以下代码为J2SE的numSet源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> java.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.SharedSecrets;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * A specialized &#123;<span class="doctag">@link</span> Set&#125; implementation for use with enum types.  All of</span><br><span class="line"> * the elements in an enum set must come from a single enum type that is</span><br><span class="line"> * specified, explicitly or implicitly, when the set is created.  Enum sets</span><br><span class="line"> * are represented internally as bit vectors.  This representation is</span><br><span class="line"> * extremely compact and efficient. The space and time performance of this</span><br><span class="line"> * class should be good enough to allow its use as a high-quality, typesafe</span><br><span class="line"> * alternative to traditional &lt;tt&gt;int&lt;/tt&gt;-based "bit flags."  Even bulk</span><br><span class="line"> * operations (such as &lt;tt&gt;containsAll&lt;/tt&gt; and &lt;tt&gt;retainAll&lt;/tt&gt;) should</span><br><span class="line"> * run very quickly if their argument is also an enum set.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;The iterator returned by the &lt;tt&gt;iterator&lt;/tt&gt; method traverses the</span><br><span class="line"> * elements in their &lt;i&gt;natural order&lt;/i&gt; (the order in which the enum</span><br><span class="line"> * constants are declared).  The returned iterator is &lt;i&gt;weakly</span><br><span class="line"> * consistent&lt;/i&gt;: it will never throw &#123;<span class="doctag">@link</span> ConcurrentModificationException&#125;</span><br><span class="line"> * and it may or may not show the effects of any modifications to the set that</span><br><span class="line"> * occur while the iteration is in progress.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;Null elements are not permitted.  Attempts to insert a null element</span><br><span class="line"> * will throw &#123;<span class="doctag">@link</span> NullPointerException&#125;.  Attempts to test for the</span><br><span class="line"> * presence of a null element or to remove one will, however, function</span><br><span class="line"> * properly.</span><br><span class="line"> *</span><br><span class="line"> * &lt;P&gt;Like most collection implementations, &lt;tt&gt;EnumSet&lt;/tt&gt; is not</span><br><span class="line"> * synchronized.  If multiple threads access an enum set concurrently, and at</span><br><span class="line"> * least one of the threads modifies the set, it should be synchronized</span><br><span class="line"> * externally.  This is typically accomplished by synchronizing on some</span><br><span class="line"> * object that naturally encapsulates the enum set.  If no such object exists,</span><br><span class="line"> * the set should be "wrapped" using the &#123;<span class="doctag">@link</span> Collections#synchronizedSet&#125;</span><br><span class="line"> * method.  This is best done at creation time, to prevent accidental</span><br><span class="line"> * unsynchronized access:</span><br><span class="line"> *</span><br><span class="line"> * &lt;pre&gt;</span><br><span class="line"> * Set&amp;lt;MyEnum&amp;gt; s = Collections.synchronizedSet(EnumSet.noneOf(MyEnum.class));</span><br><span class="line"> * &lt;/pre&gt;</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;Implementation note: All basic operations execute in constant time.</span><br><span class="line"> * They are likely (though not guaranteed) to be much faster than their</span><br><span class="line"> * &#123;<span class="doctag">@link</span> HashSet&#125; counterparts.  Even bulk operations execute in</span><br><span class="line"> * constant time if their argument is also an enum set.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;This class is a member of the</span><br><span class="line"> * &lt;a href="&#123;<span class="doctag">@docRoot</span>&#125;/../technotes/guides/collections/index.html"&gt;</span><br><span class="line"> * Java Collections Framework&lt;/a&gt;.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@author</span> Josh Bloch</span><br><span class="line"> * <span class="doctag">@since</span> 1.5</span><br><span class="line"> * <span class="doctag">@see</span> EnumMap</span><br><span class="line"> * <span class="doctag">@serial</span> exclude</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumSet</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">E</span>&gt;&gt; <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">E</span>&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The class of all the elements of this set.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">final</span> Class&lt;E&gt; elementType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * All of the values comprising T.  (Cached for performance.)</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">final</span> Enum[] universe;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Enum[] ZERO_LENGTH_ENUM_ARRAY = <span class="keyword">new</span> Enum[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    EnumSet(Class&lt;E&gt;elementType, Enum[] universe) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementType = elementType;</span><br><span class="line">        <span class="keyword">this</span>.universe    = universe;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an empty enum set with the specified element type.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> elementType the class object of the element type for this enum</span><br><span class="line">     *     set</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if &lt;tt&gt;elementType&lt;/tt&gt; is null</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">noneOf</span><span class="params">(Class&lt;E&gt; elementType)</span> </span>&#123;</span><br><span class="line">        Enum[] universe = getUniverse(elementType);</span><br><span class="line">        <span class="keyword">if</span> (universe == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException(elementType + <span class="string">" not an enum"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (universe.length &lt;= <span class="number">64</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RegularEnumSet&lt;&gt;(elementType, universe);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JumboEnumSet&lt;&gt;(elementType, universe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set containing all of the elements in the specified</span><br><span class="line">     * element type.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> elementType the class object of the element type for this enum</span><br><span class="line">     *     set</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if &lt;tt&gt;elementType&lt;/tt&gt; is null</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">allOf</span><span class="params">(Class&lt;E&gt; elementType)</span> </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(elementType);</span><br><span class="line">        result.addAll();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Adds all of the elements from the appropriate enum type to this enum</span><br><span class="line">     * set, which is empty prior to the call.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set with the same element type as the specified enum</span><br><span class="line">     * set, initially containing the same elements (if any).</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> s the enum set from which to initialize this enum set</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if &lt;tt&gt;s&lt;/tt&gt; is null</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">copyOf</span><span class="params">(EnumSet&lt;E&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initialized from the specified collection.  If</span><br><span class="line">     * the specified collection is an &lt;tt&gt;EnumSet&lt;/tt&gt; instance, this static</span><br><span class="line">     * factory method behaves identically to &#123;<span class="doctag">@link</span> #copyOf(EnumSet)&#125;.</span><br><span class="line">     * Otherwise, the specified collection must contain at least one element</span><br><span class="line">     * (in order to determine the new enum set's element type).</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> c the collection from which to initialize this enum set</span><br><span class="line">     * <span class="doctag">@throws</span> IllegalArgumentException if &lt;tt&gt;c&lt;/tt&gt; is not an</span><br><span class="line">     *     &lt;tt&gt;EnumSet&lt;/tt&gt; instance and contains no elements</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if &lt;tt&gt;c&lt;/tt&gt; is null</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">copyOf</span><span class="params">(Collection&lt;E&gt; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (c <span class="keyword">instanceof</span> EnumSet) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((EnumSet&lt;E&gt;)c).clone();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (c.isEmpty())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Collection is empty"</span>);</span><br><span class="line">            Iterator&lt;E&gt; i = c.iterator();</span><br><span class="line">            E first = i.next();</span><br><span class="line">            EnumSet&lt;E&gt; result = EnumSet.of(first);</span><br><span class="line">            <span class="keyword">while</span> (i.hasNext())</span><br><span class="line">                result.add(i.next());</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set with the same element type as the specified enum</span><br><span class="line">     * set, initially containing all the elements of this type that are</span><br><span class="line">     * &lt;i&gt;not&lt;/i&gt; contained in the specified set.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> s the enum set from whose complement to initialize this enum set</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if &lt;tt&gt;s&lt;/tt&gt; is null</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">complementOf</span><span class="params">(EnumSet&lt;E&gt; s)</span> </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = copyOf(s);</span><br><span class="line">        result.complement();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initially containing the specified element.</span><br><span class="line">     *</span><br><span class="line">     * Overloadings of this method exist to initialize an enum set with</span><br><span class="line">     * one through five elements.  A sixth overloading is provided that</span><br><span class="line">     * uses the varargs feature.  This overloading may be used to create</span><br><span class="line">     * an enum set initially containing an arbitrary number of elements, but</span><br><span class="line">     * is likely to run slower than the overloadings that do not use varargs.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> e the element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if &lt;tt&gt;e&lt;/tt&gt; is null</span><br><span class="line">     * <span class="doctag">@return</span> an enum set initially containing the specified element</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(e.getDeclaringClass());</span><br><span class="line">        result.add(e);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initially containing the specified elements.</span><br><span class="line">     *</span><br><span class="line">     * Overloadings of this method exist to initialize an enum set with</span><br><span class="line">     * one through five elements.  A sixth overloading is provided that</span><br><span class="line">     * uses the varargs feature.  This overloading may be used to create</span><br><span class="line">     * an enum set initially containing an arbitrary number of elements, but</span><br><span class="line">     * is likely to run slower than the overloadings that do not use varargs.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> e1 an element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e2 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if any parameters are null</span><br><span class="line">     * <span class="doctag">@return</span> an enum set initially containing the specified elements</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e1, E e2)</span> </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(e1.getDeclaringClass());</span><br><span class="line">        result.add(e1);</span><br><span class="line">        result.add(e2);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initially containing the specified elements.</span><br><span class="line">     *</span><br><span class="line">     * Overloadings of this method exist to initialize an enum set with</span><br><span class="line">     * one through five elements.  A sixth overloading is provided that</span><br><span class="line">     * uses the varargs feature.  This overloading may be used to create</span><br><span class="line">     * an enum set initially containing an arbitrary number of elements, but</span><br><span class="line">     * is likely to run slower than the overloadings that do not use varargs.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> e1 an element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e2 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e3 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if any parameters are null</span><br><span class="line">     * <span class="doctag">@return</span> an enum set initially containing the specified elements</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e1, E e2, E e3)</span> </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(e1.getDeclaringClass());</span><br><span class="line">        result.add(e1);</span><br><span class="line">        result.add(e2);</span><br><span class="line">        result.add(e3);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initially containing the specified elements.</span><br><span class="line">     *</span><br><span class="line">     * Overloadings of this method exist to initialize an enum set with</span><br><span class="line">     * one through five elements.  A sixth overloading is provided that</span><br><span class="line">     * uses the varargs feature.  This overloading may be used to create</span><br><span class="line">     * an enum set initially containing an arbitrary number of elements, but</span><br><span class="line">     * is likely to run slower than the overloadings that do not use varargs.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> e1 an element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e2 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e3 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e4 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if any parameters are null</span><br><span class="line">     * <span class="doctag">@return</span> an enum set initially containing the specified elements</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e1, E e2, E e3, E e4)</span> </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(e1.getDeclaringClass());</span><br><span class="line">        result.add(e1);</span><br><span class="line">        result.add(e2);</span><br><span class="line">        result.add(e3);</span><br><span class="line">        result.add(e4);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initially containing the specified elements.</span><br><span class="line">     *</span><br><span class="line">     * Overloadings of this method exist to initialize an enum set with</span><br><span class="line">     * one through five elements.  A sixth overloading is provided that</span><br><span class="line">     * uses the varargs feature.  This overloading may be used to create</span><br><span class="line">     * an enum set initially containing an arbitrary number of elements, but</span><br><span class="line">     * is likely to run slower than the overloadings that do not use varargs.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> e1 an element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e2 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e3 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e4 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> e5 another element that this set is to contain initially</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if any parameters are null</span><br><span class="line">     * <span class="doctag">@return</span> an enum set initially containing the specified elements</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E e1, E e2, E e3, E e4,</span><br><span class="line">                                                    E e5)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(e1.getDeclaringClass());</span><br><span class="line">        result.add(e1);</span><br><span class="line">        result.add(e2);</span><br><span class="line">        result.add(e3);</span><br><span class="line">        result.add(e4);</span><br><span class="line">        result.add(e5);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initially containing the specified elements.</span><br><span class="line">     * This factory, whose parameter list uses the varargs feature, may</span><br><span class="line">     * be used to create an enum set initially containing an arbitrary</span><br><span class="line">     * number of elements, but it is likely to run slower than the overloadings</span><br><span class="line">     * that do not use varargs.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> first an element that the set is to contain initially</span><br><span class="line">     * <span class="doctag">@param</span> rest the remaining elements the set is to contain initially</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if any of the specified elements are null,</span><br><span class="line">     *     or if &lt;tt&gt;rest&lt;/tt&gt; is null</span><br><span class="line">     * <span class="doctag">@return</span> an enum set initially containing the specified elements</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@SafeVarargs</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">of</span><span class="params">(E first, E... rest)</span> </span>&#123;</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(first.getDeclaringClass());</span><br><span class="line">        result.add(first);</span><br><span class="line">        <span class="keyword">for</span> (E e : rest)</span><br><span class="line">            result.add(e);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Creates an enum set initially containing all of the elements in the</span><br><span class="line">     * range defined by the two specified endpoints.  The returned set will</span><br><span class="line">     * contain the endpoints themselves, which may be identical but must not</span><br><span class="line">     * be out of order.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> from the first element in the range</span><br><span class="line">     * <span class="doctag">@param</span> to the last element in the range</span><br><span class="line">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> from&#125; or &#123;<span class="doctag">@code</span> to&#125; are null</span><br><span class="line">     * <span class="doctag">@throws</span> IllegalArgumentException if &#123;<span class="doctag">@code</span> from.compareTo(to) &gt; 0&#125;</span><br><span class="line">     * <span class="doctag">@return</span> an enum set initially containing all of the elements in the</span><br><span class="line">     *         range defined by the two specified endpoints</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">range</span><span class="params">(E from, E to)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (from.compareTo(to) &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(from + <span class="string">" &gt; "</span> + to);</span><br><span class="line">        EnumSet&lt;E&gt; result = noneOf(from.getDeclaringClass());</span><br><span class="line">        result.addRange(from, to);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Adds the specified range to this enum set, which is empty prior</span><br><span class="line">     * to the call.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addRange</span><span class="params">(E from, E to)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns a copy of this set.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> a copy of this set</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EnumSet&lt;E&gt; <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (EnumSet&lt;E&gt;) <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(CloneNotSupportedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Complements the contents of this enum set.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">complement</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Throws an exception if e is not of the correct type for this enum set.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">typeCheck</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        Class eClass = e.getClass();</span><br><span class="line">        <span class="keyword">if</span> (eClass != elementType &amp;&amp; eClass.getSuperclass() != elementType)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException(eClass + <span class="string">" != "</span> + elementType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns all of the values comprising E.</span><br><span class="line">     * The result is uncloned, cached, and shared by all callers.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; E[] getUniverse(Class&lt;E&gt; elementType) &#123;</span><br><span class="line">        <span class="keyword">return</span> SharedSecrets.getJavaLangAccess()</span><br><span class="line">                                        .getEnumConstantsShared(elementType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * This class is used to serialize all EnumSet instances, regardless of</span><br><span class="line">     * implementation type.  It captures their "logical contents" and they</span><br><span class="line">     * are reconstructed using public static factories.  This is necessary</span><br><span class="line">     * to ensure that the existence of a particular implementation type is</span><br><span class="line">     * an implementation detail.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@serial</span> include</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializationProxy</span> &lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">E</span>&gt;&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * The element type of this enum set.</span><br><span class="line">         *</span><br><span class="line">         * <span class="doctag">@serial</span></span><br><span class="line">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;E&gt; elementType;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * The elements contained in this enum set.</span><br><span class="line">         *</span><br><span class="line">         * <span class="doctag">@serial</span></span><br><span class="line">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Enum[] elements;</span><br><span class="line"></span><br><span class="line">        SerializationProxy(EnumSet&lt;E&gt; set) &#123;</span><br><span class="line">            elementType = set.elementType;</span><br><span class="line">            elements = set.toArray(ZERO_LENGTH_ENUM_ARRAY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            EnumSet&lt;E&gt; result = EnumSet.noneOf(elementType);</span><br><span class="line">            <span class="keyword">for</span> (Enum e : elements)</span><br><span class="line">                result.add((E)e);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">362491234563181265L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">writeReplace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SerializationProxy&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// readObject method for the serialization proxy pattern</span></span><br><span class="line">    <span class="comment">// See Effective Java, Second Ed., Item 78.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream stream)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.InvalidObjectException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> java.io.InvalidObjectException(<span class="string">"Proxy required"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，EnumSet是抽象类。和大多数类库自带Set一样，它继承自AbstractSet，获得了AbstractSet和AbstractMap的部分功能。</p>
<p>然后，至少我见到了有两个类是继承EnumSet的：一个RegularEnumSet，一个JumboEnumSet。但之所以我们在代码中很少见到直接调用这两个类的构造函数，是因为EnumSet的构造函数承担了根据枚举规模选择调用它们其中的哪一个构造函数。通过noneOf()函数中的如下部分代码，基本可以判断：RegularEnumSet用在枚举规模小于64的情况下。而JamboEnumSet用在大于64的情况下。要做这样的拆分，估计还是出于效率的考虑。毕竟可扩展大小的开销不小。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E extends Enum&lt;E&gt;&gt; <span class="function">EnumSet&lt;E&gt; <span class="title">noneOf</span><span class="params">(Class&lt;E&gt; elementType)</span> </span>&#123;</span><br><span class="line">    Enum[] universe = getUniverse(elementType);</span><br><span class="line">    <span class="keyword">if</span> (universe == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException(elementType + <span class="string">" not an enum"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (universe.length &lt;= <span class="number">64</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RegularEnumSet&lt;&gt;(elementType, universe);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JumboEnumSet&lt;&gt;(elementType, universe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在RegularEnumSet中维护的主力数据结构确实如书中所说是一个long型：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> elements = <span class="number">0L</span>;</span><br></pre></td></tr></table></figure></p>
<p>然后看它的add()函数：明显是把long型64 bit中，某个枚举实例的次序属性（ordinal）所对应的位置设为1。用1 bit表示这个枚举实例的存在。所以也确实像书里说的，long型中的每一位，映射到一个具体的枚举实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    typeCheck(e);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> oldElements = elements;</span><br><span class="line">    elements |= (<span class="number">1L</span> &lt;&lt; ((Enum)e).ordinal());</span><br><span class="line">    <span class="keyword">return</span> elements != oldElements;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至于JumboEnumSet，其中维护的主力容器是一个long型数组。看看它的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JumboEnumSet</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">E</span>&gt;&gt; <span class="keyword">extends</span> <span class="title">EnumSet</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">334349849919042784L</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> elements[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    JumboEnumSet(Class&lt;E&gt;elementType, Enum[] universe) &#123;</span><br><span class="line">        <span class="keyword">super</span>(elementType, universe);</span><br><span class="line">        elements = <span class="keyword">new</span> <span class="keyword">long</span>[(universe.length + <span class="number">63</span>) &gt;&gt;&gt; <span class="number">6</span>];</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//... ...</span></span><br></pre></td></tr></table></figure></p>
<p>相当于枚举规模对64取模获得的数组长度。</p>
<h4 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h4><ul>
<li><strong>Exercise 8</strong>: (6) Modify PostOffice.java so it has the ability to forward mail.</li>
</ul>
<h5 id="Mail-java"><a href="#Mail-java" class="headerlink" title="Mail.java"></a>Mail.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mail</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The NO’s lower the probability of random selection:</span></span><br><span class="line">    <span class="keyword">enum</span> GeneralDelivery &#123;YES,NO1,NO2,NO3,NO4,NO5&#125;</span><br><span class="line">    <span class="keyword">enum</span> Scannability &#123;UNSCANNABLE,YES1,YES2,YES3,YES4&#125;</span><br><span class="line">    <span class="keyword">enum</span> Readability &#123;ILLEGIBLE,YES1,YES2,YES3,YES4&#125;</span><br><span class="line">    <span class="keyword">enum</span> Address &#123;INCORRECT,OK1,OK2,OK3,OK4,OK5,OK6&#125;</span><br><span class="line">    <span class="keyword">enum</span> Forward &#123;YES,NO&#125;</span><br><span class="line">    <span class="keyword">enum</span> ForwardAddress &#123;INCORRECT,OK1,OK2,OK3,OK4,OK5&#125;</span><br><span class="line">    <span class="keyword">enum</span> ReturnAddress &#123;MISSING,OK1,OK2,OK3,OK4,OK5&#125;</span><br><span class="line">    </span><br><span class="line">    GeneralDelivery generalDelivery;</span><br><span class="line">    Scannability scannability;</span><br><span class="line">    Readability readability;</span><br><span class="line">    Address address;</span><br><span class="line">    Forward forward;</span><br><span class="line">    ForwardAddress forwardAddress;</span><br><span class="line">    ReturnAddress returnAddress;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">long</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> id = counter++;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Mail "</span> + id; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">details</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> toString() +</span><br><span class="line">        <span class="string">", General Delivery: "</span> + generalDelivery +</span><br><span class="line">        <span class="string">", Address Scanability: "</span> + scannability +</span><br><span class="line">        <span class="string">", Address Readability: "</span> + readability +</span><br><span class="line">        <span class="string">", Address Address: "</span> + address +</span><br><span class="line">        <span class="string">", Forward: "</span> + forward +</span><br><span class="line">        <span class="string">", Forward Address: "</span> + forwardAddress +</span><br><span class="line">        <span class="string">", Return address: "</span> + returnAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Generate test Mail:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mail <span class="title">randomMail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Mail m = <span class="keyword">new</span> Mail();</span><br><span class="line">        m.generalDelivery= Enums.random(GeneralDelivery.class);</span><br><span class="line">        m.scannability = Enums.random(Scannability.class);</span><br><span class="line">        m.readability = Enums.random(Readability.class);</span><br><span class="line">        m.address = Enums.random(Address.class);</span><br><span class="line">        m.forward = Enums.random(Forward.class);</span><br><span class="line">        m.forwardAddress = Enums.random(ForwardAddress.class);</span><br><span class="line">        m.returnAddress = Enums.random(ReturnAddress.class);</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Iterable&lt;Mail&gt; <span class="title">generator</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Iterable&lt;Mail&gt;() &#123;</span><br><span class="line">            <span class="keyword">int</span> n = count;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterator&lt;Mail&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;Mail&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> n-- &gt; <span class="number">0</span>; &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Mail <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> randomMail(); &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123; <span class="comment">// Not implemented</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PostOffice-java"><a href="#PostOffice-java" class="headerlink" title="PostOffice.java"></a>PostOffice.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostOffice</span> </span>&#123;</span><br><span class="line">    <span class="keyword">enum</span> MailHandler &#123;</span><br><span class="line">        GENERAL_DELIVERY &#123;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.generalDelivery) &#123;</span><br><span class="line">                    <span class="keyword">case</span> YES:</span><br><span class="line">                        System.out.println(<span class="string">"Using general delivery for "</span> + m);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        MACHINE_SCAN &#123;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.scannability) &#123;</span><br><span class="line">                    <span class="keyword">case</span> UNSCANNABLE: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">switch</span>(m.address) &#123;</span><br><span class="line">                            <span class="keyword">case</span> INCORRECT: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                System.out.println(<span class="string">"Delivering "</span>+ m + <span class="string">" automatically"</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        VISUAL_INSPECTION &#123;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.readability) &#123;</span><br><span class="line">                    <span class="keyword">case</span> ILLEGIBLE: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">switch</span>(m.address) &#123;</span><br><span class="line">                            <span class="keyword">case</span> INCORRECT: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                System.out.println(<span class="string">"Delivering "</span> + m + <span class="string">" normally"</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        FORWARD_STEP &#123;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.forward)&#123;</span><br><span class="line">                    <span class="keyword">case</span> NO:</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">switch</span>(m.forwardAddress)&#123;</span><br><span class="line">                            <span class="keyword">case</span> INCORRECT: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                System.out.println(<span class="string">"Forward "</span>+ m +<span class="string">" normally"</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        RETURN_TO_SENDER &#123;</span><br><span class="line">            <span class="function"><span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.returnAddress) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MISSING: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        System.out.println(<span class="string">"Returning "</span> + m + <span class="string">" to sender"</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(MailHandler handler : MailHandler.values())</span><br><span class="line">            <span class="keyword">if</span>(handler.handle(m))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        System.out.println(m + <span class="string">" is a dead letter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise8-java"><a href="#Exercise8-java" class="headerlink" title="Exercise8.java"></a>Exercise8.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise8</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Mail mail : Mail.generator(<span class="number">10</span>)) &#123;</span><br><span class="line">            System.out.println(mail.details());</span><br><span class="line">            PostOffice.handle(mail);</span><br><span class="line">            System.out.println(<span class="string">"*****"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h4><ul>
<li><strong>Exercise 9</strong>: (5) Modify class PostOffice so that it uses an EnumMap. Project:2 Specialized languages like Prolog use backward chaining in order to solve problems like this. Using PostOffice.java for inspiration, research such languages and develop a program that allows new “rules” to be easily added to the system.</li>
</ul>
<h5 id="Mail-java-1"><a href="#Mail-java-1" class="headerlink" title="Mail.java"></a>Mail.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mail</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The NO’s lower the probability of random selection:</span></span><br><span class="line">    <span class="keyword">enum</span> GeneralDelivery &#123;YES,NO1,NO2,NO3,NO4,NO5&#125;</span><br><span class="line">    <span class="keyword">enum</span> Scannability &#123;UNSCANNABLE,YES1,YES2,YES3,YES4&#125;</span><br><span class="line">    <span class="keyword">enum</span> Readability &#123;ILLEGIBLE,YES1,YES2,YES3,YES4&#125;</span><br><span class="line">    <span class="keyword">enum</span> Address &#123;INCORRECT,OK1,OK2,OK3,OK4,OK5,OK6&#125;</span><br><span class="line">    <span class="keyword">enum</span> Forward &#123;YES,NO&#125;</span><br><span class="line">    <span class="keyword">enum</span> ForwardAddress &#123;INCORRECT,OK1,OK2,OK3,OK4,OK5&#125;</span><br><span class="line">    <span class="keyword">enum</span> ReturnAddress &#123;MISSING,OK1,OK2,OK3,OK4,OK5&#125;</span><br><span class="line">    </span><br><span class="line">    GeneralDelivery generalDelivery;</span><br><span class="line">    Scannability scannability;</span><br><span class="line">    Readability readability;</span><br><span class="line">    Address address;</span><br><span class="line">    Forward forward;</span><br><span class="line">    ForwardAddress forwardAddress;</span><br><span class="line">    ReturnAddress returnAddress;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">long</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> id = counter++;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"Mail "</span> + id; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">details</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> toString() +</span><br><span class="line">        <span class="string">", General Delivery: "</span> + generalDelivery +</span><br><span class="line">        <span class="string">", Address Scanability: "</span> + scannability +</span><br><span class="line">        <span class="string">", Address Readability: "</span> + readability +</span><br><span class="line">        <span class="string">", Address Address: "</span> + address +</span><br><span class="line">        <span class="string">", Forward: "</span> + forward +</span><br><span class="line">        <span class="string">", Forward Address: "</span> + forwardAddress +</span><br><span class="line">        <span class="string">", Return address: "</span> + returnAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Generate test Mail:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mail <span class="title">randomMail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Mail m = <span class="keyword">new</span> Mail();</span><br><span class="line">        m.generalDelivery= Enums.random(GeneralDelivery.class);</span><br><span class="line">        m.scannability = Enums.random(Scannability.class);</span><br><span class="line">        m.readability = Enums.random(Readability.class);</span><br><span class="line">        m.address = Enums.random(Address.class);</span><br><span class="line">        m.forward = Enums.random(Forward.class);</span><br><span class="line">        m.forwardAddress = Enums.random(ForwardAddress.class);</span><br><span class="line">        m.returnAddress = Enums.random(ReturnAddress.class);</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Iterable&lt;Mail&gt; <span class="title">generator</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Iterable&lt;Mail&gt;() &#123;</span><br><span class="line">            <span class="keyword">int</span> n = count;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Iterator&lt;Mail&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;Mail&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> n-- &gt; <span class="number">0</span>; &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Mail <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> randomMail(); &#125;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123; <span class="comment">// Not implemented</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PostOffice9-java"><a href="#PostOffice9-java" class="headerlink" title="PostOffice9.java"></a>PostOffice9.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostOffice9</span> </span>&#123;</span><br><span class="line">    <span class="keyword">enum</span> MailHandler &#123; GENERAL_DELIVERY, MACHINE_SCAN, VISUAL_INSPECTION, FORWARD_STEP, RETURN_TO_SENDER &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Handler</span></span>&#123;<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span></span>;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EnumMap&lt;MailHandler, PostOffice9.Handler&gt; em=<span class="keyword">new</span> EnumMap&lt;MailHandler,PostOffice9.Handler&gt;(MailHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        em.put(MailHandler.GENERAL_DELIVERY,<span class="keyword">new</span> PostOffice9.Handler()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.generalDelivery) &#123;</span><br><span class="line">                    <span class="keyword">case</span> YES:</span><br><span class="line">                        System.out.println(<span class="string">"Using general delivery for "</span> + m);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(MailHandler.MACHINE_SCAN, <span class="keyword">new</span> PostOffice9.Handler()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.scannability) &#123;</span><br><span class="line">                    <span class="keyword">case</span> UNSCANNABLE: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">switch</span>(m.address) &#123;</span><br><span class="line">                            <span class="keyword">case</span> INCORRECT: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                System.out.println(<span class="string">"Delivering "</span>+ m + <span class="string">" automatically"</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(MailHandler.VISUAL_INSPECTION, <span class="keyword">new</span> PostOffice9.Handler()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.readability) &#123;</span><br><span class="line">                    <span class="keyword">case</span> ILLEGIBLE: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">switch</span>(m.address) &#123;</span><br><span class="line">                            <span class="keyword">case</span> INCORRECT: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                System.out.println(<span class="string">"Delivering "</span> + m + <span class="string">" normally"</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(MailHandler.FORWARD_STEP, <span class="keyword">new</span> PostOffice9.Handler()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.forward)&#123;</span><br><span class="line">                    <span class="keyword">case</span> NO:</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">switch</span>(m.forwardAddress)&#123;</span><br><span class="line">                            <span class="keyword">case</span> INCORRECT: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">default</span>:</span><br><span class="line">                                System.out.println(<span class="string">"Forward "</span>+ m +<span class="string">" normally"</span>);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(MailHandler.RETURN_TO_SENDER, <span class="keyword">new</span> PostOffice9.Handler()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(m.returnAddress) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MISSING: <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        System.out.println(<span class="string">"Returning "</span> + m + <span class="string">" to sender"</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Mail m)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;MailHandler,PostOffice9.Handler&gt; entry: PostOffice9.em.entrySet())&#123;</span><br><span class="line">            <span class="keyword">if</span>(entry.getValue()!=<span class="keyword">null</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span>(entry.getValue().handle(m))&#123;</span><br><span class="line">                   <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(m + <span class="string">" is a dead letter"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showHandleMap</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(em);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise9-java"><a href="#Exercise9-java" class="headerlink" title="Exercise9.java"></a>Exercise9.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise9</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Mail mail : Mail.generator(<span class="number">10</span>)) &#123;</span><br><span class="line">            System.out.println(mail.details());</span><br><span class="line">            PostOffice9.handle(mail);</span><br><span class="line">            System.out.println(<span class="string">"*****"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-10"><a href="#Exercise-10" class="headerlink" title="Exercise 10"></a>Exercise 10</h4><ul>
<li><strong>Exercise 10</strong>: (7) Modify class VendingMachine (only) using EnumMap so that one program can have multiple instances of VendingMachine.</li>
</ul>
<p>思路很简单，利用“命令模式”，把状态机的“状态”和“操作”分离。“状态”继续保持静态，放在State枚举型里。但具体的next()操作作为value和“状态”一起存入EnumMap里。而EnumMap作为VendingMachine的一个成员字段被维护。</p>
<h5 id="Input-java"><a href="#Input-java" class="headerlink" title="Input.java"></a>Input.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Input &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  枚举成员</span><br><span class="line">     */</span></span><br><span class="line">    NICKEL(<span class="number">5</span>), DIME(<span class="number">10</span>), QUARTER(<span class="number">25</span>), DOLLAR(<span class="number">100</span>), TOOTHPASTE(<span class="number">200</span>), CHIPS(<span class="number">75</span>), SODA(<span class="number">100</span>), SOAP(<span class="number">50</span>),</span><br><span class="line">    ABORT_TRANSACTION &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">amount</span><span class="params">()</span> </span>&#123; <span class="comment">// Disallow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ABORT.amount()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    STOP &#123; <span class="comment">// This must be the last instance.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">amount</span><span class="params">()</span> </span>&#123; <span class="comment">// Disallow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"SHUT_DOWN.amount()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  其他成员</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// In cents</span></span><br><span class="line">    Input(<span class="keyword">int</span> value) &#123; <span class="keyword">this</span>.value = value; &#125;</span><br><span class="line">    Input() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">amount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> value; &#125;; <span class="comment">// In cents</span></span><br><span class="line">    <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Input <span class="title">randomSelection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Don’t include STOP:</span></span><br><span class="line">        <span class="keyword">return</span> values()[rand.nextInt(values().length - <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Category-java"><a href="#Category-java" class="headerlink" title="Category.java"></a>Category.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.Input.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Category &#123;</span><br><span class="line">    MONEY(NICKEL, DIME, QUARTER, DOLLAR),</span><br><span class="line">    ITEM_SELECTION(TOOTHPASTE, CHIPS, SODA, SOAP),</span><br><span class="line">    QUIT_TRANSACTION(ABORT_TRANSACTION),</span><br><span class="line">    SHUT_DOWN(STOP);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Input[] values;</span><br><span class="line">    Category(Input... types) &#123; values = types; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EnumMap&lt;Input,Category&gt; categories = <span class="keyword">new</span> EnumMap&lt;Input,Category&gt;(Input.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(Category c : Category.class.getEnumConstants()) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Input type : c.values)&#123;</span><br><span class="line">                categories.put(type, c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Category <span class="title">categorize</span><span class="params">(Input input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> categories.get(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="RandomInputGenerator-java"><a href="#RandomInputGenerator-java" class="headerlink" title="RandomInputGenerator.java"></a>RandomInputGenerator.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For a basic sanity check:</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomInputGenerator</span> <span class="keyword">implements</span> <span class="title">Generator</span>&lt;<span class="title">Input</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Input <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Input.randomSelection(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="VendingMachine-java"><a href="#VendingMachine-java" class="headerlink" title="VendingMachine.java"></a>VendingMachine.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VendingMachine</span> </span>&#123;</span><br><span class="line">    <span class="keyword">enum</span> StateDuration &#123; TRANSIENT &#125; <span class="comment">// Tagging enum</span></span><br><span class="line">    <span class="keyword">enum</span> State &#123;</span><br><span class="line">        RESTING, ADDING_MONEY, DISPENSING(StateDuration.TRANSIENT), GIVING_CHANGE(StateDuration.TRANSIENT),</span><br><span class="line">        TERMINAL;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> isTransient = <span class="keyword">false</span>;</span><br><span class="line">        State() &#123;&#125;</span><br><span class="line">        State(StateDuration trans) &#123; isTransient = <span class="keyword">true</span>; &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> State state = State.RESTING;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> amount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Input selection = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> EnumMap&lt;State,StateMachine&gt; em=<span class="keyword">new</span> EnumMap&lt;State,StateMachine&gt;(State.class);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StateMachine</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">(Input input)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only call "</span> + <span class="string">"next(Input input) for non-transient states"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only call next() for "</span> + <span class="string">"StateDuration.TRANSIENT states"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">()</span> </span>&#123; System.out.println(amount); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VendingMachine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        em.put(State.RESTING,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">(Input input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(Category.categorize(input)) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MONEY:</span><br><span class="line">                        amount += input.amount();</span><br><span class="line">                        state = State.ADDING_MONEY;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> SHUT_DOWN:</span><br><span class="line">                        state = State.TERMINAL;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.ADDING_MONEY,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">(Input input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(Category.categorize(input)) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MONEY:</span><br><span class="line">                        amount += input.amount();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> ITEM_SELECTION:</span><br><span class="line">                        selection = input;</span><br><span class="line">                        <span class="keyword">if</span>(amount &lt; selection.amount())</span><br><span class="line">                            System.out.println(<span class="string">"Insufficient money for "</span> + selection);</span><br><span class="line">                        <span class="keyword">else</span> state = State.DISPENSING;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> QUIT_TRANSACTION:</span><br><span class="line">                        state = State.GIVING_CHANGE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> SHUT_DOWN:</span><br><span class="line">                        state = State.TERMINAL;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.DISPENSING,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"here is your "</span> + selection);</span><br><span class="line">                amount -= selection.amount();</span><br><span class="line">                state = State.GIVING_CHANGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.GIVING_CHANGE,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(amount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Your change: "</span> + amount);</span><br><span class="line">                    amount = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = State.TERMINAL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.TERMINAL,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">"Halted"</span>); &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span></span>&#123;</span><br><span class="line">        state = State.RESTING;</span><br><span class="line">        amount = <span class="number">0</span>;</span><br><span class="line">        selection = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">               </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Generator&lt;Input&gt; gen)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(state != State.TERMINAL) &#123;</span><br><span class="line">            em.get(state).next(gen.next());</span><br><span class="line">            <span class="keyword">while</span>(state.isTransient)&#123;</span><br><span class="line">                em.get(state).next();</span><br><span class="line">            &#125;</span><br><span class="line">            em.get(state).output();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        VendingMachine vm=<span class="keyword">new</span> VendingMachine();</span><br><span class="line">        vm.run(<span class="keyword">new</span> RandomInputGenerator());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Exercise10-java"><a href="#Exercise10-java" class="headerlink" title="Exercise10.java"></a>Exercise10.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise10</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        VendingMachine vm1=<span class="keyword">new</span> VendingMachine();</span><br><span class="line">        Generator&lt;Input&gt; gen=<span class="keyword">new</span> RandomInputGenerator();</span><br><span class="line">        vm1.run(gen);</span><br><span class="line">        vm1.reset();</span><br><span class="line">        vm1.run(gen);</span><br><span class="line">        </span><br><span class="line">        VendingMachine vm2=<span class="keyword">new</span> VendingMachine();</span><br><span class="line">        vm2.run(gen);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Exercise-11"><a href="#Exercise-11" class="headerlink" title="Exercise 11"></a>Exercise 11</h4><ul>
<li><strong>Exercise 11</strong>: (7) In a real vending machine you will want to easily add and change the type of vended items, so the limits imposed by an enum on Input are impractical (remember that enums are for a restricted set of types). Modify VendingMachine.java so that the vended items are represented by a class instead of being part of Input, and initialize an Array List of these objects from a text file (using net.mindview.util.TextFile).</li>
</ul>
<p>思路也很简单，把原先的商品设计成Product类，允许从外部文件读入商品条目。售货机初始化时完成载入商品条目。再把原先ITEM_SELECTION枚举型Input改成一个标记。当状态机收到ITEM_SELECTION型状态时，next()方法变为从商品条目列表中随机读取一个商品。</p>
<h5 id="Input11-java"><a href="#Input11-java" class="headerlink" title="Input11.java"></a>Input11.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Input11 &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  枚举成员</span><br><span class="line">     */</span></span><br><span class="line">    NICKEL(<span class="number">5</span>), DIME(<span class="number">10</span>), QUARTER(<span class="number">25</span>), DOLLAR(<span class="number">100</span>), PRODUCT(<span class="number">0</span>),</span><br><span class="line">    ABORT_TRANSACTION &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">amount</span><span class="params">()</span> </span>&#123; <span class="comment">// Disallow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ABORT.amount()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    STOP &#123; <span class="comment">// This must be the last instance.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">amount</span><span class="params">()</span> </span>&#123; <span class="comment">// Disallow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"SHUT_DOWN.amount()"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *  其他成员</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">int</span> value; <span class="comment">// In cents</span></span><br><span class="line">    Input11(<span class="keyword">int</span> value) &#123; <span class="keyword">this</span>.value = value; &#125;</span><br><span class="line">    Input11() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">amount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> value; &#125;; <span class="comment">// In cents</span></span><br><span class="line">    <span class="keyword">static</span> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Input11 <span class="title">randomSelection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Don’t include STOP:</span></span><br><span class="line">        <span class="keyword">return</span> values()[rand.nextInt(values().length - <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="RandomInputGenerator11-java"><a href="#RandomInputGenerator11-java" class="headerlink" title="RandomInputGenerator11.java"></a>RandomInputGenerator11.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// For a basic sanity check:</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomInputGenerator11</span> <span class="keyword">implements</span> <span class="title">Generator</span>&lt;<span class="title">Input11</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Input11 <span class="title">next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Input11.randomSelection(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Category11-java"><a href="#Category11-java" class="headerlink" title="Category11.java"></a>Category11.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.ciaoshen.thinkinjava.chapter19.Input11.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Category11 &#123;</span><br><span class="line">    MONEY(NICKEL, DIME, QUARTER, DOLLAR),</span><br><span class="line">    ITEM_SELECTION(PRODUCT),</span><br><span class="line">    QUIT_TRANSACTION(ABORT_TRANSACTION),</span><br><span class="line">    SHUT_DOWN(STOP);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EnumMap&lt;Input11,Category11&gt; categories = <span class="keyword">new</span> EnumMap&lt;Input11,Category11&gt;(Input11.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(Category11 c : Category11.class.getEnumConstants()) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Input11 type : c.values)&#123;</span><br><span class="line">                categories.put(type, c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Category11 <span class="title">categorize</span><span class="params">(Input11 input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> categories.get(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Input11[] values;</span><br><span class="line">    Category11(Input11... types) &#123; values = types; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        System.out.println(Category11.MONEY);</span><br><span class="line">        System.out.println(Category11.categories);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="VendingMachine11-java"><a href="#VendingMachine11-java" class="headerlink" title="VendingMachine11.java"></a>VendingMachine11.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VendingMachine11</span> </span>&#123;</span><br><span class="line">    <span class="keyword">enum</span> StateDuration &#123; TRANSIENT &#125; <span class="comment">// Tagging enum</span></span><br><span class="line">    <span class="keyword">enum</span> State &#123;</span><br><span class="line">        RESTING, ADDING_MONEY, DISPENSING(StateDuration.TRANSIENT), GIVING_CHANGE(StateDuration.TRANSIENT),</span><br><span class="line">        TERMINAL;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> isTransient = <span class="keyword">false</span>;</span><br><span class="line">        State() &#123;&#125;</span><br><span class="line">        State(StateDuration trans) &#123; isTransient = <span class="keyword">true</span>; &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> State state = State.RESTING;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> amount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Product selection = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> EnumMap&lt;State,StateMachine&gt; em=<span class="keyword">new</span> EnumMap&lt;State,StateMachine&gt;(State.class);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StateMachine</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">(Input11 input)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only call "</span> + <span class="string">"next(Input input) for non-transient states"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only call next() for "</span> + <span class="string">"StateDuration.TRANSIENT states"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">()</span> </span>&#123; System.out.println(amount); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VendingMachine11</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        Product.loadProducts(path);</span><br><span class="line">        em.put(State.RESTING,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">(Input11 input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(Category11.categorize(input)) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MONEY:</span><br><span class="line">                        amount += input.amount();</span><br><span class="line">                        state = State.ADDING_MONEY;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> SHUT_DOWN:</span><br><span class="line">                        state = State.TERMINAL;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.ADDING_MONEY,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">(Input11 input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span>(Category11.categorize(input)) &#123;</span><br><span class="line">                    <span class="keyword">case</span> MONEY:</span><br><span class="line">                        amount += input.amount();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> ITEM_SELECTION:</span><br><span class="line">                        selection = Product.randomSelection();</span><br><span class="line">                        <span class="keyword">if</span>(amount &lt; selection.amount())&#123;</span><br><span class="line">                            System.out.println(<span class="string">"Insufficient money for "</span> + selection);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> state = State.DISPENSING;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> QUIT_TRANSACTION:</span><br><span class="line">                        state = State.GIVING_CHANGE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> SHUT_DOWN:</span><br><span class="line">                        state = State.TERMINAL;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.DISPENSING,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"here is your "</span> + selection);</span><br><span class="line">                amount -= selection.amount();</span><br><span class="line">                state = State.GIVING_CHANGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.GIVING_CHANGE,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(amount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Your change: "</span> + amount);</span><br><span class="line">                    amount = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = State.TERMINAL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        em.put(State.TERMINAL,<span class="keyword">new</span> StateMachine()&#123;</span><br><span class="line">            <span class="function"><span class="keyword">void</span> <span class="title">output</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">"Halted"</span>); &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span></span>&#123;</span><br><span class="line">        state = State.RESTING;</span><br><span class="line">        amount = <span class="number">0</span>;</span><br><span class="line">        selection = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Generator&lt;Input11&gt; gen)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(state != State.TERMINAL) &#123;</span><br><span class="line">            em.get(state).next(gen.next());</span><br><span class="line">            <span class="keyword">while</span>(state.isTransient)&#123;</span><br><span class="line">                em.get(state).next();</span><br><span class="line">            &#125;</span><br><span class="line">            em.get(state).output();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        VendingMachine11 vm=<span class="keyword">new</span> VendingMachine11(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter19/product.txt"</span>);</span><br><span class="line">        vm.run(<span class="keyword">new</span> RandomInputGenerator11());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="TextFile-java"><a href="#TextFile-java" class="headerlink" title="TextFile.java"></a>TextFile.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextFile</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// Read a file as a single string:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">read</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedReader in= <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(fileName).getAbsoluteFile()));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String s;</span><br><span class="line">                <span class="keyword">while</span>((s = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    sb.append(s);</span><br><span class="line">                    sb.append(<span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TextFile</span><span class="params">(String fileName, String splitter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Arrays.asList(read(fileName).split(splitter)));</span><br><span class="line">        <span class="comment">// Regular expression split() often leaves an empty</span></span><br><span class="line">        <span class="comment">// String at the first position:</span></span><br><span class="line">        <span class="keyword">if</span>(get(<span class="number">0</span>).equals(<span class="string">""</span>)) remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Normally read by lines:</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TextFile</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(fileName, <span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="product-txt"><a href="#product-txt" class="headerlink" title="product.txt"></a>product.txt</h5><p>存放商品条目的文本文件。每行存放一种商品的信息。第一项：商品名，第二项：价格。中间用tab符号分隔。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TOOTTHPASTE&#9;200&#10;CHIPS&#9;75&#10;SODA&#9;100&#10;SOAP&#9;50</span><br></pre></td></tr></table></figure></p>
<h5 id="Exercise11-java"><a href="#Exercise11-java" class="headerlink" title="Exercise11.java"></a>Exercise11.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ciaoshen.thinkinjava.chapter19;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exercise11</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        VendingMachine11 vm=<span class="keyword">new</span> VendingMachine11(<span class="string">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter19/product.txt"</span>);</span><br><span class="line">        Generator&lt;Input11&gt; gen=<span class="keyword">new</span> RandomInputGenerator11();</span><br><span class="line">        vm.run(gen);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/枚举/" rel="tag">#枚举</a>
          
            <a href="/tags/状态机/" rel="tag">#状态机</a>
          
            <a href="/tags/职责链/" rel="tag">#职责链</a>
          
            <a href="/tags/表驱动/" rel="tag">#表驱动</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/19/nio/" rel="next" title="【转】NIO入门">
                <i class="fa fa-chevron-left"></i> 【转】NIO入门
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/10/26/tij4-20/" rel="prev" title="Thinking in Java 读书笔记：第二十章 - 注释">
                Thinking in Java 读书笔记：第二十章 - 注释 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/10/20/tij4-19/"
           data-title="Thinking in Java 读书笔记：第十九章 - 枚举" data-url="www.ciaoshen.com/2016/10/20/tij4-19/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/shenAvatar.jpg"
               alt="沈玮 | Wei SHEN" />
          <p class="site-author-name" itemprop="name">沈玮 | Wei SHEN</p>
          <p class="site-description motion-element" itemprop="description">Coder & Designer</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">61</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">198</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/helloShen" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.douban.com/people/72441576/" target="_blank">
                  
                    <i class="fa fa-globe"></i> DouBan
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/pang-pang-37-37" target="_blank">
                  
                    <i class="fa fa-globe"></i> ZhiHu
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Enum的一些基本性质"><span class="nav-number">1.</span> <span class="nav-text">Enum的一些基本性质</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#枚举型都是java-lang-Enum的派生类"><span class="nav-number">1.1.</span> <span class="nav-text">枚举型都是java.lang.Enum的派生类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#枚举型可以有自己的成员"><span class="nav-number">1.2.</span> <span class="nav-text">枚举型可以有自己的成员</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#枚举型的实质是“单例模式”的变种"><span class="nav-number">1.3.</span> <span class="nav-text">枚举型的实质是“单例模式”的变种</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#枚举类内部还可以定义抽象方法"><span class="nav-number">1.4.</span> <span class="nav-text">枚举类内部还可以定义抽象方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#扒光枚举类的全部语法糖"><span class="nav-number">1.5.</span> <span class="nav-text">扒光枚举类的全部语法糖</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#利用反射获取enum实例"><span class="nav-number">2.</span> <span class="nav-text">利用反射获取enum实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#枚举型作为成员字段是“静态的”"><span class="nav-number">3.</span> <span class="nav-text">枚举型作为成员字段是“静态的”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EnumSet"><span class="nav-number">4.</span> <span class="nav-text">EnumSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EnumMap"><span class="nav-number">5.</span> <span class="nav-text">EnumMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#职责链（Chain-of-Responsibility）和状态机"><span class="nav-number">6.</span> <span class="nav-text">职责链（Chain of Responsibility）和状态机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多路分发"><span class="nav-number">7.</span> <span class="nav-text">多路分发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#问题"><span class="nav-number">7.1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案"><span class="nav-number">7.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用枚举型多路分发"><span class="nav-number">7.3.</span> <span class="nav-text">用枚举型多路分发</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表驱动编码"><span class="nav-number">8.</span> <span class="nav-text">表驱动编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习"><span class="nav-number">9.</span> <span class="nav-text">练习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#本章练习常用工具包"><span class="nav-number">9.1.</span> <span class="nav-text">本章练习常用工具包</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#枚举随机器"><span class="nav-number">9.1.1.</span> <span class="nav-text">枚举随机器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-1"><span class="nav-number">9.2.</span> <span class="nav-text">Exercise 1</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Signal-java"><span class="nav-number">9.2.1.</span> <span class="nav-text">Signal.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TrafficLight-java"><span class="nav-number">9.2.2.</span> <span class="nav-text">TrafficLight.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise1-java"><span class="nav-number">9.2.3.</span> <span class="nav-text">Exercise1.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-2"><span class="nav-number">9.3.</span> <span class="nav-text">Exercise 2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-3"><span class="nav-number">9.4.</span> <span class="nav-text">Exercise 3</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Food-java"><span class="nav-number">9.4.1.</span> <span class="nav-text">Food.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Course-java"><span class="nav-number">9.4.2.</span> <span class="nav-text">Course.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise3-java"><span class="nav-number">9.4.3.</span> <span class="nav-text">Exercise3.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-4"><span class="nav-number">9.5.</span> <span class="nav-text">Exercise 4</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Meal2-java"><span class="nav-number">9.5.1.</span> <span class="nav-text">Meal2.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise4-java"><span class="nav-number">9.5.2.</span> <span class="nav-text">Exercise4.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-5"><span class="nav-number">9.6.</span> <span class="nav-text">Exercise 5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-6"><span class="nav-number">9.7.</span> <span class="nav-text">Exercise 6</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Letters-java"><span class="nav-number">9.7.1.</span> <span class="nav-text">Letters.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise6-java"><span class="nav-number">9.7.2.</span> <span class="nav-text">Exercise6.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-7"><span class="nav-number">9.8.</span> <span class="nav-text">Exercise 7</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-8"><span class="nav-number">9.9.</span> <span class="nav-text">Exercise 8</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Mail-java"><span class="nav-number">9.9.1.</span> <span class="nav-text">Mail.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PostOffice-java"><span class="nav-number">9.9.2.</span> <span class="nav-text">PostOffice.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise8-java"><span class="nav-number">9.9.3.</span> <span class="nav-text">Exercise8.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-9"><span class="nav-number">9.10.</span> <span class="nav-text">Exercise 9</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Mail-java-1"><span class="nav-number">9.10.1.</span> <span class="nav-text">Mail.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PostOffice9-java"><span class="nav-number">9.10.2.</span> <span class="nav-text">PostOffice9.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise9-java"><span class="nav-number">9.10.3.</span> <span class="nav-text">Exercise9.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-10"><span class="nav-number">9.11.</span> <span class="nav-text">Exercise 10</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Input-java"><span class="nav-number">9.11.1.</span> <span class="nav-text">Input.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Category-java"><span class="nav-number">9.11.2.</span> <span class="nav-text">Category.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RandomInputGenerator-java"><span class="nav-number">9.11.3.</span> <span class="nav-text">RandomInputGenerator.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#VendingMachine-java"><span class="nav-number">9.11.4.</span> <span class="nav-text">VendingMachine.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise10-java"><span class="nav-number">9.11.5.</span> <span class="nav-text">Exercise10.java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Exercise-11"><span class="nav-number">9.12.</span> <span class="nav-text">Exercise 11</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Input11-java"><span class="nav-number">9.12.1.</span> <span class="nav-text">Input11.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RandomInputGenerator11-java"><span class="nav-number">9.12.2.</span> <span class="nav-text">RandomInputGenerator11.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Category11-java"><span class="nav-number">9.12.3.</span> <span class="nav-text">Category11.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#VendingMachine11-java"><span class="nav-number">9.12.4.</span> <span class="nav-text">VendingMachine11.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TextFile-java"><span class="nav-number">9.12.5.</span> <span class="nav-text">TextFile.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#product-txt"><span class="nav-number">9.12.6.</span> <span class="nav-text">product.txt</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Exercise11-java"><span class="nav-number">9.12.7.</span> <span class="nav-text">Exercise11.java</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">沈玮 | Wei SHEN</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io" rel="external nofollow">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>
</div>

</br>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div>
  <span id="busuanzi_container_site_pv">
  Visited  <span id="busuanzi_value_site_pv"></span>  times
  </span>

<span id="busuanzi_container_site_pv">&nbsp; &nbsp; | &nbsp; &nbsp;</span>

  <span id="busuanzi_container_site_uv">
  <span id="busuanzi_value_site_uv"></span>  Visitors
  </span>
<div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ciaoshen"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  





  
  

  
  


</body>
</html>
