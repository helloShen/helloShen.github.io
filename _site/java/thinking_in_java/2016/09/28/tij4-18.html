<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Thinking {SHEN}</title>

    <!-- Bootstrap Core CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Blog Template CSS -->
    <link href="/assets/css/blog.css" rel="stylesheet">
    <!-- jQuery Version 1.11.1 -->
    <script src="/assets/js/jquery.js"></script>
    <!-- footer bar -->
    <link href="/assets/css/footer.css" rel="stylesheet">
    <!-- code highlight. I also have other options. But this one looks good! -->
    <link href="/assets/css/jekyll-github.css" rel="stylesheet">
    <!-- Sidebar -->
    <!--<link href="/assets/css/sidebar.css" rel="stylesheet">-->


    <!-- Custom CSS -->
    <style>
        body {
            padding-top: 70px;
            /* Required padding for .navbar-fixed-top. Remove if using .navbar-static-top. Change if height of navigation changes. */
        }
        .container {
            width: 80%;
        }
    </style>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="">Thinking {SHEN}</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/resume/">Resume</a>
                    </li>
                    <li>
                        <a href="/thinkinginjava/">Thinking in Java</a>
                    </li>
                    <li>
                        <a href="#">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Container -->
    <div class="container">

        <!-- Page Title -->
        <div class="text-center">
      <!-- page-header是Bootstrap内置页头组件 -->
      <div class="page-header">
          <h1>[Thinking in Java] Note: Chapter 18 - IO</h1>
      </div>
      <h5 class="blog-post-meta">
                <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span> &nbsp
                2016-09-28 15:55:14 -0400
                &nbsp | &nbsp
                <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> &nbsp
            
                <a href="/categories/Java.html"><span class="label label-primary"><b>Java</b></span></a>
                &nbsp
            
                <a href="/categories/Thinking_in_Java.html"><span class="label label-primary"><b>Thinking_in_Java</b></span></a>
                &nbsp
            
                &nbsp | &nbsp
                <span class="glyphicon glyphicon-comment" aria-hidden="true"></span> &nbsp
                <a href="#disqus_thread "></a>
      </h5>
      <h5 class="blog-post-meta">
          <span class="glyphicon glyphicon-tags" aria-hidden="true"></span> &nbsp
          
              <a href="/tags/IO.html"><span class="label label-default">IO</span></a>
              &nbsp
          
              <a href="/tags/File.html"><span class="label label-default">File</span></a>
              &nbsp
          
              <a href="/tags/Stream.html"><span class="label label-default">Stream</span></a>
              &nbsp
          
      </h5>
</div>


        <!-- Page Content -->
        <h3 id="file">File</h3>
<p>File的本质是一个<strong>“文件地址标识”</strong>。内部维护着表示绝对路径的String。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="n">String</span> <span class="n">path</span><span class="o">;</span>
</code></pre>
</div>

<p>File不是单指某一个文件，而是 <strong>“绝对地址”</strong> 目录下的所有文件。<strong>“注意”：不迭代目录。只返回第一层的文件列表。</strong></p>

<ul>
  <li><strong>File对象比单纯文件名更有用。因为包含了更多有用的信息。</strong></li>
</ul>

<h4 id="filelist">File#list()</h4>
<p><strong>“绝对地址”</strong> 目录下的所有文件列表可以用 <strong>File#list()</strong> 方法得到。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">list</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">SecurityManager</span> <span class="n">security</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">security</span><span class="o">.</span><span class="na">checkRead</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">fs</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>这个方法调用的<strong>fs</strong>：指的是native数据<strong>FileSystem</strong>。所以返回文件列表的动作是系统替我们完成的。不是用Java实现的。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">private</span> <span class="n">FileSystem</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">FileSystem</span><span class="o">.</span><span class="na">getFileSystem</span><span class="o">();</span>
</code></pre>
</div>

<p>但我们还是可以对返回的List有所控制。通过给list()方法传入一个FilenameFilter对象做参数。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">list</span><span class="o">(</span><span class="n">FilenameFilter</span> <span class="n">filter</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">names</span><span class="o">[]</span> <span class="o">=</span> <span class="n">list</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">names</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">filter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">names</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">names</span><span class="o">.</span><span class="na">length</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">names</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                <span class="n">v</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">names</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">v</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>list()方法会回调FilenameFilter对象的accept()方法，判断某个文件是否符合过滤条件。accept()方法用个正则表达式就行了。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>	<span class="n">File</span> <span class="n">path</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
	<span class="n">String</span><span class="o">[]</span> <span class="n">list</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="k">new</span> <span class="n">FilenameFilter</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">private</span> <span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
		<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">matches</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">});</span>
</code></pre>
</div>

<p>这是一个标准的<strong>“策略模式”</strong>的良好实践。</p>

<h4 id="递归获取某个地址下的所有文件">递归获取某个地址下的所有文件</h4>
<p>非常常用的功能。完全可以写进自己的类库。</p>

<p>具体实现参见本章练习4，5，6.</p>

<h3 id="流stream家族">“流（Stream）”家族</h3>
<p>Java IO有60个类。但只要思路清晰，它们各自的用途还是很明确的。</p>

<h4 id="两大家族面向字节--面向字符">两大家族：面向字节 &amp; 面向字符</h4>
<p>首先要明确，IO有两大家族：</p>
<ul>
  <li><strong>InputStream, OutputStream：面向字节。</strong></li>
  <li><strong>Reader, Writer：面向字符。</strong></li>
</ul>

<p>上两张全家福：
<img src="/images/tij4-18/streamZoo.jpg" alt="streamZoo" />
<img src="/images/tij4-18/readerWriter.gif" alt="readerWriter" /></p>

<h5 id="字节到字符的编码">字节到字符的编码</h5>
<p>什么是面向字节？什么是面向字符？先要从最基本的概念说起：</p>

<ul>
  <li><strong>一个字节（byte）：8 bit</strong></li>
  <li><strong>一个字符（char）：16 bit Unicode</strong></li>
</ul>

<p>基本单位一个<strong>”字节“</strong>占<strong>8个bit</strong>。这很简单。Java里的基本字符<strong>char</strong>基于UTF-16。和只占一个字节的ASCII码不同，常规字符占用两个字节，16 bit。</p>

<p>要搞懂各种编码之间的前世今生，推荐下面这篇比较好懂的文章：
<a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html"><strong>《字符编码笔记：ASCII，Unicode和UTF-8》</strong></a></p>

<h6 id="ascii">ASCII</h6>
<p>简单讲就是，一个字节8 bit，最多为256个符号编码。所以英语26个字母，再加几个常用符号，标点，256个码位足够了。这就熟悉的<strong>ASCII码</strong>。如下图，ASCII码一共收录了空格及94个“可印刷字符”。
<img src="/images/tij4-18/ascii.png" alt="ascii" /></p>

<h6 id="isoiec-8859-1">ISO/IEC 8859-1</h6>
<p>ASCII给英语用足够了。但其他的语言，比如拉丁语系的法语西班牙语等语言都有自己的特殊字母。所以，世界的每个不同地区又有了自己的特殊编码标准。比如<strong>ISO/IEC 8859-n</strong>系就是国际标准化组织定义的一系列8位字符集。也只占一个字节。最常用的比如<strong>ISO/IEC 8859-1</strong>就是法语，芬兰语所用的西欧字符集。
<img src="/images/tij4-18/8859.png" alt="8859" /></p>

<h6 id="中文编码">中文编码</h6>
<p>汉字有好几万个。编码一个8 bit，256个码位就不够了。所以我国的汉字编码现行标准是<a href="https://zh.wikipedia.org/wiki/GB_18030"><strong>《GB 18030》</strong></a>。每个字可以由1个、2个或4个字节组成，编码空间有161万个字符。另一个中国常用编码集是Big5。全世界各国都有自己的<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><strong>《字元编码标准》</strong></a>。</p>

<h6 id="unicode">Unicode</h6>
<p>但这样编码的缺点很明显，同一个文件，到了另一个国家，用另一套编码集来解码，会产生乱码。在全球化的今天，最好全世界有一套统一的字符编码集。这就是<a href="https://zh.wikipedia.org/wiki/Unicode"><strong>《Unicode》</strong></a>。Unicode的理念就是那么直接 – <strong>每种不同语言的不同字符都有一个单独编码</strong>。最初，Unicode占用2个字节，最多编码<strong>256*256=65536</strong>个字符。但很快从3.1版本开始就不够用了。所以又搞出了<strong>附加字符集</strong>。附加字符用4个字节表示。目前Unicode已对总共超过12万个字符编码。</p>

<h6 id="utf-8">UTF-8</h6>
<p>这里需要搞清楚一件事：<strong>Unicode只是一套符号的编码。但计算机具体怎么读取这套编码，又是另外一件事。</strong></p>

<p>我们可以老老实实地用2个字节，16位来表示一个Unicode字符。每次老老实实读取两个字节。然后在读到某个特殊标记的时候，知道是附加字符集，需要再往后读2个字节。但由于英语是使用最广泛的语言，明明一个字符就能完成，现在非要用2个字符。浪费了内存空间。不符合编码的规范：常用字符用最短的编码。所以就要想办法怎么能用一个字节表示英语，其他字符用多个字节。而且又要让电脑能够识别，自动处理。这就是UTF-8做的事。一本正经下定义的话：关键就是<strong>可变长编码</strong>。</p>
<ul>
  <li><strong>UTF-8（8-bit Unicode Transformation Format）是一种针对Unicode的可变长度字元编码，也是一种前缀码。</strong></li>
</ul>

<p>UTF-8编码规则，如下图。可变长编码的关键就是：怎么让电脑知道每次需要读多大长度。所以必然需要某种标识。
<img src="/images/tij4-18/utf8.png" alt="utf8" />
具体的规则，很简单，只有两条：</p>
<ol>
  <li>对于单字节的符号，字节的第一位设为0，后面7位为这个符号的unicode码。因此对于英语字母，UTF-8编码和ASCII码是相同的。</li>
  <li>对于n字节的符号（n&gt;1），第一个字节的前n位都设为1，第n+1位设为0，后面字节的前两位一律设为10。剩下的没有提及的二进制位，全部为这个符号的unicode码。</li>
</ol>

<h6 id="utf-16">UTF-16</h6>
<p>UTF-16和UTF-8的不同在于，它用2个字节表示一些常用字符，4个字节表示附加字符。</p>

<p>具体编码规则，参见<a href="https://www.ibm.com/developerworks/cn/java/j-unicode/"><strong>《使用 Java 语言进行 Unicode 代理编程》</strong></a>这篇文章。</p>

<h4 id="优先考虑面向字符的流">优先考虑面向字符的流</h4>
<p>如果使用面向字节的流，那我们就必须自己处理上面介绍的从字节到字符的编码转换工作。比如根据UTF-16编码规则把byte[]数组解码成String字符串。虽然String类的构造器可以完成编码到字符映射的工作，一个String对象也有getBytes()方法反向编码。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code> <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"我是沈玮"</span><span class="o">;</span>
 <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
 <span class="n">String</span> <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="s">"UTF-8"</span><span class="o">);</span>
</code></pre>
</div>
<p>但这样也增加了很多工作量。所以大多数情况应该优先使用面向字符的流。</p>

<p>关于Java的编码问题，也有一篇好的阅读材料：<a href="https://www.ibm.com/developerworks/cn/java/j-lo-chinesecoding/"><strong>《深入分析 Java 中的中文编码问题》</strong></a>。</p>

<h4 id="数据的编码">数据的编码</h4>
<p>除了byte到char需要编码和解码，其他基本型也不是直接读取就可以的。不同数据类型有不同的长度，而且内部数据编排原理也各不相同。以双精度浮点数double为例，
<img src="/images/tij4-18/double.png" alt="double" />
首先，double型的长度为64 bit。占据8个字节。最高位63位表示正负号，62-52的高11位为指数位，51-0的低52位表示尾数。</p>

<p>对double型的解码，虽然不需要一个几十万规模的字符集，但也需要一个转换。</p>

<h4 id="装饰器模式">装饰器模式</h4>
<p>装饰器模式的基本思想很简单，就是利用组合和代理为类添加新功能。</p>

<p>比如一个最简单的容器模型Basic类。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Basic</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="n">String</span> <span class="n">value</span><span class="o">;</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>需要有一个所有装饰器的基类。把Basic类作为一个成员字段，以及一个以Basic类对象为参数的构造器。其实就是简单地用一个Basic对象做代理，封装所有方法。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Decorator</span> <span class="kd">extends</span> <span class="n">Basic</span> <span class="o">{</span>
	<span class="kd">protected</span> <span class="n">Basic</span> <span class="n">basic</span><span class="o">;</span>
	<span class="kd">public</span> <span class="nf">Decorator</span><span class="o">(</span><span class="n">Basic</span> <span class="n">basic</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">basic</span> <span class="o">=</span> <span class="n">basic</span><span class="o">;</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span> <span class="n">basic</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">val</span><span class="o">);</span> <span class="o">}</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">basic</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>所有的装饰类继承原始装饰器基类后，可以在原有Basic基础上添加新功能。而它的构造器就是一个普通Basic类。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TimeStamped</span> <span class="kd">extends</span> <span class="n">Decorator</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeStamp</span><span class="o">;</span>
	<span class="kd">public</span> <span class="nf">TimeStamped</span><span class="o">(</span><span class="n">Basic</span> <span class="n">basic</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">basic</span><span class="o">);</span>
		<span class="n">timeStamp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">getStamp</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">timeStamp</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="java-io为什么用装饰器模式">Java IO为什么用装饰器模式？</h5>
<p>Java用装饰器模式实现IO，<strong>主要是为了减少库中类的数量。通过拼装有限的功能组件，最终实现具有复合型功能的IO工具。</strong></p>

<p>虽然Java IO包里类一点也不少，一共有60个类。但它们能够组合出来的具有不同功能的工具数量更是惊人。这么说，Java IO虽然有点难用，但还是挺成功的。</p>

<h5 id="谁直接接触数据源谁用来装饰">谁直接接触数据源？谁用来装饰？</h5>
<p>要理清IO包的脉络，一定要明确一个思路，IO包中的类分为<strong>两种不同的角色</strong>：</p>
<ul>
  <li><strong>一类是直接对数据源进行读写的。</strong></li>
  <li><strong>另一类是添加功能的过滤器。</strong></li>
</ul>

<p><strong>“核心IO”</strong>：负责直接读写特定类型数据源。以（InputStream，OutputStream），或者（Reader，Writer）为基类。
	* File######：
	* String######:
	* ByteArray######(or: CharArray######):
	* Piped######:
	* Zip######:</p>

<p><strong>“过滤器”</strong>：负责改变流的行为。以（FilterInputStream，FilterOutputStream），或者（FilterReader，FilterWriter）为基类。
	* Buffered######:
	* Data######:
	* Print######:
	* Pushback######:</p>

<h5 id="组合流过滤器">组合流过滤器</h5>
<p>一般使用IO包的模式就是：<strong>在核心IO类的外面套过滤器。</strong></p>

<p>考虑下面这个例子：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">DataInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">Data</span><span class="o">.</span><span class="na">txt</span><span class="o">))));</span>
</code></pre>
</div>
<p>FileInputStream负责从本地文件读取字节流。然后套上一层BufferedInputStream缓冲器，避免频繁读取磁盘。最后还要套上DataInputStream装饰器，为的是方便读取不同类型的数据。</p>

<p>构造器层面，能够这样装配，因为FileInputStream有一个接受File为参数的构造器。BufferedInputStream和DataInputStream都有一个接受InputStream为参数的构造器。这就是装饰器模式的工作方式。</p>

<p>我们把DataInputStream套在最外面，最后暴露给我们的是DataInputStream类的接口，这是因为我们要用的就是DataInputStream所独有的比如readInt(), readDouble()这样方便读取数据的方法。</p>

<p>我们把BufferedInputReader夹在中间，但不用担心他的功能被覆盖掉。因为DataInputStream读取数据的方法，比如readInt()最终调用的都是read()方法（源代码如下）：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">readInt</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">ch1</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">ch2</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">ch3</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">ch4</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">ch1</span> <span class="o">|</span> <span class="n">ch2</span> <span class="o">|</span> <span class="n">ch3</span> <span class="o">|</span> <span class="n">ch4</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EOFException</span><span class="o">();</span>
        <span class="k">return</span> <span class="o">((</span><span class="n">ch1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">ch2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">ch3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">ch4</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre>
</div>
<p>因为int型占4个字节，所以调用4次read()方法。由于DataInputStream没有定义自己的无参数read()方法。所以根据其基类FilterInputStream类的无参数read()方法，直接调用的就是BufferedInputStream的read()方法。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre>
</div>
<p>而BufferedInputStream的read()方法是实现了缓冲功能的。所以BufferedInputStream的缓冲作用也得以发挥。同时又拥有了DataInputStream的特殊数据读取接口。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">fill</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="o">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">getBufIfOpen</span><span class="o">()[</span><span class="n">pos</span><span class="o">++]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>所以一般把DataInputStream或者PrintStream这种拥有特殊接口的类套在最外面，然后把BufferedInputStream夹在中间，最后由FileInputStream或者StringInputStream负责直接面对数据源，是套嵌多层过滤器的通用做法。</p>

<h5 id="缓冲器buffer是怎么工作的">缓冲器Buffer是怎么工作的？</h5>
<p>作为最常用的过滤器，每个流不管是输入还是输出都会被套上一层“缓冲器”。缓冲器的原理其实很简单：一次性读取很多数据到内存，作为缓存，以后每次read就从缓存里取，而不是每次都磁盘操作读取实际文件。输出缓冲的原理也是一样，多攒一点内容才执行实际读写。下面代码是BufferedInputStream的部分源码：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BufferedInputStream</span> <span class="kd">extends</span> <span class="n">FilterInputStream</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">defaultBufferSize</span> <span class="o">=</span> <span class="mi">8192</span><span class="o">;</span>

    <span class="cm">/**
     * The internal buffer array where the data is stored. When necessary,
     * it may be replaced by another array of
     * a different size.
     */</span>
    <span class="kd">protected</span> <span class="kd">volatile</span> <span class="kt">byte</span> <span class="n">buf</span><span class="o">[];</span>

	<span class="c1">//... ...</span>
<span class="o">}</span>
</code></pre>
</div>
<p>可以看到，BufferedInputStream的缓冲区是一个字节数组<strong>byte buf[]</strong>。默认大小是8192字节，总共64k bit。</p>

<p>下面是它的read()方法。很简单，如果缓存读完了，就执行fill()方法重新填充。否则就直接用getBufIfOpen()方法读取缓存数组。其中pos作为数组的游标。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>	<span class="c1">//缓存读完</span>
            <span class="n">fill</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="o">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">getBufIfOpen</span><span class="o">()[</span><span class="n">pos</span><span class="o">++]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>
<p>getBufIfOpen()方法就是简单返回缓存数组。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="cm">/**
     * Check to make sure that buffer has not been nulled out due to
     * close; if not return it;
     */</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBufIfOpen</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">buf</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Stream closed"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>
<p>fill()方法稍微复杂一点，但抛开前面的各种安全检测，最后就是用getInIfOpen()方法获取它装饰的输入流。然后调用被装饰输入流的read()方法读取数据，放到缓存buffer里。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="cm">/**
     * Fills the buffer with more data, taking into account
     * shuffling and other tricks for dealing with marks.
     * Assumes that it is being called by a synchronized method.
     * This method also assumes that all data has already been read in,
     * hence pos &gt; count.
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">fill</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">getBufIfOpen</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">markpos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>            <span class="cm">/* no mark: throw away the buffer */</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>  <span class="cm">/* no room left in buffer */</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">markpos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  <span class="cm">/* can throw away early part of the buffer */</span>
                <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">markpos</span><span class="o">;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">markpos</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">sz</span><span class="o">);</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">sz</span><span class="o">;</span>
                <span class="n">markpos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="n">marklimit</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">markpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>   <span class="cm">/* buffer got too big, invalidate mark */</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>        <span class="cm">/* drop buffer contents */</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>            <span class="cm">/* grow buffer */</span>
                <span class="kt">int</span> <span class="n">nsz</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">nsz</span> <span class="o">&gt;</span> <span class="n">marklimit</span><span class="o">)</span>
                    <span class="n">nsz</span> <span class="o">=</span> <span class="n">marklimit</span><span class="o">;</span>
                <span class="kt">byte</span> <span class="n">nbuf</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">nsz</span><span class="o">];</span>
                <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">nbuf</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">pos</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">bufUpdater</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">nbuf</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// Can't replace buf if there was an async close.</span>
                    <span class="c1">// Note: This would need to be changed if fill()</span>
                    <span class="c1">// is ever made accessible to multiple threads.</span>
                    <span class="c1">// But for now, the only way CAS can fail is via close.</span>
                    <span class="c1">// assert buf == null;</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Stream closed"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">nbuf</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">getInIfOpen</span><span class="o">().</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">pos</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">pos</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">pos</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<h3 id="一些常见使用场景">一些常见使用场景</h3>
<p>把握住上面这个组合装饰器的原则，java IO的一些习惯用法就很好理解了。</p>

<h4 id="读取本地文本文件">读取本地文本文件</h4>
<p>一般Unicode编码的文本文件，可以用面向字符的FileReader读取，再套一个缓冲器BufferedReader。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">Data</span><span class="o">.</span><span class="na">txt</span><span class="o">)));</span>
</code></pre>
</div>

<h4 id="从内存读取">从内存读取</h4>
<p>一般把数据封装成String，然后用StringReader读取。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"Hello World!"</span><span class="o">;</span>
<span class="n">StringReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</code></pre>
</div>

<h4 id="格式化内存读取">格式化内存读取</h4>
<p>格式化读取就必须用DataInputStream。因为DataInputStream是面向字节的，可以用把String打散成byte[]数组，然后用ByteArrayInputStream读取。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"Hello World!"</span><span class="o">;</span>
<span class="n">DataInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</code></pre>
</div>

<h4 id="基本文件输出">基本文件输出</h4>
<p>写入本地文件，最好用PrintWriter。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">PrintWriter</span> <span class="n">pr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">Data</span><span class="o">.</span><span class="na">txt</span><span class="o">))));</span>
</code></pre>
</div>

<h4 id="文件输出快捷方式">文件输出快捷方式</h4>
<p>PrintWriter有一个直接接受File为参数的构造器。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">PrintWriter</span> <span class="n">pr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">Data</span><span class="o">.</span><span class="na">txt</span><span class="o">));</span>
</code></pre>
</div>

<h3 id="底层输入输出是怎么实现的">底层“输入”“输出”是怎么实现的？</h3>
<p>到目前为止，所有的描述到了附着于具体数据读写对象的“核心IO”类就结束了。具体的读写操作被想象成一个“黑箱”过程。这里，以FileInputStream为例，解释一下，一个本地文件到底是怎么被打开，然后读取到内存的。此处主要参考了[** 《JNI探秘—–你不知道的FileInputStream的秘密》 <strong>](http://www.cnblogs.com/zuoxiaolong/p/jni1.html)这篇文章。感谢作者 – **左潇龙</strong>。</p>

<p>先看FileInputStream源码中的一小段：</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileInputStream</span> <span class="kd">extends</span> <span class="n">InputStream</span> <span class="o">{</span>
    <span class="cm">/* File Descriptor - handle to the open file */</span>
    <span class="kd">private</span> <span class="n">FileDescriptor</span> <span class="n">fd</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">FileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">FileNotFoundException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">FileNotFoundException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="n">file</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">file</span><span class="o">.</span><span class="na">getPath</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">SecurityManager</span> <span class="n">security</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">security</span><span class="o">.</span><span class="na">checkRead</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileDescriptor</span><span class="o">();</span>
    <span class="n">open</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
	<span class="c1">//... ...</span>
<span class="o">}</span>
</code></pre>
</div>
<p>这段代码有两个重点：</p>
<ol>
  <li>有个FileDescriptor字段</li>
  <li>构造函数最后调用了open(name)方法。</li>
</ol>

<p>FileDescriptor类里最关键的是这个叫handle的字段。就是我们打开文件的<strong>句柄（handle）</strong>。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">FileDescriptor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">fd</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">handle</span><span class="o">;</span>

	<span class="c1">//... ...</span>
<span class="o">}</span>
</code></pre>
</div>

<p>而open()方法是个native方法。如下所示，内部就是简单调用了另一个系统方法<strong>fileOpen()</strong>。</p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
<span class="nf">Java_java_io_FileInputStream_open</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">this</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fileOpen</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">fis_fd</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>而Windows系统fileOpen()方法的作用就是：<strong>获得目标文件的句柄，并赋值给handle字段。</strong></p>
<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cm">/*
    env是一个指向JAVA本地方法环境的指针，它的作用大部分用来获取环境参数，比如当前线程。
    this相信大家都不陌生，这就是指的当前FileInputStream的实例，只不过在C/C++环境中，它是jobject类型
    path就是文件路径了，也是我们传进来的name参数
    fid是FileInputStream类中fd属性的地址偏移量
    flags是打开文件的方式，一般就是只读方式。
*/</span>
<span class="kt">void</span> <span class="nf">fileOpen</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">this</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">path</span><span class="p">,</span> <span class="n">jfieldID</span> <span class="n">fid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">jlong</span> <span class="n">h</span> <span class="o">=</span> <span class="n">winFileHandleOpen</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span><span class="c1">//这一句话就得到了一个文件的句柄
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SET_FD</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fid</span><span class="p">);</span><span class="c1">//这一句话就是将这个句柄赋给了FileDescriptor类的handle属性
</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>所以打开一个文件的本质很简单，就是获得这个文件在系统中的“句柄”，然后根据这个句柄，顺藤摸瓜找到这个文件在磁盘上的物理地址。最后对磁盘进行读写。</p>

<h3 id="新io">新I/O</h3>
<p>和老io包的 <strong>“面向流”</strong> 读写不同，引入java.nio包是 <strong>“面向缓冲区”</strong> 的读写。</p>

<h4 id="什么是面向缓冲区">什么是面向缓冲区？</h4>
<p>“面向流”之前已经讲了，就是老IO包所有操作的的底层都是在InputStream和OutputStream的流上进行操作。上文已经分析过，比如我们打开文件，其实就是直接获取此文件在系统上的句柄，然后通过系统调用对文件进行读写。中间没有缓冲（BufferedReader那是通过装饰器套上的）。</p>

<p>而“面向缓冲区”的结构由两个部分组成：一个是管道“FileChannel”，一个是缓冲区“ByteBuffer”。他们两个就像是 <strong>“煤矿隧道”</strong> 和 <strong>“拉煤车”</strong> 的关系。至于样的模型为什么要比传统面向流的模型要高效，背后涉及两个不同的I/O模型。</p>

<h4 id="传统阻塞式io">传统阻塞式I/O</h4>
<p>旧IO包采用的是传统阻塞式IO模式。如下图所示，阻塞式IO就是用户进程在系统调用读写文件时，保持“阻塞”。大白话讲就是知道文件完整地读写完之前，用户进程一直处在等待状态。
<img src="/images/tij4-18/blockingIO.png" alt="blockingIO" /></p>

<h4 id="多路复用io">多路复用I/O</h4>
<p>新IO采用的是复用I/O模型。简单讲就是第一个select步骤就是用户问系统他要的文件有没有准备好。之后的recvfrom才是真正的文件复制阶段。
<img src="/images/tij4-18/multiIO.png" alt="multiIO" /></p>

<p>至于这个复用I/O模型好在哪儿，关键就在于它允许内核同时管理多条“管道”。最基本的是一个叫Reactor的模式。
<img src="/images/tij4-18/reactor.png" alt="reactor" /></p>

<p>用户向内核注册感兴趣的事件（用register()方法），由内核维护一个负责轮询的线程，在某个同道准备好之后，通知用户。
nio多路复用的架构几乎就是UNIX内核的“管道-缓冲”架构的翻版。主要是为了更好地充分利用底层系统调用。实际上NIO在性能上已经几乎达到了它能达到的最佳性能。</p>

<h4 id="两者的区别">两者的区别</h4>
<p>一张图，看清旧io包和nio包的区别。映证了NIO使用了Reactor模式。
<img src="/images/tij4-18/oldIOnewIO.jpg" alt="oldIOnewIO" /></p>

<h4 id="演示">演示</h4>
<p>注意FileChannel并没有实现SelectableChannel接口，因此不支持Selector。只有用于网络传输的ServerSocketChannel才实现了SelectableChannel接口。 下面这个清单演示了一次创建Channel，Selector，以及Channel向Selector注册感兴趣事件，获得注册钥的过程。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">//创建Selector</span>
<span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>

<span class="c1">//创建Channel</span>
<span class="n">ServerSocketChannel</span> <span class="n">ssc</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="n">ssc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span> <span class="kc">false</span> <span class="o">);</span>
<span class="n">ServerSocket</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">socket</span><span class="o">();</span>
<span class="n">InetSocketAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span> <span class="n">ports</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">);</span>
<span class="n">ss</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span> <span class="n">address</span> <span class="o">);</span>

<span class="c1">//Channel向Selector注册感兴趣事件</span>
<span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ssc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span> <span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span> <span class="o">);</span>
</code></pre>
</div>
<p>接下来，用Selector#selectedKey()方法监听发生的感兴趣事件，对返回的就绪的SelectionKey一一处理。</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>

<span class="n">Set</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
<span class="n">Iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">selectedKeys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

<span class="k">while</span> <span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="n">SelectionKey</span><span class="o">)</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
     <span class="c1">// ... deal with I/O event ...</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="buffer的细节">Buffer的细节</h4>
<p>通过mark,position,limit,capacity四个标量控制缓冲区的读写。可以前进，可以后退，比传统流只能一位位往下读写更灵活。
<img src="/images/tij4-18/buffer.jpg" alt="buffer" /></p>

<h4 id="mappedbytebuffer">MappedByteBuffer</h4>
<p>一篇好文章：<a href="http://blog.jobbole.com/104880/">** 《深入浅出 MappedByteBuffer》 **</a></p>

<h3 id="序列化">序列化</h3>
<p>既然类和对象的本质就是数据的封装。那么无论是类还是对象，本质都是一组结构化的数据，也就是都可以序列化。</p>

<p>支持序列化的类必须实现 <strong>“Serializable”</strong> 接口。它只是一个标记性接口，没有定义任何方法。</p>

<p>一个序列化的对象可以被编码成流写入磁盘，“持久”储存。并且对象序列化<strong>保存的是对象的“全景图”和它所包含的所有引用</strong>。</p>

<p>对象序列化具体是一个很复杂的过程，尽量不要自己重复造轮子。用系统自带的 <strong>“ObjectOutputStream”</strong> 和 <strong>“ObjectInputStream”</strong> 就可以。</p>

<p>对象的“持久化”似乎为OO编程在工程上打开了一扇新的大门。尤其是网络编程，这让远距离传输对象变得非常方便。只要拥有某个类的.class文件，就能远距离复活这个类的对象。</p>

<ul>
  <li><strong>!注意：</strong>序列化有个“缺陷”，就是<strong>不能序列化静态字段</strong>。需要自己添加额外方法来实现追加序列化静态字段。就像 <strong>“练习30”</strong> 中演示的那样。</li>
</ul>

<h4 id="externalizable接口">Externalizable接口</h4>
<p>Externalizable接口继承自Serializable接口。可以在序列化和反序列化过程中提供更多的控制。</p>

<p>实现Externalizable接口的类在被反序列化的时候，不是直接通过字节码来全盘复制和重建对象，而是调用默认构造器，重新构造。</p>

<p>接口通过定义 <strong>WriteExternal(ObjectOutput out)</strong> 和 <strong>ReadExternal(ObjectInput in)</strong> 两个方法。分别接受输入，输出流为参数，目的是允许追加序列化某些需要被序列化的部件。所以更灵活。</p>

<h4 id="transient关键字">transient关键字</h4>
<p><strong>transient</strong> 关键字用来“定点关闭”某些不想被序列化的“敏感字段”，比如说密码。</p>

<h3 id="持久化的另一个选择---preferences-api">持久化的另一个选择 - Preferences API</h3>

<p>要持久化某些数据或者部件，序列化并不是唯一的选择。另一种更轻量级的实现是Preferences API。</p>

<p>关于Prefecrences API的一篇文章：<a href="http://www.ibm.com/developerworks/cn/java/j-prefapi/"><strong>《用 Preferences API 存储对象》</strong></a></p>

<p>它有点类似Windows的注册表。这里对它的细节深挖。但它确实可以在系统层面持久储存某些信息。比如基本型，以及String。但它只能做这么多。</p>

<p>数据结构层面，Preferences是一系列“键-值”对的节点。一共有两棵树”用户树”和”系统树“。分别用userNodeForPackage()和systemNodeForPackage()。这两棵树功能是一样的。</p>

<p>具体这些数据被储存到哪里了？对不同的操作系统，Java使用的是不同的系统资源。对于Windows系统，就是存在了注册表里。</p>

<h3 id="练习">练习</h3>
<h4 id="exercise-1">Exercise 1</h4>
<ul>
  <li><strong>Exercise 1</strong>: (3) Modify DirList.java (or one of its variants) so that the FilenameFilter opens and reads each file (using the net.mindview.util.TextFile utility) and accepts the file based on whether any of the trailing arguments on the command line exist in that file.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">path</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/gen/"</span><span class="o">);</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">list</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
            <span class="n">p</span><span class="o">=</span><span class="s">".*gen.*"</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">p</span><span class="o">=</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="o">}</span>

        <span class="n">list</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="k">new</span> <span class="n">FilenameFilter</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">result</span><span class="o">=</span><span class="kc">false</span><span class="o">;</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">BufferedReader</span> <span class="n">br</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()+</span><span class="s">"/"</span><span class="o">+</span><span class="n">name</span><span class="o">)));</span>
                    <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                        <span class="n">String</span> <span class="n">line</span><span class="o">=</span><span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">line</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span><span class="k">break</span><span class="o">;}</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">line</span><span class="o">).</span><span class="na">matches</span><span class="o">()){</span>
                            <span class="n">result</span><span class="o">=</span><span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Can not open file:  "</span><span class="o">+</span><span class="n">dir</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()+</span><span class="n">name</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">CASE_INSENSITIVE_ORDER</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">dirItem</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dirItem</span><span class="o">+</span><span class="s">":   contains "</span><span class="o">+</span><span class="n">p</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-2">Exercise 2</h4>
<ul>
  <li><strong>Exercise 2</strong>: (2) Create a class called SortedDirList with a constructor that takes a File object and builds a sorted directory list from the files at that File. Add to this class two overloaded list( ) methods: the first produces the whole list, and the second produces the subset of the list that matches its argument (which is a regular expression).</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SortedDirList</span><span class="o">{</span>
        <span class="kd">private</span> <span class="n">File</span> <span class="n">path</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">list</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">SortedDirList</span><span class="o">(</span><span class="n">String</span> <span class="n">absPath</span><span class="o">){</span>
            <span class="n">path</span><span class="o">=</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">absPath</span><span class="o">);</span>
            <span class="n">list</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">list</span><span class="o">(){</span><span class="k">return</span> <span class="n">list</span><span class="o">;}</span>
        <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">list</span><span class="o">(</span><span class="n">String</span> <span class="n">regex</span><span class="o">){</span>
            <span class="n">list</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="k">new</span> <span class="n">FilenameFilter</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">private</span> <span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">regex</span><span class="o">);</span>
                <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">matches</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">CASE_INSENSITIVE_ORDER</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Exercise2</span><span class="o">.</span><span class="na">SortedDirList</span> <span class="n">dl</span><span class="o">=</span><span class="k">new</span> <span class="n">Exercise2</span><span class="o">.</span><span class="na">SortedDirList</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/gen/"</span><span class="o">);</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">fullList</span><span class="o">=</span><span class="n">dl</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">filteredList</span><span class="o">=</span><span class="n">dl</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="s">".*Ran.*"</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;FULL LIST&lt;&lt;&lt;\n"</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">fullList</span><span class="o">)+</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;GEN LIST&lt;&lt;&lt;\n"</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">filteredList</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-3">Exercise 3</h4>
<ul>
  <li><strong>Exercise 3</strong>: (3) Modify DirList.java (or one of its variants) so that it sums up the file sizes of the selected files.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise3</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SortedDirList</span><span class="o">{</span>
        <span class="kd">private</span> <span class="n">File</span> <span class="n">path</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">list</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">SortedDirList</span><span class="o">(</span><span class="n">String</span> <span class="n">absPath</span><span class="o">){</span>
            <span class="n">path</span><span class="o">=</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">absPath</span><span class="o">);</span>
            <span class="n">list</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">list</span><span class="o">(){</span><span class="k">return</span> <span class="n">list</span><span class="o">;}</span>
        <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">list</span><span class="o">(</span><span class="n">String</span> <span class="n">regex</span><span class="o">){</span>
            <span class="n">list</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="k">new</span> <span class="n">FilenameFilter</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">private</span> <span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">regex</span><span class="o">);</span>
                <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">matches</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">CASE_INSENSITIVE_ORDER</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">File</span> <span class="nf">getPath</span><span class="o">(){</span><span class="k">return</span> <span class="n">path</span><span class="o">;}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">countLine</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">list</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span><span class="k">return</span> <span class="mi">0</span><span class="o">;}</span>
        <span class="kt">int</span> <span class="n">result</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="nl">name:</span><span class="n">list</span><span class="o">){</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="n">BufferedReader</span> <span class="n">br</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">+</span><span class="s">"/"</span><span class="o">+</span><span class="n">name</span><span class="o">)));</span>
                <span class="k">while</span><span class="o">(</span><span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">()!=</span><span class="kc">null</span><span class="o">){</span><span class="n">result</span><span class="o">++;}</span>
            <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Can not open the file:  "</span><span class="o">+</span><span class="n">dir</span><span class="o">+</span><span class="s">"/"</span><span class="o">+</span><span class="n">name</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Exercise3</span><span class="o">.</span><span class="na">SortedDirList</span> <span class="n">dl</span><span class="o">=</span><span class="k">new</span> <span class="n">Exercise3</span><span class="o">.</span><span class="na">SortedDirList</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/gen/"</span><span class="o">);</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">fullList</span><span class="o">=</span><span class="n">dl</span><span class="o">.</span><span class="na">list</span><span class="o">();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">filteredList</span><span class="o">=</span><span class="n">dl</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="s">".*Ran.*"</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;FULL LIST&lt;&lt;&lt;\n"</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">fullList</span><span class="o">)+</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;GEN LIST&lt;&lt;&lt;\n"</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">filteredList</span><span class="o">)+</span><span class="s">"\n"</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total Line: "</span><span class="o">+</span><span class="n">Exercise3</span><span class="o">.</span><span class="na">countLine</span><span class="o">(</span><span class="n">dl</span><span class="o">.</span><span class="na">getPath</span><span class="o">(),</span><span class="n">filteredList</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-456">Exercise 4,5,6</h4>
<ul>
  <li>
    <p><strong>Exercise 4</strong>: (2) Use Directory.walk( ) to sum the sizes of all files in a directory tree whose names match a particular regular expression.</p>
  </li>
  <li>
    <p><strong>Exercise 5</strong>: (1) Modify ProcessFiles.java so that it matches a regular expression rather than a fixed extension.</p>
  </li>
  <li>
    <p><strong>Exercise 6</strong>: (5) Use ProcessFiles to find all the Java source-code files in a particular directory subtree that have been modified after a particular date.</p>
  </li>
</ul>

<h5 id="directoryjava">Directory.java</h5>
<p>简化练习4中的Directory类。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Directory</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">files</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;();</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">dirs</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;();</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">lines</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(){</span><span class="k">this</span><span class="o">(</span><span class="s">"."</span><span class="o">);}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">String</span> <span class="n">dir</span><span class="o">){</span><span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">));}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">){</span><span class="k">this</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="s">".*"</span><span class="o">);}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">String</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">regex</span><span class="o">){</span><span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">),</span><span class="n">regex</span><span class="o">);}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span><span class="n">String</span> <span class="n">regex</span><span class="o">){</span>
        <span class="n">recurseDirs</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="k">new</span> <span class="n">FilenameFilter</span><span class="o">(){</span>
            <span class="kd">private</span> <span class="n">Pattern</span> <span class="n">p</span><span class="o">=</span><span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">regex</span><span class="o">);</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">matches</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">statistic</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span><span class="n">FilenameFilter</span> <span class="n">filter</span><span class="o">){</span>
        <span class="n">recurseDirs</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="n">filter</span><span class="o">);</span>
        <span class="n">statistic</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//递归收集文件</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recurseDirs</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">FilenameFilter</span> <span class="n">filter</span><span class="o">){</span>
        <span class="n">File</span><span class="o">[]</span> <span class="n">children</span><span class="o">=</span><span class="n">dir</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">children</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="n">children</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span><span class="k">return</span><span class="o">;}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="nl">f:</span><span class="n">children</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">()){</span>
                <span class="n">dirs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
                <span class="n">recurseDirs</span><span class="o">(</span><span class="n">f</span><span class="o">,</span><span class="n">filter</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">())){</span>
                    <span class="n">files</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">statistic</span><span class="o">(){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">files</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">size</span><span class="o">=</span><span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">num</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="nl">file:</span><span class="n">files</span><span class="o">){</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">BufferedReader</span> <span class="n">bf</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
                    <span class="k">while</span><span class="o">(</span><span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">()!=</span><span class="kc">null</span><span class="o">){</span>
                        <span class="n">num</span><span class="o">++;</span>
                    <span class="o">}</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">" can not open!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">lines</span><span class="o">=</span><span class="n">num</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">getFile</span><span class="o">(){</span><span class="k">return</span> <span class="n">files</span><span class="o">;}</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">getDir</span><span class="o">(){</span><span class="k">return</span> <span class="n">dirs</span><span class="o">;}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">showStatistic</span><span class="o">(){</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"File number:    "</span><span class="o">+</span><span class="n">size</span><span class="o">+</span><span class="s">"\n"</span><span class="o">+</span><span class="s">"Total Lines:   "</span><span class="o">+</span><span class="n">lines</span><span class="o">+</span><span class="s">"\n"</span><span class="o">);}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="exercise4java">Exercise4.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise4</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">Directory</span> <span class="n">d</span><span class="o">=</span><span class="k">new</span> <span class="n">Directory</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter17/testframework/"</span><span class="o">,</span><span class="s">".*Gen.*"</span><span class="o">);</span>
        <span class="n">d</span><span class="o">.</span><span class="na">showStatistic</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">files</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="na">getFile</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">dirs</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="na">getDir</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">files</span><span class="o">!=</span><span class="kc">null</span>  <span class="o">&amp;&amp;</span> <span class="o">!(</span><span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">)){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">files</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">dirs</span><span class="o">!=</span><span class="kc">null</span>  <span class="o">&amp;&amp;</span> <span class="o">!(</span><span class="n">dirs</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">0</span><span class="o">)){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dirs</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="processfilesjava">ProcessFiles.java</h5>
<p>ProcessFiles配合Directory使用。由Directory递归读取文件，然后由ProcessFiles里的Strategy模块处理。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProcessFiles</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Strategy</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="n">Strategy</span> <span class="n">strategy</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">ext</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">ProcessFiles</span><span class="o">(</span><span class="n">Strategy</span> <span class="n">strategy</span><span class="o">,</span> <span class="n">String</span> <span class="n">ext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">strategy</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span>
                <span class="n">processDirectoryTree</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"."</span><span class="o">));</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="nl">arg:</span><span class="n">args</span><span class="o">){</span>
                    <span class="n">processDirectoryTree</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">arg</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processDirectoryTree</span><span class="o">(</span><span class="n">File</span> <span class="n">root</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span> <span class="o">:</span> <span class="k">new</span> <span class="n">Directory</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span> <span class="s">".*\\."</span> <span class="o">+</span> <span class="n">ext</span><span class="o">).</span><span class="na">getFile</span><span class="o">()){</span>
            <span class="n">strategy</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getCanonicalFile</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// Demonstration of how to use it:</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">ProcessFiles</span><span class="o">(</span><span class="k">new</span> <span class="n">ProcessFiles</span><span class="o">.</span><span class="na">Strategy</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"java"</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="exercise5java">Exercise5.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise5</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="k">new</span> <span class="nf">ProcessFiles</span><span class="o">(</span><span class="k">new</span> <span class="n">ProcessFiles</span><span class="o">.</span><span class="na">Strategy</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"ja.*"</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="exercise6java">Exercise6.java</h5>
<p>用Directory和ProcessFile，对File做时间过滤。加了两个“时间-日期”转换方法。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.text.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise6</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">filterByModifyDate</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">date</span><span class="o">){</span>
        <span class="k">new</span> <span class="nf">ProcessFiles</span><span class="o">(</span><span class="k">new</span> <span class="n">ProcessFiles</span><span class="o">.</span><span class="na">Strategy</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="kt">long</span> <span class="n">time</span><span class="o">=</span><span class="n">getNanoTime</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()&gt;</span><span class="n">time</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">+</span><span class="s">"   &gt;&gt;&gt;Last Modified: "</span><span class="o">+</span><span class="n">getFormatDate</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">()));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"java"</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">getNanoTime</span><span class="o">(</span><span class="n">String</span> <span class="n">date</span><span class="o">){</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">DateFormat</span> <span class="n">dateFormat1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd"</span><span class="o">);</span>
            <span class="n">Date</span> <span class="n">myDate</span> <span class="o">=</span> <span class="n">dateFormat1</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">myDate</span><span class="o">.</span><span class="na">getTime</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">ParseException</span> <span class="n">pe</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error when parsing Date!"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="n">l</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getFormatDate</span><span class="o">(</span><span class="kt">long</span> <span class="n">millitime</span><span class="o">){</span>
        <span class="n">SimpleDateFormat</span> <span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">millitime</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">filterByModifyDate</span><span class="o">(</span><span class="n">args</span><span class="o">,</span><span class="s">"2016-09-29"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-7">Exercise 7</h4>
<ul>
  <li><strong>Exercise 7</strong>: (2) Open a text file so that you can read the file one line at a time. Read each line as a String and place that String object into a LinkedList. Print all of the lines in the LinkedList in reverse order.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise7</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">File</span> <span class="n">file</span><span class="o">=</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Directory.java"</span><span class="o">);</span>
        <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">=</span><span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">BufferedReader</span> <span class="n">bf</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">bf</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                <span class="n">String</span> <span class="n">line</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">line</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span><span class="k">break</span><span class="o">;}</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">" not found!"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"have problem when reading lines... ..."</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">bf</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">bf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"File can not be close!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">size</span><span class="o">=</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(--</span><span class="n">size</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-8">Exercise 8</h4>
<ul>
  <li><strong>Exercise 8</strong>: (1) Modify Exercise 7 so that the name of the file you read is provided as a command-line argument.</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>package com.ciaoshen.thinkinjava.chapter18;
import java.util.*;
import java.io.*;
import java.util.regex.*;

public class Exercise8{
    public static void inversePrint(File file){
        LinkedList&lt;String&gt; list=new LinkedList&lt;String&gt;();
        BufferedReader bf=null;
        try{
            bf=new BufferedReader(new FileReader(file));
            while(true){
                String line=bf.readLine();
                if(line==null){break;}
                list.add(line);
            }
        }catch(FileNotFoundException e){
            System.out.println(file.getName()+" not found!");
        }catch(IOException ioe){
            System.out.println("have problem when reading lines... ...");
        }finally{
            if(bf!=null){
                try{
                    bf.close();
                }catch(IOException ioe){
                    System.out.println("File can not be close!");
                }
            }
        }
        int size=list.size();
        for(int i=0;i&lt;list.size();i++){
            System.out.println(list.get(--size));
        }
    }

    public static void main(String[] args){
        if(args.length==0){
            Exercise8.inversePrint(new File("/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Directory.java"));
        }else{
            for(String arg:args){
                Exercise8.inversePrint(new File(arg));
            }
        }
    }
}
</code></pre>
</div>

<h4 id="exercise-9">Exercise 9</h4>
<ul>
  <li><strong>Exercise 9</strong>: (1) Modify Exercise 8 to force all the lines in the LinkedList to uppercase and send the results to System.out.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise9</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">inversePrint</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">){</span>
        <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">=</span><span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">BufferedReader</span> <span class="n">bf</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">bf</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                <span class="n">String</span> <span class="n">line</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">line</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span><span class="k">break</span><span class="o">;}</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">" not found!"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"have problem when reading lines... ..."</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">bf</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">bf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"File can not be close!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">size</span><span class="o">=</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(--</span><span class="n">size</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">Exercise9</span><span class="o">.</span><span class="na">inversePrint</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Directory.java"</span><span class="o">));</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="nl">arg:</span><span class="n">args</span><span class="o">){</span>
                <span class="n">Exercise9</span><span class="o">.</span><span class="na">inversePrint</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">arg</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-10">Exercise 10</h4>
<ul>
  <li><strong>Exercise 10</strong>: (2) Modify Exercise 8 to take additional command-line arguments of words to find in the file. Print all lines in which any of the words match.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise10</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">inversePrint</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">,</span> <span class="n">String</span> <span class="n">inWord</span><span class="o">){</span>
        <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">=</span><span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">BufferedReader</span> <span class="n">bf</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">bf</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
            <span class="n">String</span> <span class="n">line</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
            <span class="k">while</span><span class="o">((</span><span class="n">line</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">words</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"[\\W]+"</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">words</span><span class="o">.</span><span class="na">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">){</span>
                    <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="nl">word:</span><span class="n">words</span><span class="o">){</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">inWord</span><span class="o">)){</span>
                            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">" not found!"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"have problem when reading lines... ..."</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">bf</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">bf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"File can not be close!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">size</span><span class="o">=</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(--</span><span class="n">size</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">!=</span><span class="mi">2</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Please check the args!"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">Exercise10</span><span class="o">.</span><span class="na">inversePrint</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-11">Exercise 11</h4>
<ul>
  <li><strong>Exercise 11</strong>: (2) In the innerclasses/GreenhouseController.java example, GreenhouseController contains a hard-coded set of events. Change the program so that it reads the events and their relative times from a text file, ((difficulty level 8): Use a Factory Method design pattern to build the events.</li>
</ul>

<p>使用了注册工厂模式。</p>

<h5 id="controllerjava">Controller.java</h5>
<p>基层设施</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Controller</span> <span class="o">{</span>
    <span class="c1">// A class from java.util to hold Event objects:</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span> <span class="n">eventList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;();</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addEvent</span><span class="o">(</span><span class="n">Event</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span> <span class="n">eventList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span><span class="o">(</span><span class="n">eventList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="c1">// Make a copy so you’re not modifying the list</span>
            <span class="c1">// while you’re selecting the elements in it:</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Event</span> <span class="n">e</span> <span class="o">:</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;(</span><span class="n">eventList</span><span class="o">))</span>
                <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">ready</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">action</span><span class="o">();</span>
                    <span class="n">eventList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span> <span class="nf">getList</span><span class="o">(){</span><span class="k">return</span> <span class="n">eventList</span><span class="o">;}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="eventjava">Event.java</h5>
<p>基层设施</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Event</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">eventTime</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">delayTime</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Event</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">delayTime</span> <span class="o">=</span> <span class="n">delayTime</span><span class="o">;</span>
        <span class="n">start</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// Allows restarting</span>
        <span class="n">eventTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">delayTime</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">ready</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">eventTime</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="greenhousecontrolsjava">GreenhouseControls.java</h5>
<p>Controller和Event的综合体。 内部有一个Controller字段，每个Event都是一个内部类。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GreenhouseControls</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Controller</span> <span class="n">con</span><span class="o">=</span><span class="k">new</span> <span class="n">Controller</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">Controller</span> <span class="nf">getController</span><span class="o">(){</span><span class="k">return</span> <span class="n">con</span><span class="o">;}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">light</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LightOn</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">LightOn</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">LightOn</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">LightOn</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">LightOn</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// Put hardware control code here to</span>
            <span class="c1">// physically turn on the light.</span>
            <span class="n">light</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"Light is on"</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LightOff</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">LightOff</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">LightOff</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">LightOff</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">LightOff</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// Put hardware control code here to</span>
            <span class="c1">// physically turn off the light.</span>
            <span class="n">light</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"Light is off"</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">water</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WaterOn</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">WaterOn</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">WaterOn</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">WaterOn</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">WaterOn</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// Put hardware control code here.</span>
            <span class="n">water</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Greenhouse water is on"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WaterOff</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">WaterOff</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">WaterOff</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">WaterOff</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">WaterOff</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// Put hardware control code here.</span>
            <span class="n">water</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Greenhouse water is off"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">thermostat</span> <span class="o">=</span> <span class="s">"Day"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThermostatNight</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">ThermostatNight</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">ThermostatNight</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">ThermostatNight</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">ThermostatNight</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// Put hardware control code here.</span>
            <span class="n">thermostat</span> <span class="o">=</span> <span class="s">"Night"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Thermostat on night setting"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThermostatDay</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">ThermostatDay</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">ThermostatDay</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">ThermostatDay</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">ThermostatDay</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// Put hardware control code here.</span>
            <span class="n">thermostat</span> <span class="o">=</span> <span class="s">"Day"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Thermostat on day setting"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// An example of an action() that inserts a</span>
    <span class="c1">// new one of itself into the event list:</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bell</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">Bell</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">Bell</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">Bell</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">Bell</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">con</span><span class="o">.</span><span class="na">addEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">Bell</span><span class="o">(</span><span class="n">delayTime</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"Bing!"</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Restart</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">BigEventFactory</span><span class="o">&lt;</span><span class="n">Restart</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">Restart</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">,</span> <span class="n">Event</span><span class="o">[]</span> <span class="n">eventList</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">Restart</span><span class="o">(</span><span class="n">delayTime</span><span class="o">,</span> <span class="n">eventList</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">private</span> <span class="n">Event</span><span class="o">[]</span> <span class="n">eventList</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">Restart</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">,</span> <span class="n">Event</span><span class="o">[]</span> <span class="n">eventList</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">eventList</span> <span class="o">=</span> <span class="n">eventList</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Event</span> <span class="n">e</span> <span class="o">:</span> <span class="n">eventList</span><span class="o">)</span>
                <span class="n">con</span><span class="o">.</span><span class="na">addEvent</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span><span class="n">Event</span> <span class="n">e</span> <span class="o">:</span> <span class="n">eventList</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// Rerun each event</span>
                <span class="n">con</span><span class="o">.</span><span class="na">addEvent</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">start</span><span class="o">();</span> <span class="c1">// Rerun this Event</span>
            <span class="n">con</span><span class="o">.</span><span class="na">addEvent</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Restarting system"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Terminate</span> <span class="kd">extends</span> <span class="n">Event</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Factory</span> <span class="kd">implements</span> <span class="n">SmallEventFactory</span><span class="o">&lt;</span><span class="n">Terminate</span><span class="o">&gt;{</span>
            <span class="kd">public</span> <span class="n">Terminate</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">){</span><span class="k">return</span> <span class="k">new</span> <span class="n">Terminate</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">Terminate</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">)</span> <span class="o">{</span> <span class="kd">super</span><span class="o">(</span><span class="n">delayTime</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span> <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="s">"Terminating"</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="eventfactoryjava">EventFactory.java</h5>
<p>工厂接口</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EventFactory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;{}</span>
</code></pre>
</div>

<h5 id="bigeventfactoryjava">BigEventFactory.java</h5>
<p>工厂接口。因为Restart类的create()方法有两个参数，所以分化出一个工厂类。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BigEventFactory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;{</span>
    <span class="kd">public</span> <span class="n">T</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">,</span> <span class="n">Event</span><span class="o">[]</span> <span class="n">eventList</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="smalleventfactoryjava">SmallEventFactory.java</h5>
<p>工厂接口。正常Event的工厂接口。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SmallEventFactory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;{</span>
    <span class="kd">public</span> <span class="n">T</span> <span class="nf">create</span><span class="o">(</span><span class="kt">long</span> <span class="n">delayTime</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="controllerhelperjava">ControllerHelper.java</h5>
<p>主要是Event的注册工厂。还有一个从外部文件读取EventList的loadEvents()方法。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ControllerHelper</span> <span class="o">{</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">SmallEventFactory</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Event</span><span class="o">&gt;&gt;</span> <span class="n">smallEventFactories</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">SmallEventFactory</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Event</span><span class="o">&gt;&gt;();</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">BigEventFactory</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Event</span><span class="o">&gt;&gt;</span> <span class="n">bigEventFactories</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">BigEventFactory</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Event</span><span class="o">&gt;&gt;();</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"LightOn"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">LightOn</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"LightOff"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">LightOff</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"WaterOn"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">WaterOn</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"WaterOff"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">WaterOff</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"ThermostatNight"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">ThermostatNight</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"ThermostatDay"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">ThermostatDay</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"Bell"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">Bell</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">bigEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"Restart"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">Restart</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
        <span class="n">smallEventFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"Terminate"</span><span class="o">,</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">.</span><span class="na">Terminate</span><span class="o">.</span><span class="na">Factory</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Event</span><span class="o">[]</span> <span class="nf">loadEvents</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">){</span>
        <span class="n">File</span> <span class="n">file</span><span class="o">=</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;();</span>
        <span class="n">BufferedReader</span> <span class="n">bf</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">bf</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
            <span class="n">String</span> <span class="n">line</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
            <span class="k">while</span><span class="o">((</span><span class="n">line</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">param</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\t"</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">length</span><span class="o">!=</span><span class="mi">2</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Args Error:  "</span><span class="o">+</span><span class="n">line</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">param</span><span class="o">[</span><span class="mi">0</span><span class="o">]+</span><span class="s">","</span><span class="o">+</span><span class="n">param</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
                    <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">smallEventFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">param</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">create</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">param</span><span class="o">[</span><span class="mi">1</span><span class="o">])));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">" not found!"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"have problem when reading lines... ..."</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">bf</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">bf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"File can not be close!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Event</span><span class="o">[</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="exercise11java">Exercise11.java</h5>
<p>最后的测试类。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise11</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">GreenhouseControls</span> <span class="n">c</span><span class="o">=</span><span class="k">new</span> <span class="n">GreenhouseControls</span><span class="o">();</span>
        <span class="n">Controller</span> <span class="n">controller</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="na">getController</span><span class="o">();</span>
        <span class="n">controller</span><span class="o">.</span><span class="na">addEvent</span><span class="o">((</span><span class="n">Event</span><span class="o">)(</span><span class="n">ControllerHelper</span><span class="o">.</span><span class="na">smallEventFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Bell"</span><span class="o">).</span><span class="na">create</span><span class="o">(</span><span class="mi">900</span><span class="o">)));</span>
        <span class="n">Event</span><span class="o">[]</span> <span class="n">eventList</span> <span class="o">=</span> <span class="n">ControllerHelper</span><span class="o">.</span><span class="na">loadEvents</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Event.txt"</span><span class="o">);</span>
        <span class="n">controller</span><span class="o">.</span><span class="na">addEvent</span><span class="o">((</span><span class="n">Event</span><span class="o">)(</span><span class="n">ControllerHelper</span><span class="o">.</span><span class="na">bigEventFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Restart"</span><span class="o">).</span><span class="na">create</span><span class="o">(</span><span class="mi">2000</span><span class="o">,</span><span class="n">eventList</span><span class="o">)));</span>
        <span class="n">controller</span><span class="o">.</span><span class="na">addEvent</span><span class="o">((</span><span class="n">Event</span><span class="o">)(</span><span class="n">ControllerHelper</span><span class="o">.</span><span class="na">smallEventFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Terminate"</span><span class="o">).</span><span class="na">create</span><span class="o">(</span><span class="mi">1000</span><span class="o">)));</span>
        <span class="n">controller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-12">Exercise 12</h4>
<ul>
  <li><strong>Exercise 12</strong>: (3) Modify Exercise 8 to also open a text file so you can write text into it. Write the lines in the LinkedList, along with line numbers (do not attempt to use the “LineNumber” classes), out to the file.</li>
</ul>

<h5 id="exercise12java">Exercise12.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise12</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">copyFile</span><span class="o">(</span><span class="n">File</span> <span class="n">inFile</span><span class="o">,</span> <span class="n">File</span> <span class="n">outFile</span><span class="o">){</span>
        <span class="n">BufferedReader</span> <span class="n">in</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="n">PrintWriter</span> <span class="n">out</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="c1">//input</span>
            <span class="n">in</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">inFile</span><span class="o">));</span>
            <span class="c1">//output</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">outFile</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
                <span class="n">outFile</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">out</span><span class="o">=</span><span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="n">outFile</span><span class="o">)));</span>

            <span class="kt">int</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">line</span><span class="o">;</span>
            <span class="k">while</span><span class="o">((</span><span class="n">line</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span><span class="o">){</span>
                <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Line "</span><span class="o">+</span> <span class="o">++</span><span class="n">count</span> <span class="o">+</span><span class="s">":\t"</span><span class="o">+</span><span class="n">line</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Check your inFile and outFile!"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Files cannot be closed correctly!"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">!=</span><span class="mi">2</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Check your arguments!"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">copyFile</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-13">Exercise 13</h4>
<ul>
  <li><strong>Exercise 13</strong>: (3) Modify BasicFileOutput.java so that it uses LineNumberReader to keep track of the line count. Note that it’s much easier to just keep track programmatically.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise13</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="n">String</span> <span class="n">file</span> <span class="o">=</span> <span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BasicFileOutput.txt"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">LineNumberReader</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LineNumberReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise13.java"</span><span class="o">)));</span>
        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="n">file</span><span class="o">)));</span>
        <span class="kt">int</span> <span class="n">lineCount</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">while</span><span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">){</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">getLineNumber</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-14">Exercise 14</h4>
<ul>
  <li><strong>Exercise 14</strong>: (2) Starting with BasicFileOutput.java, write a program that compares the performance of writing to a file when using buffered and unbuffered I/O.</li>
</ul>

<p>实验结果显示加了BufferedWriter装饰器之后比原先FileWriter效率高了20-25%。</p>

<p>需要当心，不要把最初两次测试结果统计进最后结果。因为最初的两轮耗时明显地长，尤其是第一次跑，是明显的离群点。这会导致先跑的Writer吃亏。</p>

<h5 id="exercise14java">Exercise14.java</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>package com.ciaoshen.thinkinjava.chapter18;
import java.util.*;
import java.io.*;

public class Exercise14 {
    private static String inFile = "/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BufferedInputFile.java";

    public static long test(Writer out) throws IOException{
        BufferedReader in = new BufferedReader(new FileReader(new File(inFile)));
        int lineCount = 1;
        String s;
        long begin;
        long end;
        long result=0;
        while((s = in.readLine()) != null ){
            begin=System.nanoTime();
            for(int i=0;i&lt;10000;i++){
                out.write(lineCount++ + ": " + s);
            }
            result+=(System.nanoTime()-begin);
        }

        out.close();
        return result;
    }

    public static void main(String[] args) throws IOException {
        long timeBuffer=0;
        long timeNot=0;
        for(int i=0;i&lt;20;i++){
            FileWriter fileOut=new FileWriter("/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BufferedInputFile.txt");
            BufferedWriter bufferedOut = new BufferedWriter(new FileWriter("/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BufferedInputFile2.txt"));
            if(i&gt;=5){
                timeBuffer+=test(bufferedOut);
                timeNot+=test(fileOut);
            }
        }
        System.out.println("Buf:    "+timeBuffer/15);
        System.out.println("Not:    "+timeNot/15);
        System.out.println((double)timeBuffer/timeNot);
    }
}
</code></pre>
</div>

<h5 id="测试结果">测试结果</h5>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Buf:    27568796
Not:    37021046
0.7446790010523365
</code></pre>
</div>

<h4 id="exercise-15">Exercise 15</h4>
<ul>
  <li><strong>Exercise 15</strong>: (4) Look up DataOutputStream and DataInputStream in the JDK documentation. Starting with StoringAndRecoveringData.java, create a program that stores and then retrieves all the different possible types provided by the DataOutputStream and DataInputStream classes. Verify that the values are stored and retrieved accurately.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise15</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">String</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">DataOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">file</span><span class="o">)));</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBoolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">56</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeChar</span><span class="o">(</span><span class="sc">'a'</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">56</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeLong</span><span class="o">(</span><span class="mi">56</span><span class="n">l</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="mi">56</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeFloat</span><span class="o">(</span><span class="mi">56</span><span class="n">f</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeDouble</span><span class="o">(</span><span class="mf">3.14159</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="s">"That was pi"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">(</span><span class="n">String</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">DataInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">)));</span>
        <span class="kt">boolean</span> <span class="n">b</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readBoolean</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">bt</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">char</span> <span class="n">c</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readChar</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">l</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readLong</span><span class="o">();</span>
        <span class="kt">short</span> <span class="n">s</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readShort</span><span class="o">();</span>
        <span class="kt">float</span> <span class="n">f</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readFloat</span><span class="o">();</span>
        <span class="kt">double</span> <span class="n">d</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readDouble</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">str</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"["</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">bt</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">str</span><span class="o">+</span><span class="s">"]"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">file</span><span class="o">=</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Data.txt"</span><span class="o">;</span>
        <span class="n">write</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="n">read</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-16">Exercise 16</h4>
<ul>
  <li><strong>Exercise 16</strong>: (2) Look up RandomAccessFile in the JDK documentation. Starting with UsingRandomAccessFile.java, create a program that stores and then retrieves all the different possible types provided by the RandomAccessFile class. Verify that the values are stored and retrieved accurately.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise16</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="n">String</span> <span class="n">file</span> <span class="o">=</span> <span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Data2.txt"</span><span class="o">;</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">display</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">RandomAccessFile</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RandomAccessFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="s">"r"</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Value "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">in</span><span class="o">.</span><span class="na">readDouble</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readUTF</span><span class="o">());</span>
        <span class="kt">boolean</span> <span class="n">b</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readBoolean</span><span class="o">();</span>
        <span class="kt">byte</span> <span class="n">bt</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readByte</span><span class="o">();</span>
        <span class="kt">char</span> <span class="n">c</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readChar</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">l</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readLong</span><span class="o">();</span>
        <span class="kt">short</span> <span class="n">s</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readShort</span><span class="o">();</span>
        <span class="kt">float</span> <span class="n">f</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readFloat</span><span class="o">();</span>
        <span class="kt">double</span> <span class="n">d</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readDouble</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">str</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"["</span><span class="o">+</span><span class="n">b</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">bt</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="s">"],"</span><span class="o">+</span><span class="s">"["</span><span class="o">+</span><span class="n">str</span><span class="o">+</span><span class="s">"]"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">RandomAccessFile</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RandomAccessFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">out</span><span class="o">.</span><span class="na">writeDouble</span><span class="o">(</span><span class="n">i</span><span class="o">*</span><span class="mf">1.414</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="s">"The end of the file"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBoolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="mi">56</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeChar</span><span class="o">(</span><span class="sc">'a'</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">56</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeLong</span><span class="o">(</span><span class="mi">56</span><span class="n">l</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="mi">56</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeFloat</span><span class="o">(</span><span class="mi">56</span><span class="n">f</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeDouble</span><span class="o">(</span><span class="mf">3.14159</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="s">"That was pi"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">write</span><span class="o">();</span>
        <span class="n">display</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-17">Exercise 17</h4>
<ul>
  <li><strong>Exercise 17</strong>: (4) Using TextFile and a Map&lt;Character,Integer&gt;, create a program that counts the occurrence of all the different characters in a file. (So if there are 12 occurrences of the letter ‘a’ in the file, the Integer associated with the Character containing ‘a’ in the Map contains ‘12’).</li>
</ul>

<h5 id="textfilejava">TextFile.java</h5>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextFile</span> <span class="kd">extends</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// 读文件，返回String</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">read</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">BufferedReader</span> <span class="n">in</span><span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">()));</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
                <span class="k">while</span><span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 直接写String进文件</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">());</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 构造器。 切割成String的ArrayList。</span>
    <span class="kd">public</span> <span class="nf">TextFile</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">String</span> <span class="n">splitter</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">read</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="n">splitter</span><span class="o">)));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)){</span><span class="n">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);}</span>
    <span class="o">}</span>

    <span class="c1">// 构造器。按行切割。</span>
    <span class="kd">public</span> <span class="nf">TextFile</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">());</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">item</span> <span class="o">:</span> <span class="k">this</span><span class="o">){</span>
                    <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">file</span> <span class="o">=</span> <span class="n">read</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span><span class="o">);</span>
        <span class="n">write</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span><span class="o">,</span> <span class="n">file</span><span class="o">);</span>
        <span class="n">TextFile</span> <span class="n">text</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TextFile</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span><span class="o">);</span>
        <span class="n">text</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"test2.txt"</span><span class="o">);</span>
        <span class="c1">// Break into unique sorted list of words:</span>
        <span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">words</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">TextFile</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span><span class="o">,</span> <span class="s">"\\W+"</span><span class="o">));</span>
        <span class="c1">// Display the capitalized words:</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">words</span><span class="o">.</span><span class="na">headSet</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="exercise17java">Exercise17.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise17</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">TextFile</span> <span class="n">tf</span><span class="o">=</span><span class="k">new</span> <span class="n">TextFile</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span><span class="o">,</span><span class="s">""</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">,</span><span class="n">Integer</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="nl">s:</span><span class="n">tf</span><span class="o">){</span>
            <span class="n">Character</span> <span class="n">c</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">c</span><span class="o">)){</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">c</span><span class="o">,</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">c</span><span class="o">)+</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">c</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-18">Exercise 18</h4>
<ul>
  <li><strong>Exercise 18</strong>: (1) Modify TextFile.java so that it passes IOExceptions out to the caller.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"serial"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise18</span> <span class="kd">extends</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// 读文件，返回String</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">read</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="n">BufferedReader</span> <span class="n">in</span><span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">()));</span>
        <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="k">while</span><span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 直接写String进文件</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">());</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 构造器。 切割成String的ArrayList。</span>
    <span class="kd">public</span> <span class="nf">Exercise18</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">,</span> <span class="n">String</span> <span class="n">splitter</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">read</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="n">splitter</span><span class="o">)));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)){</span><span class="n">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);}</span>
    <span class="o">}</span>

    <span class="c1">// 构造器。按行切割。</span>
    <span class="kd">public</span> <span class="nf">Exercise18</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">fileName</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">());</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">item</span> <span class="o">:</span> <span class="k">this</span><span class="o">){</span>
                <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">file</span> <span class="o">=</span> <span class="n">read</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span><span class="o">);</span>
        <span class="n">write</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span><span class="o">,</span> <span class="n">file</span><span class="o">);</span>
        <span class="n">Exercise18</span> <span class="n">text</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Exercise18</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.txt"</span><span class="o">);</span>
        <span class="n">text</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"test2.txt"</span><span class="o">);</span>
        <span class="c1">// Break into unique sorted list of words:</span>
        <span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">words</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="k">new</span> <span class="n">TextFile</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/TextFile.java"</span><span class="o">,</span> <span class="s">"\\W+"</span><span class="o">));</span>
        <span class="c1">// Display the capitalized words:</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">words</span><span class="o">.</span><span class="na">headSet</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-19">Exercise 19</h4>
<ul>
  <li><strong>Exercise 19</strong>: (2) Using BinaryFile and a Map&lt;Byte,Integer&gt;, create a program that counts the occurrence of all the different bytes in a file.</li>
</ul>

<h5 id="binaryfilejava">BinaryFile.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BinaryFile</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">(</span><span class="n">File</span> <span class="n">bFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">BufferedInputStream</span> <span class="n">bf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">bFile</span><span class="o">));</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bf</span><span class="o">.</span><span class="na">available</span><span class="o">()];</span>
            <span class="n">bf</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">bf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">(</span><span class="n">String</span> <span class="n">bFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">read</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">bFile</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="exercise19java">Exercise19.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise19</span>  <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">=</span><span class="n">BinaryFile</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/BinaryFile.java"</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Byte</span><span class="o">,</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Byte</span><span class="o">,</span><span class="n">Integer</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="kt">byte</span> <span class="n">b</span><span class="o">=</span><span class="n">bytes</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="k">if</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">b</span><span class="o">)){</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">b</span><span class="o">)+</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-20">Exercise 20</h4>
<ul>
  <li><strong>Exercise 20</strong>: (4) Using Directory.walk( ) and BinaryFile, verify that all .class files in a directory tree begin with the hex characters ‘CAFEBABE’.</li>
</ul>

<h5 id="directoryjava-1">Directory.java</h5>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Directory</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">files</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;();</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">dirs</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;();</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">lines</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(){</span><span class="k">this</span><span class="o">(</span><span class="s">"."</span><span class="o">);}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">String</span> <span class="n">dir</span><span class="o">){</span><span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">));}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">){</span><span class="k">this</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="s">".*"</span><span class="o">);}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">String</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">regex</span><span class="o">){</span><span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dir</span><span class="o">),</span><span class="n">regex</span><span class="o">);}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span><span class="n">String</span> <span class="n">regex</span><span class="o">){</span>
        <span class="n">recurseDirs</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="k">new</span> <span class="n">FilenameFilter</span><span class="o">(){</span>
            <span class="kd">private</span> <span class="n">Pattern</span> <span class="n">p</span><span class="o">=</span><span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">regex</span><span class="o">);</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">matches</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">statistic</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">Directory</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span><span class="n">FilenameFilter</span> <span class="n">filter</span><span class="o">){</span>
        <span class="n">recurseDirs</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="n">filter</span><span class="o">);</span>
        <span class="n">statistic</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//递归收集文件</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recurseDirs</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">FilenameFilter</span> <span class="n">filter</span><span class="o">){</span>
        <span class="n">File</span><span class="o">[]</span> <span class="n">children</span><span class="o">=</span><span class="n">dir</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">children</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="n">children</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span><span class="k">return</span><span class="o">;}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="nl">f:</span><span class="n">children</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">()){</span>
                <span class="n">dirs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
                <span class="n">recurseDirs</span><span class="o">(</span><span class="n">f</span><span class="o">,</span><span class="n">filter</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span><span class="n">f</span><span class="o">.</span><span class="na">getName</span><span class="o">())){</span>
                    <span class="n">files</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">statistic</span><span class="o">(){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">files</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">size</span><span class="o">=</span><span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">num</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="nl">file:</span><span class="n">files</span><span class="o">){</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">BufferedReader</span> <span class="n">bf</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
                    <span class="k">while</span><span class="o">(</span><span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">()!=</span><span class="kc">null</span><span class="o">){</span>
                        <span class="n">num</span><span class="o">++;</span>
                    <span class="o">}</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()+</span><span class="s">" can not open!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">lines</span><span class="o">=</span><span class="n">num</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">getFile</span><span class="o">(){</span><span class="k">return</span> <span class="n">files</span><span class="o">;}</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">getDir</span><span class="o">(){</span><span class="k">return</span> <span class="n">dirs</span><span class="o">;}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">showStatistic</span><span class="o">(){</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"File number:    "</span><span class="o">+</span><span class="n">size</span><span class="o">+</span><span class="s">"\n"</span><span class="o">+</span><span class="s">"Total Lines:   "</span><span class="o">+</span><span class="n">lines</span><span class="o">+</span><span class="s">"\n"</span><span class="o">);}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="binaryfilejava-1">BinaryFile.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BinaryFile</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">(</span><span class="n">File</span> <span class="n">bFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">BufferedInputStream</span> <span class="n">bf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">bFile</span><span class="o">));</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bf</span><span class="o">.</span><span class="na">available</span><span class="o">()];</span>
            <span class="n">bf</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">bf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">(</span><span class="n">String</span> <span class="n">bFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">read</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">bFile</span><span class="o">).</span><span class="na">getAbsoluteFile</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="exercise20java">Exercise20.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise20</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">Directory</span> <span class="n">dir</span><span class="o">=</span><span class="k">new</span> <span class="n">Directory</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18"</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">files</span><span class="o">=</span><span class="n">dir</span><span class="o">.</span><span class="na">getFile</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">files</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
            <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="nl">file:</span><span class="n">files</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".class"</span><span class="o">)){</span>
                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">=</span><span class="n">BinaryFile</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
                    <span class="n">String</span> <span class="n">one</span><span class="o">=</span><span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(((</span><span class="n">Byte</span><span class="o">)</span><span class="n">bytes</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">intValue</span><span class="o">());</span>
                    <span class="n">String</span> <span class="n">two</span><span class="o">=</span><span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(((</span><span class="n">Byte</span><span class="o">)</span><span class="n">bytes</span><span class="o">[</span><span class="mi">1</span><span class="o">]).</span><span class="na">intValue</span><span class="o">());</span>
                    <span class="n">String</span> <span class="n">three</span><span class="o">=</span><span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(((</span><span class="n">Byte</span><span class="o">)</span><span class="n">bytes</span><span class="o">[</span><span class="mi">2</span><span class="o">]).</span><span class="na">intValue</span><span class="o">());</span>
                    <span class="n">String</span> <span class="n">four</span><span class="o">=</span><span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(((</span><span class="n">Byte</span><span class="o">)</span><span class="n">bytes</span><span class="o">[</span><span class="mi">3</span><span class="o">]).</span><span class="na">intValue</span><span class="o">());</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">one</span><span class="o">+</span><span class="n">two</span><span class="o">+</span><span class="n">three</span><span class="o">+</span><span class="n">four</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-21">Exercise 21</h4>
<ul>
  <li><strong>Exercise 21</strong>: (1) Write a program that takes standard input and capitalizes all characters, then puts the results on standard output. Redirect the contents of a file into this program (the process of redirection will vary depending on your operating system).</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise21</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">PrintStream</span> <span class="n">console</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
        <span class="n">BufferedReader</span> <span class="n">br</span><span class="o">=</span><span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">));</span>
        <span class="n">PrintStream</span> <span class="n">ps</span><span class="o">=</span><span class="k">new</span> <span class="n">PrintStream</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise21.txt"</span><span class="o">)));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">ps</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">while</span><span class="o">((</span><span class="n">s</span><span class="o">=</span><span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()!=</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">console</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-22">Exercise 22</h4>
<ul>
  <li><strong>Exercise 22</strong>: (5) Modify OSExecute.java so that, instead of printing the standard output stream, it returns the results of executing the program as a List of Strings. Demonstrate the use of this new version of the utility.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise22</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">command</span><span class="o">(</span><span class="n">String</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">err</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">=</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
            <span class="n">BufferedReader</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">process</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
            <span class="n">String</span> <span class="n">s</span><span class="o">;</span>
            <span class="k">while</span><span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">BufferedReader</span> <span class="n">errors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">process</span><span class="o">.</span><span class="na">getErrorStream</span><span class="o">()));</span>
            <span class="c1">// Report errors and return nonzero value</span>
            <span class="c1">// to calling process if there are problems:</span>
            <span class="k">while</span><span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="na">readLine</span><span class="o">())!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                <span class="n">err</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Compensate for Windows 2000, which throws an</span>
            <span class="c1">// exception for the default command line:</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">command</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"CMD /C"</span><span class="o">)){</span>
                <span class="n">command</span><span class="o">(</span><span class="s">"CMD /C "</span> <span class="o">+</span> <span class="n">command</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">err</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">OSExecuteException</span><span class="o">(</span><span class="s">"Errors executing "</span> <span class="o">+</span> <span class="n">command</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">reverse</span><span class="o">=</span><span class="n">Exercise22</span><span class="o">.</span><span class="na">command</span><span class="o">(</span><span class="s">"javap com.ciaoshen.thinkinjava.chapter18.OSExecute"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reverse</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-23">Exercise 23</h4>
<ul>
  <li><strong>Exercise 23</strong>: (6) Create and test a utility method to print the contents of a CharBuffer up to the point where the characters are no longer printable.</li>
</ul>

<p>这题有个坑：
asCharBuffer()方法，默认以UTF-16BE来解码byteBuffer里的字节。每个字符2字节。而String # getBytes()使用我系统默认编码方式：而我系统的默认编码方式是：UTF-8。英语字母一个字节。</p>
<ul>
  <li>解决方法一：要么在byte解码到char的时候，找到系统默认的编码标准。</li>
  <li>解决方法二：要么在getBytes编码的时候就用asCharSet默认的UTF-16BE标准：getBytes(“UTF-16BE”)。</li>
  <li>解决方法三：要么在写入文件的时候直接用CharSet的视图往里写入，就会直接用UTF-16BE的编码标准。</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise23</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">BSIZE</span><span class="o">=</span><span class="mi">1024</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">File</span> <span class="n">f</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Exercise23</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">Exercise23</span><span class="o">(</span><span class="n">File</span> <span class="n">f</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">f</span><span class="o">=</span><span class="n">f</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">f</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
            <span class="n">f</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">FileChannel</span> <span class="n">fc</span><span class="o">=</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="c1">//method 1 to create and fill a ByteBuffer</span>
        <span class="n">ByteBuffer</span> <span class="n">bf1</span><span class="o">=</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()/</span><span class="mi">2</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="c1">//method 2 to create and fill a ByteBuffer</span>
        <span class="n">ByteBuffer</span> <span class="n">bf2</span><span class="o">=</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">BSIZE</span><span class="o">);</span>
        <span class="n">bf2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()/</span><span class="mi">2</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">bf2</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span> <span class="c1">//Important!!</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bf1</span><span class="o">);</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bf2</span><span class="o">);</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">FileChannel</span> <span class="n">fc</span><span class="o">=</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="n">ByteBuffer</span> <span class="n">bf</span><span class="o">=</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">BSIZE</span><span class="o">);</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bf</span><span class="o">);</span>
        <span class="n">bf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">ba</span><span class="o">=</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bf</span><span class="o">.</span><span class="na">limit</span><span class="o">()];</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span><span class="n">bf</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">()){</span>
            <span class="n">ba</span><span class="o">[</span><span class="n">index</span><span class="o">]=</span><span class="n">bf</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">index</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">ba</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//输出乱码</span>
    <span class="kd">public</span> <span class="kt">char</span><span class="o">[]</span> <span class="nf">badReadAsChars</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">FileChannel</span> <span class="n">fc</span><span class="o">=</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="n">ByteBuffer</span> <span class="n">bf</span><span class="o">=</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">BSIZE</span><span class="o">);</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bf</span><span class="o">);</span>
        <span class="n">bf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="cm">/**
         *  坑在这儿：
         *  asCharBuffer()方法，默认以UTF-16BE来解码byteBuffer里的字节。每个字符2字节。
         *  而String # getBytes()使用我系统默认编码方式：
         *      而我系统的默认编码方式是：UTF-8。英语字母一个字节。
         */</span>
        <span class="n">CharBuffer</span> <span class="n">cf</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="na">asCharBuffer</span><span class="o">();</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">ca</span><span class="o">=</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">cf</span><span class="o">.</span><span class="na">limit</span><span class="o">()];</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span><span class="n">cf</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">()){</span>
            <span class="n">ca</span><span class="o">[</span><span class="n">index</span><span class="o">]=</span><span class="n">cf</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">index</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">ca</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="c1">//这种解决方案比较好。因为从头到尾使用系统默认的编码标准，系统打开本地写入的文件的时候，不会显示乱码。</span>
    <span class="kd">public</span> <span class="kt">char</span><span class="o">[]</span> <span class="nf">readAsChars</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">FileChannel</span> <span class="n">fc</span><span class="o">=</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="n">ByteBuffer</span> <span class="n">bf</span><span class="o">=</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">BSIZE</span><span class="o">);</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bf</span><span class="o">);</span>
        <span class="n">bf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="c1">//解决方法一</span>
        <span class="c1">//要么在byte解码到char的时候，找到系统默认的编码标准。</span>
        <span class="n">CharBuffer</span> <span class="n">cf</span><span class="o">=</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"file.encoding"</span><span class="o">)).</span><span class="na">decode</span><span class="o">(</span><span class="n">bf</span><span class="o">);</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">ca</span><span class="o">=</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">cf</span><span class="o">.</span><span class="na">limit</span><span class="o">()];</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span><span class="n">cf</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">()){</span>
            <span class="n">ca</span><span class="o">[</span><span class="n">index</span><span class="o">]=</span><span class="n">cf</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">index</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">ca</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="c1">//系统默认编码是UTF-8</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"file.encoding"</span><span class="o">));</span>

        <span class="n">Exercise23</span> <span class="n">gc</span><span class="o">=</span><span class="k">new</span> <span class="n">Exercise23</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise23.txt"</span><span class="o">);</span>

        <span class="n">gc</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">ba</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Bytes   &gt;&gt;&gt; "</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">ba</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"String  &gt;&gt;&gt; "</span><span class="o">+</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">ba</span><span class="o">));</span>

        <span class="kt">char</span><span class="o">[]</span> <span class="n">ca</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="na">readAsChars</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Chars   &gt;&gt;&gt; "</span><span class="o">+</span><span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">ca</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"String  &gt;&gt;&gt; "</span><span class="o">+</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">ca</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-24">Exercise 24</h4>
<ul>
  <li><strong>Exercise 24</strong>: (1) Modify IntBufferDemo.java to use doubles.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise24</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">BSIZE</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ByteBuffer</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">BSIZE</span><span class="o">);</span>
        <span class="n">DoubleBuffer</span> <span class="n">db</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="na">asDoubleBuffer</span><span class="o">();</span>
        <span class="n">db</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="k">new</span> <span class="kt">double</span><span class="o">[]{</span> <span class="mf">11.1</span><span class="o">,</span> <span class="mf">42.2</span><span class="o">,</span> <span class="mf">47.3</span><span class="o">,</span> <span class="mf">99.4</span><span class="o">,</span> <span class="mf">143.5</span><span class="o">,</span> <span class="mf">811.6</span><span class="o">,</span> <span class="mf">1016.7</span> <span class="o">});</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">db</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
        <span class="n">db</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="k">new</span> <span class="kt">double</span><span class="o">[]</span> <span class="o">{</span><span class="mf">3.8</span><span class="o">,</span> <span class="mf">1811.9</span><span class="o">});</span>
        <span class="n">db</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span><span class="n">db</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-25">Exercise 25</h4>
<ul>
  <li><strong>Exercise 25</strong>: (6) Experiment with changing the ByteBuffer.allocate( ) statements in the examples in this chapter to ByteBuffer.allocateDirect( ). Demonstrate performance differences, but also notice whether the startup time of the programs noticeably changes.</li>
</ul>

<p>确实如书中所说，ByteBuffer.allocateDirect()可以提高后面的读写效率，但allocateDirect()本身启动时间比allocate()慢。</p>

<h5 id="exercise25java">Exercise25.java</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise25</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">BSIZE</span> <span class="o">=</span> <span class="mi">1048576</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Tester</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">Tester</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">runTest</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">": "</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="kt">long</span> <span class="n">mid</span><span class="o">=</span><span class="n">test</span><span class="o">();</span>
                <span class="kt">long</span> <span class="n">end</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="kt">double</span> <span class="n">firstHalf</span> <span class="o">=</span> <span class="n">mid</span><span class="o">-</span><span class="n">start</span><span class="o">;</span>
                <span class="kt">double</span> <span class="n">secondHalf</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">mid</span><span class="o">;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%.2f %.2f\n"</span><span class="o">,</span> <span class="n">firstHalf</span><span class="o">/</span><span class="mf">1.0e6</span><span class="o">,</span> <span class="n">secondHalf</span><span class="o">/</span><span class="mf">1.0e6</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">long</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Tester</span><span class="o">[]</span> <span class="n">tests</span><span class="o">={</span>
        <span class="k">new</span> <span class="nf">Tester</span><span class="o">(</span><span class="s">"Allocate"</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">long</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
                <span class="n">ByteBuffer</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">BSIZE</span><span class="o">);</span>
                <span class="kt">long</span> <span class="n">mid</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="n">DoubleBuffer</span> <span class="n">db</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="na">asDoubleBuffer</span><span class="o">();</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">BSIZE</span><span class="o">/</span><span class="mi">8</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
                    <span class="n">db</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">double</span><span class="o">)</span><span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">mid</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">},</span>

        <span class="k">new</span> <span class="nf">Tester</span><span class="o">(</span><span class="s">"AllocateDirect"</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">long</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
                <span class="n">ByteBuffer</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">BSIZE</span><span class="o">);</span>
                <span class="kt">long</span> <span class="n">mid</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="n">DoubleBuffer</span> <span class="n">db</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="na">asDoubleBuffer</span><span class="o">();</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">BSIZE</span><span class="o">/</span><span class="mi">8</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
                    <span class="n">db</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">double</span><span class="o">)</span><span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">mid</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Tester</span> <span class="n">test</span> <span class="o">:</span> <span class="n">tests</span><span class="o">){</span>
            <span class="n">test</span><span class="o">.</span><span class="na">runTest</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="结果">结果</h5>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Allocate: 0,62 10,53
AllocateDirect: 0,96 4,52
</code></pre>
</div>

<h4 id="exercise-26">Exercise 26</h4>
<ul>
  <li><strong>Exercise 26</strong>: (3) Modify strings/JGrep.java to use Java nio memorymapped files.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise26</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">jgrep</span><span class="o">(</span><span class="n">String</span> <span class="n">regex</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">Pattern</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">regex</span><span class="o">);</span>
        <span class="c1">// Iterate through the lines of the input file:</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">Matcher</span> <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
        <span class="n">FileChannel</span> <span class="n">fc</span><span class="o">=</span><span class="k">new</span> <span class="n">RandomAccessFile</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="s">"r"</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
        <span class="n">CharBuffer</span> <span class="n">cb</span><span class="o">=</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"file.encoding"</span><span class="o">)).</span><span class="na">decode</span><span class="o">(</span><span class="n">fc</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">FileChannel</span><span class="o">.</span><span class="na">MapMode</span><span class="o">.</span><span class="na">READ_ONLY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">fc</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span><span class="o">=</span><span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="n">Character</span> <span class="n">c</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">()){</span>
            <span class="n">c</span><span class="o">=</span><span class="n">cb</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">)){</span>
                <span class="n">m</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="k">while</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">find</span><span class="o">()){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">index</span><span class="o">++</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="na">start</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">sb</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">fc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">jgrep</span><span class="o">(</span><span class="s">"if"</span><span class="o">,</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise26.java"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-27">Exercise 27</h4>
<ul>
  <li><strong>Exercise 27</strong>: (1) Create a Serializable class containing a reference to an object of a second Serializable class. Create an instance of your class, serialize it to disk, then restore it and verify that the process worked correctly.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise27</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Random</span> <span class="n">rander</span><span class="o">=</span><span class="k">new</span> <span class="n">Random</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Pregnant</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">month</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">Baby</span> <span class="n">theBaby</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">Pregnant</span><span class="o">(</span><span class="kt">int</span> <span class="n">month</span><span class="o">){</span>
            <span class="k">this</span><span class="o">.</span><span class="na">month</span><span class="o">=</span><span class="n">month</span><span class="o">;</span>
            <span class="n">theBaby</span><span class="o">=</span><span class="k">new</span> <span class="n">Baby</span><span class="o">(</span><span class="n">month</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">(){</span><span class="k">return</span> <span class="s">"Pregnant for "</span><span class="o">+</span><span class="n">month</span><span class="o">+</span><span class="s">" month!   Baby weights "</span><span class="o">+</span><span class="n">theBaby</span><span class="o">.</span><span class="na">getWeight</span><span class="o">()+</span><span class="s">" KG!"</span><span class="o">;}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Baby</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">float</span> <span class="n">weight</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">sex</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">Baby</span><span class="o">(</span><span class="kt">int</span> <span class="n">month</span><span class="o">){</span>
            <span class="n">weight</span><span class="o">=</span><span class="n">rander</span><span class="o">.</span><span class="na">nextFloat</span><span class="o">()*</span><span class="n">rander</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">2</span><span class="o">)+(</span><span class="kt">float</span><span class="o">)</span><span class="n">month</span><span class="o">;</span>
            <span class="n">sex</span><span class="o">=</span><span class="n">rander</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getWeight</span><span class="o">(){</span><span class="k">return</span> <span class="n">weight</span><span class="o">;}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">Exercise27</span><span class="o">.</span><span class="na">Pregnant</span> <span class="n">p</span><span class="o">=</span><span class="k">new</span> <span class="n">Pregnant</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">File</span> <span class="n">f</span><span class="o">=</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise27.txt"</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">f</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
            <span class="n">f</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//序列化</span>
        <span class="n">ObjectOutputStream</span> <span class="n">out</span><span class="o">=</span><span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">f</span><span class="o">));</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>

        <span class="c1">//反序列化</span>
        <span class="n">ObjectInputStream</span> <span class="n">in</span><span class="o">=</span><span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">));</span>
        <span class="n">Pregnant</span> <span class="n">p2</span><span class="o">=(</span><span class="n">Pregnant</span><span class="o">)</span><span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p2</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-28">Exercise 28</h4>
<ul>
  <li><strong>Exercise 28</strong> : (2) In Blips.java, copy the file and rename it to BlipCheck.java and rename the class Blip2 to BlipCheck (making it public and removing the public scope from the class Blips in the process). Remove the //! marks in the file and execute the program, including the offending lines. Next, comment out the default constructor for BlipCheck. Run it and explain why it works. Note that after compiling, you must execute the program with “Java Blips” because the main( ) method is still in the class Blips.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise28</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BlipCheck</span> <span class="kd">implements</span> <span class="n">Externalizable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="c1">//这里默认构造器会被外部调用，所以必须是public的。</span>
        <span class="c1">//注释掉之后系统会自动创建一个默认构造器，默认是public的。</span>
        <span class="cm">/*
        BlipCheck() {
            System.out.println("Blip2 Constructor");
        }
         */</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeExternal</span><span class="o">(</span><span class="n">ObjectOutput</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Blip2.writeExternal"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readExternal</span><span class="o">(</span><span class="n">ObjectInput</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Blip2.readExternal"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Constructing objects:"</span><span class="o">);</span>
        <span class="n">Exercise28</span><span class="o">.</span><span class="na">BlipCheck</span> <span class="n">bc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Exercise28</span><span class="o">.</span><span class="na">BlipCheck</span><span class="o">();</span>
        <span class="n">ObjectOutputStream</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise28.txt"</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Saving objects:"</span><span class="o">);</span>
        <span class="n">o</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">bc</span><span class="o">);</span>
        <span class="n">o</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="c1">// Now get them back:</span>
        <span class="n">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise28.txt"</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Recovering BlipCheck:"</span><span class="o">);</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="o">(</span><span class="n">BlipCheck</span><span class="o">)</span><span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-29">Exercise 29</h4>
<ul>
  <li><strong>Exercise 29</strong>: (2) In Blip3.java, comment out the two lines after the phrases “You must do this:” and run the program. Explain the result and why it differs from when the two lines are in the program.</li>
</ul>

<p>运行的结果会抛出OptionalDataException。异常的原因是实现Externalizable接口的可序列化类，在序列化和反序列化的时候，都只调用默认的构造器。而这里Blip3的默认构造器没有初始化s和i的值。而在writeExternal和readExternal方法里又没有把s和i补偿序列化。反序列化的结果不完整。s和i始终没有初始化。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise29</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Blip3</span> <span class="kd">implements</span> <span class="n">Externalizable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">s</span><span class="o">;</span> <span class="c1">// No initialization</span>
        <span class="kd">public</span> <span class="nf">Blip3</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Blip3 Constructor"</span><span class="o">);</span>
            <span class="c1">// s, i not initialized</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="nf">Blip3</span><span class="o">(</span><span class="n">String</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Blip3(String x, int a)"</span><span class="o">);</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
            <span class="c1">// s &amp; i initialized only in non-default constructor.</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeExternal</span><span class="o">(</span><span class="n">ObjectOutput</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Blip3.writeExternal"</span><span class="o">);</span>
            <span class="c1">// You must do this:</span>
            <span class="c1">//out.writeObject(s);</span>
            <span class="c1">//out.writeInt(i);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readExternal</span><span class="o">(</span><span class="n">ObjectInput</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Blip3.readExternal"</span><span class="o">);</span>
            <span class="c1">// You must do this:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Constructing objects:"</span><span class="o">);</span>
        <span class="n">Exercise29</span><span class="o">.</span><span class="na">Blip3</span> <span class="n">b3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Exercise29</span><span class="o">.</span><span class="na">Blip3</span><span class="o">(</span><span class="s">"A String "</span><span class="o">,</span> <span class="mi">47</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">b3</span><span class="o">);</span>
        <span class="n">ObjectOutputStream</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise29.txt"</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Saving object:"</span><span class="o">);</span>
        <span class="n">o</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">b3</span><span class="o">);</span>
        <span class="n">o</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="c1">// Now get it back:</span>
        <span class="n">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/Exercise29.txt"</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Recovering b3:"</span><span class="o">);</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="o">(</span><span class="n">Blip3</span><span class="o">)</span><span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="c1">// System.out.println(b3);  //!!OptionalDataException</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-30">Exercise 30</h4>
<ul>
  <li><strong>Exercise 30</strong>: (1) Repair the program CADState.java as described in the text.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise30</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Shape</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
        <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RED</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">BLUE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">GREEN</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">color</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">xPos</span><span class="o">,</span> <span class="n">yPos</span><span class="o">,</span> <span class="n">dimension</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">(</span><span class="mi">47</span><span class="o">);</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">setColor</span><span class="o">(</span><span class="kt">int</span> <span class="n">newColor</span><span class="o">);</span>
        <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">getColor</span><span class="o">();</span>
        <span class="kd">public</span> <span class="nf">Shape</span><span class="o">(</span><span class="kt">int</span> <span class="n">xVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">xPos</span> <span class="o">=</span> <span class="n">xVal</span><span class="o">;</span>
            <span class="n">yPos</span> <span class="o">=</span> <span class="n">yVal</span><span class="o">;</span>
            <span class="n">dimension</span> <span class="o">=</span> <span class="n">dim</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getClass</span><span class="o">()</span> <span class="o">+</span>
            <span class="s">"color["</span> <span class="o">+</span> <span class="n">getColor</span><span class="o">()</span> <span class="o">+</span> <span class="s">"] xPos["</span> <span class="o">+</span> <span class="n">xPos</span> <span class="o">+</span>
            <span class="s">"] yPos["</span> <span class="o">+</span> <span class="n">yPos</span> <span class="o">+</span> <span class="s">"] dim["</span> <span class="o">+</span> <span class="n">dimension</span> <span class="o">+</span> <span class="s">"]\n"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="n">Shape</span> <span class="nf">randomFactory</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">xVal</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">yVal</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="k">switch</span><span class="o">(</span><span class="n">counter</span><span class="o">++</span> <span class="o">%</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">default</span><span class="o">:</span>
                <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="n">Circle</span><span class="o">(</span><span class="n">xVal</span><span class="o">,</span> <span class="n">yVal</span><span class="o">,</span> <span class="n">dim</span><span class="o">);</span>
                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="n">Square</span><span class="o">(</span><span class="n">xVal</span><span class="o">,</span> <span class="n">yVal</span><span class="o">,</span> <span class="n">dim</span><span class="o">);</span>
                <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="n">Line</span><span class="o">(</span><span class="n">xVal</span><span class="o">,</span> <span class="n">yVal</span><span class="o">,</span> <span class="n">dim</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serializeStaticState</span><span class="o">(</span><span class="n">ObjectOutputStream</span> <span class="n">os</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span> <span class="n">os</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">color</span><span class="o">);</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">deserializeStaticState</span><span class="o">(</span><span class="n">ObjectInputStream</span> <span class="n">os</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span> <span class="n">color</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Circle</span> <span class="kd">extends</span> <span class="n">Shape</span> <span class="o">{</span>
        <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">Circle</span><span class="o">(</span><span class="kt">int</span> <span class="n">xVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">xVal</span><span class="o">,</span> <span class="n">yVal</span><span class="o">,</span> <span class="n">dim</span><span class="o">);</span>
            <span class="n">color</span><span class="o">=</span><span class="n">RED</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setColor</span><span class="o">(</span><span class="kt">int</span> <span class="n">newColor</span><span class="o">)</span> <span class="o">{</span> <span class="n">color</span> <span class="o">=</span> <span class="n">newColor</span><span class="o">;</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getColor</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">color</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Square</span> <span class="kd">extends</span> <span class="n">Shape</span> <span class="o">{</span>
        <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">Square</span><span class="o">(</span><span class="kt">int</span> <span class="n">xVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">xVal</span><span class="o">,</span> <span class="n">yVal</span><span class="o">,</span> <span class="n">dim</span><span class="o">);</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">RED</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setColor</span><span class="o">(</span><span class="kt">int</span> <span class="n">newColor</span><span class="o">)</span> <span class="o">{</span> <span class="n">color</span> <span class="o">=</span> <span class="n">newColor</span><span class="o">;</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getColor</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">color</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Line</span> <span class="kd">extends</span> <span class="n">Shape</span> <span class="o">{</span>
        <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span><span class="o">=</span><span class="mi">1L</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nf">Line</span><span class="o">(</span><span class="kt">int</span> <span class="n">xVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yVal</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">xVal</span><span class="o">,</span> <span class="n">yVal</span><span class="o">,</span> <span class="n">dim</span><span class="o">);</span>
            <span class="n">color</span><span class="o">=</span><span class="n">RED</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setColor</span><span class="o">(</span><span class="kt">int</span> <span class="n">newColor</span><span class="o">)</span> <span class="o">{</span> <span class="n">color</span> <span class="o">=</span> <span class="n">newColor</span><span class="o">;</span> <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getColor</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">color</span><span class="o">;</span> <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"/Users/Wei/java/com/ciaoshen/thinkinjava/chapter18/CADState.txt"</span><span class="o">));</span>
        <span class="c1">// Read in the same order they were written:</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Exercise30</span><span class="o">.</span><span class="na">Shape</span><span class="o">&gt;&gt;</span> <span class="n">shapeTypes</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Exercise30</span><span class="o">.</span><span class="na">Shape</span><span class="o">&gt;&gt;)</span><span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">Exercise30</span><span class="o">.</span><span class="na">Line</span><span class="o">.</span><span class="na">deserializeStaticState</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Exercise30</span><span class="o">.</span><span class="na">Shape</span><span class="o">&gt;</span> <span class="n">shapes</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Exercise30</span><span class="o">.</span><span class="na">Shape</span><span class="o">&gt;)</span><span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">shapes</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="exercise-3132">Exercise 31，32</h4>
<ul>
  <li><strong>Exercise 31</strong>: (2) Add appropriate address information to Person.java and People.java.</li>
  <li><strong>Exercise 32</strong>: (4) Using a Map&lt;String,Integer&gt; and the net.mindview.util.TextFile utility, write a program that counts the occurrence of words in a file (use “\W+” as the second argument to the TextFile constructor). Store the results as an XML file.</li>
</ul>

<p>涉及外部库Elliote Rusty Harold的XOM。跳过。</p>

<h4 id="exercise-33">Exercise 33</h4>
<ul>
  <li><strong>Exercise 33</strong>: (2) Write a program that displays the current value of a directory called “base directory” and prompts you for a new value. Use the Preferences API to store the value.</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">ciaoshen</span><span class="o">.</span><span class="na">thinkinjava</span><span class="o">.</span><span class="na">chapter18</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.prefs.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exercise33</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">BackingStoreException</span><span class="o">{</span>
        <span class="n">Preferences</span> <span class="n">root</span><span class="o">=</span><span class="n">Preferences</span><span class="o">.</span><span class="na">userRoot</span><span class="o">();</span>
        <span class="n">root</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>   <span class="c1">//remove the previous enregistrer</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">info</span><span class="o">=</span><span class="n">root</span><span class="o">.</span><span class="na">getByteArray</span><span class="o">(</span><span class="s">"base directory"</span><span class="o">,</span><span class="s">"/Users"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">info</span><span class="o">));</span>
        <span class="n">info</span><span class="o">=</span><span class="s">"/Users/Wei"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="n">root</span><span class="o">.</span><span class="na">putByteArray</span><span class="o">(</span><span class="s">"base directory"</span><span class="o">,</span><span class="n">info</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">getByteArray</span><span class="o">(</span><span class="s">"base directory"</span><span class="o">,</span><span class="s">"/Users"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">())));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

        <div class="after-post"></div> <!-- 文章结尾，和Disqus留一些间隔。-->
        <script>
            $("div.after-post").css("margin-bottom","50px");
        </script>

        <!-- Disqus plugin -->
        <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = /java/thinking_in_java/2016/09/28/tij4-18.html;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = /java/thinking_in_java/2016/09/28/tij4-18; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//www-ciaoshen-com.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
    <!-- .container -->


    <!-- footer bar -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<footer>
    <!-- Don't show tag cloud
    <div class="footer" id="footer">
        <div class="container">
            <div id="tags-cloud-title">
            <div class="row">
                <div class="col-lg-12  col-md-12 col-sm-12 col-xs-12">
                    <h2>Tag Cloud</h2>
                </div>
            </div>
            </div>
            <div id="tags-cloud" class="row">
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_String" href="/tags/String.html">
                        String
                        <span class="badge">5</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Memory_Model" href="/tags/Memory_Model.html">
                        Memory_Model
                        <span class="badge">6</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_JVM" href="/tags/JVM.html">
                        JVM
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Hexo" href="/tags/Hexo.html">
                        Hexo
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Github" href="/tags/Github.html">
                        Github
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Blog" href="/tags/Blog.html">
                        Blog
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Git" href="/tags/Git.html">
                        Git
                        <span class="badge">6</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_JDK" href="/tags/JDK.html">
                        JDK
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_JRE" href="/tags/JRE.html">
                        JRE
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_IDE" href="/tags/IDE.html">
                        IDE
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_OOP" href="/tags/OOP.html">
                        OOP
                        <span class="badge">7</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Initialization" href="/tags/Initialization.html">
                        Initialization
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Control_Flow" href="/tags/Control_Flow.html">
                        Control_Flow
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_GC" href="/tags/GC.html">
                        GC
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Access_Control" href="/tags/Access_Control.html">
                        Access_Control
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Package" href="/tags/Package.html">
                        Package
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Inheritance" href="/tags/Inheritance.html">
                        Inheritance
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Composition" href="/tags/Composition.html">
                        Composition
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Factory_Pattern" href="/tags/Factory_Pattern.html">
                        Factory_Pattern
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Polymorphism" href="/tags/Polymorphism.html">
                        Polymorphism
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Late_Binding" href="/tags/Late_Binding.html">
                        Late_Binding
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_State_Pattern" href="/tags/State_Pattern.html">
                        State_Pattern
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Interface" href="/tags/Interface.html">
                        Interface
                        <span class="badge">5</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Abstract_Class" href="/tags/Abstract_Class.html">
                        Abstract_Class
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Strategy_Pattern" href="/tags/Strategy_Pattern.html">
                        Strategy_Pattern
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Inner_Class" href="/tags/Inner_Class.html">
                        Inner_Class
                        <span class="badge">3</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Callback" href="/tags/Callback.html">
                        Callback
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Closure" href="/tags/Closure.html">
                        Closure
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Lambda_Expression" href="/tags/Lambda_Expression.html">
                        Lambda_Expression
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Container" href="/tags/Container.html">
                        Container
                        <span class="badge">9</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Array" href="/tags/Array.html">
                        Array
                        <span class="badge">6</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Hash" href="/tags/Hash.html">
                        Hash
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Exception" href="/tags/Exception.html">
                        Exception
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_IO" href="/tags/IO.html">
                        IO
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Regular_Expression" href="/tags/Regular_Expression.html">
                        Regular_Expression
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Reflection" href="/tags/Reflection.html">
                        Reflection
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Career_Path" href="/tags/Career_Path.html">
                        Career_Path
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Immutability" href="/tags/Immutability.html">
                        Immutability
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Dynamic_Proxies" href="/tags/Dynamic_Proxies.html">
                        Dynamic_Proxies
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Generics" href="/tags/Generics.html">
                        Generics
                        <span class="badge">8</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Adapter_Pattern" href="/tags/Adapter_Pattern.html">
                        Adapter_Pattern
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Wildcards" href="/tags/Wildcards.html">
                        Wildcards
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_PESC" href="/tags/PESC.html">
                        PESC
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Covariant" href="/tags/Covariant.html">
                        Covariant
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_View" href="/tags/View.html">
                        View
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Iterator" href="/tags/Iterator.html">
                        Iterator
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Fly_Weight" href="/tags/Fly_Weight.html">
                        Fly_Weight
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_LinkedList" href="/tags/LinkedList.html">
                        LinkedList
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Weak_Reference" href="/tags/Weak_Reference.html">
                        Weak_Reference
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Phantom_Reference" href="/tags/Phantom_Reference.html">
                        Phantom_Reference
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_HashMap" href="/tags/HashMap.html">
                        HashMap
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_File" href="/tags/File.html">
                        File
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Stream" href="/tags/Stream.html">
                        Stream
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Encapsulation" href="/tags/Encapsulation.html">
                        Encapsulation
                        <span class="badge">3</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Unicode" href="/tags/Unicode.html">
                        Unicode
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_UTF-8" href="/tags/UTF-8.html">
                        UTF-8
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_ASCII" href="/tags/ASCII.html">
                        ASCII
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Encoding" href="/tags/Encoding.html">
                        Encoding
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Charset" href="/tags/Charset.html">
                        Charset
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_CPU" href="/tags/CPU.html">
                        CPU
                        <span class="badge">3</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Process" href="/tags/Process.html">
                        Process
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Block" href="/tags/Block.html">
                        Block
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Logic_Gates" href="/tags/Logic_Gates.html">
                        Logic_Gates
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_NIO" href="/tags/NIO.html">
                        NIO
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Enum" href="/tags/Enum.html">
                        Enum
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Table_Driven" href="/tags/Table_Driven.html">
                        Table_Driven
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Annotations" href="/tags/Annotations.html">
                        Annotations
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Hibernate" href="/tags/Hibernate.html">
                        Hibernate
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_JUnit" href="/tags/JUnit.html">
                        JUnit
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Spring" href="/tags/Spring.html">
                        Spring
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Syntactic sugar" href="/tags/Syntactic sugar.html">
                        Syntactic sugar
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_AOP" href="/tags/AOP.html">
                        AOP
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Concurrency" href="/tags/Concurrency.html">
                        Concurrency
                        <span class="badge">4</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Thread" href="/tags/Thread.html">
                        Thread
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_DJ" href="/tags/DJ.html">
                        DJ
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_IOC" href="/tags/IOC.html">
                        IOC
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Interrupt" href="/tags/Interrupt.html">
                        Interrupt
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_HTML" href="/tags/HTML.html">
                        HTML
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_CSS" href="/tags/CSS.html">
                        CSS
                        <span class="badge">3</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Javascript" href="/tags/Javascript.html">
                        Javascript
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_JQuery" href="/tags/JQuery.html">
                        JQuery
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Sass" href="/tags/Sass.html">
                        Sass
                        <span class="badge">3</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Responsive_Design" href="/tags/Responsive_Design.html">
                        Responsive_Design
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Code_Style" href="/tags/Code_Style.html">
                        Code_Style
                        <span class="badge">15</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Builder_Pattern" href="/tags/Builder_Pattern.html">
                        Builder_Pattern
                        <span class="badge">3</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Instance_Control" href="/tags/Instance_Control.html">
                        Instance_Control
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Singleton" href="/tags/Singleton.html">
                        Singleton
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Comparable" href="/tags/Comparable.html">
                        Comparable
                        <span class="badge">2</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Clone" href="/tags/Clone.html">
                        Clone
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_API" href="/tags/API.html">
                        API
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Template_Pattern" href="/tags/Template_Pattern.html">
                        Template_Pattern
                        <span class="badge">3</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Jekyll" href="/tags/Jekyll.html">
                        Jekyll
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_Bootstrap" href="/tags/Bootstrap.html">
                        Bootstrap
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_SSH" href="/tags/SSH.html">
                        SSH
                        <span class="badge">1</span>
                        </a>
                    </div>
                
                    <div col-lg-3  col-md-4 col-sm-4 col-xs-6">
                        <a class="list-group-item" id="tag_RSA" href="/tags/RSA.html">
                        RSA
                        <span class="badge">1</span>
                        </a>
                    </div>
                
            </div>
        </div>
    </div>
    don't need tag cloud here -->

    <div class="footer-bottom">
        <div class="container">
            <p class="pull-left"> Copyright © <b>Wei SHEN</b> &nbsp | &nbsp Designed by <b>Wei SHEN</b> &nbsp | &nbsp Coded by <b>Wei SHEN</b> &nbsp | &nbsp 2015-2017. All right reserved.  &nbsp | &nbsp  Contact me: <b>symantec__@hotmail.com</b> </p>
            <div class="pull-right">
                <ul class="social">

                </ul>
            </div>
        </div>
    </div>
    <!--/.footer-bottom-->
</footer>



    <!-- Bootstrap Core JavaScript -->
    <script src="/assets/js/bootstrap.min.js"></script>
    <!-- Add space between two paragraph -->
    <script src="/assets/js/span.js"></script>
    <!-- Adjust images size -->
    <script src="/assets/js/imgResponsive.js"></script>
    <!-- Disqus comment count plugin -->
    <script id="dsq-count-scr" src="//www-ciaoshen-com.disqus.com/count.js" async></script>

</body>

</html>
